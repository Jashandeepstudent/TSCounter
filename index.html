async function openSerialPreview(input) {
  try {
    const { db, ref, get, set } = window._firebase || {};
    if (!db || !ref || !get) {
      alert("Firebase not ready yet.");
      return;
    }

    // --- Resolve serial title ---
    const title = typeof input === "string"
      ? input.trim()
      : (input && (input.key || input.title || "")).trim();

    if (!title) {
      alert("Serial not found (no title).");
      return;
    }

    // --- Fetch serial data ---
    let serialData =
      typeof input === "object" && input.title ? input : null;

    if (!serialData) {
      const snap = await get(ref(db, "serials"));
      if (snap.exists()) {
        const all = snap.val();
        for (const [key, obj] of Object.entries(all)) {
          if ((obj.title || "").trim().toLowerCase() === title.toLowerCase()) {
            serialData = obj;
            break;
          }
        }
      }
    }

    if (!serialData) {
      alert(`Serial "${title}" not found in Firebase.`);
      return;
    }

    // --- Ensure fields exist ---
    serialData.likes = serialData.likes || 0;
    serialData.dislikes = serialData.dislikes || 0;

    // --- Calculate total reads ---
    const totalReads = (serialData.episodes || []).reduce(
      (sum, ep) => sum + (ep.reads || 0),
      0
    );

    // --- Load user vote state ---
    const votes = JSON.parse(localStorage.getItem("user_votes_serials") || "{}");
    let userVote = votes[serialData.title] || null;

    // --- Create container ---
    let preview = document.getElementById("previewFull");
    if (!preview) {
      preview = document.createElement("div");
      preview.id = "previewFull";
      document.body.appendChild(preview);
    }

    // --- UI Template ---
    preview.innerHTML = `
      <style>
#previewFull {
  position: fixed;
  inset: 0;
  background: #f7f8fb;
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: opacity 0.3s ease;
  opacity: 0;
  overflow: auto;
  padding: 40px 20px;
}
#previewFull.show { opacity: 1; }
.fullscreen-panel {
  width: 100%;
  max-width: 900px;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  animation: fadeIn 0.4s ease both;
  margin: auto;
}
@keyframes fadeIn {
  from {opacity: 0; transform: scale(0.97);}
  to {opacity: 1; transform: scale(1);}
}
.panel-top {
  background: linear-gradient(135deg, #5b7cff, #00b4d8);
  color: white;
  padding: 22px 28px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.panel-top h2 { margin: 0; font-size: 1.8rem; }
.panel-meta {
  padding: 16px 28px;
  font-size: 14px;
  color: #444;
  border-bottom: 1px solid #eee;
  background: #fafafa;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.meta-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
}
.vote-bar {
  display: flex;
  align-items: center;
  gap: 12px;
}
.vote-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 999px;
  border: none;
  background: #f1f1f1;
  color: #606060;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.vote-btn:hover {
  background: #e5e5e5;
  transform: translateY(-1px);
}
.vote-btn svg {
  width: 22px;
  height: 22px;
  transition: transform 0.25s ease, color 0.25s ease;
}
.vote-btn.active.like {
  background: #e6f0ff;
  color: #1976d2;
}
.vote-btn.active.like svg path {
  fill: #1976d2;
}
.vote-btn.active.dislike {
  background: #ffebee;
  color: #d32f2f;
}
.vote-btn.active.dislike svg path {
  fill: #d32f2f;
}
.vote-btn:active {
  transform: scale(0.93);
}
.vote-count {
  font-weight: 500;
  font-size: 0.9rem;
  color: inherit;
}
.share-menu {
  position: absolute;
  z-index: 99999;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 5px 25px rgba(0,0,0,0.1);
  padding: 10px;
}
.share-option {
  padding: 8px 12px;
  background: none;
  border: none;
  text-align: left;
  width: 100%;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s ease;
}
.share-option:hover { background: #f5f5f5; }
.episodes-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
  background: #f9fafc;
  display: flex;
  justify-content: center;
}
.episodes-list {
  width: 100%;
  max-width: 800px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  align-items: center;
}
.episode-card {
  width: 100%;
  background: #ffffff;
  border: 1px solid #e6e9f2;
  border-radius: 14px;
  padding: 20px 22px;
  box-shadow: 0 5px 14px rgba(0, 0, 0, 0.05);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  display: flex;
  flex-direction: column;
  text-align: left;
}
.episode-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}
.episode-card h3 { margin: 0 0 6px; font-size: 1.1rem; color: #2b2b2b; }
.episode-card p { font-size: 0.9rem; color: #666; margin-bottom: 14px; }
.episode-card button { align-self: flex-end; }
      </style>

      <div class="fullscreen-panel">
        <div class="panel-top">
          <h2>${serialData.title}</h2>
          <button class="btn btn-secondary" id="closePreviewBtn">✕ Close</button>
        </div>

        <div class="panel-meta">
          <div class="meta-row">
            <div>
              <b>Genre:</b> ${serialData.genre || "N/A"} &nbsp; • &nbsp;
              <b>Episodes:</b> ${(serialData.episodes || []).length} &nbsp; • &nbsp;
              <b>Reads:</b> ${totalReads}
            </div>
            <div class="vote-bar">
              <button class="vote-btn like ${userVote === "like" ? "active" : ""}" id="likeBtn">
                 <svg viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-6 0v4H5v10h13l2-9h-6z" fill="currentColor"/></svg>
                <span id="likeCount">${serialData.likes}</span>
              </button>
              <button class="vote-btn dislike ${userVote === "dislike" ? "active" : ""}" id="dislikeBtn">
                   <svg viewBox="0 0 24 24"><path d="M10 15v4a3 3 0 0 0 6 0v-4h3V5H6l-2 9h6z" fill="currentColor"/></svg>
                <span id="dislikeCount">${serialData.dislikes}</span>
              </button>
              <button class="vote-btn" id="shareSerialBtn">🔗 Share</button>
            </div>
          </div>
        </div>

        <div class="episodes-scroll">
          <div class="episodes-list">
            ${(serialData.episodes || [])
              .map(
                (ep, i) => `
                <div class="episode-card">
                  <h3>${ep.title || "Untitled Episode"}</h3>
                  <p>${ep.description || "No description available."}</p>
                  <button class="btn btn-primary read-episode-btn" data-ep="${i}">
                    📖 Read Episode
                  </button>
                </div>`
              )
              .join("")}
          </div>
        </div>
      </div>
    `;

    preview.classList.remove("hidden");
    setTimeout(() => preview.classList.add("show"), 10);

    // --- Close preview ---
    document.getElementById("closePreviewBtn").onclick = () => {
      preview.classList.remove("show");
      setTimeout(() => preview.remove(), 300);
    };

    // --- Read episode ---
    preview.querySelectorAll(".read-episode-btn").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const epIndex = parseInt(e.currentTarget.dataset.ep, 10);
        const episode = serialData.episodes[epIndex];
        episode.reads = (episode.reads || 0) + 1;
        await set(ref(db, `serials/${encodeURIComponent(serialData.title)}`), serialData);
        preview.remove();
        if (typeof openSerialReader === "function") openSerialReader(serialData.title, epIndex);
      });
    });

    // --- Like / Dislike smart toggle ---
    const likeBtn = document.getElementById("likeBtn");
    const dislikeBtn = document.getElementById("dislikeBtn");
    const likeCount = document.getElementById("likeCount");
    const dislikeCount = document.getElementById("dislikeCount");

    async function saveVoteChange() {
      await set(ref(db, `serials/${encodeURIComponent(serialData.title)}`), serialData);
      localStorage.setItem("user_votes_serials", JSON.stringify(votes));
      likeCount.textContent = serialData.likes;
      dislikeCount.textContent = serialData.dislikes;
    }

    likeBtn.onclick = async () => {
      if (userVote === "like") {
        serialData.likes--;
        userVote = null;
        votes[serialData.title] = null;
        likeBtn.classList.remove("active");
      } else {
        if (userVote === "dislike") {
          serialData.dislikes--;
          dislikeBtn.classList.remove("active");
        }
        serialData.likes++;
        userVote = "like";
        votes[serialData.title] = "like";
        likeBtn.classList.add("active");
      }
      await saveVoteChange();
    };

    dislikeBtn.onclick = async () => {
      if (userVote === "dislike") {
        serialData.dislikes--;
        userVote = null;
        votes[serialData.title] = null;
        dislikeBtn.classList.remove("active");
      } else {
        if (userVote === "like") {
          serialData.likes--;
          likeBtn.classList.remove("active");
        }
        serialData.dislikes++;
        userVote = "dislike";
        votes[serialData.title] = "dislike";
        dislikeBtn.classList.add("active");
      }
      await saveVoteChange();
    };

    // --- SHARE BUTTON ---
    const existingMenu = document.getElementById("serial-preview-share-menu");
    if (existingMenu) existingMenu.remove();

    const shareMenu = document.createElement("div");
    shareMenu.id = "serial-preview-share-menu";
    shareMenu.className = "share-menu";
    shareMenu.style.display = "none";
    document.body.appendChild(shareMenu);

function getShareLink(platform) {
  const baseUrl = "https://meurbal.site"; // your live website
  const link = `${baseUrl}?previewSerial=${encodeURIComponent(serialData.title || "")}`;

  const message = `📖 ${serialData.title || "Untitled"}\nGenre: ${
    serialData.genre || "—"
  }\nDescription: ${
    serialData.description || "No description provided."
  }\nRead it on Meurbal: ${link}`;

  if (platform === "WhatsApp")
    return `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
  if (platform === "Facebook")
    return `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
  if (platform === "Twitter")
    return `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
  if (platform === "Copy") return link;

  return link;
}


    [
      { name: "WhatsApp", emoji: "🟢" },
      { name: "Facebook", emoji: "🔵" },
      { name: "Twitter", emoji: "🐦" },
      { name: "Copy", emoji: "🔗" },
    ].forEach((opt) => {
      const btn = document.createElement("button");
      btn.className = "share-option";
      btn.innerHTML = `${opt.emoji} ${opt.name}`;
      btn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const link = getShareLink(opt.name);
        if (opt.name === "Copy") {
          await navigator.clipboard.writeText(link);
          btn.textContent = "✅ Copied!";
          setTimeout(() => (btn.innerHTML = `${opt.emoji} ${opt.name}`), 1200);
        } else {
          window.open(link, "_blank");
        }
        shareMenu.style.display = "none";
      });
      shareMenu.appendChild(btn);
    });

    const shareBtn = document.getElementById("shareSerialBtn");
    shareBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const rect = shareBtn.getBoundingClientRect();
      shareMenu.style.top = rect.bottom + 8 + "px";
      shareMenu.style.left = rect.left + "px";
      shareMenu.style.display =
        shareMenu.style.display === "flex" ? "none" : "flex";
      shareMenu.style.flexDirection = "column";
    });

    document.addEventListener("click", (e) => {
      if (!shareMenu.contains(e.target) && e.target !== shareBtn) {
        shareMenu.style.display = "none";
      }
    });
// --- COMMENTS PANEL ---
// --- COMMENTS PANEL ---
const commentsBtn = document.createElement("button");
commentsBtn.className = "vote-btn";
commentsBtn.id = "commentsBtn";
commentsBtn.innerHTML = "💬 Comments";
document.querySelector(".vote-bar").appendChild(commentsBtn);

commentsBtn.addEventListener("click", async () => {

  let panel = document.getElementById("commentsPanel");
  if (panel) panel.remove();

  panel = document.createElement("div");
  panel.id = "commentsPanel";
  panel.innerHTML = `
  <style>
    #commentsPanel {
      position: fixed;
      inset: 0;
      background: #ffffff;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      animation: fadeIn .25s ease both;
    }

    .comments-header {
      background: linear-gradient(135deg,#5b7cff,#00b4d8);
      padding: 16px 20px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
    }

    #closeCommentsBtn {
      background:none;
      border:none;
      color:#fff;
      font-size:22px;
      cursor:pointer;
      padding:0;
    }

    #commentsList {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px 80px;
      background: #f5f7fb;
    }

    .comment-item {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      animation: fadeUp 0.25s ease both;
    }

    @keyframes fadeUp { from { opacity: 0; transform: translateY(4px);} to {opacity: 1; transform: translateY(0);} }

    .comment-user { font-weight: 700; color: #222; font-size: 15px; margin-bottom: 4px; }
    .comment-text { color: #333; font-size: 14px; line-height: 1.5; margin-bottom: 6px; }
    .comment-time { font-size: 12px; color: #8a8a8a; }

    .comment-actions { display: flex; gap: 12px; margin-top: 8px; }
    .comment-actions button {
      border: none; background: #eef2ff; padding: 6px 12px; border-radius: 10px; cursor: pointer;
      font-size: 14px; display: flex; align-items: center; gap: 6px; transition: 0.2s;
    }
    .comment-actions button:hover { background: #d9e0ff; }
    .comment-actions button.active { background: #5b7cff; color: white; }
    .reply-btn,.view-replies-btn { background:#f1f4ff; padding:6px 10px; border-radius:8px; }

    .reply-input { display:none; gap:8px; margin-top:8px; }
    .reply-input input { flex:1; padding:6px; border-radius:6px; border:1px solid #ccc; }
    .reply-input button { background:#5b7cff; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }

    .replies-list { display:none; margin-top:6px; }
    .reply-item {
      background:#fff; padding:10px 12px; border-radius:10px; margin-top:6px; margin-left:20px;
      box-shadow:0 1px 4px rgba(0,0,0,0.07);
    }

    .reply-actions button {
      border:none;background:#eef2ff;padding:4px 8px;border-radius:8px;cursor:pointer;
      font-size:13px;display:inline-flex;align-items:center;gap:4px;
    }
    .reply-actions button.active { background:#5b7cff;color:#fff; }

    .comment-input-area { padding:12px 20px;border-top:1px solid #ddd;background:#fafafa;display:flex; }
    .comment-input-area textarea {
      flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;resize:none;font-size:14px;
    }
    .comment-input-area button {
      margin-left:10px;padding:10px 16px;border:none;background:#5b7cff;color:#fff;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s;
    }
    .comment-input-area button:hover { background:#4967e0; }
  </style>

  <div class="comments-header">
    <span>${serialData.title} — <span id="commentsCount">0</span> Comments</span>
    <button id="closeCommentsBtn">✕</button>
  </div>

  <div id="commentsList">Loading comments...</div>

  <div class="comment-input-area">
    <textarea id="newCommentText" placeholder="Write a comment..." rows="2"></textarea>
    <button id="sendCommentBtn">Post</button>
  </div>
`;

  document.body.appendChild(panel);

  const commentsList = panel.querySelector("#commentsList");
  const closeBtn = panel.querySelector("#closeCommentsBtn");
  const sendBtn = panel.querySelector("#sendCommentBtn");
  const input = panel.querySelector("#newCommentText");
  closeBtn.onclick = () => panel.remove();

  const commentsRef = ref(db, `serial_comments/${encodeURIComponent(serialData.title)}/comments`);

  async function loadReplies(commentId, container) {
    const user = localStorage.getItem("username") || "Guest";
    const replyRef = ref(db, `serial_comments/${encodeURIComponent(serialData.title)}/comments/${commentId}/replies`);
    const snap = await get(replyRef);

    if (!snap.exists()) {
      container.innerHTML = "<p style='margin-left:12px;color:#666;font-size:12px;'>No replies yet.</p>";
      return;
    }

    const replies = Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
    container.innerHTML = replies.map(r=>{
      const likeCount = r.likes ? Object.keys(r.likes).length : 0;
      const dislikeCount = r.dislikes ? Object.keys(r.dislikes).length : 0;
      const youLike = r.likes && r.likes[user];
      const youDislike = r.dislikes && r.dislikes[user];

      return `
      <div class="reply-item" data-rid="${r.id}">
        <div class="reply-user"><b>${r.user}</b></div>
        <div class="reply-text">${r.text}</div>
        <div class="reply-time" style="font-size:11px;color:#888;">${new Date(r.ts).toLocaleString()}</div>
        <div class="reply-actions" style="margin-top:4px;">
          <button class="reply-like-btn ${youLike?"active":""}">👍 <span>${likeCount}</span></button>
          <button class="reply-dislike-btn ${youDislike?"active":""}">👎 <span>${dislikeCount}</span></button>
        </div>
      </div>`;
    }).join("");

    container.querySelectorAll(".reply-item").forEach(rep=>{
      const rid = rep.dataset.rid;
      rep.querySelector(".reply-like-btn").onclick = () => toggleReplyReaction(commentId,rid,"like");
      rep.querySelector(".reply-dislike-btn").onclick = () => toggleReplyReaction(commentId,rid,"dislike");
    });
  }

  async function loadComments() {
    try {
      const snap = await get(commentsRef);
      const username = localStorage.getItem("username") || "Guest";
      const countEl = document.getElementById("commentsCount");

      if (!snap.exists()) {
        commentsList.innerHTML = "<p>No comments yet.</p>";
        countEl.textContent = 0;
        return;
      }

      const arr = Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
      countEl.textContent = arr.length;

      commentsList.innerHTML = arr.map(c=>{
        const likes = c.likes?Object.keys(c.likes).length:0;
        const dislikes = c.dislikes?Object.keys(c.dislikes).length:0;
        const userLiked = c.likes&&c.likes[username];
        const userDisliked = c.dislikes&&c.dislikes[username];

        return `
        <div class="comment-item" data-id="${c.id}">
          <div class="comment-user">${c.user}</div>
          <div class="comment-text">${c.text}</div>
          <div class="comment-time">${new Date(c.ts).toLocaleString()}</div>

          <div class="comment-actions">
            <button class="like-btn ${userLiked?"active":""}">
              <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M14 9V5a3 3 0 0 0-6 0v4H5v10h13l2-9h-6z"/></svg>
              <span>${likes}</span>
            </button>

            <button class="dislike-btn ${userDisliked?"active":""}">
              <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M10 15v4a3 3 0 0 0 6 0v-4h3V5H6l-2 9h6z"/></svg>
              <span>${dislikes}</span>
            </button>

            <button class="reply-btn">💬 Reply</button>
            <button class="view-replies-btn" style="display:${c.replies?"inline-block":"none"}">Replies (${c.replies?Object.keys(c.replies).length:0})</button>
          </div>

          <div class="reply-input">
            <input type="text" class="reply-text" placeholder="Write a reply...">
            <button class="send-reply-btn">Reply</button>
          </div>

          <div class="replies-list"></div>
        </div>`;
      }).join("");

      commentsList.querySelectorAll(".comment-item").forEach(item=>{
        const id = item.dataset.id;

        item.querySelector(".like-btn").onclick = () => toggleReaction(id,"like");
        item.querySelector(".dislike-btn").onclick = () => toggleReaction(id,"dislike");

      item.querySelector(".reply-btn").onclick = () => {
  const box = item.querySelector(".reply-input");
  if (box.style.display === "" || box.style.display === "none") {
    box.style.display = "flex";
  } else {
    box.style.display = "none";
  }
};

item.querySelector(".send-reply-btn").onclick = async ()=>{
  const t = item.querySelector(".reply-text").value.trim();
  if(!t) return;

  const u = localStorage.getItem("username") || "Guest";
  const replyRef = ref(db, `serial_comments/${encodeURIComponent(serialData.title)}/comments/${id}/replies`);
  const snap = await get(replyRef);

  let replies = snap.exists() ? snap.val() : {};
  const rid = "r_" + Date.now();

  replies[rid] = {
    id: rid,
    user: u,
    text: t,
    ts: Date.now(),
    likes: {},
    dislikes: {}
  };

  await set(replyRef, replies);

  // ✅ Update Replies button count ONLY
  const repliesBtn = item.querySelector(".view-replies-btn");
  repliesBtn.style.display = "inline-block";
  repliesBtn.textContent = `Replies (${Object.keys(replies).length})`;

  // ✅ Close reply box & clear input
  const inputBox = item.querySelector(".reply-input");
  inputBox.style.display = "none";
  item.querySelector(".reply-text").value = "";

  // ✅ DO NOT open replies section automatically anymore
};


        item.querySelector(".view-replies-btn").onclick = ()=>{
          const box = item.querySelector(".replies-list");
          box.style.display = box.style.display==="none"?"block":"none";
          loadReplies(id,box);
        };
      });
    } catch(e){
      commentsList.innerHTML="<p>⚠️ Failed to load comments.</p>";
    }
  }

  async function toggleReaction(id,type){
  const user = localStorage.getItem("username")||"Guest";
  const refC = ref(db,`serial_comments/${encodeURIComponent(serialData.title)}/comments/${id}`);
  const snap = await get(refC);
  if(!snap.exists()) return;
  let c = snap.val();

  c.likes=c.likes||{};
  c.dislikes=c.dislikes||{};

  if(type==="like"){
    if(c.likes[user]) delete c.likes[user];
    else{ c.likes[user]=true; delete c.dislikes[user]; }
  } else {
    if(c.dislikes[user]) delete c.dislikes[user];
    else{ c.dislikes[user]=true; delete c.likes[user]; }
  }

  await set(refC,c);

  // UPDATE UI (NO RELOAD)
  const el = document.querySelector(`.comment-item[data-id="${id}"]`);
  el.querySelector(".like-btn span").textContent = Object.keys(c.likes).length;
  el.querySelector(".dislike-btn span").textContent = Object.keys(c.dislikes).length;
  el.querySelector(".like-btn").classList.toggle("active", !!c.likes[user]);
  el.querySelector(".dislike-btn").classList.toggle("active", !!c.dislikes[user]);
}

 async function toggleReplyReaction(cid,rid,type){
  const user = localStorage.getItem("username")||"Guest";
  const refR = ref(db,`serial_comments/${encodeURIComponent(serialData.title)}/comments/${cid}/replies/${rid}`);
  const snap = await get(refR);
  if(!snap.exists()) return;
  let r = snap.val();

  r.likes=r.likes||{};
  r.dislikes=r.dislikes||{};

  if(type==="like"){
    if(r.likes[user]) delete r.likes[user];
    else{ r.likes[user]=true; delete r.dislikes[user]; }
  } else {
    if(r.dislikes[user]) delete r.dislikes[user];
    else{ r.dislikes[user]=true; delete r.likes[user]; }
  }

  await set(refR,r);

  // UPDATE UI instantly
  const rep = document.querySelector(`.reply-item[data-rid="${rid}"]`);
  rep.querySelector(".reply-like-btn span").textContent = Object.keys(r.likes).length;
  rep.querySelector(".reply-dislike-btn span").textContent = Object.keys(r.dislikes).length;
  rep.querySelector(".reply-like-btn").classList.toggle("active", !!r.likes[user]);
  rep.querySelector(".reply-dislike-btn").classList.toggle("active", !!r.dislikes[user]);
}

  sendBtn.onclick = async () => {
    const text = input.value.trim();
    if (!text) return;
    const user = localStorage.getItem("username")||"Guest";
    const newC = {id:"c_"+Date.now(),user,text,ts:Date.now()};
    const snap = await get(commentsRef);
    let list = snap.exists()?snap.val():{};
    list[newC.id]=newC;
    await set(commentsRef,list);
    input.value="";
    loadComments();
  };

  loadComments();
});


    console.log(`✅ openSerialPreview: displayed "${serialData.title}"`);
  } catch (err) {
    console.error("❌ openSerialPreview error:", err);
    alert("Error loading serial preview.");
  }
}

// --- AUTO OPEN ON SHARE LINK ---
(function autoOpenPreviewFromUrl() {
  try {
    const params = new URLSearchParams(window.location.search);
    const t = params.get("previewSerial");
    if (!t) return;
    setTimeout(() => openSerialPreview(t), 200);
  } catch (e) {
    console.warn("Auto-open preview failed:", e);
  }
})();

