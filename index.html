



<!DOCTYPE html>
<html lang="en">
<head>
<style>#profileBtn,#profileDropdown{display:none!important;}</style>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">


  <title>Meurbal - Where Dream.Write.Live</title>
<!-- ========== FAVICONS (MUST BE FIRST) ========== -->
<link rel="icon" type="image/svg+xml" href="/melogo.svg"> <!-- best for modern browsers -->
<link rel="shortcut icon" href="/favicon.ico"> <!-- Google safe -->
<link rel="icon" href="/favicon.ico" sizes="any"> <!-- fallback for old browsers -->

<!-- PNG FALLBACKS -->
<link rel="icon" type="image/png" sizes="192x192" href="/melogo.png">
<link rel="icon" type="image/png" sizes="512x512" href="/melogo.png">
<link rel="apple-touch-icon" sizes="180x180" href="/melogo.png"> <!-- iOS -->

<!-- ========== GOOGLE BRAND ICON BOOST ========== -->
<link rel="mask-icon" href="/melogo.svg" color="#0099FF">

<!-- ========== PWA / ANDROID APP SUPPORT ========== -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0099FF">

<!-- ========== iOS WEB APP ENHANCEMENT ========== -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- ========== SEO / SEARCH ENGINE ========== -->
<meta name="description" content="Meurbal - Where Dream. Write. Live. Read fantasy, action, romance, crime & adventure stories online. Enter new worlds of thrill & imagination.">
<meta name="keywords" content="Meurbal, Meurbal Site, Meurbal stories, Meurbal writing platform, Dream Write Live, fantasy stories, romance novels, adventure series">
<link rel="canonical" href="https://meurbal.site">

<!-- ========== SOCIAL MEDIA / LINK PREVIEW ========== -->
<meta property="og:title" content="Meurbal - Where Dream.Write.Live">
<meta property="og:description" content="Fantasy, action, romance, crime & adventure ‚Äî read and write stories and series online.">
<meta property="og:url" content="https://meurbal.site">
<meta property="og:type" content="website">
<meta property="og:image" content="https://meurbal.site/melogo.png">


<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Meurbal - Where Dream.Write.Live">
<meta name="twitter:description" content="Fantasy, action, romance, crime & adventure ‚Äî explore online stories on Meurbal.">
<meta name="twitter:image" content="https://meurbal.site/melogo.png">
<meta name="application-name" content="Meurbal">
<!-- ========== STRUCTURED DATA (GOOGLE) ========== -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Meurbal",
  "url": "https://meurbal.site",
  "logo": "https://meurbal.site/melogo.png",
  "description": "Meurbal - Where Dream. Write. Live. Read and write fantasy, romance, action and adventure stories and series online.",
  "sameAs": [
    "https://meurbal.site"
  ]
}
</script>

</script>
<!-- Splash / Opening Animation -->
<div id="meurbalSplash" aria-hidden="true">
  <div class="meurbal-splash-inner">
    <img src="melogo.png" alt="Meurbal logo" id="meurbalSplashLogo">
  <p style="font-size: 20px; font-weight: 600; color: #0099FF; margin-bottom: 20px;">
      <span style="font-weight: 700;">Dream. Write. Live.</span>
    </p>

    <div id="meurbalSplashBar">
      <div id="meurbalSplashBarFill"></div>
    </div>
  </div>
</div>

<meta name="apple-mobile-web-app-title" content="Meurbal">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00bcd4">

  <style>
    :root{ --bg:#f9fafb;--accent:#4f46e5;--muted:#6b7280; --shadow:0 4px 14px rgba(0,0,0,0.08);--border:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, Arial,sans-serif;background:var(--bg);color:#111827;font-size:16px;line-height:1.45;}
    h1,h2{margin:16px 0;text-align:center}
    button,input,select,textarea{font-family:inherit;font-size:14px}
    .btn{padding:14px 20px;border:none;border-radius:14px;cursor:pointer;font-weight:700;transition:0.18s;box-shadow:0 8px 24px rgba(79,70,229,0.12)}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:#e5e7eb;color:#111;border:1px solid #d1d5db}
    .btn:hover{opacity:0.95;transform:translateY(-1px)}
    .hidden{display:none!important}
#saveDraftBtn { display: none !important; }

.story-analytics-modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.45);
  z-index: 9999;
  padding: 20px;
  box-sizing: border-box;
}
.story-analytics-card {
  width: min(980px, 96%);
  max-height: 90vh;
  overflow: auto;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25);
  padding: 18px;
  box-sizing: border-box;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
.analytics-header {
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
  flex-wrap:wrap;
}
.analytics-title { font-size:20px; font-weight:700; }
.analytics-summary {
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.summary-pill {
  padding:8px 12px;
  border-radius:10px;
  background:#f3f4f6;
  font-weight:600;
}
.status-pill {
  padding:8px 12px;
  border-radius:10px;
  font-weight:700;
  display:inline-block;
}
.analytics-body { margin-top:8px; }
.canvas-wrap { width:100%; height:360px; background:#fff; border-radius:8px; padding:10px; box-sizing:border-box; }
.legend { margin-top:8px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.legend-item { display:flex; gap:6px; align-items:center; font-size:13px; }
.legend-swatch { width:14px; height:6px; border-radius:2px; display:inline-block; }
.close-analytics {
  background:transparent;
  border:0;
  font-size:18px;
  cursor:pointer;
}
.small-note { color:#6b7280; font-size:13px; margin-top:8px; }

    /* Header */
    header{position:fixed;top:12px;left:12px;z-index:60}
    .profile-btn{width:56px;height:56px;border-radius:50%;background:white; box-shadow:0 10px 30px rgba(0,0,0,0.12); display:flex;align-items:center;justify-content:center; border:none;cursor:pointer;overflow:hidden;font-size:16px}
    .profile-initials{font-weight:700;color:var(--accent);font-size:16px}
    .dropdown{position:absolute;background:white;border:1px solid var(--border);border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,0.08);padding:8px;display:none;flex-direction:column; min-width:220px;z-index:55}
    .dropdown button{background:transparent;border:none;padding:10px;border-radius:8px;text-align:left;cursor:pointer;font-size:15px}
    .dropdown button:hover{background:#f3f4f6}
/* --- Meurbal Splash --- */
#meurbalSplash {
  position: fixed;
  inset: 0;
  z-index: 999999;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(180deg, #fff, #fff); /* cyan gradient */
  opacity: 1;
  transition: opacity 400ms ease, transform 400ms ease;
  will-change: opacity, transform;
}

#meurbalSplash.hidden {
  opacity: 0;
  pointer-events: none;
  transform: scale(0.995);
}

.meurbal-splash-inner {
  text-align: center;
}

#meurbalSplashLogo {
  width: min(40vw, 230px);
  max-width: 250px;
  height: auto;
  display: inline-block;
  transform-origin: center;
  animation: logoPop 900ms cubic-bezier(.2,.9,.2,1);
  filter: drop-shadow(0 10px 25px rgba(0,0,0,0.25));
  margin-bottom: 28px;
}

@keyframes logoPop {
  0% { transform: scale(.8) translateY(6px); opacity: 0; }
  60% { transform: scale(1.05) translateY(-4px); opacity: 1; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}

/* --- Loading Bar --- */
#meurbalSplashBar {
  position: relative;
  width: 180px;
  height: 6px;
  background: rgba(0, 123, 255, 0.3); /* light blue background track */
  border-radius: 6px;
  overflow: hidden;
  margin: 0 auto;
}

#meurbalSplashBarFill {
  position: absolute;
  top: 0; left: 0;
  height: 100%;
  width: 0%;
  background: #007bff; /* bright blue fill color */
  border-radius: 6px;
  transition: width 0.2s linear;
}


    /* Main */
    main{display:flex;flex-direction:column;align-items:center;justify-content:center; height:100vh;text-align:center;padding:20px}
    .buttons{display:flex;flex-direction:column;gap:12px;align-items:center}
    .btn-small{padding:10px 16px;font-size:16px;border-radius:12px}

.jelly-btn {
  background-color: white;
  color: #333; /* dark text */
  font-weight: bold;
  padding: 10px 25px;
  border: 2px solid #ccc;
  border-radius: 50px;
  cursor: pointer;
  font-size: 16px;
  position: relative;
  overflow: hidden;
  outline: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}

.jelly-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 15px rgba(0,0,0,0.2);
  border-color: #888;
}

.jelly-btn:active {
  animation: jelly 0.6s;
}

/* Wobble animation */
@keyframes jelly {
  0% { transform: scale(1, 1); }
  25% { transform: scale(1.2, 0.8); }
  50% { transform: scale(0.8, 1.2); }
  75% { transform: scale(1.1, 0.9); }
  100% { transform: scale(1, 1); }
}
/* --- MAIN BUTTON IMPROVEMENTS --- */
.btn-primary {
  background: linear-gradient(135deg,#00eaff,#0077ff);
  border:none;
  padding:8px 16px;
  border-radius:8px;
  color:white;
  cursor:pointer;
  transition:0.25s;
  box-shadow:0 0 12px #00eaff80;
}
.btn-primary:hover { transform:scale(1.05); }

/* Like + Dislike Neon ACTIVE */
.btn-liked {
  background:#00eaff !important;
  box-shadow:0 0 10px #00eaff;
  color:#000;
}
.btn-disliked {
  background:#ff0048 !important;
  box-shadow:0 0 10px #ff0048;
  color:#fff;
}
.word.highlight {
  background: yellow;
  border-radius: 4px;
  transition: background 0.15s;
}

/* --- COMMENT CARD UI --- */
.comment-item {
  background:#ffffff;
  padding:12px 14px;
  border-radius:14px;
  margin-bottom:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.10);
  border:1px solid rgba(0,0,0,0.05);
}

/* Comment buttons */
.comment-item .replyBtn,
.comment-item .viewRepliesBtn {
  background:none;
  border:none;
  color:#0077ff;
  cursor:pointer;
  font-size:14px;
  padding:4px 6px;
}
.comment-item .replyBtn:hover,
.comment-item .viewRepliesBtn:hover {
  text-decoration:underline;
}

/* Reply input box */
.replyInput {
  margin-top:8px;
  display:flex;
  gap:8px;
}
.replyInput input {
  flex:1;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
.replyInput button {
  background:linear-gradient(135deg, #4facfe, #ffffff);
  border:none;
  color:white;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
  box-shadow:0 0 10px #ff00e070;
}

/* Replies mini-cards */
.replies > div {
  background:#f0f4ff;
  padding:8px;
  margin-top:6px;
  border-radius:8px;
  border-left:3px solid #7aa8ff;
}
.btn-liked {
  background:#00eaff !important;
  box-shadow:0 0 10px #00eaff;
  color:#000;
}
.btn-disliked {
  background:#ff0048 !important;
  box-shadow:0 0 10px #ff0048;
  color:#fff;
}

    /* Form */
    .form-container{max-width:680px;margin:40px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:var(--shadow)}
    label{display:block;margin:8px 0 4px;font-weight:600;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:12px}
    .genres-container{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;margin-bottom:16px}
    .genre-option{padding:8px 14px;border:1px solid var(--border);border-radius:20px;cursor:pointer; background:#f9fafb;transition:0.2s}
    .genre-option.active{background:var(--accent);color:#fff;border-color:var(--accent)}

    /* Dashboard */
    #dashboardPage{padding:24px;min-height:100vh}
    .dashboard-header{display:flex;flex-direction:column;align-items:center;margin-bottom:20px;gap:12px;text-align:center}
    .dashboard-card{padding:16px;background:#fff;margin-bottom:12px;border-radius:12px;box-shadow:var(--shadow);display:flex;justify-content:space-between;gap:8px;align-items:center}
    .dashboard-card .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .dashboard-card h3{margin:0;font-size:18px}
    .dashboard-card p{margin:6px 0;color:#111827}
    .dashboard-card .desc{color:#374151}
    .status-public{color:green;font-weight:700}
    .status-draft{color:#b45309;font-weight:700}
    .card-actions{display:flex;gap:8px;align-items:center}
    .small-btn{padding:6px 10px;border-radius:8px;font-weight:600}

    /* Editor Page */
    #editorPage{position:fixed;inset:0;background:var(--bg);z-index:100;display:flex;flex-direction:column;padding:18px;gap:12px}
    .sheets-bar{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px}
    .sheet-thumb{position:relative;min-width:180px;min-height:80px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,0.08);cursor:pointer;white-space:pre-wrap;overflow:hidden;text-overflow:ellipsis}
    .sheet-thumb.active{border:2px solid var(--accent)}
    .sheet-thumb .del{position:absolute;top:6px;right:6px;background:transparent;border:none;font-size:12px;cursor:pointer;padding:4px;border-radius:4px}
    .add-sheet-btn{min-width:40px;min-height:60px;border:1px dashed var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:var(--accent);cursor:pointer;flex-shrink:0}
    .sheet-textarea{flex:1;padding:18px;border:1px solid var(--border);border-radius:12px;font-size:16px;resize:none;min-height:320px}
    .editor-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}

    /* Slots Page */
    #slotsContainer{display:flex;gap:24px;flex-wrap:wrap;justify-content:center;padding:16px}
    .slot-card{width:260px;height:220px;background:#fff;border-radius:20px;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;position:relative;box-shadow:0 14px 40px rgba(0,0,0,0.14);font-size:18px;text-align:center;transition:all 0.22s;padding:16px}
    .slot-card:hover{transform:translateY(-4px);box-shadow:0 10px 24px rgba(0,0,0,0.15)}
    .slot-card.locked{background:#f3f4f6;color:#111827;font-weight:600}
    .slot-card.locked::before{content:"üîí";font-size:24px;position:absolute;top:8px;right:8px}
    .slot-card .slot-title{font-weight:700;margin-bottom:6px}
    .slot-card .slot-meta{font-size:13px;color:var(--muted)}

    /* Popups */
    .popup { position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:300}
    .popup .popup-content{background:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.15);max-width:520px;width:92%}
    .popup input{width:100%;padding:10px;margin-bottom:12px;border:1px solid var(--border);border-radius:8px;font-size:16px}

    /* Back button (left bottom) */
    .back-btn{position:fixed;left:18px;bottom:18px;background:#fff;color:#111;padding:10px 14px;border-radius:12px;border:1px solid var(--border);cursor:pointer;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
    .back-btn .icon{margin-right:8px}

    /* small helpers */
    .row{display:flex;gap:12px;align-items:center;justify-content:center}
    .muted{color:var(--muted)}
  .book {
  position: relative;
  perspective: 2000px;
  width: 880px;
  max-width: 100%;
  height: 420px;
}

.page {
  position: absolute;
  inset: 0;
  background: #fffef9;
  border: 1px solid #e5d7b7;
  border-radius: 12px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.15);
  transform-origin: left center;
  backface-visibility: hidden;
  transform-style: preserve-3d;
  overflow: hidden;
}

.page.back {
  transform-origin: right center;
  transform: rotateY(180deg);
}

@keyframes turnNextFront {
  0%   { transform: rotateY(0deg);   z-index: 2; }
  100% { transform: rotateY(-180deg); z-index: 1; }
}
@keyframes turnNextBack {
  0%   { transform: rotateY(180deg);  z-index: 1; }
  100% { transform: rotateY(0deg);    z-index: 2; }
}

    
    /* Smaller and mobile-friendly categories */
    #categoriesPage, #serialCategoriesPage {padding:20px;min-height:100vh;display:flex;flex-direction:column;align-items:center;gap:14px;background:var(--bg)}
    .categories-header{max-width:800px;width:100%;text-align:center}
    .categories-grid{display:flex;gap:10px;flex-wrap:nowrap;overflow-x:auto;padding:8px 4px;width:100%;justify-content:center}
    .cat-card{flex:0 0 auto;padding:12px 18px;border-radius:14px;background:#fff;box-shadow:var(--shadow);min-width:110px;text-align:center;cursor:pointer;border:1px solid var(--border);transition:transform .15s, box-shadow .15s}
    .cat-card .cat-title{font-weight:700;margin-bottom:4px;font-size:14px}
    .cat-card .cat-sub{font-size:12px;color:var(--muted)}
    .cat-card:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(0,0,0,0.08)}
    .cat-card.active{background:linear-gradient(135deg, #4facfe, #ffffff),#7c3aed);color:#fff;border-color:transparent;box-shadow:0 14px 35px rgba(79,70,229,0.18)}
    .categories-grid::-webkit-scrollbar{height:6px}
    .categories-grid::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:6px}
    #categoriesBackBtn, #serialCategoriesBackBtn{position:fixed;left:14px;bottom:14px}

#previewFull {
  position: fixed !important;
  inset: 0 !important;
  z-index: 99999 !important;
  display: block !important;
}
#previewFull.hidden {
  display: none !important;
}
5:00 PM 10/27/2025

    /* full-width story cards */
   #storiesCards {
  display: flex;
  flex-direction: column;
  gap: 32px;
  width: 100%;
  align-items: center;
}

.story-card {
  width: 280px;
  height: 420px;
  background: linear-gradient(180deg, #fdf6f0, #e0d8c0);
  border-radius: 14px;
  padding: 24px;
  color: #0f172a;
  box-shadow: 0 10px 25px rgba(0,0,0,0.25);
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  position: relative;
  font-family: 'Georgia', serif;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.story-card:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 15px 30px rgba(0,0,0,0.3);
}

.story-card::before {
  content: "";
  position: absolute;
  inset: 0;
  background: url('your-cover-image.jpg') center/cover no-repeat;
  opacity: 0.15;
  pointer-events: none;
}

.story-card h2 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

.story-card p {
  margin: 4px 0 0;
  font-size: 1rem;
  font-style: italic;
  text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
}

.story-card .read-btn,
.story-card .view-serial-btn {
  margin-top: 12px;
  padding: 8px 16px;
  border: none;
  background: #1e40af;
  color: #fff;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s ease;
}

.story-card .read-btn:hover,
.story-card .view-serial-btn:hover {
  background: #1e3a8a;
}
.scroll-wrap {
  display: flex;
  overflow-x: auto;
  gap: 12px;
  padding: 12px;
  scroll-behavior: smooth;
  flex-wrap: nowrap;
  position: relative; /* important for overlay effect */
}
.btn-like-active {
  background: #007bff !important; /* Blue */
  color: #fff !important;
}

.btn-dislike-active {
  background: #ff3b3b !important; /* Red */
  color: #fff !important;
}
.btn-like-active {
  background: #2563eb !important; /* Blue */
  color: white !important;
}

.btn-dislike-active {
  background: #dc2626 !important; /* Red */
  color: white !important;
}

    /* Fullscreen preview */
    .fullscreen-panel{position:fixed;inset:0;background:var(--bg);z-index:800;display:flex;flex-direction:column;padding:22px;overflow:auto}
    .fullscreen-panel .panel-inner{max-width:1100px;margin:12px auto;display:flex;flex-direction:column;gap:12px}
    .panel-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .panel-meta{color:var(--muted)}
    /* Fullscreen reader */
    .reader-full{position:fixed;inset:0;background:#ffffff;z-index:900;display:flex;flex-direction:column;padding:18px;overflow:auto}
    .reader-header{display:flex;justify-content:space-between;align-items:center}
    .reader-body{flex:1;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;padding:12px}
    .reader-sheet{width:100%;max-width:980px;border-radius:10px;padding:18px;min-height:240px;font-size:18px;line-height:1.6;background:linear-gradient(180deg,#fff,#fbfbff);box-shadow:0 12px 40px rgba(0,0,0,0.06)}


/* Added tweaks for murbal: ensure story cards use full-color gradient and fixed height */
.story-card{ color:#0f172a; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.08); min-height:180px; display:flex; flex-direction:column; justify-content:space-between; }
.story-card h4{ margin:0; font-size:18px; font-weight:700; }
.story-card p{ margin:0; }

</style>

<style>
#writerGateActionBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.55);
}
#writerGateActionBtn:active {
  transform: translateY(1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.35);
}
</style>

</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
async function loadCurrentUsername() {
  const uid = "M9z7gJueT9a8zm7uZXh6ek3WHQ93"; // ‚ö° Your actual Firebase reader UID
  const snap = await window._firebase.get(
    window._firebase.ref(window._firebase.db, "meurbal_v1/readers/" + uid)
  );
  if (snap.exists()) {
    const data = snap.val();
    if (data.username) {
      localStorage.setItem("username", data.username);
      localStorage.setItem("readerUid", uid);
      console.log("‚úÖ Username loaded:", data.username);
    }
  }
}
loadCurrentUsername();

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDZpUl6FzT7pRtb5QwlEZrjkE4gpjZxIY4",
  authDomain: "meurbal-d3c72.firebaseapp.com",
  databaseURL: "https://meurbal-d3c72-default-rtdb.firebaseio.com",
  projectId: "meurbal-d3c72",
  storageBucket: "meurbal-d3c72.firebasestorage.app",
  messagingSenderId: "707190126856",
  appId: "1:707190126856:web:128c972aef19934c81d4bd",
  measurementId: "G-4SBPDJHJDS"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const statusBox = document.createElement('div');
statusBox.id = '__firebase_status_box';
statusBox.textContent = 'üü° Firebase: Connecting...';
statusBox.style.cssText = `
  display: none;
  position: fixed;
  right: 12px;
  bottom: 12px;
  padding: 8px 12px;
  border-radius: 10px;
  background: #fff;
  font-weight: 700;
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
  z-index: 99999;
`;
document.addEventListener('DOMContentLoaded', () => document.body.appendChild(statusBox));

function setStatus(text, color) {
  try {
    statusBox.textContent = text;
    if (color) statusBox.style.background = color;
  } catch (e) {}
}

get(ref(db, '/'))
  .then(() => setStatus('üü¢ Firebase: Connected', '#dcfce7'))
  .catch(() => setStatus('üî¥ Firebase: Offline', '#fee2e2'));

window._firebase={app,db,ref,set,get,child};

function saveLocal(k,d){localStorage.setItem(k,JSON.stringify(d));}
function loadLocal(k){try{return JSON.parse(localStorage.getItem(k))||[]}catch{return [];}}

window.storiesData=loadLocal('storiesData');
window.serialsData=loadLocal('serialsData');
window.serialSlots = loadLocal('serialSlots') || []; // ‚úÖ Load serial slots locally

function renderStoriesList(stories){
 const list=document.getElementById('storiesCards');if(!list)return;
 list.innerHTML='';
 stories.forEach(s=>{const c=document.createElement('div');c.className='story-card';c.innerHTML=`<h2>${s.title}</h2><p>${s.genre||''}</p>`;list.appendChild(c);});
}
function renderSerialsList(serials) {
  const list = document.getElementById('serialsCards');
  if (!list) return;
  list.innerHTML = '';

  serials.forEach(s => {
    const c = document.createElement('div');
    c.className = 'story-card';
    c.innerHTML = `
      <h2>${s.title}</h2>
      <p>${s.genre || ''}</p>
      <button class="view-serial-btn">View Serial</button>
    `;

    c.querySelector('.view-serial-btn').addEventListener('click', async () => {
      const titleKey = s.title.trim();
      console.log('üé¨ View Serial clicked:', titleKey);

      try {
        const allSnap = await get(ref(window._firebase.db, 'serials'));
        if (!allSnap.exists()) {
          alert('No serials found in Firebase.');
          return;
        }

        const allSerials = allSnap.val();
        let data = null;
let foundKey = null;

// Try exact key match first
if (allSerials[titleKey]) {
  data = allSerials[titleKey];
  foundKey = titleKey;
} else {
  // Otherwise, scan all serials by title field
  for (const [key, obj] of Object.entries(allSerials)) {
    if ((obj.title || '').trim().toLowerCase() === titleKey.toLowerCase()) {
      data = obj;
      foundKey = key;
      break;
    }
  }
}

if (data) {
          console.log(`‚úÖ Found serial "${titleKey}" under key "${foundKey}"`);
          openSerialPreview(data);
        } else {
          console.warn(`‚ö†Ô∏è Serial "${titleKey}" not found in Firebase.`);
          alert(`Serial "${titleKey}" not found!`);
        }

      } catch (err) {
        console.error('‚ùå Error fetching serial from Firebase:', err);
        alert('Error fetching serial. Check your network connection.');
      }
    });

    list.appendChild(c);
  });
}


function openSerialPreview(serialData) {
  const preview = document.getElementById('previewFull');
  preview.innerHTML = `
    <div class="fullscreen-panel">
      <div class="panel-inner">
        <div class="panel-top">
          <h2>${serialData.title}</h2>
          <button class="btn btn-secondary" id="closePreviewBtn">Close</button>
        </div>
        <div class="panel-meta">
          Genre: ${serialData.genre || 'N/A'} ‚Ä¢ Episodes: ${serialData.episodes?.length || 0}
        </div>
        <div class="episodes-list">
          ${(serialData.episodes || []).map((ep, i) => `
            <div class="dashboard-card">
              <h3>${ep.title}</h3>
              <p>${ep.description || ''}</p>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  preview.classList.remove('hidden');
  document.getElementById('closePreviewBtn').addEventListener('click', () => {
    preview.classList.add('hidden');
  });
}

// ---------- STORIES + SERIALS LOAD FROM FIREBASE ----------



onValue(ref(db, 'stories'), snap => {
  if (snap.exists()) {
    const obj = snap.val();
    window.storiesData = Object.values(obj);
    if (!_storiesRendered) {
      _storiesRendered = true;
    }
  } else {
    window.storiesData = [];
    saveLocal('storiesData', []);
  }
});
// --- AUTO OPEN STORY PREVIEW ---
(function autoOpenStoryPreview(){
  try {
    const params = new URLSearchParams(window.location.search);
    const t = params.get("previewStory");
    if (!t) return;

    const timer = setInterval(() => {
      if (window.storiesData && window.storiesData.length > 0) {
        clearInterval(timer);

        const match = window.storiesData.find(
          s => (s.title || '').trim().toLowerCase() === t.trim().toLowerCase()
        );

        if (match) {
          console.log("üéØ Auto opening preview for", match.title);
          setTimeout(()=>openPreviewFullScreen(match), 300);

          history.replaceState({}, "", window.location.pathname);
        } else {
          console.warn("‚ö† Story not found:", t);
        }
      }
    }, 300);

  } catch (e) {
    console.warn("Auto-open preview failed:", e);
  }
})();


onValue(ref(db, 'serials'), snap => {
  if (snap.exists()) {
    const obj = snap.val();
    window.serialsData = Object.values(obj);
    saveLocal('serialsData', window.serialsData);

    console.log(`üî• Firebase delivered ${window.serialsData.length} serials`);

    // ‚úÖ Update both list and browse views
    if (typeof renderSerialsList === 'function') {
      renderSerialsList(window.serialsData);
    }
    if (typeof renderBrowseSerials === 'function') {
      renderBrowseSerials(window.serialsData, { mergeWithSaved: false });
    }

  } else {
    window.serialsData = [];
    saveLocal('serialsData', []);
    if (typeof renderBrowseSerials === 'function') {
      renderBrowseSerials([], { includeDemo: true, demoCount: 10 });
    }
  }
});

// ---------- OPTIONAL: UPDATE YOUR SAVE CALLS TOO ----------
// Everywhere you have a serial save call like this:
// await set(ref(db, `serials/${encodeURIComponent(ser.title)}`), ser);

// Replace with this:
async function saveSerialToFirebase(ser) {
  try {
    await set(
  ref(window._firebase.db, `serials/${encodeURIComponent(ser.title.trim())}`),
  ser
);

    console.log(`‚úÖ Serial "${ser.title}" saved successfully to Firebase.`);
  } catch (err) {
    console.error('‚ùå Error saving serial to Firebase:', err);
  }
}

</script>



<body>
<!-- üåå COSMIC PURPLE BOTTOM NAVIGATION -->
<div id="bottomNav" style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  border-top: 1px solid rgba(255,255,255,0.15);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 10px 0;
  z-index: 9999;
  box-shadow: 0 -3px 15px rgba(106,17,203,0.4);
  transition: transform 0.35s ease, opacity 0.35s ease;
">
  <!-- üßë‚ÄçüöÄ Register -->
  <button id="registerBtn" class="nav-btn" style="background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;color:white;">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M20 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M4 21v-2a4 4 0 0 1 3-3.87"></path>
      <circle cx="12" cy="7" r="4"></circle>
    </svg>
    <span class="nav-label" style="font-size:12px;margin-top:4px;opacity:0.85;">Register</span>
  </button>

  <!-- üè† Home -->
  <button id="homeBtn" class="nav-btn" style="background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;color:white;">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"></path>
    </svg>
    <span class="nav-label" style="font-size:12px;margin-top:4px;opacity:0.85;">Home</span>
  </button>

  <!-- ‚úèÔ∏è Writer -->
  <button id="writerBtn" class="nav-btn" style="background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;color:white;">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 20h9"></path>
      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
    </svg>
    <span class="nav-label" style="font-size:12px;margin-top:4px;opacity:0.85;">Writer Section</span>
  </button>
</div>
  <!-- üßë‚ÄçüöÄ Register -->


<style>
  .nav-btn:hover svg { filter: drop-shadow(0 0 6px rgba(255,255,255,0.7)); transform: scale(1.1); transition: all 0.25s ease; }
  .nav-btn:hover .nav-label { opacity: 1; }
  #bottomNav.hidden { transform: translateY(100%); opacity: 0; }
</style>

<script>
  const bottomNav = document.getElementById('bottomNav');

  // ‚úÖ Hide bar when these pages are visible
  function updateBottomNavVisibility() {
    const pagesToHide = [
      'dashboardPage',       // dashboard
      'storyFormPage',       // story editor
      'slidesPage',          // serial editor
      'workspacePage',       // writer workspace
      'categoriesPage',      // browse stories
      'serialCategoriesPage',
      'editorPage'
     
    ];

    let shouldHide = false;
    for (const id of pagesToHide) {
      const el = document.getElementById(id);
      if (el && !el.classList.contains('hidden')) {
        shouldHide = true;
        break;
      }
    }

    bottomNav.classList.toggle('hidden', shouldHide);
  }

  // üè† Home button
  document.getElementById('homeBtn').addEventListener('click', () => {
    if (typeof showHomePage === 'function') showHomePage();
    updateBottomNavVisibility();
  });

  // ‚úèÔ∏è Writer button
  document.getElementById('writerBtn').addEventListener('click', () => {
    if (typeof showWriterGateway === 'function') showWriterGateway();
    updateBottomNavVisibility();
  });

  // üëÅÔ∏è React to any class visibility changes
  const observer = new MutationObserver(updateBottomNavVisibility);
  observer.observe(document.body, { attributes: true, subtree: true, attributeFilter: ['class'] });

  document.addEventListener('DOMContentLoaded', updateBottomNavVisibility);
</script>





<script>
function showHomePage(){
  const welcomePage = document.getElementById('welcomePage');
  const dashboardPage = document.getElementById('dashboardPage');
  const profileFormPage = document.getElementById('profileFormPage');
  const slidesPage = document.getElementById('slidesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const serialCategoriesPage = document.getElementById('serialCategoriesPage');
  const writerGatePage = document.getElementById('writerGatePage'); // ‚úÖ add this line

  if(welcomePage) welcomePage.classList.remove('hidden');
  if(dashboardPage) dashboardPage.classList.add('hidden');
  if(profileFormPage) profileFormPage.classList.add('hidden');
  if(slidesPage) slidesPage.classList.add('hidden');
  if(categoriesPage) categoriesPage.classList.add('hidden');
  if(serialCategoriesPage) serialCategoriesPage.classList.add('hidden');
  if(writerGatePage) writerGatePage.classList.add('hidden'); // ‚úÖ hide writer gate
}

document.getElementById('homeBtn').addEventListener('click', ()=>{ showHomePage(); });



document.getElementById('writerBtn').addEventListener('click', () => {
  const profile = localStorage.getItem("writerProfile_v1");
  const writerGate = document.getElementById('writerGatePage');
  const welcome = document.getElementById('welcomePage');
  const dashboard = document.getElementById('dashboardPage');
  const categories = document.getElementById('categoriesPage');
  const serialCategories = document.getElementById('serialCategoriesPage');
  const profileForm = document.getElementById('profileFormPage');

  if(welcome) welcome.classList.add('hidden');
  if(dashboard) dashboard.classList.add('hidden');
  if(categories) categories.classList.add('hidden');
  if(serialCategories) serialCategories.classList.add('hidden');
  if(profileForm) profileForm.classList.add('hidden');

  writerGate.classList.remove('hidden');

  if (!profile) {
    document.getElementById('writerGateTitle').innerText = "No Writer Profile Found";
    document.getElementById('writerGateSubtitle').innerText = "To unlock the Writer Section, please create your writer profile.";
    document.getElementById('writerGateActionBtn').innerText = "Create Profile";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      profileForm.classList.remove('hidden');
    };
  document.getElementById('writerGateWorkspaceBtn').style.display = 'none';
  document.getElementById('writerGateAssistantBtn').style.display = 'none';

} else {
  document.getElementById('writerGateTitle').innerText = "Writer Section Unlocked";
  document.getElementById('writerGateSubtitle').innerText = "Access your tools, manage stories and serials.";
  document.getElementById('writerGateActionBtn').innerText = "Open Writer Dashboard";
  document.getElementById('writerGateActionBtn').onclick = () => {
    writerGate.classList.add('hidden');
    showDashboard('stories');
  };

  // ‚úÖ Show these buttons only when profile exists
  document.getElementById('writerGateWorkspaceBtn').style.display = 'inline-flex';
  document.getElementById('writerGateAssistantBtn').style.display = 'inline-flex';
}
});



document.addEventListener('DOMContentLoaded', showHomePage);
</script>

<div style='margin-top:60px;'></div>
  <header>
    <button class="profile-btn" id="profileBtn"><span class="profile-initials">??</span></button>
    <div class="dropdown" id="profileDropdown"></div>
  </header>

<!-- üé¨ CINEMATIC MEURBAL WELCOME PAGE -->
<main id="welcomePage" role="main" aria-labelledby="welcomeTitle"
  style="display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden;position:relative;background:#000;color:#fff;font-family:'Poppins',system-ui;">

  <style>
    /* ======= Cinematic Welcome Page Styles (Final Custom Version) ======= */
    #welcomePage * { box-sizing:border-box; }

    #welcomePage .wall-wrap {
      position:fixed;inset:0;z-index:0;overflow:hidden;display:block;
    }

    #welcomePage .wall {
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%);
      width:200%;height:140%;
      display:grid;
      grid-template-columns:repeat(8,1fr);
      grid-auto-rows:1fr;
      gap:8px;
      padding:40px;
      animation: wallMove 40s linear infinite;
      filter:saturate(1.05) contrast(0.95);
    }

    #welcomePage .cover {
      position:relative;overflow:hidden;border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.04);
    }

    #welcomePage .cover::after {
      content:"";
      position:absolute;inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(0,0,0,0.15));
      mix-blend-mode:screen;
      pointer-events:none;
    }

    #welcomePage .cover img {
      width:100%;height:100%;object-fit:cover;display:block;
      transform:scale(1.06);
      transition:transform 18s ease;
      filter:brightness(1.25) contrast(0.92) saturate(1.1);
    }
    #welcomePage .cover:hover img { transform:scale(1.12); }

    #welcomePage .wall-overlay {
      position:fixed;inset:0;pointer-events:none;
      background:
        radial-gradient(circle at 50% 30%, rgba(255,255,255,0.18), transparent 70%),
        linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.65));
      z-index:1;
    }

    #welcomePage .center-card {
      position:relative;z-index:3;
      width:min(520px,calc(100% - 48px));
      border-radius:20px;padding:48px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter:blur(14px) saturate(1.05);
      text-align:center;
      box-shadow:0 20px 60px rgba(5,8,18,0.6);
    }

    #welcomePage .brand {
      display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:10px;
    }

    #welcomePage .logo {
      width:44px;height:44px;border-radius:10px;object-fit:cover;
      box-shadow:0 6px 18px rgba(37,117,252,0.18);
    }

    #welcomePage .brand h4 {
      font-size:18px;margin:0;font-weight:600;
      background:linear-gradient(90deg,#2575fc,#6a11cb);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }

    #welcomePage .tagline {
      color:rgba(255,255,255,0.9);margin:6px 0 18px;font-weight:300;
    }

    #welcomePage h1 {
      font-size:26px;line-height:1.05;margin:4px 0 10px;font-weight:700;
      background:linear-gradient(90deg,#2575fc,#6a11cb);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }

    #welcomePage .subtitle {
      color:#e9eefc;opacity:0.9;font-size:14px;margin-bottom:26px;
    }

    #welcomePage .cta-row {
      display:flex;gap:14px;justify-content:center;align-items:center;flex-wrap:wrap;
    }

    #welcomePage .btn {
      min-width:160px;padding:14px 20px;border-radius:12px;border:none;cursor:pointer;
      font-weight:600;font-size:15px;letter-spacing:0.2px;
      transition:transform .22s ease,box-shadow .22s ease;
    }

    #welcomePage .btn.primary {
      color:#fff;background:linear-gradient(135deg,#6a11cb,#2575fc);
      box-shadow:0 10px 30px rgba(37,117,252,0.24);
    }

    #welcomePage .btn.ghost {
      background:transparent;color:#f0f6ff;
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter:blur(6px);
    }

    #welcomePage .btn.primary:hover {
      transform:translateY(-5px);
      box-shadow:0 16px 40px rgba(37,117,252,0.32);
    }

    #welcomePage .btn.ghost:hover { transform:translateY(-4px); }

    #welcomePage .muted {
      margin-top:18px;font-size:12px;color:rgba(255,255,255,0.6);
    }

    @keyframes wallMove {
      0% { transform:translate(-45%,-48%) scale(1); }
      50% { transform:translate(-52%,-52%) scale(1.04); }
      100% { transform:translate(-45%,-48%) scale(1); }
    }

    @media (max-width:880px) {
      #welcomePage .wall { width:260%;height:180%;padding:18px;grid-template-columns:repeat(6,1fr); }
      #welcomePage .center-card { padding:28px; }
      #welcomePage h1 { font-size:20px; }
      #welcomePage .btn { min-width:150px; }
    }

    @media (max-width:480px) {
      #welcomePage .wall { grid-template-columns:repeat(4,1fr);height:200%; }
      #welcomePage .center-card { padding:22px;border-radius:16px; }
      #welcomePage h1 { font-size:18px; }
      #welcomePage .btn { width:100%; }
      #welcomePage .cta-row { flex-direction:column;gap:12px; }
    }
  </style>

  <!-- Background cinematic wall -->
  <div class="wall-wrap" aria-hidden="true">
    <div class="wall">
      <div class="cover"><img src="https://images.unsplash.com/photo-1542204625-6f6b1d68b4f6?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1499084732479-de2c02d45fc4?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1549880180-2f2b8b9373b3?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1518791841217-8f162f1e1131?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      <div class="cover"><img src="https://images.unsplash.com/photo-1506619216599-9d16b7d1b4a2?q=80&w=1200&auto=format&fit=crop" alt=""></div>
    </div>
    <div class="wall-overlay"></div>
  </div>

  <!-- Frosted glass center card -->
  <section class="center-card">
    <div class="brand">
      <img src="melogo.png" alt="Meurbal Logo" class="logo">
      <div>
        <h4>Meurbal</h4>
        <div class="tagline">Where Dream. Write. Live.</div>
      </div>
    </div>

    <h1 id="welcomeTitle">Enter worlds of wonder & thrill</h1>
    <div class="subtitle">Fantasy, action, romance, adventure & crime etc ‚Äî all in one home.</div>

    <div class="cta-row">
      <button class="btn primary" id="browseStoriesBtn">üìñ Browse Stories</button>
      <button class="btn ghost" id="browseSerialsBtn">üé¨ Browse Series</button>
      <button class="btn primary" id="createContentBtn">‚úçÔ∏è Create Story / Series</button>
    </div>

  </section>
</main>

<script>
  // Hook buttons to navigation
  document.getElementById('browseStoriesBtn').addEventListener('click', () => {
    if (typeof openCategoriesPage === 'function') openCategoriesPage();
    updateHeaderVisibility?.();
  });
  document.getElementById('browseSerialsBtn').addEventListener('click', () => {
    if (typeof openSerialCategoriesPage === 'function') openSerialCategoriesPage();
    updateHeaderVisibility?.();
  });
  document.getElementById('createContentBtn').addEventListener('click', () => {
    if (typeof openWriterGateway === 'function') openWriterGateway();
    updateHeaderVisibility?.();
  });
</script>




  <!-- Categories Page (opened from Browse Stories) -->
  
<div id="writerGatePage" class="hidden" style="padding:24px;text-align:center; display:flex; flex-direction:column; align-items:center;">
  <h2 id="writerGateTitle" style="margin-bottom:12px;"></h2>
  <p id="writerGateSubtitle" style="margin-bottom:20px;color:#555;"></p>

  <button id="writerGateActionBtn" style="padding:14px 24px; border-radius:14px; border:none; background:linear-gradient(135deg, #4facfe, #ffffff); color:white; font-weight:700; font-size:17px; cursor:pointer; box-shadow:0 4px 14px rgba(0,0,0,0.45); transition:transform .15s, box-shadow .15s;">Continue</button>

  <button id="writerGateWorkspaceBtn" style="margin-top:14px; padding:14px 24px; border-radius:14px; border:none; background:linear-gradient(135deg, #4facfe, #00f2fe); color:white; font-weight:700; font-size:17px; cursor:pointer; box-shadow:0 4px 14px rgba(0,0,0,0.45);">Your Writing Workspace</button>

  <!-- NEW: Your Writing Assistant button -->
  <button id="writerGateAssistantBtn" style="margin-top:14px; padding:12px 22px; border-radius:12px; border:none; background:linear-gradient(135deg,#5b9bff,#00d4ff); color:white; font-weight:700; font-size:16px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:flex; align-items:center; gap:10px;">
    <img src="meurballogo.jpg" alt="AI" style="width:24px;height:24px;border-radius:6px;object-fit:cover;border:0;"/>
    Your Writing Assistant
  </button>
</div>

<script>
/* --- Attach a small AI logo + popup safely (enhanced centered glass version) --- */
(function attachAiBadge() {
  const existingPopup = document.getElementById('editor_ai_popup');
  if (existingPopup) return;

  const img = document.createElement('img');
  img.src = 'meurballogo.jpg';
  img.alt = 'AI Logo';
  img.style.cssText = `
    width:38px;height:38px;border-radius:10px;cursor:pointer;display:none;
    object-fit:cover;border:0;margin-right:6px;
  `;

  // ‚≠ê FIXED ‚Äî works in Story + Serial editor
const editorDiv = document.getElementById("editorPage") || document.body;

const headerRow = editorDiv.querySelector('div[style*="justify-content:space-between"]');

if (headerRow) {
    headerRow.appendChild(img);
} else {
    document.body.appendChild(img); // fallback
}

  // create centered glass popup
  const aiPopup = document.createElement('div');
  aiPopup.id = 'editor_ai_popup';
  aiPopup.style.cssText = `
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    z-index: 1200; background: rgba(0,0,0,0.45); backdrop-filter: blur(6px);
    transition: opacity 0.25s ease; font-family: 'Poppins','Inter',system-ui,sans-serif;
  `;

  const inner = document.createElement('div');
  inner.style.cssText = `
    background: rgba(255,255,255,0.25); backdrop-filter: blur(14px) saturate(180%);
    border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    padding: 32px 36px; min-width: 360px; text-align: center;
    border: 1px solid rgba(255,255,255,0.25); animation: popupFade 0.3s ease-out;
  `;
  inner.innerHTML = `
    <h2 style="
      margin:0 0 22px;
      font-size:1.4rem;
      color:#fff;
      font-weight:700;
      text-shadow:0 2px 8px rgba(0,0,0,0.4);
    ">ü§ñ Choose your AI Mode</h2>

    <div style="display:flex;align-items:center;justify-content:center;gap:14px;">
      <button id="aiAssistantBtn_local" style="
        background:linear-gradient(135deg,#4facfe,#00f2fe);
        color:white;font-weight:700;font-size:16px;
        border:none;border-radius:12px;padding:12px 26px;
        cursor:pointer;letter-spacing:0.3px;
        transition:all 0.25s ease;
        box-shadow:0 6px 16px rgba(0,242,254,0.4);
      ">üí° AI Assistant</button>

      <button id="aiCloseBtn_local" style="
        background:linear-gradient(135deg,#ff5f6d,#ffc371);
        color:white;font-weight:700;font-size:16px;
        border:none;border-radius:12px;padding:12px 26px;
        cursor:pointer;letter-spacing:0.3px;
        transition:all 0.25s ease;
        box-shadow:0 6px 16px rgba(255,95,109,0.4);
      ">‚úñ Close</button>
    </div>
  `;

  aiPopup.appendChild(inner);
  document.body.appendChild(aiPopup);

  const aiAssistantBtn = aiPopup.querySelector('#aiAssistantBtn_local');
  const aiCloseBtn = aiPopup.querySelector('#aiCloseBtn_local');

  aiAssistantBtn.addEventListener('mouseover', () => aiAssistantBtn.style.transform = 'scale(1.07)');
  aiAssistantBtn.addEventListener('mouseout', () => aiAssistantBtn.style.transform = 'scale(1.0)');

  aiAssistantBtn.addEventListener('mouseover', () => {
    aiAssistantBtn.style.boxShadow = '0 0 20px rgba(0,242,254,0.7)';
  });
  aiAssistantBtn.addEventListener('mouseout', () => {
    aiAssistantBtn.style.boxShadow = '0 6px 16px rgba(0,242,254,0.4)';
  });

  function toggleAIPopup(show) {
    aiPopup.style.display = show ? 'flex' : 'none';
    aiPopup.style.opacity = show ? '1' : '0';
  }

  // expose a global opener so other code (e.g. the writer gate button) can open it
  window.openEditorAIPopup = function() { toggleAIPopup(true); };
  window.closeEditorAIPopup = function() { toggleAIPopup(false); };

  img.addEventListener('click', e => {
    e.stopPropagation();
    toggleAIPopup(aiPopup.style.display !== 'flex');
  });

  // close when clicking outside inner content
  aiPopup.addEventListener('click', e => { if (e.target === aiPopup) toggleAIPopup(false); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') toggleAIPopup(false); });

  aiAssistantBtn.addEventListener('click', () => {
    toggleAIPopup(false);
    // optional hooks - these functions may or may not exist in your app
    if (typeof saveActiveSheet === 'function') try { saveActiveSheet(); } catch(e){}
    if (typeof openVoiceAssistant === 'function') try { openVoiceAssistant(); } catch(e){}
    // If you want to route to a built-in editor assistant handler, call it here.
  });

  aiCloseBtn.addEventListener('click', () => toggleAIPopup(false));  // ‚úÖ CLOSE 

  // small reusable style animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes popupFade {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  `;
  document.head.appendChild(style);

})();
</script>

<script>
/* Hook the "Your Writing Assistant" button to open the editor AI popup */
(function hookWriterGateAssistant() {
  const assistantBtn = document.getElementById('writerGateAssistantBtn');
  if (!assistantBtn) return;

  assistantBtn.addEventListener('click', (e) => {
    e.preventDefault();
    // Use the global opener created above by the AI popup script
    if (typeof window.openEditorAIPopup === 'function') {
      window.openEditorAIPopup();
    } else {
      // Fallback: try to show the popup by id if it exists (handles order-of-load issues)
      const popup = document.getElementById('editor_ai_popup');
      if (popup) popup.style.display = 'flex';
    }
  });
})();
</script>

<div id="categoriesPage" class="hidden">
    <button class="back-btn" id="categoriesBackBtn">‚Üê Back</button>
    <div class="categories-header">
      <h2>Browse Stories</h2>
    </div>
    <div style="max-width:980px;margin:8px auto 0;display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div style="flex:1">
        <input id="storiesSearchInput" placeholder="Search your stories..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px" />
      </div>
      <div style="min-width:140px;text-align:right">
        <button id="storiesClearSearchBtn" class="btn btn-secondary" style="padding:8px 10px">Clear</button>
      </div>
    </div>

    <div class="categories-grid" id="categoriesGrid" aria-label="story categories">
      <!-- Stories list shown after selecting a category -->
      </div>
      <div id="storiesBrowseList" style="max-width:980px;margin:18px auto;display:none">
        <h3 style="text-align:left;margin:6px 12px">Stories</h3>
        <div id="storiesCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;padding:12px"></div>
      </div>
      <!-- Fullscreen Preview & Reader Containers -->
  


      <div id="readerModal" class="hidden popup">
        <div class="popup-content" style="width:90%;max-width:900px;padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 id="readerTitle">Story</h3>
              <div class="muted" id="readerMeta"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="readerDownloadBtn" class="btn btn-secondary">Download Story</button>
              <button id="readerLikeBtn" class="btn btn-secondary">üëç Like <span id="readerLikeCount">0</span></button>
              <button id="readerDislikeBtn" class="btn btn-secondary">üëé Dislike <span id="readerDislikeCount">0</span></button>
              <button id="readerCloseBtn" class="btn btn-secondary">Close</button>
            </div>
          </div>
          <div id="readerContent" style="min-height:260px;padding:12px;margin-top:12px;border-radius:8px;background:#fff;overflow:hidden;position:relative">
            <div id="readerSheet" style="min-height:200px"></div>
          </div>
          <div style="display:flex;justify-content:center;gap:12px;margin-top:12px">
            <button id="readerPrevBtn" class="btn btn-secondary">‚óÄ Prev</button>
            <span id="readerPager" class="muted"></span>
            <button id="readerNextBtn" class="btn btn-primary">Next ‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- cards injected by JS -->
    </div>
  </div>

  
  <!-- Serials Categories Page -->
  <div id="serialCategoriesPage" class="hidden">
    <button class="back-btn" id="serialCategoriesBackBtn">‚Üê Back</button>
    <div class="categories-header">
      <h2>Browse Series</h2>
      <div style="max-width:980px;margin:8px auto 0;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="flex:1">
          <input id="serialsSearchInput" placeholder="Search your series..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px" />
        </div>
        <div style="min-width:140px;text-align:right">
          <button id="serialsClearSearchBtn" class="btn btn-secondary" style="padding:8px 10px">Clear</button>
        </div>
      </div>
      <div id="serialSearchResults" style="max-width:980px;margin:12px auto;display:none">
        <div id="serialsCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;padding:12px"></div>
      </div>

      <p class="muted" style="margin:6px 0 12px">Explore Interesting Series Here Only</p>
    </div>
    <div class="categories-grid" id="serialCategoriesGrid" aria-label="serial categories">
      <!-- serial cards injected by JS -->
    </div>
  </div>

  <!-- Profile Form -->
  <div id="profileFormPage" class="form-container hidden">
    <h2>Create Writer Profile</h2>
    <label>Name</label><input type="text" id="profileName">
    <label>Age</label><input type="number" id="profileAge">
    <label>Country</label><input type="text" id="profileCountry">
    <label>Favourite Genres</label>
    <div class="genres-container" id="genresContainer">
      <label class="genre-option"><input type="checkbox" value="Horror">Horror</label>
      <label class="genre-option"><input type="checkbox" value="Comedy">Comedy</label>
      <label class="genre-option"><input type="checkbox" value="Action">Action</label>
      <label class="genre-option"><input type="checkbox" value="Tragic">Tragic</label>
      <label class="genre-option"><input type="checkbox" value="Romance">Romance</label>
      <label class="genre-option"><input type="checkbox" value="Fantasy">Fantasy</label>
      <label class="genre-option"><input type="checkbox" value="Thriller">Thriller</label>
         <label class="genre-option"><input type="checkbox" value="Adventure">Adventure</label>
      <label class="genre-option"><input type="checkbox" value="Crime">Crime</label>
      <label class="genre-option"><input type="checkbox" value="Historic">Historic</label>
    </div>
    <button class="btn btn-primary" id="saveProfileBtn">Create Profile</button>
  </div>


 <!-- Choose Type Popup -->
<div id="chooseTypePopup" class="hidden popup">
  <div class="popup-content" style="position: relative; padding: 20px;">
    <!-- Close button -->
    <span id="closeChooseTypePopup" 
          style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer;">
      &times;
    </span>

    <h2>What do you want to create?</h2>
    <div style="display:flex; gap:12px; justify-content:center; margin-top:12px;">
      <button id="createStoryBtn" class="btn btn-primary">Story</button>
      <button id="createSerialBtn" class="btn btn-secondary">Series</button>
    </div>
  </div>
</div>

<script>
  // Get elements
  const popup = document.getElementById('chooseTypePopup');
  const closeBtn = document.getElementById('closeChooseTypePopup');

  // Close popup on button click
  closeBtn.addEventListener('click', () => {
    popup.classList.add('hidden'); // hide the popup
  });

  // Optional: Open popup for testing
  // popup.classList.remove('hidden');
</script>


  <!-- Slot Name / Unlock Popup -->
  <div id="slotNamePopup" class="hidden popup">
    <div class="popup-content">
      <h3>Name this slot</h3>
      <input id="slotNameInput" placeholder='Slot name (e.g. "My Fantasy Series")'>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="slotNameCancelBtn" class="btn btn-secondary">Cancel</button>
        <button id="slotNameUnlockBtn" class="btn btn-primary">Unlock Slot</button>
      </div>
    </div>
  </div>

<!-- Serial Create Popup (updated: genre mandatory) -->
<div id="serialCreatePopup" class="hidden popup">
  <div class="popup-content" style="max-width:480px;padding:16px;">
    <h3 style="margin-bottom:8px;">Create Series</h3>

    <!-- Series Section -->
    <div style="margin-bottom:8px;">
      <label style="font-weight:600;">Series Title</label>
      <input id="seriesTitleInput" placeholder="e.g. The Lost Scrolls" style="margin-bottom:6px;">

      <label>Genre</label>
      <select id="seriesGenreInput" style="margin-bottom:6px;" required>
        <option value="">Select genre</option>
        <option>Comedy</option>
        <option>Fantasy</option>
        <option>Horror</option>
        <option>Romance</option>
        <option>Action</option>
        <option>Tragic</option>
        <option>Thriller</option>
        <option>Adventure</option>
        <option>Crime</option>
        <option>Historic</option>
      </select>
      <small id="seriesGenreWarn" style="color:red;display:none;">‚ö†Ô∏è Please select a genre.</small>

      <label>Description (optional, 3‚Äì8 words if filled)</label>
      <textarea id="seriesDescInput" rows="2" placeholder="Short series description" style="margin-bottom:6px;"></textarea>
      <small id="seriesDescWarn" style="color:red;display:none;">‚ö†Ô∏è Description must be 3‚Äì8 words if filled.</small>
    </div>

    <!-- Episode Section -->
    <div style="margin-bottom:8px;">
      <label style="font-weight:600;">Episode 1</label>
      <input id="ep1TitleInput" placeholder="Episode 1 title" style="margin-bottom:6px;">
      <small id="epTitleWarn" style="color:red;display:none;">‚ö†Ô∏è Episode title is required.</small>

      <textarea id="ep1DescInput" rows="2" placeholder="Short episode description" style="margin-bottom:6px;"></textarea>

      <!-- Cover -->
      <label>Series Cover</label>
      <input type="file" id="serialCoverInput" accept="image/*">

      <div style="font-size:12px;margin-top:4px;color:#444;">
        JPG ONLY.
      </div>

      <!-- Writer + Publish Date -->
      <label>Writer Name</label>
      <input type="text" id="serialWriterNameInput" placeholder="e.g. John Doe">

      <label>Publish Date</label>
      <input type="date" id="serialPublishDateInput">

      <div id="serialCoverPreview" style="margin-top:6px;text-align:center;">
        <img id="serialCoverImg" src="" alt="Cover Preview"
          style="max-width:1px;height:1px;object-fit:cover;border-radius:1px;display:none;">
      </div>
    </div>

    <!-- Buttons -->
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="serialCreateCancelBtn" class="btn btn-secondary" style="padding:6px 12px;">Cancel</button>
      <button id="serialCreateConfirmBtn" class="btn btn-primary" style="padding:6px 12px;" disabled>Create </button>
    </div>
  </div>
</div>

<!-- PNG ERROR POPUP (unchanged) -->
<div id="pngPopup" class="hidden popup">
  <div class="popup-content" style="max-width:420px; text-align:center;">
    <h3>‚ùå PNG Not Allowed</h3>
    <p>Sorry, you cannot upload a PNG file.<br>Please upload a JPG image.</p>

    <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
      <button id="closePngPopup" class="btn btn-secondary">Close</button>
      <button id="openConverterBtn" class="btn btn-primary">Open Converter Page</button>
      <button id="backPngBtn" class="btn btn-ghost">Back</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const descInput = document.getElementById('seriesDescInput');
  const titleInput = document.getElementById('ep1TitleInput');
  const genreSelect = document.getElementById('seriesGenreInput');
  const createBtn = document.getElementById('serialCreateConfirmBtn');
  const descWarn = document.getElementById('seriesDescWarn');
  const titleWarn = document.getElementById('epTitleWarn');
  const genreWarn = document.getElementById('seriesGenreWarn');

  const sDate = document.getElementById('serialPublishDateInput');
  if (sDate && !sDate.value) sDate.value = new Date().toISOString().split('T')[0];

  function validateForm() {
    const descWords = (descInput && descInput.value.trim().length > 0)
      ? descInput.value.trim().split(/\s+/).filter(w => w.length > 0)
      : [];
    const validDesc = descWords.length === 0 || (descWords.length >= 3 && descWords.length <= 8);
    const validTitle = titleInput && titleInput.value.trim().length > 0;
    const validGenre = genreSelect && genreSelect.value.trim() !== "";

    // warnings
    if (descWarn) descWarn.style.display = validDesc ? 'none' : 'block';
    if (titleWarn) titleWarn.style.display = validTitle ? 'none' : 'block';
    if (genreWarn) genreWarn.style.display = validGenre ? 'none' : 'block';

    createBtn.disabled = !(validTitle && validDesc && validGenre);
  }

  // listen for changes
  [descInput, titleInput, genreSelect].forEach(el => {
    if (!el) return;
    const ev = (el.tagName === 'SELECT' || el.type === 'file') ? 'change' : 'input';
    el.addEventListener(ev, validateForm);
  });

  // run once on load
  validateForm();

  // (optional) cancel/close handlers and PNG popup wiring can remain as you had them
});
</script>

<!-- PNG BLOCKING SCRIPT -->
<script>
const serialInput = document.getElementById("serialCoverInput");
const pngPopup = document.getElementById("pngPopup");
const closePngPopup = document.getElementById("closePngPopup");
const openConverterBtn = document.getElementById("openConverterBtn");
const backPngBtn = document.getElementById("backPngBtn"); // NEW

// Detect PNG upload
if (serialInput) {
  serialInput.addEventListener("change", () => {
    const file = serialInput.files[0];
    if (!file) return;

    if (file.type === "image/png") {
      pngPopup.classList.remove("hidden");
      serialInput.value = ""; // reset input
    }
  });
}

// Close popup
if (closePngPopup) {
  closePngPopup.addEventListener("click", () => {
    pngPopup.classList.add("hidden");
  });
}

// Open converter page
if (openConverterBtn) {
  openConverterBtn.addEventListener("click", () => {
    window.open("converter.html", "_blank");
  });
}

// Back ‚Üí call showSlotsPage()
if (backPngBtn) {
  backPngBtn.addEventListener("click", () => {
    try {
      showSlotsPage();    // ‚Üê your function
    } catch (e) {
      console.error("showSlotsPage() is not defined:", e);
    }
    pngPopup.classList.add("hidden"); // also hide popup
  });
}

// Open converter page
openConverterBtn.addEventListener("click", () => {
  window.open("converter.html", "_blank");
});
</script>






  <!-- Add Episode Popup -->
  <div id="addEpisodePopup" class="hidden popup">
    <div class="popup-content">
      <h3>Add Episode</h3>
      <label>Episode Title</label>
      <input id="addEpTitleInput" placeholder="Episode title">
      <label>Episode Description (optional)</label>
      <textarea id="addEpDescInput" rows="2" placeholder="Episode description"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="addEpCancelBtn" class="btn btn-secondary">Cancel</button>
        <button id="addEpConfirmBtn" class="btn btn-primary">Add Episode</button>
      </div>
    </div>
  </div>

  <!-- Slots Page -->
  <div id="slidesPage" class="hidden">
    <button class="back-btn" id="slotsBackBtn">‚Üê Back</button>
    <h2 style="text-align:center;margin-top:30px">Select a Slot</h2>
    <div id="slotsContainer"></div>
  </div>

   <!-- Story Form -->
<div id="storyFormPage" class="form-container hidden">
  <h2>Create Story / Series</h2>

  <label>Title</label>
  <input type="text" id="storyTitle" placeholder="Enter your story title">

  <label>Genre</label>
  <select id="storyGenre">
    <option value="">Select genre</option>
    <option>Horror</option>
    <option>Comedy</option>
    <option>Action</option>
    <option>Romance</option>
    <option>Tragic</option>
    <option>Fantasy</option>
    <option>Thriller</option>
    <option>Adventure</option>
    <option>Crime</option>
    <option>Historic</option>
  </select>

  <label>Description (must be 3‚Äì8 words)</label>
  <textarea id="storyDesc" rows="3" placeholder="Short story description (3‚Äì8 words)"></textarea>
  <small id="storyDescWarn" style="color:red;display:none;">‚ö†Ô∏è Description must be between 3 and 8 words.</small>

  <label>Cover Image</label>
  <input type="file" id="storyCoverInput" accept="image/*">



  <!-- Added Writer Name & Publish Date inputs -->
  <label>Writer Name</label>
  <input type="text" id="writerNameInput" placeholder="e.g. John Doe">

  <label>Publish Date</label>
  <input type="date" id="publishDateInput">
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dateInput = document.getElementById('publishDateInput');
      if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
      }
    });
  </script>
  <!-- End added inputs -->

  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn btn-secondary" id="cancelCreateBtn">Cancel</button>
    <button class="btn btn-primary" id="startCreatingBtn" disabled>Start Creating</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const titleInput = document.getElementById('storyTitle');
  const descInput = document.getElementById('storyDesc');
  const createBtn = document.getElementById('startCreatingBtn');
  const descWarn = document.getElementById('storyDescWarn');

  // ensure it's a button (not a submit in a form)
  createBtn.type = 'button';

  function validateStoryForm() {
    const title = titleInput.value.trim();
    const desc = descInput.value.trim();

    const descWords = desc.split(/\s+/).filter(w => w.length > 0);
    const hasDesc = desc.length > 0;
    const validDesc = !hasDesc || (descWords.length >= 3 && descWords.length <= 8);
    const validTitle = title.length > 0;

    // Show warning only if description is filled but invalid
    descWarn.style.display = hasDesc && !validDesc ? 'block' : 'none';

    // Enable button only if title is filled AND (desc empty or valid)
    createBtn.disabled = !(validTitle && validDesc);
  }

  // Run validation on input changes
  titleInput.addEventListener('input', validateStoryForm);
  descInput.addEventListener('input', validateStoryForm);

  // Run once on load so button state is correct
  validateStoryForm();

  // Click handler: only proceeds if enabled; dispatches a custom event you can listen for
  createBtn.addEventListener('click', () => {
    if (createBtn.disabled) return; // safety, shouldn't happen because browser blocks clicks on disabled buttons
    const payload = {
      title: titleInput.value.trim(),
      description: descInput.value.trim(),
      genre: document.getElementById('storyGenre').value,
      writer: document.getElementById('writerNameInput')?.value || '',
      publishDate: document.getElementById('publishDateInput')?.value || ''
    };
    // Dispatch an app-level event ‚Äî listen for 'startCreating' elsewhere to open editor / save draft
    window.dispatchEvent(new CustomEvent('startCreating', { detail: payload }));
  });
});
</script>

  <!-- Dashboard -->
<div id="dashboardPage" class="hidden">
  <div class="dashboard-header">
    <h2>Your Content</h2>
    <div class="row">
      <button class="btn btn-primary" id="showStoriesBtn">Your Stories</button>
      <button class="btn btn-secondary" id="showSerialsBtn">Your Series</button>
    </div>
  </div>

  <div id="dashboardList"></div>
  <button class="back-btn hidden" id="dashboardBackBtn">‚Üê Back</button>
</div>


  <script>
    // ---------- Variables ----------
    const STORAGE_KEY = "writerProfile_v1";

    // palette for random card colors (bright)
    const CARD_COLOR_PALETTE = ['#FF6B6B','#FF8A65','#FFB86B','#FFD166','#6EE7B7','#4FD1FF','#60A5FA','#A78BFA','#FF7AB6','#2DD4BF'];
    function pickCardColor(){ return CARD_COLOR_PALETTE[Math.floor(Math.random()*CARD_COLOR_PALETTE.length)]; }

    let profileExists = false, storiesData = [], serialsData = [];
    let storySlots = [], serialSlots = [];
    let currentType = 'story', selectedSlot = null;
// Load saved slots before anything else
loadSlotsFromStorage();
    // Elements
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const profileFormPage = document.getElementById('profileFormPage');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const profileName = document.getElementById('profileName');
    const profileAge = document.getElementById('profileAge');
    const profileCountry = document.getElementById('profileCountry');
    const welcomePage = document.getElementById('welcomePage');
    const createContentBtn = document.getElementById('createContentBtn');
    const storyFormPage = document.getElementById('storyFormPage');
    const storyTitleInput = document.getElementById('storyTitle');
    const storyGenreSelect = document.getElementById('storyGenre');
    const storyDescInput = document.getElementById('storyDesc');
    const startCreatingBtn = document.getElementById('startCreatingBtn');
    const dashboardPage = document.getElementById('dashboardPage');
    const dashboardList = document.getElementById('dashboardList');
    const slidesPage = document.getElementById('slidesPage');
    const slotsContainer = document.getElementById('slotsContainer');
    const chooseTypePopup = document.getElementById('chooseTypePopup');
    const createStoryBtn = document.getElementById('createStoryBtn');
    const createSerialBtn = document.getElementById('createSerialBtn');
    const showStoriesBtn = document.getElementById('showStoriesBtn');
    const showSerialsBtn = document.getElementById('showSerialsBtn');
    const slotsBackBtn = document.getElementById('slotsBackBtn');
    const dashboardBackBtn = document.getElementById('dashboardBackBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');

    // new popups
    const slotNamePopup = document.getElementById('slotNamePopup');
    const slotNameInput = document.getElementById('slotNameInput');
    const slotNameUnlockBtn = document.getElementById('slotNameUnlockBtn');
    const slotNameCancelBtn = document.getElementById('slotNameCancelBtn');

    const serialCreatePopup = document.getElementById('serialCreatePopup');
    const seriesTitleInput = document.getElementById('seriesTitleInput');
    const seriesGenreInput = document.getElementById('seriesGenreInput');
    const seriesDescInput = document.getElementById('seriesDescInput');
    const ep1TitleInput = document.getElementById('ep1TitleInput');
    const ep1DescInput = document.getElementById('ep1DescInput');
    const serialCreateConfirmBtn = document.getElementById('serialCreateConfirmBtn');
    const serialCreateCancelBtn = document.getElementById('serialCreateCancelBtn');

    const addEpisodePopup = document.getElementById('addEpisodePopup');
    const addEpTitleInput = document.getElementById('addEpTitleInput');
    const addEpDescInput = document.getElementById('addEpDescInput');
    const addEpConfirmBtn = document.getElementById('addEpConfirmBtn');
    const addEpCancelBtn = document.getElementById('addEpCancelBtn');
    let addEpisodeSerialIndex = null; // which serial we're adding to

    
// ---- Cover Image Handling ----
const coverInput = document.getElementById('storyCoverInput');
const coverImg = document.getElementById('storyCoverImg');
if (coverInput) {
  coverInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        coverImg.src = ev.target.result;
        coverImg.style.display = 'block';
        window._currentStoryCover = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
}

// ---- Serial cover handling ----
const serialCoverInput = document.getElementById('serialCoverInput');
const serialCoverImg = document.getElementById('serialCoverImg');
if (serialCoverInput) {
  serialCoverInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        if (serialCoverImg) {
          serialCoverImg.src = ev.target.result;
          serialCoverImg.style.display = 'block';
        }
        window._currentSerialCover = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
} else {
  // create placeholders if elements aren't present yet
  window._serialCoverPending = true;
}

// Ensure current cover vars exist
window._currentStoryCover = window._currentStoryCover || '';
window._currentSerialCover = window._currentSerialCover || '';

// ---------- Profile ----------
    function loadProfile(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const profile = JSON.parse(raw);
          profileExists = true;
          updateProfileUI(profile);
        }
      }catch(e){console.warn(e)}
    }
    
    // show profile button only on home (welcomePage) ‚Äî hide everywhere else
function updateHeaderVisibility() {
  const welcomePage = document.getElementById('welcomePage');
  const categoriesPage = document.getElementById('categoriesPage');
  const serialCategoriesPage = document.getElementById('serialCategoriesPage');
  const profileDropdown = document.getElementById('profileDropdown');
  const profileBtn = document.getElementById('profileBtn'); // your reference

  if (!welcomePage || !categoriesPage || !serialCategoriesPage || !profileBtn) return;

  const onHome = !welcomePage.classList.contains('hidden');
  const onBrowseStories = !categoriesPage.classList.contains('hidden');
  const onBrowseSerials = !serialCategoriesPage.classList.contains('hidden');

  if (onHome) {
    profileBtn.classList.remove('hidden');
    profileDropdown?.classList.remove('hidden');
  } else if (onBrowseStories || onBrowseSerials) {
    profileBtn.classList.add('hidden');
    profileDropdown?.classList.add('hidden');
  } else {
    profileBtn.classList.remove('hidden');
    profileDropdown?.classList.remove('hidden');
  }

  console.log('Header updated:', { onHome, onBrowseStories, onBrowseSerials });
}

function updateProfileUI(profile){
      const initials = (profile.name||'??').slice(0,2).toUpperCase();
      profileBtn.innerHTML = `<span class="profile-initials">${initials}</span>`;
    }
   profileBtn.addEventListener('click', () => {
  // prevent dropdown opening on browse pages
  const onBrowseStories = !document.getElementById('categoriesPage').classList.contains('hidden');
  const onBrowseSerials = !document.getElementById('serialCategoriesPage').classList.contains('hidden');
  if (onBrowseStories || onBrowseSerials) return;

  profileDropdown.style.display = (profileDropdown.style.display === 'flex' ? 'none' : 'flex');
  renderDropdown();
});

    function renderDropdown(){
      profileDropdown.innerHTML = '';
      if(!profileExists){
        const btn = document.createElement('button');
        btn.textContent = '‚úçÔ∏è Create Profile';
        btn.addEventListener('click', ()=>{ profileFormPage.classList.remove('hidden'); welcomePage.classList.add('hidden'); profileDropdown.style.display='none'; });
        profileDropdown.appendChild(btn);
      } else {
        const btn = document.createElement('button');
        btn.textContent = 'üß≠ Writer Dashboard';
        btn.addEventListener('click', ()=>{ showDashboard('stories'); });
        profileDropdown.appendChild(btn);
      }
    }
  saveProfileBtn.addEventListener('click', () => {
  const name = profileName.value.trim();

  // üî¥ Mandatory validation
  if (name === "") {
    alert("Name is required!");
    profileName.focus();
    return; // ‚õî STOP ‚Äî DO NOT SAVE
  }

  const genres = Array.from(document.querySelectorAll('#genresContainer input:checked'))
                      .map(c => c.value);

  const profile = {
    name: name,
    age: profileAge.value,
    country: profileCountry.value,
    genres
  };

  // ‚úÖ Only runs if name is NOT empty
  localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));

  profileExists = true;
  updateProfileUI(profile);

  profileFormPage.classList.add('hidden');
  welcomePage.classList.remove('hidden');
  updateHeaderVisibility();
});


    // ---------- Browse ----------
document.getElementById('browseStoriesBtn').addEventListener('click', () => {
  openCategoriesPage();
  updateHeaderVisibility(); // ‚úÖ update header after page change
});

document.getElementById('browseSerialsBtn').addEventListener('click', () => {
  openSerialCategoriesPage();
  updateHeaderVisibility(); // ‚úÖ update header after page change
});

    
    
  // ---------- Categories Page ----------
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const _browseStoriesBtn = document.getElementById('browseStoriesBtn');
  const _browseSerialsBtn = document.getElementById('browseSerialsBtn');
  const _categoriesBackBtn = document.getElementById('categoriesBackBtn');
  const _serialCategoriesBackBtn = document.getElementById('serialCategoriesBackBtn');

  const _welcomePage = document.getElementById('welcomePage');
  const _categoriesPage = document.getElementById('categoriesPage');
  const _categoriesGrid = document.getElementById('categoriesGrid');
  const _serialCategoriesPage = document.getElementById('serialCategoriesPage');
  const _serialCategoriesGrid = document.getElementById('serialCategoriesGrid');

  // Safe header updater
  function safeUpdateHeader() {
    if (typeof updateHeaderVisibility === 'function') {
      updateHeaderVisibility();
    }
  }

  // Render categories
  function renderCategories(targetGrid){
    if(!targetGrid) return;
    targetGrid.innerHTML = '';
    CATEGORIES.forEach(cat=>{
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.innerHTML = '<div class="cat-title">'+cat+'</div><div class="cat-sub">'+(cat==='All' ? 'All genres' : (cat + ' stories'))+'</div>';
      card.addEventListener('click', ()=>{
        targetGrid.querySelectorAll('.cat-card').forEach(c=>c.classList.remove('active'));
        card.classList.add('active');
      });
      targetGrid.appendChild(card);
    });
  }

  // Event listeners
  _browseStoriesBtn?.addEventListener('click', () => {
    _welcomePage?.classList.add('hidden');
    _categoriesPage?.classList.remove('hidden');
    if (_categoriesGrid) {
      renderCategories(_categoriesGrid);
      _categoriesGrid.scrollLeft = 0;
    }
   updateHeaderVisibility();
  });

  _browseSerialsBtn?.addEventListener('click', () => {
    _welcomePage?.classList.add('hidden');
    _serialCategoriesPage?.classList.remove('hidden');
    if (_serialCategoriesGrid) {
      renderCategories(_serialCategoriesGrid);
      _serialCategoriesGrid.scrollLeft = 0;
    }
   updateHeaderVisibility();
  });

  _categoriesBackBtn?.addEventListener('click', () => {
    _categoriesPage?.classList.add('hidden');
    _welcomePage?.classList.remove('hidden');
    updateHeaderVisibility();
  });

  _serialCategoriesBackBtn?.addEventListener('click', () => {
    _serialCategoriesPage?.classList.add('hidden');
    _welcomePage?.classList.remove('hidden');
    updateHeaderVisibility();
  });
});



    // ---------- End Categories Page ----------
// ---------- LocalStorage Helpers ----------
function saveSlotsToStorage() {
  try {
    const data = { storySlots, serialSlots };
    localStorage.setItem('userSlots', JSON.stringify(data));
    console.log('‚úÖ Slots saved to localStorage');
  } catch (e) {
    console.warn('‚ö†Ô∏è Failed to save slots:', e);
  }
}

function loadSlotsFromStorage() {
  try {
    const saved = JSON.parse(localStorage.getItem('userSlots') || '{}');
    if (saved.storySlots && Array.isArray(saved.storySlots)) storySlots = saved.storySlots;
    if (saved.serialSlots && Array.isArray(saved.serialSlots)) serialSlots = saved.serialSlots;
    console.log('‚úÖ Slots loaded from localStorage');
  } catch (e) {
    console.warn('‚ö†Ô∏è Failed to load slots:', e);
  }
}

// ‚úÖ Load immediately on startup before anything else
loadSlotsFromStorage();

// ---------- Create ----------
createContentBtn.addEventListener('click', ()=>{ 
  if(!profileExists){ alert('Create a writer profile first!'); return; } 
  chooseTypePopup.classList.remove('hidden'); 
});
createStoryBtn.addEventListener('click', ()=>{ 
  currentType='story'; 
  chooseTypePopup.classList.add('hidden'); 
  showSlotsPage(); 
});
createSerialBtn.addEventListener('click', ()=>{ 
  currentType='serial'; 
  chooseTypePopup.classList.add('hidden'); 
  showSlotsPage(); 
});

// ---------- Slots Page ----------
function showSlotsPage(){ 
  welcomePage.classList.add('hidden'); 
  slidesPage.classList.remove('hidden'); 

  // ‚úÖ Re-load slots from storage before showing
  loadSlotsFromStorage();
  renderSlots(); 
  updateHeaderVisibility(); 
}

function renderSlots() {
  slotsContainer.innerHTML = '';

  // Load correct slots depending on type
  let slots = (currentType === 'story') ? storySlots : serialSlots;

  // ‚úÖ Ensure there's always at least one slot
  if (!slots || slots.length === 0) {
    slots = [{ id: 0, unlocked: false, name: '' }];
    if (currentType === 'story') storySlots = slots; else serialSlots = slots;
  }

  slots.forEach((slot, index) => {
    const div = document.createElement('div');
    div.className = 'slot-card ' + (slot.unlocked ? 'unlocked' : 'locked');
    const meta = ((slot.blocked === true) || (slot.unlocked && ((currentType === 'story' && slot.name) || (currentType === 'serial' && (slot.episodes || []).length >= 0)))) ? 'Published' : (slot.unlocked ? (`Episodes: ${(slot.episodes || []).length}`) : 'Unlock to start');
    div.innerHTML = `
      <div class="slot-title">${slot.unlocked ? (slot.name || ('Slot ' + (slot.id + 1))) : 'Locked Slot'}</div>
      <div class="slot-meta">${meta}</div>
    `;

    div.addEventListener('click', () => {
      selectedSlot = slot;
      // ‚ö° Immediate check: block instantly if already published
      if (slot.blocked === true) {
        if (currentType === 'story') {
          alert('This slot already has a published story. You can edit it from your Writer Dashboard.');
        } else {
          alert('This slot already has a published serial. You can add or edit episodes from your Writer Dashboard.');
        }
        console.log('‚ö†Ô∏è Click prevented: slot already blocked (instant check).', slot.name);
        return;
      }
      // üü£ Prevent if slot is blocked (persisted)
      if (slot.blocked) {
        if (currentType === 'story') {
          alert('This slot already has a published story. You can edit it from your Writer Dashboard.');
        } else {
          alert('This slot already has a published serial. You can add or edit episodes from your Writer Dashboard.');
        }
        console.log('‚ö†Ô∏è Slot click blocked (persisted blocked flag):', slot.name);
        return;
      }

      // üü¢ Added: Check if this slot already has content (story or serial)
      if (slot.unlocked) {
        if (currentType === 'story') {
          const existingStory = (window.storiesData || []).find(s => (s.title || '').trim() === (slot.name || '').trim());
          if (existingStory && existingStory.sheets && existingStory.sheets.length > 0 && existingStory.sheets.some(sh => (sh.content || '').trim() !== '')) {
            alert('This slot already has a published story. You can edit it from your Writer Dashboard.');
            let slotsArr = currentType==='story' ? storySlots : serialSlots;
            // Identify the correct slot by index from the rendering loop
            const slotIndex = index;
            if (slotIndex !== -1) {
              slotsArr[slotIndex].blocked = true;
              if(currentType==='story') storySlots = slotsArr; else serialSlots = slotsArr;
              saveSlotsToStorage();
              console.log('‚úÖ Only this slot marked as blocked:', slotsArr[slotIndex].name);
            }
            saveSlotsToStorage();
            console.log('‚ö†Ô∏è Story slot blocked (has content):', existingStory.title);
            return;
          }
        } else if (currentType === 'serial') {
          const existingSerial = (window.serialsData || []).find(s => (s.title || '').trim() === (slot.name || '').trim());
          if (existingSerial && existingSerial.episodes && existingSerial.episodes.some(ep => (ep.sheets || []).some(sh => (sh.content || '').trim() !== ''))) {
            alert('This slot already has a published serial. You can add or edit episodes from your Writer Dashboard.');
            let slotsArr = currentType==='story' ? storySlots : serialSlots;
            // Identify the correct slot by index from the rendering loop
            const slotIndex = index;
            if (slotIndex !== -1) {
              slotsArr[slotIndex].blocked = true;
              if(currentType==='story') storySlots = slotsArr; else serialSlots = slotsArr;
              saveSlotsToStorage();
              console.log('‚úÖ Only this slot marked as blocked:', slotsArr[slotIndex].name);
            }
            saveSlotsToStorage();
            console.log('‚ö†Ô∏è Serial slot blocked (has content):', existingSerial.title);
            return;
          }
        }
      }


      selectedSlot = slot;
      if (!slot.unlocked) {
        // unlock popup
        slotNameInput.value = slot.name || '';
        slotNamePopup.dataset.slotIndex = index;
        window._currentStoryCover = '';
        window._currentSerialCover = '';
        if (document.getElementById('storyCoverImg')) { document.getElementById('storyCoverImg').style.display = 'none'; document.getElementById('storyCoverImg').src = ''; }
        if (document.getElementById('serialCoverImg')) { document.getElementById('serialCoverImg').style.display = 'none'; document.getElementById('serialCoverImg').src = ''; }
        slotNamePopup.classList.remove('hidden');
      } else {
        // open existing story/serial
        if (currentType === 'story') {
          const existingStoryIndex = storiesData.findIndex(s => (s.title || '').trim() === (slot.name || '').trim());
          if (existingStoryIndex >= 0) {
            createEditorPage(storiesData[existingStoryIndex].title, storiesData[existingStoryIndex].genre || '', storiesData[existingStoryIndex].description || '', {
              isEdit: true, editType: 'story', index: existingStoryIndex
            
});
          } else showStoryForm(slot.name || '');
        } else {
          const existingIndex = serialsData.findIndex(s => (s.title || '').trim() === (slot.name || '').trim());
          if (existingIndex >= 0) {
            const ser = serialsData[existingIndex];
            const epIndex = ser.episodes && ser.episodes.length ? 0 : null;
            createEditorPage(
              epIndex != null ? ser.episodes[epIndex].title : ser.title,
              ser.genre,
              epIndex != null ? ser.episodes[epIndex].description : ser.description,
              { isEdit: true, editType: 'serial', index: existingIndex, episodeIndex: epIndex }
            );
          } else {
            serialCreatePopup.dataset.slotIndex = index;
            seriesTitleInput.value = slot.name || '';
            seriesGenreInput.value = '';
            seriesDescInput.value = '';
            ep1TitleInput.value = '';
            ep1DescInput.value = '';
            window._currentSerialCover = '';
            if (document.getElementById('serialCoverImg')) {
              document.getElementById('serialCoverImg').style.display = 'none';
              document.getElementById('serialCoverImg').src = '';
            }
            serialCreatePopup.classList.remove('hidden');
          }
        }
      }
    });

    slotsContainer.appendChild(div);
  });
}

// ---------- Back ----------
slotsBackBtn.addEventListener('click', ()=>{ 
  slidesPage.classList.add('hidden'); 
  welcomePage.classList.remove('hidden'); 
  updateHeaderVisibility(); 
});

// ---------- Slot Name Popup ----------
slotNameCancelBtn.addEventListener('click', ()=>{ slotNamePopup.classList.add('hidden'); });
slotNameUnlockBtn.addEventListener('click', ()=>{
  const idx = parseInt(slotNamePopup.dataset.slotIndex || '0', 10);
  const name = slotNameInput.value.trim();
  let slotsArr = currentType==='story' ? storySlots : serialSlots;
  if(slotsArr.length === 0) slotsArr = [{id:0,unlocked:false,name:''}];
  if(!slotsArr[idx]){ slotsArr[idx] = { id: idx, unlocked: false, name: '' }; }
  slotsArr[idx].name = name || ('Slot ' + (idx+1));
  slotsArr[idx].unlocked = true;
  if(slotsArr[slotsArr.length-1] === slotsArr[idx]) slotsArr.push({id: slotsArr.length, unlocked: false, name: ''});
  if(currentType==='story') storySlots = slotsArr; else serialSlots = slotsArr;
  saveSlotsToStorage(); // ‚úÖ Save
  slotNamePopup.classList.add('hidden');
  renderSlots();
});

// ---------- Serial Create Popup ----------
serialCreateCancelBtn.addEventListener('click', ()=>{ serialCreatePopup.classList.add('hidden'); });
serialCreateConfirmBtn.addEventListener('click', ()=>{
  const title = seriesTitleInput.value.trim();
  const genre = seriesGenreInput.value.trim();
  const sdesc = seriesDescInput.value.trim();
  const epTitle = ep1TitleInput.value.trim();
  const epDesc = ep1DescInput.value.trim();
  if(!title){ alert('Series title is required'); return; }

  let serIndex = serialsData.findIndex(s=> s.title === title);
  let ser;
  if(serIndex >= 0){
    ser = serialsData[serIndex];
    ser.genre = genre; ser.description = sdesc;
  } else {
    ser = { title, genre, description: sdesc, episodes: [], cover: (window._currentSerialCover || '') };
    serialsData.push(ser);
    serIndex = serialsData.indexOf(ser);
  }
  ser.cover = window._currentSerialCover || '';

  if(epTitle){
    ser.episodes = ser.episodes || [];
    const lastEp = ser.episodes[ser.episodes.length - 1];
    if(!lastEp || lastEp.title !== epTitle){
      ser.episodes.push({ title: epTitle, description: epDesc || '', sheets: [], status: 'Draft' });
    }
  }

  const idx = parseInt(serialCreatePopup.dataset.slotIndex || '-1', 10);
  let slotsArr = serialSlots.length? serialSlots : [{id:0,unlocked:false,name:''}];
  let slotToUpdate = slotsArr.find(s=> s.name === title) || (slotsArr[idx] || slotsArr[0]);
  slotToUpdate.unlocked = true; 
  slotToUpdate.name = title; 
  slotToUpdate.episodes = ser.episodes.slice(); 
  slotToUpdate.cover = ser.cover || '';
  if(slotsArr[slotsArr.length-1] === slotToUpdate) slotsArr.push({id: slotsArr.length, unlocked: false, name: ''});
  serialSlots = slotsArr;
  saveSlotsToStorage(); // ‚úÖ Save

  serialCreatePopup.classList.add('hidden');
  renderSlots();

  if(epTitle){
    const epIndex = ser.episodes.length - 1;
    createEditorPage(ser.episodes[epIndex].title, ser.genre, ser.episodes[epIndex].description, { isEdit:true, editType:'serial', index: serIndex, episodeIndex: epIndex });
  }
});

// ---------- Add Episode Popup ----------
addEpCancelBtn.addEventListener('click', ()=>{ addEpisodePopup.classList.add('hidden'); addEpisodeSerialIndex = null; });
addEpConfirmBtn.addEventListener('click', ()=>{
  const title = addEpTitleInput.value.trim(); 
  const desc = addEpDescInput.value.trim();
  if(!title){ alert('Episode title is required'); return; }
  if(addEpisodeSerialIndex == null){ alert('Serial not selected'); addEpisodePopup.classList.add('hidden'); return; }
  const ser = serialsData[addEpisodeSerialIndex]; 
  if(!ser){ alert('Serial not found'); addEpisodePopup.classList.add('hidden'); return; }
  addEpisodePopup.classList.add('hidden');
  createEditorPage(title, ser.genre, desc, { isEdit:false, editType:'serial', index: addEpisodeSerialIndex, isNewEpisode:true });
  addEpisodeSerialIndex = null;
});


    // ---------- Story Form & Editor ----------
    function showStoryForm(title=''){ slidesPage.classList.add('hidden'); storyFormPage.classList.remove('hidden'); storyTitleInput.value = title; storyGenreSelect.value=''; storyDescInput.value=''; updateHeaderVisibility(); }
    cancelCreateBtn.addEventListener('click', ()=>{ storyFormPage.classList.add('hidden'); slidesPage.classList.remove('hidden'); updateHeaderVisibility(); });

    startCreatingBtn.addEventListener('click', ()=>{
      // carry-over any tags entered in the story form into pending tags map
      try{
        const t = (document.getElementById('storyTitle') && document.getElementById('storyTitle').value && document.getElementById('storyTitle').value.trim()) ? document.getElementById('storyTitle').value.trim() : 'temp_story';
        const tagsFromForm = getTagsFromContainer(document.getElementById('storyTagsContainer')) || [];
        window._pendingTags = window._pendingTags || {};
        if (tagsFromForm.length) window._pendingTags[t] = Array.from(new Set([...(window._pendingTags[t]||[]), ...tagsFromForm]));
      }catch(e){ console.warn('carry tags into pending failed', e); }

      if(!storyTitleInput.value || !storyGenreSelect.value){ alert('Fill Title & Genre'); return; }
      storyFormPage.classList.add('hidden'); createEditorPage(storyTitleInput.value, storyGenreSelect.value, storyDescInput.value, {isEdit:false, editType:'story'});
    });

   function createEditorPage(title, genre, desc, opts = {}) {
  // opts: {isEdit, editType:'story'|'serial', index, episodeIndex, isNewEpisode}
  const editType = opts.editType || 'story';
  const isEdit = !!opts.isEdit;
  const isNewEpisode = !!opts.isNewEpisode;

  const editorDiv = document.createElement('div');
  editorDiv.id = 'editorPage';
  editorDiv.innerHTML = `
  ${(editType === 'serial' && opts.isEdit && opts.episodeIndex === 0) ? `
    <div style="background:#fff8e1;border:1px solid #facc15; border-radius:10px;display:none;padding:10px;margin-bottom:8px; text-align:center;font-weight:600;color:#92400e;">
      ‚ö†Ô∏è Please create a new sheet before writing your Episodes by clicking the + button.
    </div>` : ''}

  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div>
      <h2 style="margin:0">
        ${editType === 'serial'
          ? (isEdit && opts.episodeIndex != null
              ? 'Edit Episode'
              : (isNewEpisode ? 'New Episode' : 'Edit Serial'))
          : (isEdit ? 'Edit Story' : 'New Story')}
      </h2>
      <div class="muted">${genre || ''} ${desc ? (' ‚Ä¢ ' + desc) : ''}</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-secondary" id="closeEditorBtn">Close</button>
    </div>
  </div>

  <div class="sheets-bar" id="sheetsBar">
    <div class="add-sheet-btn" id="addSheetBtn">+</div>
  </div>

  <textarea id="sheetTextarea" class="sheet-textarea" placeholder="Type your story..."></textarea>

  <div style="display:flex;justify-content:flex-start;gap:8px;margin-top:6px">
    <button id="deleteSheetBtn" class="btn btn-secondary">Delete Active Sheet</button>
  </div>

  <div class="editor-actions">
    <button class="btn btn-secondary" id="saveDraftBtn">Save Draft</button>
    <button class="btn btn-primary" id="publishStoryBtn">
      ${isEdit && editType === 'story'
        ? 'Update'
        : (isEdit && editType === 'serial' && opts.episodeIndex != null
            ? 'Update'
            : (editType === 'story'
                ? 'Publish'
                : 'Publish Episode'))}
    </button>
  </div>
  `;

  document.body.appendChild(editorDiv);
  updateHeaderVisibility();

  const sheetsBar = editorDiv.querySelector('#sheetsBar');
  const addSheetBtn = editorDiv.querySelector('#addSheetBtn');
  const sheetTextarea = editorDiv.querySelector('#sheetTextarea');
  const publishStoryBtn = editorDiv.querySelector('#publishStoryBtn');
  const saveDraftBtnLocal = editorDiv.querySelector('#saveDraftBtn');
  const closeEditorBtn = editorDiv.querySelector('#closeEditorBtn');
  const deleteSheetBtn = editorDiv.querySelector('#deleteSheetBtn');
// --- Attach a small AI logo + popup safely (enhanced centered glass version)
(function attachAiBadge() {
  const existingPopup = document.getElementById('editor_ai_popup');
  if (existingPopup) return;

  const img = document.createElement('img');
  img.src = 'meurballogo.jpg';
  img.alt = 'AI Logo';
  img.style.cssText = `
    width:38px;height:38px;border-radius:10px;cursor:pointer;
    object-fit:cover;border:0;margin-right:6px;
  `;

  const closeBtn = editorDiv.querySelector('#closeEditorBtn');
  if (closeBtn) closeBtn.parentNode.insertBefore(img, closeBtn);
  else editorDiv.querySelector('div[style*="display:flex"][style*="gap:8px"]')?.appendChild(img);

  const aiPopup = document.createElement('div');
  aiPopup.id = 'editor_ai_popup';
  aiPopup.style.cssText = `
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    z-index: 1200; background: rgba(0,0,0,0.45); backdrop-filter: blur(6px);
    transition: opacity 0.25s ease; font-family: 'Poppins','Inter',system-ui,sans-serif;
  `;

  const inner = document.createElement('div');
  inner.style.cssText = `
    background: rgba(255,255,255,0.25); backdrop-filter: blur(14px) saturate(180%);
    border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    padding: 32px 36px; min-width: 360px; text-align: center;
    border: 1px solid rgba(255,255,255,0.25); animation: popupFade 0.3s ease-out;
  `;
 inner.innerHTML = `
  <h2 style="
    margin:0 0 22px;
    font-size:1.4rem;
    color:#fff;
    font-weight:700;
    text-shadow:0 2px 8px rgba(0,0,0,0.4);
  ">ü§ñ Choose your AI Mode</h2>

  <div style="display:flex;align-items:center;justify-content:center;gap:14px;">
    <button id="aiAssistantBtn_local" style="
      background:linear-gradient(135deg,#4facfe,#00f2fe);
      color:white;font-weight:700;font-size:16px;
      border:none;border-radius:12px;padding:12px 26px;
      cursor:pointer;letter-spacing:0.3px;
      transition:all 0.25s ease;
      box-shadow:0 6px 16px rgba(0,242,254,0.4);
    ">üí° AI Assistant</button>

    <button id="aiCloseBtn_local" style="
      background:linear-gradient(135deg,#ff5f6d,#ffc371);
      color:white;font-weight:700;font-size:16px;
      border:none;border-radius:12px;padding:12px 26px;
      cursor:pointer;letter-spacing:0.3px;
      transition:all 0.25s ease;
      box-shadow:0 6px 16px rgba(255,95,109,0.4);
    ">‚úñ Close</button>
  </div>
`;

  aiPopup.appendChild(inner);
  document.body.appendChild(aiPopup);

const aiAssistantBtn = aiPopup.querySelector('#aiAssistantBtn_local');
const aiCloseBtn = aiPopup.querySelector('#aiCloseBtn_local');

aiAssistantBtn.addEventListener('mouseover', () => aiAssistantBtn.style.transform = 'scale(1.07)');
aiAssistantBtn.addEventListener('mouseout', () => aiAssistantBtn.style.transform = 'scale(1.0)');

aiAssistantBtn.addEventListener('mouseover', () => {
  aiAssistantBtn.style.boxShadow = '0 0 20px rgba(0,242,254,0.7)';
});
aiAssistantBtn.addEventListener('mouseout', () => {
  aiAssistantBtn.style.boxShadow = '0 6px 16px rgba(0,242,254,0.4)';
});

function toggleAIPopup(show) {
  aiPopup.style.display = show ? 'flex' : 'none';
}

img.addEventListener('click', e => {
  e.stopPropagation();
  toggleAIPopup(aiPopup.style.display !== 'flex');
});
document.addEventListener('click', e => { if (e.target === aiPopup) toggleAIPopup(false); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') toggleAIPopup(false); });

aiAssistantBtn.addEventListener('click', () => {
  toggleAIPopup(false);
  saveActiveSheet && saveActiveSheet();
  openVoiceAssistant();
});

aiCloseBtn.addEventListener('click', () => toggleAIPopup(false));  // ‚úÖ CLOSE 

  const style = document.createElement('style');
  style.textContent = `
    @keyframes popupFade {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
})();
// üìù Creation Workspace Reminder with glassmorphic card
(function showCreationNotePopup() {
  const popupKey = 'creationNoteCounter';
  const firstTimeKey = 'creationNoteShownOnce';
  const showAfter = 5; // show after 5 editor opens

  const shownOnce = localStorage.getItem(firstTimeKey) === 'true';
  let counter = parseInt(localStorage.getItem(popupKey) || '0', 10);

  if (!shownOnce) {
    localStorage.setItem(firstTimeKey, 'true');
  } else {
    counter++;
    if (counter < showAfter) {
      localStorage.setItem(popupKey, counter);
      return;
    }
    counter = 0; // reset after showing
    localStorage.setItem(popupKey, counter);
  }

  const existingNote = document.getElementById('editor_creation_note');
  if (existingNote) return;

  const notePopup = document.createElement('div');
  notePopup.id = 'editor_creation_note';
  notePopup.style.cssText = `
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1250;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(6px);
    font-family: 'Inter', 'Poppins', sans-serif;
    opacity: 0;
    animation: fadeSlideIn 0.5s forwards;
  `;

  const inner = document.createElement('div');
  inner.style.cssText = `
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(14px) saturate(180%);
    border-radius: 24px;
    padding: 36px 42px;
    max-width: 520px;
    text-align: left;
    box-shadow: 0 12px 36px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.3);
    transform: translateY(30px);
    position: relative;
  `;

  inner.innerHTML = `
    <!-- Friendly icon -->
    <div style="text-align:center;margin-bottom:20px;">
      <img src="https://img.icons8.com/emoji/48/000000/light-bulb-emoji.png" alt="Note Icon" style="width:48px;height:48px;">
    </div>
    <h2 style="margin:0 0 16px; font-size:1.6rem; color:#fff; font-weight:800; line-height:1.3; text-shadow:0 2px 6px rgba(0,0,0,0.5);">
      üí° Reminder
    </h2>
    <p style="font-size:1.05rem; color:#eee; line-height:1.7;">
      To save your progress safely:
    </p>
    <ul style="font-size:1rem; color:#ddd; line-height:1.6; margin:10px 0 0 20px;">
      <li>Type your Episodes or Stories in the <strong>Writing Workspace</strong> first.</li>
      <li>Save your work there before copying it into this Editor.</li>
      <li>Then you can publish your Episode or Story from here safely.</li>
    </ul>
    <p style="margin-top:14px; font-size:0.95rem; color:#ccc; line-height:1.5;">
      The <strong>Writing Workspace</strong> is available in the Writer Section .
    </p>
    <button id="closeCreationNoteBtn" disabled style="
      margin-top:24px;
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      color:white;
      font-weight:700;
      font-size:15px;
      border:none;
      border-radius:14px;
      padding:12px 26px;
      cursor:not-allowed;
      box-shadow:0 6px 20px rgba(0,242,254,0.5);
      transition: all 0.3s ease;
      display:block;
      margin-left:auto;
      margin-right:auto;
    ">Got it! (5)</button>
  `;

  notePopup.appendChild(inner);
  document.body.appendChild(notePopup);

  const closeBtn = notePopup.querySelector('#closeCreationNoteBtn');

  // Countdown logic
  let countdown = 5;
  const countdownInterval = setInterval(() => {
    countdown--;
    closeBtn.textContent = `Got it! (${countdown})`;
    if (countdown <= 0) {
      clearInterval(countdownInterval);
      closeBtn.textContent = 'Got it!';
      closeBtn.disabled = false;
      closeBtn.style.cursor = 'pointer';
    }
  }, 1000);

  closeBtn.addEventListener('click', () => notePopup.remove());

  notePopup.addEventListener('click', e => {
    if (e.target === notePopup) notePopup.remove();
  });

  document.addEventListener('keydown', function escListener(e) {
    if (e.key === 'Escape') {
      notePopup.remove();
      document.removeEventListener('keydown', escListener);
    }
  });

  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeSlideIn {
      0% { opacity: 0; transform: translateY(30px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    #closeCreationNoteBtn:hover:enabled {
      transform: scale(1.05);
      box-shadow:0 8px 24px rgba(0,242,254,0.6);
    }
  `;
  document.head.appendChild(style);
})();

  // üß≠ Close button logic
  closeEditorBtn.addEventListener('click', () => {
    saveActiveSheet();
    editorDiv.remove();

    // ‚úÖ Go HOME
    document.getElementById('welcomePage').classList.remove('hidden');

    // ‚úÖ Hide pages that might still be open
    document.getElementById('slidesPage')?.classList.add('hidden');
    document.getElementById('storyFormPage')?.classList.add('hidden');
    document.getElementById('dashboardPage')?.classList.add('hidden');

    // ‚úÖ Update header correctly
    if (typeof updateHeaderVisibility === 'function') {
      updateHeaderVisibility();
    }
  });

  // ---------- Sheet Management ----------
  let sheets = [], activeSheetId = 0;

  function addNewSheet(content = '') {
    saveActiveSheet();
    const id = sheets.length;
    sheets.push({ id, content });
    activeSheetId = id;
    renderSheetsBar();
    sheetTextarea.value = content;
    sheetTextarea.focus();
  }

  function renderSheetsBar() {
    sheetsBar.querySelectorAll('.sheet-thumb').forEach(e => e.remove());
    sheets.forEach(sheet => {
      const thumb = document.createElement('div');
      thumb.className = 'sheet-thumb' + (sheet.id === activeSheetId ? ' active' : '');
      thumb.innerHTML = `<div class="thumb-text">${(sheet.content || '').slice(0, 60) || 'Empty'}</div>`;

      // delete button on the thumb
      const del = document.createElement('button');
      del.className = 'del';
      del.innerHTML = '‚úñ';
      del.title = 'Delete this sheet';
      del.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (!confirm('Delete this sheet? This cannot be undone.')) return;
        deleteSheetById(sheet.id);
      });

      thumb.appendChild(del);
      thumb.addEventListener('click', () => {
        saveActiveSheet();
        activeSheetId = sheet.id;
        sheetTextarea.value = sheet.content || '';
        renderSheetsBar();
      });

      sheetsBar.insertBefore(thumb, addSheetBtn);
    });
  }

  function saveActiveSheet() {
    const s = sheets.find(s => s.id === activeSheetId);
    if (s) s.content = sheetTextarea.value;
  }

  function deleteSheetById(id) {
    const idx = sheets.findIndex(s => s.id === id);
    if (idx === -1) return;
    sheets.splice(idx, 1);
    // reassign ids
    sheets = sheets.map((s, i) => ({ id: i, content: s.content }));
    // adjust activeSheetId
    if (sheets.length === 0) { addNewSheet(''); return; }
    activeSheetId = Math.min(activeSheetId, sheets.length - 1);
    sheetTextarea.value = sheets[activeSheetId].content || '';
    renderSheetsBar();
  }

  addSheetBtn.addEventListener('click', () => addNewSheet(''));

  // Delete active sheet button
  deleteSheetBtn.addEventListener('click', () => {
    if (!confirm('Delete the active sheet? This cannot be undone.')) return;
    deleteSheetById(activeSheetId);
  });

  // üß† Auto-split long sheets (more than 500 words)
  sheetTextarea.addEventListener('input', () => {
    const words = sheetTextarea.value.trim().split(/\s+/);
    if (words.length > 500) {
      saveActiveSheet();

      const firstPart = words.slice(0, 500).join(' ');
      const remainder = words.slice(500).join(' ');

      sheets[activeSheetId].content = firstPart;

      // üî• Auto-create new sheet with overflow text
      const newSheetId = sheets.length;
      sheets.push({ id: newSheetId, content: remainder });
      activeSheetId = newSheetId;

      renderSheetsBar();
      sheetTextarea.value = remainder;
      sheetTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });

  // ---------- Initialize: load existing or new ----------
  if (isEdit) {
    if (editType === 'story') {
      const obj = storiesData[opts.index] || { sheets: [] };
      sheets = (obj.sheets || []).map((s, i) => ({ id: i, content: s.content || s }));
      activeSheetId = 0;
      renderSheetsBar();
      sheetTextarea.value = sheets[0] ? sheets[0].content : '';
    } else if (editType === 'serial') {
      const ser = serialsData[opts.index] || { episodes: [] };
      if (opts.episodeIndex != null) {
        const ep = (ser.episodes || [])[opts.episodeIndex] || { sheets: [] };
        sheets = (ep.sheets || []).map((s, i) => ({ id: i, content: s.content || s }));
        activeSheetId = 0;
        renderSheetsBar();
        sheetTextarea.value = sheets[0] ? sheets[0].content : '';
      } else {
        sheets = [];
        addNewSheet('');
      }
    }
  } else {
    // new story or new episode
    addNewSheet('');
  }
if (sheets.length === 0) {
    const warn = document.createElement('div');
    warn.style.cssText = `
      background:#fff7d6;
      border:1px solid #ffcc33;
      padding:10px;
      color:#8a5a00;
      font-weight:600;
      border-radius:8px;
      margin:10px 0;
      text-align:center;
    `;
    warn.innerHTML = "‚ö†Ô∏è You have no sheets. Click the ‚ûï button to create one! and if your story or series is big please save your progress in the Writing Workspace";
    
    editorDiv.insertBefore(warn, editorDiv.firstChild);
}


      publishStoryBtn.addEventListener('click', async ()=>{
        saveActiveSheet(); const payloadSheets = sheets.map(s=>({content: s.content || ''}));
       if(editType === 'story'){
  const writerName = document.getElementById('writerNameInput')?.value.trim() || 'Unknown';
  const publishDate = document.getElementById('publishDateInput')?.value || new Date().toISOString().split('T')[0];
  const payload = {
    title: title,
    genre: genre,
    description: desc,
    sheets: payloadSheets,
    status: 'Public',
    cover: window._currentStoryCover || '',
    writerName: writerName,
    publishDate: publishDate
  };

          // Save locally first
          if(isEdit){ storiesData[opts.index] = Object.assign({}, storiesData[opts.index], payload); }
          else { storiesData.push(payload); }
          // Attempt to save to Firebase (overwrite same title key)
          try{
            if(window._firebase && window._firebase.set){
              const { db, ref, set } = window._firebase;
              await set(ref(db, `stories/${encodeURIComponent(title)}`), payload);
              console.log('Saved story to Firebase:', title);
            }
          }catch(err){ console.warn('Firebase save failed for story', err); }
          editorDiv.remove(); showDashboard('stories');
          return;
        }
        // serial path
        if(editType === 'serial'){
          const ser = serialsData[opts.index]; if(!ser){ alert('Serial not found'); return; }
          if(isEdit && opts.episodeIndex!=null){
            ser.episodes[opts.episodeIndex] = Object.assign({}, ser.episodes[opts.episodeIndex], { title: title, description: desc, sheets: payloadSheets, status: 'Public' });
            serialsData[opts.index] = ser;
          try{
            if(window._firebase && window._firebase.set){
              const { db, ref, set } = window._firebase;
const inputWriter = document.getElementById('serialWriterNameInput')?.value?.trim();
ser.writerName = inputWriter && inputWriter.length ? inputWriter : (ser.writerName || 'Unknown');

const inputDate = document.getElementById('serialPublishDateInput')?.value;
ser.publishDate = inputDate && inputDate.length ? inputDate : (ser.publishDate || new Date().toISOString().split('T')[0]);


    await set(ref(db, `serials/${encodeURIComponent(ser.title.trim())}`), ser);
              saveLocal('serialsData', serialsData);
saveLocal('serialSlots', serialSlots);
// ‚úÖ Upload full serial with new episode to Firebase
try {
  if (window._firebase && window._firebase.set) {
    const { db, ref, set } = window._firebase;
const inputWriter = document.getElementById('serialWriterNameInput')?.value?.trim();
ser.writerName = inputWriter && inputWriter.length ? inputWriter : (ser.writerName || 'Unknown');

const inputDate = document.getElementById('serialPublishDateInput')?.value;
ser.publishDate = inputDate && inputDate.length ? inputDate : (ser.publishDate || new Date().toISOString().split('T')[0]);


    await set(ref(db, `serials/${encodeURIComponent(ser.title.trim())}`), ser);
    console.log('‚úÖ Uploaded full serial with new episode to Firebase:', ser.title);
  }
} catch (err) {
  console.warn('‚ùå Firebase update failed for new episode:', err);
}
console.log('Saved serial to Firebase:', ser.title);
            }
          }catch(err){ console.warn('Firebase save failed for serial', err); }

          } else if(isNewEpisode){
            ser.episodes = ser.episodes || [];
            ser.episodes.push({ title: title || 'Episode', description: desc || '', sheets: payloadSheets, status: 'Public' });
            serialsData[opts.index] = ser;
            try{
              if(window._firebase && window._firebase.set){
                const { db, ref, set } = window._firebase;
const inputWriter = document.getElementById('serialWriterNameInput')?.value?.trim();
ser.writerName = inputWriter && inputWriter.length ? inputWriter : (ser.writerName || 'Unknown');

const inputDate = document.getElementById('serialPublishDateInput')?.value;
ser.publishDate = inputDate && inputDate.length ? inputDate : (ser.publishDate || new Date().toISOString().split('T')[0]);


    await set(ref(db, `serials/${encodeURIComponent(ser.title.trim())}`), ser);
                saveLocal('serialsData', serialsData);
saveLocal('serialSlots', serialSlots);
// ‚úÖ Upload full serial with new episode to Firebase
try {
  if (window._firebase && window._firebase.set) {
    const { db, ref, set } = window._firebase;
const inputWriter = document.getElementById('serialWriterNameInput')?.value?.trim();
ser.writerName = inputWriter && inputWriter.length ? inputWriter : (ser.writerName || 'Unknown');

const inputDate = document.getElementById('serialPublishDateInput')?.value;
ser.publishDate = inputDate && inputDate.length ? inputDate : (ser.publishDate || new Date().toISOString().split('T')[0]);


    await set(ref(db, `serials/${encodeURIComponent(ser.title.trim())}`), ser);
    console.log('‚úÖ Uploaded full serial with new episode to Firebase:', ser.title);
  }
} catch (err) {
  console.warn('‚ùå Firebase update failed for new episode:', err);
}
console.log('Saved new episode (serial) to Firebase:', ser.title);
              }
            }catch(err){ console.warn('Firebase save failed for new episode', err); }

          try{
            if(window._firebase && window._firebase.set){
              const { db, ref, set } = window._firebase;
const inputWriter = document.getElementById('serialWriterNameInput')?.value?.trim();
ser.writerName = inputWriter && inputWriter.length ? inputWriter : (ser.writerName || 'Unknown');

const inputDate = document.getElementById('serialPublishDateInput')?.value;
ser.publishDate = inputDate && inputDate.length ? inputDate : (ser.publishDate || new Date().toISOString().split('T')[0]);


    await set(ref(db, `serials/${encodeURIComponent(ser.title.trim())}`), ser);
              saveLocal('serialsData', serialsData);
saveLocal('serialSlots', serialSlots);
// ‚úÖ Upload full serial with new episode to Firebase
try {
  if (window._firebase && window._firebase.set) {
    const { db, ref, set } = window._firebase;
 const inputWriter = document.getElementById('serialWriterNameInput')?.value?.trim();
ser.writerName = inputWriter && inputWriter.length ? inputWriter : (ser.writerName || 'Unknown');

const inputDate = document.getElementById('serialPublishDateInput')?.value;
ser.publishDate = inputDate && inputDate.length ? inputDate : (ser.publishDate || new Date().toISOString().split('T')[0]);


    await set(ref(db, `serials/${encodeURIComponent(ser.title.trim())}`), ser);
    console.log('‚úÖ Uploaded full serial with new episode to Firebase:', ser.title);
  }
} catch (err) {
  console.warn('‚ùå Firebase update failed for new episode:', err);
}
console.log('Saved serial to Firebase:', ser.title);
            }
          }catch(err){ console.warn('Firebase save failed for serial', err); }

          } else {
            serialsData[opts.index] = Object.assign({}, ser, { title: title, genre: genre, description: desc });
          }
          const slot = serialSlots.find(s=> s.name === ser.title);
          if(slot) slot.episodes = ser.episodes.slice();
          editorDiv.remove(); showDashboard('serials');
          return;
        }
      });

saveDraftBtnLocal.addEventListener('click', async ()=>{
  saveActiveSheet();
  // DO NOTHING ‚Äî no Firebase, no localStorage, no slot update
  alert("Draft kept locally only while editor remains open. It won't save anywhere.");
});


      closeEditorBtn.addEventListener('click', ()=>{ if(confirm('Close editor? Your Writing Progress will not be saved it will only be saved in your writing workspace')) editorDiv.remove(); });
    }
// ---------- Dashboard UI ----------
// ---------- Show Dashboard ----------
function showDashboard(type = 'stories', genreFilter = 'All') {
  welcomePage.classList.add('hidden');
  profileFormPage.classList.add('hidden');
  storyFormPage.classList.add('hidden');
  slidesPage.classList.add('hidden');
  dashboardPage.classList.remove('hidden');
  dashboardBackBtn.classList.remove('hidden');
  dashboardList.innerHTML = '';
  updateHeaderVisibility();

  let hadCards = false;

  // Load saved cards first
  let savedCards = JSON.parse(localStorage.getItem('dashboardCards') || '[]');

  // ---------- STORIES ----------
  if (type === 'stories' && window.storiesData && storiesData.length > 0) {
    const published = storiesData.filter(s => s.status === 'Public');
    const drafts = storiesData.filter(s => s.status !== 'Public');
    const ordered = [...published, ...drafts];

    const filtered =
      genreFilter && genreFilter !== 'All'
        ? ordered.filter(
            s => (s.genre || '').toLowerCase() === genreFilter.toLowerCase()
          )
        : ordered;

    filtered.forEach(s => {
      // Skip if already in savedCards
      if (!savedCards.some(c => c.title === s.title)) {
        savedCards.push({
          title: s.title,
          status: s.status || 'Public',
          meta: 'Genre: ' + (s.genre || '‚Äî'),
          type: 'story',
        });
      }
    });
  }

  // ---------- SERIALS ----------
  else if (type === 'serials' && window.serialsData && serialsData.length > 0) {
    const ordered = [...serialsData];

    ordered.forEach(s => {
      // Skip if already in savedCards
      if (!savedCards.some(c => c.title === s.title)) {
        savedCards.push({
          title: s.title,
          meta: (s.genre || '‚Äî') + (s.description ? ' ‚Ä¢ ' + s.description : ''),
          type: 'serial',
          episodesCount: (s.episodes || []).length
        });
      }
    });
  }

savedCards.forEach(c => {
  // Only render cards matching the selected type
  if (
    (type === 'stories' && c.type !== 'story') ||
    (type === 'serials' && c.type !== 'serial')
  ) return;

const card = document.createElement('div');
card.className = 'dashboard-card';
card.innerHTML = `
  <div class="left">
    <div style="max-width:65%">
      <h3>${c.title}</h3>
      <div class="meta">${c.meta}</div>

      <!-- Removed episode count line -->

      <p>Status: <span class="status-public">Public</span></p>
    </div>
  </div>
  <div class="card-actions"></div>
`;

  const actions = card.querySelector('.card-actions');

  // ---------- STORY CARD ACTIONS ----------
  if (c.type === 'story') {


    // Analysis button
    const analysisBtn = document.createElement('button');
    analysisBtn.className = 'small-btn btn btn-info';
    analysisBtn.textContent = 'üìä Analytics';
    analysisBtn.style.background = '#3f74f0';
    analysisBtn.style.color = 'white';
    analysisBtn.addEventListener('click', () => {
      const s = window.storiesData?.find(
        x => (x.title || '').trim().toLowerCase() === c.title.trim().toLowerCase()
      );
      if (s && s.title) {
        openAnalyticsModal(s.title);
      } else if (typeof openAnalyticsModal === 'function') {
        openAnalyticsModal(c.title);
      } else {
        alert('Story analytics not available yet. Try again after data loads.');
      }
    });
    actions.appendChild(analysisBtn);

    // ‚úÖ Delete button (only for stories)
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'small-btn btn btn-danger';
    deleteBtn.textContent = 'üóëÔ∏è Delete';
    deleteBtn.style.background = '#dc2626';
    deleteBtn.style.color = 'white';
    deleteBtn.addEventListener('click', async () => {
      if (!confirm(`Are you sure you want to delete story "${c.title}"?`)) return;

      try {
        const db = window._firebase?.db;
        const refFunc = window._firebase?.ref;
        const setFunc = window._firebase?.set;

        if (!db || !refFunc || !setFunc) {
          alert('‚ùå Firebase not initialized. Please reload the app.');
          return;
        }

        // ‚úÖ Remove from Firebase by title key
        await setFunc(refFunc(db, `stories/${encodeURIComponent(c.title)}`), null);

        // ‚úÖ Remove from local data
        window.storiesData = (window.storiesData || []).filter(
          s => (s.title || '').trim().toLowerCase() !== c.title.trim().toLowerCase()
        );
        localStorage.setItem('storiesData', JSON.stringify(window.storiesData));

        // ‚úÖ Remove from dashboardCards
        const saved = JSON.parse(localStorage.getItem('dashboardCards') || '[]');
        const updated = saved.filter(card => card.title !== c.title);
        localStorage.setItem('dashboardCards', JSON.stringify(updated));

        // ‚úÖ Remove card visually
        card.remove();
        alert(`‚úÖ Story "${c.title}" deleted successfully.`);
      } catch (err) {
        console.error('‚ùå Failed to delete story:', err);
        alert('‚ùå Error deleting story from Firebase. Please check console.');
      }
    });
    actions.appendChild(deleteBtn);
  }

  // ---------- SERIAL CARD ACTIONS ----------
  if (c.type === 'serial') {
    const optionsBtn = document.createElement('button');
    optionsBtn.className = 'small-btn btn btn-secondary';
    optionsBtn.textContent = 'Series Options';
    optionsBtn.addEventListener('click', () => {
      const serial = window.serialsData?.find(
        x => (x.title || '').trim().toLowerCase() === c.title.trim().toLowerCase()
      );
      if (!serial) return alert('‚ùó Series not found maybe deleted');
      openSerialOptions(serial, window.serialsData.indexOf(serial));
    });
    actions.appendChild(optionsBtn);

    const analyticsBtn = document.createElement('button');
    analyticsBtn.className = 'small-btn btn btn-primary';
    analyticsBtn.textContent = 'Analytics';
    analyticsBtn.addEventListener('click', () => {
      const serial = window.serialsData?.find(
        x => (x.title || '').trim().toLowerCase() === c.title.trim().toLowerCase()
      );
      if (serial && serial.title) {
        openSerialAnalyticsModal(serial.title);
      } else if (typeof openSerialAnalyticsModal === 'function') {
        openSerialAnalyticsModal(c.title);
      } else {
        alert('Serial analytics not available yet. Try again after data loads.');
      }
    });
    actions.appendChild(analyticsBtn);
  }

  dashboardList.appendChild(card);
  hadCards = true;
});

  // ---------- Save merged cards ----------
  if (savedCards.length) {
    localStorage.setItem('dashboardCards', JSON.stringify(savedCards));
    console.log(`üíæ Dashboard saved (${savedCards.length} total cards, merged)`);
  }

  // Fallback
  if (!hadCards) loadDashboardCards(type);
}


// ---------- Save Dashboard Cards ----------
// ---------- Save Dashboard Cards ----------
function saveDashboardCards(type = 'stories') {
  try {
    const newCards = [];
    document.querySelectorAll('.dashboard-card').forEach(card => {
      const titleEl = card.querySelector('h3');
      const metaEl = card.querySelector('.meta');
      const descEl = card.querySelector('.desc');
      if (!titleEl) return;

      const isSerial = descEl && descEl.textContent.includes('Episodes:');
      let episodesCount = 0;
      if (isSerial && window.serialsData) {
        const found = window.serialsData.find(
          x => (x.title || '').trim().toLowerCase() === titleEl.textContent.trim().toLowerCase()
        );
        if (found && found.episodes) episodesCount = found.episodes.length;
      }

      // save minimal fields but enough to recreate buttons & behavior
      newCards.push({
        title: titleEl.textContent.trim(),
        status: 'Public',
        meta: metaEl ? metaEl.textContent.trim() : '',
        type: isSerial ? 'serial' : 'story',
        episodesCount
      });
    });

    // merge instead of overwrite
    const saved = JSON.parse(localStorage.getItem('dashboardCards') || '[]');
    const merged = [
      ...saved.filter(c => !newCards.some(n => n.title === c.title)),
      ...newCards
    ];

    localStorage.setItem('dashboardCards', JSON.stringify(merged));
    console.log(`üíæ Dashboard saved (${merged.length} total cards, merged)`);
  } catch (e) {
    console.warn('‚ö†Ô∏è Failed to save dashboard cards:', e);
  }
}

// ---------- Load Dashboard Cards ----------
function loadDashboardCards(type = 'stories') {
  try {
    const saved = JSON.parse(localStorage.getItem('dashboardCards') || '[]');
    if (!saved.length) return;

    dashboardList.innerHTML = '';

    const filtered = saved.filter(c => 
      (type === 'stories' && c.type === 'story') ||
      (type === 'serials' && c.type === 'serial')
    );

    filtered.forEach(c => {
      const card = document.createElement('div');
      card.className = 'dashboard-card';
      card.innerHTML = `
        <div class="left">
          <div style="max-width:65%">
            <h3>${c.title}</h3>
            <div class="meta">${c.meta}</div>
            <p class="desc">${
              c.type === 'serial' ? 'Episodes: ' + (c.episodesCount || '0') : ''
            }</p>
            <p>Status: <span class="status-public">Public</span></p>
          </div>
        </div>
        <div class="card-actions"></div>
      `;

      const actions = card.querySelector('.card-actions');

      // story: Update + Analysis
      if (c.type === 'story') {
        const updateBtn = document.createElement('button');
        updateBtn.className = 'small-btn btn btn-secondary';
        updateBtn.textContent = 'Update';
        updateBtn.addEventListener('click', () => {
          const s = window.storiesData?.find(
            x => (x.title || '').trim().toLowerCase() === c.title.trim().toLowerCase()
          );
          if (!s) return alert('‚è≥ Story data not loaded yet. Try again.');
          createEditorPage(s.title, s.genre, s.description, {
            isEdit: true,
            editType: 'story',
            index: window.storiesData.indexOf(s)
          });
        });
        actions.appendChild(updateBtn);

        // Analysis button for saved story cards
        const analysisBtn = document.createElement('button');
        analysisBtn.className = 'small-btn btn btn-info';
        analysisBtn.textContent = 'üìä Analytics';
        analysisBtn.style.background = '#3f74f0';
        analysisBtn.style.color = 'white';
        analysisBtn.addEventListener('click', () => {
          // prefer to open analytics with loaded story if available
          const s = window.storiesData?.find(
            x => (x.title || '').trim().toLowerCase() === c.title.trim().toLowerCase()
          );
          if (s && s.title) {
            openAnalyticsModal(s.title);
          } else if (c.title) {
            // if runtime data isn't present, still try by title (or alert)
            if (typeof openAnalyticsModal === 'function') {
              openAnalyticsModal(c.title);
            } else {
              alert('Story analytics not available yet. Try again after data loads.');
            }
          } else {
            alert('Story data not found!');
          }
        });
        actions.appendChild(analysisBtn);
      }

      // serial: Serial Options + Analysis
      if (c.type === 'serial') {
        const optionsBtn = document.createElement('button');
        optionsBtn.className = 'small-btn btn btn-secondary';
        optionsBtn.textContent = 'Serial Options';
        optionsBtn.addEventListener('click', () => {
          const serial = window.serialsData?.find(
            x => (x.title || '').trim().toLowerCase() === c.title.trim().toLowerCase()
          );
          if (!serial) return alert('‚ùó Series not found maybe deleted');
          openSerialOptions(serial, window.serialsData.indexOf(serial));
        });
        actions.appendChild(optionsBtn);

        // Analysis button for saved serial cards
        const analyticsBtn = document.createElement('button');
        analyticsBtn.className = 'small-btn btn btn-primary';
        analyticsBtn.textContent = 'Analytics';
        analyticsBtn.addEventListener('click', () => {
          const serial = window.serialsData?.find(
            x => (x.title || '').trim().toLowerCase() === c.title.trim().toLowerCase()
          );
          if (serial && serial.title) {
            openSerialAnalyticsModal(serial.title);
          } else if (typeof openSerialAnalyticsModal === 'function') {
            // fallback: try opening by title anyway
            openSerialAnalyticsModal(c.title);
          } else {
            alert('Serial analytics not available yet. Try again after data loads.');
          }
        });
        actions.appendChild(analyticsBtn);
      }

      dashboardList.appendChild(card);
    });

    console.log(`‚úÖ Dashboard restored (${filtered.length} ${type})`);
  } catch (e) {
    console.warn('‚ö†Ô∏è Failed to load dashboard cards:', e);
  }
}


// ---------- Load Dashboard When App Starts ----------
document.addEventListener('DOMContentLoaded', () => {
  // show local saved cards immediately (so user sees them on refresh)
  loadDashboardCards();

  // keep original behavior: if/when serialsData loads, you can still call loadDashboardCards
  // (this ensures handlers that depend on runtime data will succeed once data exists)
  waitForDataLoaded(() => {
    // re-run to refresh handlers / ensure accurate counts (if needed)
    loadDashboardCards();
  });
});





function openSerialOptions(serial, serialIndex) {
  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.innerHTML = `
    <div class="popup-content">
      <h3>${serial.title} ‚Äî Series Options</h3>

      <button id="addEpNowBtn" class="btn btn-primary" style="margin-top:12px;">
        ‚ûï Add New Episode
      </button>

      <button id="deleteSerialBtn" class="btn btn-danger" style="margin-top:12px;background:#dc2626;color:white;">
        üóëÔ∏è Delete Series
      </button>

      <button id="deleteEpisodeBtn" class="btn btn-warning" style="margin-top:12px;background:#f59e0b;color:white;">
        ‚ö° Delete Episode
      </button>

      <button id="closeSerialOpts" class="btn btn-secondary" style="margin-top:10px;">
        Close
      </button>
    </div>
  `;
  document.body.appendChild(popup);

  // ---- Close ----
  document.getElementById('closeSerialOpts').onclick = () => popup.remove();

  // ---- Add Episode (original logic) ----
 document.getElementById('addEpNowBtn').onclick = () => {
  popup.remove();

  const title = prompt("Enter Episode Title:");
  if (!title || !title.trim()) return;

  const desc = prompt("Enter Short Episode Description (optional):") || "";

  serial.episodes = serial.episodes || [];
  serial.episodes.push({
    title: title.trim(),
    description: desc.trim(),
    sheets: [],
    status: "Draft" // still draft
  });

  // index to target this episode later
  const newIndex = serial.episodes.length - 1;

  // üü° DO NOT save to Firebase here
  // saveSerialToFirebase(serial);  <-- remove or comment out

  // üü° Only update localStorage
  serialsData[serialIndex] = serial;
  localStorage.setItem("serialsData", JSON.stringify(serialsData));

  // open the editor
  createEditorPage(
    title.trim(),
    serial.genre,
    desc.trim(),
    {
      isEdit: true,
      editType: "serial",
      index: serialIndex,
      episodeIndex: newIndex
    }
  );
};


  // ---- Delete Serial ----
  document.getElementById('deleteSerialBtn').onclick = async () => {
    if (!confirm(`Delete series "${serial.title}" permanently?`)) return;

    try {
      const db = window._firebase?.db;
      const refFunc = window._firebase?.ref;
      const setFunc = window._firebase?.set;

      if (!db || !refFunc || !setFunc) {
        alert('‚ùå Firebase not initialized. Please reload the app.');
        return;
      }

      // ‚úÖ Remove from Firebase
      await setFunc(refFunc(db, `serials/${encodeURIComponent(serial.title)}`), null);

      // ‚úÖ Remove from localStorage + memory
      window.serialsData.splice(serialIndex, 1);
      localStorage.setItem("serialsData", JSON.stringify(window.serialsData));

      // ‚úÖ Remove from dashboardCards
      const saved = JSON.parse(localStorage.getItem('dashboardCards') || '[]');
      const updated = saved.filter(card => card.title !== serial.title);
      localStorage.setItem('dashboardCards', JSON.stringify(updated));

      popup.remove();
      alert(`‚úÖ Series "${serial.title}" deleted successfully.`);
      showDashboard('serials');
    } catch (err) {
      console.error('‚ùå Failed to delete serial:', err);
      alert('Series Successfully Deleted‚úÖ.');
    }
  };

  // ---- Delete Episode ----
  document.getElementById('deleteEpisodeBtn').onclick = async () => {
    if (!serial.episodes || serial.episodes.length === 0) {
      alert('No episodes to delete.');
      return;
    }

    const list = serial.episodes.map((ep, i) => `${i + 1}. ${ep.title}`).join('\n');
    const choice = prompt(`Enter episode number to delete:\n${list}`);
    const index = parseInt(choice) - 1;

    if (isNaN(index) || index < 0 || index >= serial.episodes.length) {
      alert('Invalid episode number.');
      return;
    }

    const epTitle = serial.episodes[index].title;
    if (!confirm(`Delete episode "${epTitle}"?`)) return;

    try {
      serial.episodes.splice(index, 1);

      // ‚úÖ Save updated serial to Firebase
      const db = window._firebase?.db;
      const refFunc = window._firebase?.ref;
      const setFunc = window._firebase?.set;

      await setFunc(refFunc(db, `serials/${encodeURIComponent(serial.title)}`), serial);

      // ‚úÖ Update localStorage
      serialsData[serialIndex] = serial;
      localStorage.setItem('serialsData', JSON.stringify(serialsData));

      alert(`‚úÖ Episode "${epTitle}" deleted successfully.`);
      popup.remove();
    } catch (err) {
      console.error('‚ùå Failed to delete episode:', err);
      alert('Error deleting episode. Please check console.');
    }
  };
}
async function saveSerialToFirebase(serial) {
  try {
    await set(
  ref(window._firebase.db, `serials/${encodeURIComponent(serial.title.trim())}`),
  serial
);

    console.log(`‚úÖ Serial "${serial.title}" saved to Firebase`);
  } catch (err) {
    console.error(`‚ùå Failed to save serial:`, err);
  }
}



async function openSerialAnalyticsModal(serialTitle) {
  try {
const url = `https://meurbal-d3c72-default-rtdb.firebaseio.com/serials.json`;
    const res = await fetch(url);
    const serialsData = await res.json();

    if (!serialsData) {
      alert('‚ùó No serials found in the database!');
      return;
    }

    // üîπ Find serial by title
    const foundKey = Object.keys(serialsData).find(k => {
      const s = serialsData[k];
      return (s.title || '').trim().toLowerCase() === serialTitle.trim().toLowerCase();
    });

    if (!foundKey) {
      alert(`Serial "${serialTitle}" not found in the database!`);
      return;
    }

    const data = serialsData[foundKey];

    // üîπ Compute analytics
    const episodesCount = data.episodes ? Object.keys(data.episodes).length : 0;
    let readsCount = 0;
    if (data.episodes) {
      Object.values(data.episodes).forEach(ep => {
        if (typeof ep.reads === 'number') readsCount += ep.reads;
      });
    }
    const likesCount = data.likes || 0;

    // üîπ Determine Status
    let statusText = "On Going";
    if (readsCount >= 200) statusText = "üî• Popular";
    else if (readsCount >= 100) statusText = "‚≠ê Trending";
    else if (readsCount >= 50) statusText = "üí™ Doing Well";
    else statusText = "üïí On Going";

    // üîπ Create Full Page View
    const overlay = document.createElement('div');
    overlay.id = "analyticsFullPage";
    overlay.style.cssText = `
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #f8fafc, #e0e7ff);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 40px 20px;
      font-family: 'Segoe UI', sans-serif;
      overflow-y: auto;
      z-index: 9999;
    `;

    // üîπ Header
    const header = document.createElement('div');
    header.innerHTML = `
      <h1 style="font-size: 26px; margin-bottom: 8px;">üìä Analytics Overview</h1>
      <h2 style="font-size: 20px; color: #3b82f6;">${serialTitle}</h2>
    `;
    header.style.textAlign = "center";
    overlay.appendChild(header);

    // üîπ Stats Grid
    const grid = document.createElement('div');
    grid.style.cssText = `
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      width: 90%;
      max-width: 900px;
      margin-top: 30px;
    `;

    // Helper to create a box
    function statBox(label, value, emoji, color) {
      const box = document.createElement('div');
      box.style.cssText = `
        background: white;
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        padding: 25px;
        text-align: center;
        border-top: 5px solid ${color};
      `;
      box.innerHTML = `
        <div style="font-size: 32px; margin-bottom: 8px;">${emoji}</div>
        <div style="font-size: 16px; font-weight: 600; color:#555;">${label}</div>
        <div style="font-size: 22px; font-weight: bold; margin-top: 4px;">${value}</div>
      `;
      return box;
    }

    grid.appendChild(statBox("Episodes", episodesCount, "üé¨", "#6366f1"));
    grid.appendChild(statBox("Total Reads", readsCount, "üëÅÔ∏è", "#10b981"));
    grid.appendChild(statBox("Likes", likesCount, "üëç", "#f59e0b"));
    grid.appendChild(statBox("Status", statusText, "üìà", "#3b82f6"));

    overlay.appendChild(grid);

    // üîπ Close Button
    const closeBtn = document.createElement('button');
    closeBtn.textContent = "‚Üê Back to Dashboard";
    closeBtn.style.cssText = `
      margin-top: 50px;
      padding: 10px 22px;
      font-size: 16px;
      border: none;
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(59,130,246,0.4);
      transition: background 0.3s ease;
    `;
    closeBtn.onmouseenter = () => (closeBtn.style.background = "#2563eb");
    closeBtn.onmouseleave = () => (closeBtn.style.background = "#3b82f6");
    closeBtn.onclick = () => overlay.remove();

    overlay.appendChild(closeBtn);
    document.body.appendChild(overlay);

  } catch (err) {
    console.error('Error loading analytics:', err);
    alert('‚ö†Ô∏è Failed to load analytics!');
  }
}


  
    dashboardBackBtn.addEventListener('click', ()=>{ dashboardPage.classList.add('hidden'); welcomePage.classList.remove('hidden'); dashboardBackBtn.classList.add('hidden'); });

    function showSerialOptions(slot){
      const modal = document.createElement('div'); modal.className='popup';
      modal.innerHTML = `<div class="popup-content"><h3>${slot.name} ‚Äî Serial Options</h3>
                         <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px;text-align:left">
                           <button id="manageEpsBtn" class="btn btn-secondary">Manage Episodes</button>
                           <button id="addEpBtn" class="btn btn-primary">Add Episode</button>
                           <button id="openCreateBtn" class="btn btn-primary">Open Serial Form</button>
                           <button id="closeSlotOpts" class="btn btn-secondary" style="margin-top:8px">Close</button>
                         </div></div>`;
      document.body.appendChild(modal);
      modal.querySelector('#manageEpsBtn').addEventListener('click', ()=>{ modal.remove(); showSerialEpisodesEditor(serialSlots.indexOf(slot)); });
      modal.querySelector('#addEpBtn').addEventListener('click', ()=>{ modal.remove();
        const ser = serialsData.find(s=> s.title === slot.name);
        if(!ser){ const newSer = { title: slot.name, genre: '', description: '', episodes: slot.episodes ? slot.episodes.slice() : [] }; serialsData.push(newSer); }
        const serIndex = serialsData.findIndex(s=> s.title === slot.name);
        addEpisodeSerialIndex = serIndex; addEpTitleInput.value = ''; addEpDescInput.value = ''; addEpisodePopup.classList.remove('hidden');
      });
      modal.querySelector('#openCreateBtn').addEventListener('click', ()=>{ modal.remove();
        serialCreatePopup.dataset.slotIndex = serialSlots.indexOf(slot);
        const existing = serialsData.find(s=> s.title === slot.name);
        if(existing){ seriesTitleInput.value = existing.title || slot.name || ''; seriesGenreInput.value = existing.genre || ''; seriesDescInput.value = existing.description || ''; }
        else { seriesTitleInput.value = slot.name || ''; seriesGenreInput.value = ''; seriesDescInput.value = ''; }
        ep1TitleInput.value = ''; ep1DescInput.value = '';
        serialCreatePopup.classList.remove('hidden');
      });
      modal.querySelector('#closeSlotOpts').addEventListener('click', ()=> modal.remove());
    }

function showSerialEpisodesEditor(serial) {
  if (!serial) {
    alert("Serial object not provided");
    return;
  }

  // ‚úÖ Always find correct serial fresh after reload
  const cleanedTitle = (serial.title || '').trim().toLowerCase();
  const serialIndex = (window.serialsData || []).findIndex(x =>
    (x.title || '').trim().toLowerCase() === cleanedTitle
  );

  if (serialIndex === -1) {
    alert("Serial not found in your data");
    console.log("SERIALNOTFOUND ‚Äî Title:", serial.title);
    return;
  }

  const ser = window.serialsData[serialIndex];

  const modal = document.createElement('div');
  modal.className='popup';
  modal.innerHTML = `
    <div class="popup-content">
      <h3>${ser.title} ‚Äî Episodes</h3>
      <div id="epsList" style="max-height:300px;overflow:auto;margin-top:10px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="closeEps" class="btn btn-secondary">Close</button>
      </div>
    </div>`;

  document.body.appendChild(modal);

  const epsList = modal.querySelector('#epsList');
  const closeEps = modal.querySelector('#closeEps');

  (ser.episodes || []).forEach((ep, i) => {
    const row = document.createElement('div');
    row.style.display='flex';
    row.style.justifyContent='space-between';
    row.style.alignItems='center';
    row.style.padding='8px 0';

    row.innerHTML = `
      <div style="max-width:70%">
        <strong>${i+1}. ${ep.title}</strong>
        <div style="font-size:13px;color:var(--muted)">${ep.description || ''}</div>
        <div style="font-size:12px;color:var(--muted)">Status: ${ep.status || 'Draft'}</div>
      </div>
    `;

    const buttons = document.createElement('div');
    buttons.style.display='flex';
    buttons.style.gap='8px';

    const editBtn = document.createElement('button');
    editBtn.className='small-btn btn btn-secondary';
    editBtn.textContent='Edit';
    editBtn.addEventListener('click', () => {
      modal.remove();
      createEditorPage(ep.title, ser.genre, ep.description, {
        isEdit: true,
        editType: 'serial',
        index: serialIndex,
        episodeIndex: i,
        isNewEpisode: false
      });
    });

    buttons.appendChild(editBtn);
    row.appendChild(buttons);
    epsList.appendChild(row);
  });

  closeEps.addEventListener('click', () => modal.remove());
}



    // ---------- Init ----------
    loadProfile();
    storySlots = [{id:0,unlocked:false,name:''}];
    serialSlots = [{id:0,unlocked:false,name:''}];
    updateHeaderVisibility();
  
    // ---------- Browse Stories rendering & Preview/Reader ----------
// Story browsing & rendering (full snippet, fixed demo merge bug)

const STORY_ALGO_CONFIG = {
  popularityWeight: 0.5,      // lower to allow new creators
  recencyWeight: 0.25,        // same as before
  noveltyWeight: 0.25,        // gives less popular stories a chance
  randomWeight: 0.1,          // small exploration
  freshDaysBoost: 21,         // recent content boost
  freshBoostMultiplier: 1.4,  // stronger boost for fresh content
  explorationFraction: 0.25,
  cardsPerViewport: 6
};

// Session RNG (seeded per page load)
(function initStorySeed() {
  if (window.__STORY_RENDER_SEED) return;
  let extra = 0;
  if (typeof crypto !== 'undefined' && typeof crypto.getRandomValues === 'function') {
    const arr = new Uint32Array(1);
    crypto.getRandomValues(arr);
    extra = arr[0];
  } else {
    extra = Math.floor(Math.random() * 0xffffffff);
  }
  window.__STORY_RENDER_SEED = ((Date.now() & 0xffffffff) ^ extra) >>> 0;
})();
function mulberry32(seed) {
  let t = seed >>> 0;
  return function() {
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r = r + Math.imul(r ^ (r >>> 7), 61 | r) ^ r;
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  };
}
function rngForStoryRender() {
  return mulberry32(window.__STORY_RENDER_SEED);
}

// Utilities
function daysSince(dateString) {
  if (!dateString) return Number.MAX_SAFE_INTEGER;
  const d = new Date(dateString);
  if (isNaN(d)) return Number.MAX_SAFE_INTEGER;
  return Math.floor((Date.now() - d.getTime()) / (1000*60*60*24));
}
function normalizeArray(values) {
  const clean = values.map(v => Number.isFinite(v) ? v : 0);
  const min = Math.min(...clean);
  const max = Math.max(...clean);
  return max === min ? clean.map(() => 0.5) : clean.map(v => (v - min) / (max - min));
}
function shuffleArray(arr, rng=Math.random) {
  for (let i = arr.length-1; i>0; i--) {
    const j = Math.floor(rng()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function computeStoryPopularity(s) {
  const reads = Number(s.reads ?? s.readCount ?? 0);
  const likes = Number(s.likes ?? 0);
  return Math.log1p(reads) + 1.5*Math.log1p(likes);
}

// ================= SCORING =================
function scoredStories(stories, rng) {
  rng = rng || Math.random;

  const popArr = stories.map(computeStoryPopularity);
  const ageArr = stories.map(s => Math.max(0, 365 - Math.min(daysSince(s.published||s.createdAt||s.date||s.uploadedAt),365)));

  const popNorm = normalizeArray(popArr);
  const recNorm = normalizeArray(ageArr);

  return stories.map((s,i) => {
    const pop = popNorm[i];
    const rec = recNorm[i];
    const novelty = Math.max(0.2, 1-pop); // ensure new stories get minimum chance
    const randomEps = (rng ? rng() : Math.random()) * STORY_ALGO_CONFIG.randomWeight;

    let score = STORY_ALGO_CONFIG.popularityWeight*pop
              + STORY_ALGO_CONFIG.recencyWeight*rec
              + STORY_ALGO_CONFIG.noveltyWeight*novelty
              + randomEps;

    const ageDays = daysSince(s.published||s.createdAt||s.date||s.uploadedAt);
    if (ageDays <= STORY_ALGO_CONFIG.freshDaysBoost) score *= STORY_ALGO_CONFIG.freshBoostMultiplier;

    return Object.assign({}, s, {
      __score: score,
      __popNorm: pop,
      __recNorm: rec,
      __novelty: novelty,
      __ageDays: ageDays
    });
  });
}

// ================= EXPLORATION =================
function pickStoryExploration(candidates, count, rng) {
  if (!candidates || candidates.length===0 || count<=0) return [];
  rng = rng || Math.random;

  const scored = candidates.map(s => {
    const novelty = s.__novelty ?? 0.5;
    const recency = s.__recNorm ?? 0.5;
    return Object.assign({}, s, { __exploreScore: novelty*0.6 + recency*0.4 + rng()*0.1 });
  });

  scored.sort((a,b) => b.__exploreScore - a.__exploreScore);
  return shuffleArray(scored.slice(0, Math.min(count, scored.length)), rng);
}

// Demo stories generator
function generateDemoStories(count=50, rng) {
  rng = rng || rngForStoryRender();
  const genres=["Action","Romance","Comedy","Fantasy","Horror","Tragic","Thriller","Adventure","Crime","Historic"];
  const covers=[
    "https://picsum.photos/seed/demo1/600/900",
    "https://picsum.photos/seed/demo2/600/900",
    "https://picsum.photos/seed/demo3/600/900",
    "https://picsum.photos/seed/demo4/600/900",
    "https://picsum.photos/seed/demo5/600/900",
    "https://picsum.photos/seed/demo6/600/900"
  ];
  const stories=[];
  for(let i=0;i<count;i++){
    const genre=genres[Math.floor(rng()*genres.length)];
    const title=`${genre} Demo Story ${i+1}`;
    const readCount=Math.floor(rng()*1000);
    const likes=Math.floor(rng()*400);
    const daysAgo=Math.floor(rng()*400);
    const date=new Date(Date.now()-daysAgo*86400000).toISOString();
    stories.push({
      id:`demo-${i+1}`,
      title,
      genre,
      description:`Demo ${genre.toLowerCase()} story ‚Äî random readCount ${readCount}.`,
      cover:covers[i%covers.length],
      readCount,
      reads:readCount,
      likes,
      createdAt:date
    });
  }
  return stories;
}

// Main render function

function renderBrowseStories(
  selectedCategory = "All",
  opts = { includeDemo: false, demoCount: 50, mergeWithSaved: false }
) {
  const rng = rngForStoryRender();
  try {
    const storiesListDiv = document.getElementById("storiesBrowseList");
    const cards = document.getElementById("storiesCards");
    if (!cards) return;

    if (storiesListDiv) storiesListDiv.style.display = "block";
    cards.style.display = "block";
    cards.style.width = "100%";
    cards.style.flexWrap = "wrap";

    const allStoriesData = window.storiesData || [];
    const publicStories = allStoriesData.filter(
      (s) => s.status === "Public" || !s.status
    );

    let filteredStories =
      selectedCategory !== "All"
        ? publicStories.filter(
            (s) =>
              (s.genre || "").toLowerCase() === selectedCategory.toLowerCase()
          )
        : publicStories;

    const demoStories =
      (!filteredStories.length && opts.includeDemo)
        ? generateDemoStories(opts.demoCount || 50, rng)
        : [];

    let allStories = [...filteredStories, ...demoStories];
    if (!allStories.length) {
      if (storiesListDiv) storiesListDiv.style.display = "none";
      return;
    }

    const oldScrollX = {};
    cards.querySelectorAll("div[data-genre]").forEach((sec) => {
      const g = sec.dataset.genre;
      const sc = sec.querySelector(".scroll-wrap");
      if (sc) oldScrollX[g] = sc.scrollLeft;
    });

    const genresOrder = [
      "Action",
      "Romance",
      "Comedy",
      "Fantasy",
      "Horror",
      "Tragic",
      "Thriller",
      "Adventure",
      "Crime",
      "Historic",
    ];

    const grouped = {};
    allStories.forEach((s) => {
      const g = s.genre ? s.genre.trim() : "Other";
      if (!grouped[g]) grouped[g] = [];
      grouped[g].push(s);
    });

    const allScored = scoredStories(allStories, rng);
    const scoredMap = new Map();
    allScored.forEach((s) => scoredMap.set(s.id ?? s.title, s));

    const imagesToWait = [];

    genresOrder.forEach((genre) => {
      const list = grouped[genre];
      if (!list || list.length === 0) return;

      let section = cards.querySelector(`div[data-genre="${genre}"]`);
      if (!section) {
        section = document.createElement("div");
        section.dataset.genre = genre;
        section.style.display = "block";
        section.style.marginBottom = "32px";
        cards.appendChild(section);

        const heading = document.createElement("h3");
        heading.textContent = genre;
        heading.style.margin = "6px 12px";
        heading.style.textAlign = "left";
        section.appendChild(heading);
      }

      let scrollWrap = section.querySelector(".scroll-wrap");
      if (!scrollWrap) {
        scrollWrap = document.createElement("div");
        scrollWrap.className = "scroll-wrap";
        scrollWrap.style.display = "flex";
        scrollWrap.style.overflowX = "auto";
        scrollWrap.style.gap = "12px";
        scrollWrap.style.padding = "12px";
        scrollWrap.style.scrollBehavior = "smooth";
        scrollWrap.style.scrollbarWidth = "thin";
        scrollWrap.style.flexWrap = "nowrap";
        section.appendChild(scrollWrap);
      }
      scrollWrap.innerHTML = "";

      const scoredList = list.map(
        (s) =>
          scoredMap.get(s.id ?? s.title) ||
          Object.assign({}, s, { __score: rng() * 0.2 })
      );
      const sorted = scoredList.slice().sort((a, b) => b.__score - a.__score);

      const displayCount = Math.min(
        sorted.length,
        Math.max(STORY_ALGO_CONFIG.cardsPerViewport, Math.ceil(sorted.length))
      );
      const explorationCount = Math.ceil(
        displayCount * STORY_ALGO_CONFIG.explorationFraction
      );
      const topCandidates = sorted.slice(0, displayCount - explorationCount);
      const explorationPool = sorted.slice(displayCount - explorationCount);
      const explorationPicked = pickStoryExploration(
        explorationPool,
        explorationCount,
        rng
      );

      const finalList = [];
      const maxLen = Math.max(topCandidates.length, explorationPicked.length);
      for (let i = 0; i < maxLen; i++) {
        if (i < topCandidates.length) finalList.push(topCandidates[i]);
        if (i < explorationPicked.length) finalList.push(explorationPicked[i]);
      }
      if (!finalList.length)
        finalList.push(...sorted.slice(0, displayCount));
      shuffleArray(finalList, rng);

      finalList.forEach((s) => {
        const card = document.createElement("div");
        card.className = "story-card";
        card.dataset.title = s.title || "";
        card.style.minWidth = "260px";
        card.style.flex = "0 0 auto";
        card.style.borderRadius = "14px";
        card.style.padding = "14px";
        card.style.boxShadow = "0 6px 16px rgba(0,0,0,0.1)";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.style.justifyContent = "space-between";
        card.style.cursor = "pointer";
        card.style.position = "relative";
        card.style.transition = "box-shadow 0.25s ease-out";

        if (s.cover) {
          const img = new Image();
          img.src = s.cover;
          imagesToWait.push(
            new Promise((res) => {
              if (img.complete) return res();
              img.onload = img.onerror = () => res();
            })
          );
          card.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4),rgba(0,0,0,0.4)),url(${s.cover})`;
          card.style.backgroundSize = "cover";
          card.style.backgroundPosition = "center";
          card.style.color = "#fff";
        } else {
          const colorMap = {
            action: "#ff4b4b",
            romance: "#ff6fa8",
            comedy: "#ffd54f",
            tragic: "#4fc3f7",
            horror: "#000",
            fantasy: "#a78bfa",
            thriller: "#A52A2A",
            crime: "#FF0000",
            adventure: "#FF0000",
            historic: "#C0C0C0",
          };
          const color = colorMap[(s.genre || "").toLowerCase()] || "#888";
          card.style.background = color;
          card.style.color = color === "#000" ? "#fff" : "#000";
        }

        const titleEl = document.createElement("h4");
        titleEl.textContent = s.title || "Untitled";
        titleEl.style.margin = "0 0 6px";
        titleEl.style.fontSize = "17px";
        titleEl.style.fontWeight = "700";
        titleEl.style.textShadow = s.cover
          ? "1px 1px 3px rgba(0,0,0,0.6)"
          : "";

        const genreEl = document.createElement("p");
        genreEl.textContent = s.genre || "Unknown";
        genreEl.style.margin = "0 0 6px";
        genreEl.style.fontSize = "13px";
        genreEl.style.fontWeight = "600";
        genreEl.style.opacity = "0.9";
        genreEl.style.textShadow = s.cover
          ? "1px 1px 2px rgba(0,0,0,0.4)"
          : "";

        const desc = document.createElement("p");
        desc.textContent = s.description || "";
        desc.style.margin = "4px 0 8px";
        desc.style.fontSize = "14px";
        desc.style.lineHeight = "1.4";
        desc.style.overflow = "hidden";
        desc.style.display = "-webkit-box";
        desc.style.webkitLineClamp = "3";
        desc.style.webkitBoxOrient = "vertical";
        desc.style.textShadow = s.cover
          ? "1px 1px 2px rgba(0,0,0,0.4)"
          : "";

        const bottomRow = document.createElement("div");
        bottomRow.style.display = "flex";
        bottomRow.style.justifyContent = "space-between";
        bottomRow.style.alignItems = "center";
        bottomRow.style.marginTop = "auto";

        const reads = document.createElement("div");
        reads.textContent = "üëÅÔ∏è " + (s.reads || 0);
        reads.style.fontSize = "13px";
        reads.style.fontWeight = "600";

        const readBtn = document.createElement("button");
        readBtn.className = "btn btn-primary";
        readBtn.textContent = "Read";
        readBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          openPreviewFullScreen(s);
        });

        bottomRow.appendChild(reads);
        bottomRow.appendChild(readBtn);

        card.appendChild(titleEl);
        card.appendChild(genreEl);
        card.appendChild(desc);
        card.appendChild(bottomRow);

        scrollWrap.appendChild(card);
      });

      if (oldScrollX[genre] !== undefined) {
        const prevBehavior = scrollWrap.style.scrollBehavior;
        scrollWrap.style.scrollBehavior = "auto";
        scrollWrap.scrollLeft = oldScrollX[genre];
        scrollWrap.style.scrollBehavior = prevBehavior || "smooth";
      }
    });
  } catch (err) {
    console.warn("renderBrowseStories error:", err);
  }
}


// Example helper (you likely have your own implementation)
function openPreviewFullScreen(story) {
  // placeholder: implement your preview open logic
  console.log('Open preview for', story.title || story.id);
}

// Run render (explicitly disable demo cards by default)
renderBrowseStories('All', { includeDemo: false, demoCount: 0, mergeWithSaved: false });




    // open preview modal for a story object
    function openPreview(story){
      const modal = document.getElementById('previewModal');
      document.getElementById('previewTitle').textContent = story.title;
      const profileRaw = localStorage.getItem(STORAGE_KEY);
      let author = '‚Äî';
      if(profileRaw){ try{ const p = JSON.parse(profileRaw); author = p.name || '‚Äî'; }catch(e){} }
      const dateStr = story.publishedOn || new Date().toISOString().split('T')[0];
      document.getElementById('previewMeta').textContent = `${story.genre || '‚Äî'} ‚Ä¢ Written by ${author} ‚Ä¢ Written on ${dateStr}`;
      document.getElementById('previewDesc').textContent = story.description || '';
      // pick random sentence(s) from sheets
      let snippet = '';
      try{
        const allText = (story.sheets||[]).map(sh => sh.content || '').join(' ');
        const sentences = allText.split(/(?<=[.!?])\s+/).filter(Boolean);
        for(let i=0;i<3 && i<sentences.length;i++){
          const r = Math.floor(Math.random()*sentences.length);
          snippet += (sentences[r] || '') + ' ';
        }
        snippet = snippet.trim().slice(0,300) + (snippet.length>300 ? '...' : '');
      }catch(e){ snippet = (story.sheets && story.sheets[0] && story.sheets[0].content.slice(0,200)) || ''; }
      document.getElementById('previewSnippet').textContent = snippet;
      modal.classList.remove('hidden');
      document.getElementById('previewCloseBtn').onclick = ()=> modal.classList.add('hidden');
      document.getElementById('startReadingBtn').onclick = ()=> { modal.classList.add('hidden'); openReader(story); };
    }

    // Reader
    let _currentReader = { story:null, sheetIndex:0 };
    function openReader(story){
      const modal = document.getElementById('readerModal');
      const titleEl = document.getElementById('readerTitle');
      const metaEl = document.getElementById('readerMeta');
      const sheetEl = document.getElementById('readerSheet');
      const pager = document.getElementById('readerPager');
      _currentReader.story = story;
      _currentReader.sheetIndex = 0;
      titleEl.textContent = story.title;
      const profileRaw = localStorage.getItem(STORAGE_KEY);
      let author = '‚Äî';
      if(profileRaw){ try{ const p = JSON.parse(profileRaw); author = p.name || '‚Äî'; }catch(e){} }
      const dateStr = story.publishedOn || new Date().toISOString().split('T')[0];
      metaEl.textContent = `${story.genre || '‚Äî'} ‚Ä¢ Written by ${author} ‚Ä¢ Published on ${dateStr}`;
      function renderSheet(){
        const sheets = story.sheets || [];
        const s = sheets[_currentReader.sheetIndex] || { content: '' };
        sheetEl.textContent = s.content || '';
        pager.textContent = `${_currentReader.sheetIndex+1} / ${Math.max(1,sheets.length)}`;
        document.getElementById('readerPrevBtn').disabled = _currentReader.sheetIndex===0;
        document.getElementById('readerNextBtn').disabled = _currentReader.sheetIndex >= sheets.length-1;
      }
      document.getElementById('readerPrevBtn').onclick = ()=> { if(_currentReader.sheetIndex>0) _currentReader.sheetIndex--; renderSheet(); };
      document.getElementById('readerNextBtn').onclick = ()=> { if((_currentReader.sheetIndex+1) < (story.sheets||[]).length) _currentReader.sheetIndex++; renderSheet(); };
      document.getElementById('readerCloseBtn').onclick = ()=> { modal.classList.add('hidden'); };
      document.getElementById('readerDownloadBtn').onclick = ()=> { downloadSingleStory(story); };
      // simple swipe support
      let startX = null;
      const readerContent = document.getElementById('readerContent');
      readerContent.ontouchstart = (e)=> { startX = e.touches[0].clientX; };
      readerContent.ontouchend = (e)=> {
        if(startX==null) return;
        const dx = e.changedTouches[0].clientX - startX;
        if(dx < -40){ // swipe left -> next
          if(_currentReader.sheetIndex < (story.sheets||[]).length-1) _currentReader.sheetIndex++;
        } else if(dx > 40){ // swipe right -> prev
          if(_currentReader.sheetIndex > 0) _currentReader.sheetIndex--;
        }
        renderSheet();
        startX = null;
      };
      modal.classList.remove('hidden');
      renderSheet();
    }

    // Download functions
    function downloadAllContent(){
      const data = { stories: storiesData, serials: serialsData, exportedOn: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'writer_content_export_'+(new Date().toISOString().slice(0,10))+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function downloadSingleStory(story){
      const blob = new Blob([JSON.stringify(story, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (story.title || 'story').replace(/[^\w\-]/g,'_') + '.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    // wire dashboard download button
    document.addEventListener('click', function(e){
      if(e.target && e.target.id === 'dashboardDownloadBtn') downloadAllContent();
    });

    // Ensure published stories show up in Browse after publish/save (hook used in createEditorPage)
    const originalPublishHook = null; // placeholder
    // We'll monkey-patch the place where storiesData is pushed: after publish or saveDraft in createEditorPage, renderBrowseStories is called.
    // To be safe, call renderBrowseStories periodically and when dashboard opens.
    setInterval(()=>{ renderBrowseStories(currentCategorySelection || 'All'); }, 1200);
 
    // hook categories selection to render browse list appropriately
    const cats = document.querySelectorAll('.cat-card');
    let currentCategorySelection = 'All';
    function attachCategoryClicks(){
      const grid = document.getElementById('categoriesGrid');
      if(!grid) return;
      grid.querySelectorAll('.cat-card').forEach(c=>{
        c.addEventListener('click', ()=>{
          const cat = c.querySelector('.cat-title').textContent || 'All'; currentCategorySelection = cat;
          renderBrowseStories(cat);
        });
      });
    }
    // attach on DOM ready
    window.addEventListener('DOMContentLoaded', ()=>{ setTimeout(attachCategoryClicks, 400); });

    // Fix profile header visibility when returning from dashboard - ensure profile button shown on welcome page
    dashboardBackBtn.addEventListener('click', ()=>{ dashboardPage.classList.add('hidden'); welcomePage.classList.remove('hidden'); dashboardBackBtn.classList.add('hidden'); profileBtn.style.display = 'inline-flex'; });

    // Also whenever showDashboard is called, ensure profile button hidden and dropdown closed
    const originalShowDashboard = showDashboard;
    showDashboard = function(type, genreFilter){ profileBtn.style.display = 'none'; profileDropdown.style.display = 'none'; originalShowDashboard(type, genreFilter); };

    // Ensure renderBrowseStories runs when storiesData changes: override publish/save code paths by wrapping push functions
    // To keep it simple, we override the global arrays' push to call renderBrowseStories after new story added (only for storiesData)
    (function(){
      const origPush = storiesData.push;
      storiesData.push = function(){
        const res = origPush.apply(this, arguments);
        try{ renderBrowseStories(currentCategorySelection || 'All'); }catch(e){};
        return res;
      };
    })();

    // Also when editor publishes (the code in createEditorPage already pushes and then calls showDashboard), but renderBrowseStories will update automatically.
    // Finally, when page loads, render browse stories once
    window.addEventListener('load', ()=>{ setTimeout(()=> renderBrowseStories('All'), 600); });

// Call preview automatically if URL contains ?previewStory=
window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const titleFromURL = params.get("previewStory");
  if (titleFromURL) {
    openPreviewFullScreen(decodeURIComponent(titleFromURL));
  }
});

async function openPreviewFullScreen(story){
  const previewFull = document.getElementById('previewFull');
  previewFull.innerHTML = '';

  const panel = document.createElement('div');
  panel.className = 'fullscreen-panel';
  const inner = document.createElement('div');
  inner.className = 'panel-inner';

  function escapeHtml(str){
    return String(str == null ? '' : str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  const storyTitle = story?.title?.trim() || "Untitled Story";
  const storyKey = encodeURIComponent(storyTitle);
  const dateStr = story.publishedOn || new Date().toISOString().split('T')[0];

  let snippet = "";
  try{
    const first = story.sheets?.[0]?.content || story.sheets?.[0] || "";
    snippet = first.toString().split(/(?<=[.!?])\s+/).slice(0,2).join(" ").slice(0,350);
  }catch(e){}

  // UI
  inner.innerHTML = `
    <h1>${escapeHtml(storyTitle)}</h1>
    <div>${escapeHtml(story.description||"")}</div>
    <div style="margin-top:6px;color:#666">
  Author: <span>${escapeHtml(story.writerName || 'Unknown')}</span> ‚Ä¢ 
  ${escapeHtml(story.publishDate || new Date().toISOString().split('T')[0])}
</div>


    <div style="margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <span>Genre: ${escapeHtml(story.genre||"‚Äî")}</span>
      <span id="previewReadCount" style="background:#000;color:#fff;padding:2px 6px;border-radius:4px;">üëÅÔ∏è ${story.reads||0} Reads</span>

      <button id="previewCommentsBtn" style="padding:4px 10px;border:none;border-radius:6px;background:#00eaff;box-shadow:0 0 8px #00eaff;cursor:pointer;">üí¨ Comments</button>
      <button id="previewShareBtn" style="padding:4px 10px;border:none;border-radius:6px;background:#ff00e0;box-shadow:0 0 8px #ff00e0;cursor:pointer;">‚Üó Share</button>
      <span id="previewCommentsCount" style="color:#666;"></span>
    </div>

    <div style="margin-top:10px;font-style:italic;color:#555;">${escapeHtml(snippet)}</div>

    <div style="display:flex;gap:14px;margin-top:18px;flex-wrap:wrap;align-items:center;">
      <button id="previewCloseBtn" class="btn btn-secondary">Close</button>
      <button id="previewStartBtn" class="btn btn-primary">Start Reading</button>

      <!-- Like / Dislike UI -->
      <div id="voteControls" style="display:flex;gap:8px;align-items:center;margin-left:8px;">
        <button id="previewLikeBtn" aria-pressed="false" title="Like" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;border:1px solid #cfd8e3;background:#f4f8ff;cursor:pointer;">
          üëç <span id="likeCount">0</span>
        </button>
        <button id="previewDislikeBtn" aria-pressed="false" title="Dislike" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;border:1px solid #f1c8d6;background:#fff5f7;cursor:pointer;">
          üëé <span id="dislikeCount">0</span>
        </button>
      </div>
    </div>
  `;

  panel.appendChild(inner);
  previewFull.appendChild(panel);
  previewFull.classList.remove('hidden');

  const fb = window._firebase || {};
  const db = fb.db, fbRef = fb.ref, fbGet = fb.get, fbSet = fb.set, fbOnValue = fb.onValue;
  const root = `stories/${storyKey}`;

  const readCountEl = inner.querySelector("#previewReadCount");
  const commentsCountEl = inner.querySelector("#previewCommentsCount");
  const likeBtn = inner.querySelector("#previewLikeBtn");
  const dislikeBtn = inner.querySelector("#previewDislikeBtn");
  const likeCountEl = inner.querySelector("#likeCount");
  const dislikeCountEl = inner.querySelector("#dislikeCount");

  // helper to set button styles for active/inactive
  function setLikeActive(active){
    likeBtn.style.background = active ? '#e6f0ff' : '#f4f8ff';
    likeBtn.style.borderColor = active ? '#3b82f6' : '#cfd8e3';
    likeBtn.style.color = active ? '#0b66ff' : 'inherit';
    likeBtn.setAttribute('aria-pressed', active ? 'true' : 'false');
  }
  function setDislikeActive(active){
    dislikeBtn.style.background = active ? '#ffecec' : '#fff5f7';
    dislikeBtn.style.borderColor = active ? '#ff3b6e' : '#f1c8d6';
    dislikeBtn.style.color = active ? '#ff0033' : 'inherit';
    dislikeBtn.setAttribute('aria-pressed', active ? 'true' : 'false');
  }

  // Load live read count and vote counts if firebase realtime is available
  if(db && fbOnValue){
    fbOnValue(fbRef(db, root), snap=>{
      const v = snap.val()||{};
      readCountEl.textContent = `üëÅÔ∏è ${v.reads||0} Reads`;
      likeCountEl.textContent = (v.likes||0);
      dislikeCountEl.textContent = (v.dislikes||0);
    });
  } else {
    // fallback to initial provided values
    readCountEl.textContent = `üëÅÔ∏è ${story.reads||0} Reads`;
    likeCountEl.textContent = story.likes || 0;
    dislikeCountEl.textContent = story.dislikes || 0;
  }

  // Initialize local vote state from localStorage
  const localKey = `vote_${storyKey}`;
  let localVote = localStorage.getItem(localKey); // 'like' | 'dislike' | null
  setLikeActive(localVote === 'like');
  setDislikeActive(localVote === 'dislike');

  // Helper to safely get numeric value from firebase path
  async function getNumber(path){
    try{
      if(!db || !fbGet) return 0;
      const snap = await fbGet(fbRef(db, path));
      return snap.exists() ? Number(snap.val()) : 0;
    }catch(e){ return 0; }
  }

  // Performs the vote update logic:
  // - If user clicks same vote again -> remove vote
  // - If user clicks opposite -> remove other, add this one
  // Update counts stored as numbers at root/likes and root/dislikes
  async function applyVote(newVote){ // newVote: 'like' | 'dislike'
    if(!db || !fbGet || !fbSet || !fbRef) {
      // local-only fallback
      const like = Number(likeCountEl.textContent||0);
      const dislike = Number(dislikeCountEl.textContent||0);
      if(localVote === newVote){
        // remove
        if(newVote === 'like'){ likeCountEl.textContent = Math.max(0, like-1); setLikeActive(false); localVote = null; localStorage.removeItem(localKey); }
        else { dislikeCountEl.textContent = Math.max(0, dislike-1); setDislikeActive(false); localVote = null; localStorage.removeItem(localKey); }
      } else {
        // switch
        if(newVote === 'like'){
          likeCountEl.textContent = like + 1;
          if(localVote === 'dislike') dislikeCountEl.textContent = Math.max(0, dislike-1);
          setLikeActive(true); setDislikeActive(false);
        } else {
          dislikeCountEl.textContent = dislike + 1;
          if(localVote === 'like') likeCountEl.textContent = Math.max(0, like-1);
          setDislikeActive(true); setLikeActive(false);
        }
        localVote = newVote; localStorage.setItem(localKey,newVote);
      }
      return;
    }

    // Read current counts
    try{
      const [likesNow, dislikesNow] = await Promise.all([
        getNumber(`${root}/likes`),
        getNumber(`${root}/dislikes`)
      ]);
      let newLikes = likesNow;
      let newDislikes = dislikesNow;

      if(localVote === newVote){
        // user is un-voting
        if(newVote === 'like') newLikes = Math.max(0, newLikes - 1);
        else newDislikes = Math.max(0, newDislikes - 1);
        localVote = null;
        localStorage.removeItem(localKey);
      } else {
        // applying a new vote
        if(newVote === 'like'){
          newLikes = newLikes + 1;
          if(localVote === 'dislike' && newDislikes > 0) newDislikes = Math.max(0, newDislikes - 1);
        } else { // dislike
          newDislikes = newDislikes + 1;
          if(localVote === 'like' && newLikes > 0) newLikes = Math.max(0, newLikes - 1);
        }
        localVote = newVote;
        localStorage.setItem(localKey,newVote);
      }

      // Write back both counts in one go
      // If your Firebase rules prefer numeric children only, adjust accordingly.
      await fbSet(fbRef(db, `${root}/likes`), newLikes);
      await fbSet(fbRef(db, `${root}/dislikes`), newDislikes);

      // Optimistic UI update
      likeCountEl.textContent = newLikes;
      dislikeCountEl.textContent = newDislikes;
      setLikeActive(localVote === 'like');
      setDislikeActive(localVote === 'dislike');
    }catch(err){
      console.error("Vote update failed:", err);
    }
  }

  // Button handlers
  likeBtn.onclick = async ()=>{
    likeBtn.disabled = true;
    try{ await applyVote('like'); }catch(e){console.error(e);} finally{ likeBtn.disabled = false; }
  };
  dislikeBtn.onclick = async ()=>{
    dislikeBtn.disabled = true;
    try{ await applyVote('dislike'); }catch(e){console.error(e);} finally{ dislikeBtn.disabled = false; }
  };

  // START READING
  inner.querySelector("#previewStartBtn").onclick = ()=>{
    previewFull.classList.add("hidden");
    if(typeof openReaderFullScreen==="function") openReaderFullScreen(story);
    (async()=>{try{
      const r = await fbGet(fbRef(db,`${root}/reads`));
      await fbSet(fbRef(db,`${root}/reads`),(r.exists()?r.val():0)+1);
    }catch(e){}})();
  };

  inner.querySelector("#previewCloseBtn").onclick = ()=> previewFull.classList.add("hidden");
// SHARE MENU
const shareBtn = inner.querySelector("#previewShareBtn");
let menu=document.createElement("div");
menu.style.cssText="position:absolute;display:none;background:#fff;border:1px solid #ddd;padding:6px;border-radius:10px;z-index:99999;box-shadow:0 6px 18px rgba(0,0,0,0.18);";
document.body.appendChild(menu);

["WhatsApp","Facebook","Twitter","Copy"].forEach(name=>{
  const b=document.createElement("button");
  b.textContent=name;
  b.style.cssText="display:block;width:100%;padding:6px 10px;text-align:left;border:none;background:none;cursor:pointer;";
  b.onclick=async()=>{
    
    const link = `https://meurbal.site?previewStory=${encodeURIComponent(storyTitle)}`;

    if(name==="Copy"){ 
      try{ await navigator.clipboard.writeText(link); b.textContent="‚úÖ Copied!"; setTimeout(()=>b.textContent=name,1200);}catch(e){} 
    }
    else window.open(
      name==="WhatsApp" ?
        `https://api.whatsapp.com/send?text=` +
          encodeURIComponent(`${storyTitle} - ${storyGenre.value}. Read this story only on Meurbal: ${link}`) :
      name==="Facebook" ?
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}` :
        `https://twitter.com/intent/tweet?text=` +
          encodeURIComponent(`${storyTitle} - ${storyGenre.value}. Read this story only on Meurbal: ${link}`),
      "_blank"
    );

    menu.style.display="none";
  };
  menu.appendChild(b);
});

shareBtn.onclick = (e)=>{
  const r = shareBtn.getBoundingClientRect();
  menu.style.top = `${r.top + window.scrollY}px`;
  menu.style.left = `${r.right + 10}px`;
  menu.style.display = "block";
};

document.addEventListener("click",(e)=>{
  if(!menu.contains(e.target) && e.target !== shareBtn) menu.style.display="none";
});


  // COMMENTS PANEL
  const commentsRef = fbRef(db, `${root}/comments`);
  if(db && fbOnValue){
    fbOnValue(commentsRef,snap=>{
      commentsCountEl.textContent = snap.exists() ? `${Object.keys(snap.val()).length} comments` : `0 comments`;
    });
  }

  inner.querySelector("#previewCommentsBtn").onclick = openCommentsPanel;

  async function openCommentsPanel(){
    let p=document.getElementById("previewCommentsFull");
    if(p) p.remove();
    p=document.createElement("div");
    p.id="previewCommentsFull";
    p.style.cssText="position:fixed;inset:0;background:#fff;z-index:999999;display:flex;flex-direction:column;";
    p.innerHTML=`
      <div style="background:linear-gradient(135deg, #4facfe, #ffffff);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;">
        <span>${escapeHtml(storyTitle)} ‚Äî <span id="liveCommentCount">0</span> Comments</span>
        <button id="closeCmt" style="background:none;border:none;color:#fff;font-size:22px;cursor:pointer;">‚úï</button>
      </div>
      <div id="cmtList" style="flex:1;overflow-y:auto;padding:14px;background:#f5f7fb;">Loading...</div>
      <div style="padding:12px;display:flex;border-top:1px solid #ddd;background:#fafafa;">
        <textarea id="cmtInput" placeholder="Write a comment..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #ccc;"></textarea>
        <button id="cmtSend" class="btn btn-primary" style="margin-left:10px;">Post</button>
      </div>`;
    document.body.appendChild(p);
    document.getElementById("closeCmt").onclick=()=>p.remove();
    document.getElementById("cmtSend").onclick=sendComment;
    loadComments();
  }

  async function loadComments(){
    const list=document.getElementById("cmtList");
    const count=document.getElementById("liveCommentCount");
    const snap = await fbGet(commentsRef);
    if(!snap.exists()){list.innerHTML="<p>No comments yet.</p>";count.textContent="0";return;}
    const arr=Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
    count.textContent=arr.length;
    list.innerHTML=arr.map(c=>{
      const replyCount = c.replies ? Object.keys(c.replies).length : 0;
      return `
      <div class="comment-item" data-id="${c.id}" style="background:#fff;padding:12px;border-radius:10px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.08);">
        <div style="font-weight:600">${c.user}</div>
        <div>${c.text}</div>
        <div style="font-size:12px;color:#777">${new Date(c.ts).toLocaleString()}</div>

        <div style="display:flex;gap:10px;margin-top:6px;">
          <button class="replyBtn">üí¨ Reply</button>
          <button class="viewRepliesBtn" style="display:${replyCount>0?"inline-block":"none"}">Replies (${replyCount})</button>
        </div>

        <div class="replyInput" style="display:none;margin-top:6px;">
          <input class="replyText" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:6px;">
          <button class="sendReplyBtn">Reply</button>
        </div>

        <div class="replies" style="display:none;margin-top:8px;"></div>
      </div>`;
    }).join("");

    list.querySelectorAll(".comment-item").forEach(el=>{
      const id=el.dataset.id;
      el.querySelector(".replyBtn").onclick=()=>toggleReply(el);
      el.querySelector(".sendReplyBtn").onclick=()=>sendReply(id,el);
      const vr = el.querySelector(".viewRepliesBtn");
      if(vr) vr.onclick=()=>toggleReplyList(el,id);
      loadReplies(id,el);
    });
  }

  async function sendComment(){
    const i=document.getElementById("cmtInput");
    const t=i.value.trim(); if(!t) return;
    const u=localStorage.getItem("username")||"Reader";
    const key="c_"+Date.now();
    const snap=await fbGet(commentsRef);
    let obj=snap.exists()?snap.val():{};
    obj[key]={id:key,user:u,text:t,ts:Date.now()};
    await fbSet(commentsRef,obj);
    i.value=""; loadComments();
  }

  async function loadReplies(id, el){
    const repRef=fbRef(db, `${root}/comments/${id}/replies`);
    const snap=await fbGet(repRef);
    const box=el.querySelector(".replies");
    if(!snap.exists()){ box.innerHTML=""; return; }
    const arr=Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
    box.innerHTML=arr.map(r=>`
      <div style="padding:8px;margin-top:6px;background:#f0f2f6;border-radius:6px;">
        <div style="font-weight:600">${r.user}</div>
        <div>${r.text}</div>
        <div style="font-size:12px;color:#777">${new Date(r.ts).toLocaleString()}</div>
      </div>
    `).join("");
  }

  function toggleReply(el){
    const box=el.querySelector(".replyInput");
    box.style.display = box.style.display==="flex" ? "none" : "flex";
  }

  function toggleReplyList(el,id){
    const box=el.querySelector(".replies");
    box.style.display = box.style.display==="none" ? "block" : "none";
  }

  async function sendReply(id, el){
    const t=el.querySelector(".replyText").value.trim(); if(!t) return;
    const u=localStorage.getItem("username")||"Guest";
    const repRef=fbRef(db, `${root}/comments/${id}/replies`);
    const snap=await fbGet(repRef);
    let r=snap.exists()?snap.val():{};
    const rid="r_"+Date.now();
    r[rid]={id:rid,user:u,text:t,ts:Date.now()};
    await fbSet(repRef,r);
    el.querySelector(".replyText").value="";
    loadComments();
  }
}

function openReaderFullScreen(story) {
  const readerFull = document.getElementById("readerFull");
  readerFull.innerHTML = "";

  // ====== PANEL ======
  const panel = document.createElement("div");
  Object.assign(panel.style, {
    position: "fixed",
    top: 0,
    left: 0,
    width: "100vw",
    height: "100vh",
    background: "#f7f7fb",
    zIndex: 1200,
    display: "flex",
    flexDirection: "column",
  });

  // ====== HEADER ======
  const header = document.createElement("div");
  Object.assign(header.style, {
    display: "flex",
    justifyContent: "space-between",
    alignItems: "center",
    padding: "12px 18px",
    background: "#fff",
  });

  const profileRaw = localStorage.getItem(STORAGE_KEY);
  let author = "‚Äî";
  if (profileRaw) {
    try {
      author = JSON.parse(profileRaw).name || "‚Äî";
    } catch (e) {}
  }
  const dateStr = story.publishedOn || new Date().toISOString().split("T")[0];

  header.innerHTML = `
    <div>
      <strong>${escapeHtml(story.title)}</strong>
      <div class="muted" style="font-size:12px">
        ${escapeHtml(story.genre || "‚Äî")}
      </div>
    </div>
    <div><button id="readerCloseFullBtn" class="btn btn-secondary">Close</button></div>
  `;
  panel.appendChild(header);

  // ====== BODY ======
  const body = document.createElement("div");
  Object.assign(body.style, {
    flex: 1,
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "flex-start",
    padding: "20px",
  });

  // ====== BOOK (Dual Pages for Flip) ======
  const book = document.createElement("div");
book.style.cssText = `
  position: relative;
  perspective: 2000px;
  width: 880px;
  max-width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;   /* iPhone scrolling */
`;

  const pageFront = document.createElement("div");
  const pageBack = document.createElement("div");
  [pageFront, pageBack].forEach((p) => {
    Object.assign(p.style, {
      position: "absolute",
      inset: 0,
      padding: "28px",
      background: "#fffef9",
      border: "1px solid #e5d7b7",
      borderRadius: "12px",
      boxShadow: "0 12px 26px rgba(0,0,0,0.15)",
      fontFamily: `'Georgia','Times New Roman',serif`,
      fontSize: "16px",
      lineHeight: "1.7",
      color: "#2e2b23",
      textAlign: "justify",
      backfaceVisibility: "hidden",
      transformStyle: "preserve-3d",
      overflowY: "auto",
    });
  });
  pageBack.style.transform = "rotateY(180deg)";
  book.appendChild(pageFront);
  book.appendChild(pageBack);
  body.appendChild(book);

  // ====== CONTROLS ======
  const controls = document.createElement("div");
  Object.assign(controls.style, {
    display: "flex",
    flexWrap: "wrap",
    gap: "6px",
    marginTop: "18px",
    justifyContent: "center",
  });
  controls.innerHTML = `
    <button id="prevFullBtn" class="btn btn-secondary">‚óÄ Prev</button>
    <button id="nextFullBtn" class="btn btn-secondary">Next ‚ñ∂</button>
  <button id="zenModeBtn" class="btn btn-secondary">üåô Zen Shield</button>
    <button id="markLastBtn" class="btn btn-primary">‚úèÔ∏è Mark Last Read</button>
    <button id="removeMarkBtn" class="btn btn-danger">üóëÔ∏è Remove Last Read</button>
    <button id="narrateBtn" class="btn btn-secondary">üéß Narrate</button>
  `;
  body.appendChild(controls);
// ====== ZEN MODE FUNCTION (Full Sheet Immersive) ======
function activateZenMode() {
  const existing = document.getElementById("zenOverlay");
  if (existing) {
    existing.remove();
    document.body.style.overflow = "";
    return;
  }

  // ‚úÖ Get current visible story page (pageFront)
  let content = "";
  if (typeof pageFront !== "undefined" && pageFront.innerHTML.trim()) {
    content = pageFront.innerHTML.trim();
  } else {
    content = "<p>No content available...</p>";
  }

  // Hide the rest of UI
  const uiEls = document.querySelectorAll(
    "#bottomNav, header, .popup, .form-container, .nav-btn, .profile-btn, #readerModal"
  );
  uiEls.forEach(el => (el.style.display = "none"));

  // === Overlay Container ===
  const overlay = document.createElement("div");
  overlay.id = "zenOverlay";
  overlay.style.cssText = `
    position: fixed;
    inset: 0;
    z-index: 999999;
    background: radial-gradient(circle at center, rgba(255,255,255,0.9) 20%, rgba(240,230,200,0.8) 100%);
    backdrop-filter: blur(10px) brightness(0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease-in-out;
    overflow: hidden;
  `;

  // === Content Area ===
  const textWrap = document.createElement("div");
  textWrap.id = "zenTextArea";
  textWrap.innerHTML = content;
  textWrap.style.cssText = `
    width: 880px;
    max-width: 90vw;
    height: 460px;
    max-height: 80vh;
    background: #fffef9;
    border: 1px solid #e5d7b7;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    padding: 40px 50px;
    overflow-y: auto;
    font-family: 'Georgia', serif;
    font-size: 18px;
    line-height: 1.8;
    color: #2e2b23;
    text-align: justify;
    animation: zenFadeIn 0.6s ease;
  `;

  // === Controls ===
  const btnRow = document.createElement("div");
  btnRow.style.cssText = `
    display: flex;
    justify-content: center;
    margin-top: 20px;
  `;

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "üõ° Close Shield Mode";
  closeBtn.className = "btn btn-secondary";
  closeBtn.style.cssText = `
    padding: 12px 20px;
    border-radius: 12px;
    background: linear-gradient(135deg, #ff5f6d, #ffc371);
    color: white;
    font-weight: 700;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    cursor: pointer;
  `;
  closeBtn.onclick = () => {
    overlay.remove();
    document.body.style.overflow = "";
    uiEls.forEach(el => (el.style.display = ""));
  };

  btnRow.append(closeBtn);
  overlay.append(textWrap, btnRow);
  document.body.appendChild(overlay);
  document.body.style.overflow = "hidden";
}

// ====== EVENT HANDLER ======
document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "zenModeBtn") {
    activateZenMode();
  }
});
// ====== SMOOTH FADE ANIMATION ======
const style = document.createElement("style");
style.textContent = `
@keyframes zenFadeIn {
  from { opacity:0; transform:scale(0.97); }
  to { opacity:1; transform:scale(1); }
}`;
document.head.appendChild(style);  // ====== NARRATION CONTROLS ======
  const narrationControls = document.createElement("div");
  Object.assign(narrationControls.style, {
    display: "none",
    marginTop: "12px",
    gap: "10px",
    justifyContent: "center",
    alignItems: "center",
    position: "relative",
  });
  narrationControls.innerHTML = `
    <button id="pauseNarrationBtn" class="btn btn-secondary">‚è∏Ô∏è Pause</button>
    <button id="stopNarrationBtn" class="btn btn-danger">‚èπÔ∏è Stop</button>
    <button id="voiceSelectBtn" class="btn btn-primary">üé§ Voice ‚ñæ</button>
    <label style="font-weight:600;">Speed:
      <input type="range" id="speedRange" min="0.6" max="1.6" step="0.05" value="1">
    </label>
    <div id="voiceDropdown" style="
      display:none;position:absolute;top:44px;right:0;
      background:white;border:1px solid #ccc;border-radius:8px;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);z-index:3001;min-width:160px;
    ">
      <button data-voice="boy" style="display:block;width:100%;border:none;background:white;padding:10px;text-align:left;">üë¶ Boy</button>
      <button data-voice="girl" style="display:block;width:100%;border:none;background:white;padding:10px;text-align:left;">üëß Girl</button>
    </div>
  `;
  body.appendChild(narrationControls);
  panel.appendChild(body);
  readerFull.appendChild(panel);
  readerFull.classList.remove("hidden");

  // ====== PAGE FLIP ANIMATION CSS ======
  if (!document.getElementById("__book_flip_style")) {
    const style = document.createElement("style");
    style.id = "__book_flip_style";
    style.textContent = `
      @keyframes turnNextFront { 0%{transform:rotateY(0deg);z-index:2}100%{transform:rotateY(-180deg);z-index:1} }
      @keyframes turnNextBack  { 0%{transform:rotateY(180deg);z-index:1}100%{transform:rotateY(0deg);z-index:2} }
      .word{cursor:pointer;display:inline;white-space:pre-wrap;}
      .highlight{background:yellow;border-radius:3px;}
    `;
    document.head.appendChild(style);
  }

  // ====== UTILITIES ======
  function showToast(msg) {
    const popup = document.createElement("div");
    popup.textContent = msg;
    Object.assign(popup.style, {
      position: "fixed",
      top: "50%",
      left: "50%",
      transform: "translate(-50%,-50%)",
      background: "rgba(0,0,0,0.85)",
      color: "#fff",
      padding: "14px 18px",
      borderRadius: "8px",
      zIndex: 5000,
      fontSize: "14px",
      opacity: 0,
      transition: "opacity .25s",
    });
    document.body.appendChild(popup);
    requestAnimationFrame(() => (popup.style.opacity = "1"));
    setTimeout(() => {
      popup.style.opacity = "0";
      setTimeout(() => popup.remove(), 300);
    }, 1600);
  }
  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"]/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[m]));
  }

  // ====== STORY STATE ======
  const sheets = story.sheets || [{ content: "" }];
  let idx = 0;
  const savedKey = `lastReadPos_${story.id || story.title}`;
  let markingMode = false;

  // TTS state & resume tracking
  let voices = [],
    currentVoice = "boy",
    currentRate = 1.0,
    utterance = null,
    utteranceActive = false,
    resumeChar = 0,
    isPaused = false;

  // wordRanges for mapping char->word index on current page (recalculated on render)
  let wordRanges = [];

  // ====== LOAD VOICES ======
  function loadVoices() {
    voices = speechSynthesis.getVoices();
    if (!voices.length) setTimeout(loadVoices, 250);
  }
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  function pickVoice(role) {
    if (!voices.length) return null;
    const pick = (rx) => voices.find((v) => rx.test(v.name) || (v.lang && rx.test(v.lang)));
    if (role === "boy") return pick(/male|david|daniel|alex|john|peter/i) || voices[0];
    if (role === "girl") return pick(/female|susan|samantha|victoria|anna|kate/i) || voices[0];
    return voices[0];
  }

  // ====== RENDER PAGE INTO ELEMENT (word spans) ======
function renderIntoElement(el, pageIndex, highlightWordIndex = -1) {
  const text = (sheets[pageIndex] && sheets[pageIndex].content) || "";
  el.innerHTML = "";

  // üî• Create scrollable inner wrapper
  const wrap = document.createElement("div");
  wrap.className = "pageContentWrap";
  wrap.style.cssText = `
    max-height: 90vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 40px;
  `;

  wordRanges = [];
  let pos = 0;
  const words = text.replace(/\n+/g, " \n ").split(/\s+/).filter(Boolean);

  words.forEach((w, wi) => {
    const span = document.createElement("span");
    span.className = "word";
    span.dataset.wordIndex = wi;
    span.textContent = w + " ";

    const start = pos;
    const end = start + span.textContent.length;
    wordRanges.push([start, end]);
    pos = end;

    span.addEventListener("click", () => {
      if (markingMode) {
        markingMode = false;
        localStorage.setItem(savedKey, JSON.stringify({ sheetIndex: pageIndex, wordIndex: wi }));
        highlightWordInElement(wrap, wi);
        showToast(`‚úÖ Marked at word: ${wi + 1}`);
        enableRemoveBtn(true);
      }
    });

    if (wi === highlightWordIndex) span.classList.add("highlight");
    wrap.appendChild(span);
  });

  el.appendChild(wrap);
}
// ====== PAGE COUNTER ======
const pageCounter = document.createElement("div");
pageCounter.id = "pageCounter";
pageCounter.style.cssText = `
  margin-top: 8px;
  font-weight: 600;
  font-size: 15px;
`;
pageCounter.textContent = `Page 1 / ${sheets.length}`;
body.appendChild(pageCounter);

// ====== PAGE NAV BUTTON LOGIC ======
const prevFullBtn = document.getElementById("prevFullBtn");
const nextFullBtn = document.getElementById("nextFullBtn");

// üî• Counter updater
function updateCounter() {
  pageCounter.textContent = `Page ${idx + 1} / ${sheets.length}`;
}

// üî• Flip prev page
prevFullBtn.onclick = () => {
  if (idx > 0) {
    idx--;
    renderIntoElement(pageFront, idx);
    updateCounter();
  }
};

// üî• Flip next page
nextFullBtn.onclick = () => {
  if (idx < sheets.length - 1) {
    idx++;
    renderIntoElement(pageFront, idx);
    updateCounter();
  }
};

// ====== INITIAL RENDER ======
renderIntoElement(pageFront, idx);
updateCounter();

// ====== FIX MOBILE & DESKTOP SCROLL ======

pageFront.style.WebkitOverflowScrolling = "touch";

pageBack.style.WebkitOverflowScrolling = "touch";

// ====== FIX BOOK CONTAINER HEIGHT ======
book.style.height = "auto";
book.style.minHeight = "60vh";


  function highlightWordInElement(el, wi) {
    el.querySelectorAll(".word").forEach((s, n) => {
      s.classList.toggle("highlight", n === wi);
    });
    const spans = el.querySelectorAll(".word");
    const target = spans[wi];
    if (target) target.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  function enableRemoveBtn(enabled) {
    const btn = document.getElementById("removeMarkBtn");
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? "1" : "0.5";
    btn.style.cursor = enabled ? "pointer" : "not-allowed";
  }

  // ====== INITIAL LOAD & RESTORE ======
  try {
    const savedData = localStorage.getItem(savedKey);
    if (savedData) {
      const { sheetIndex, wordIndex } = JSON.parse(savedData);
      if (typeof sheetIndex === "number" && sheetIndex < sheets.length) {
        const resume = confirm("üìò Resume where you left off?");
        if (resume) {
          idx = sheetIndex;
          renderIntoElement(pageFront, idx, wordIndex);
          // prepare back page
          if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
          enableRemoveBtn(true);
          highlightWordInElement(pageFront, wordIndex);
        } else {
          renderIntoElement(pageFront, idx, -1);
          if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
          enableRemoveBtn(true);
        }
      } else {
        renderIntoElement(pageFront, idx, -1);
        if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
        enableRemoveBtn(false);
      }
    } else {
      renderIntoElement(pageFront, idx, -1);
      if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
      enableRemoveBtn(false);
    }
  } catch (e) {
    renderIntoElement(pageFront, idx, -1);
    if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
    enableRemoveBtn(false);
  }

  // ====== TURN PAGE ======
  function turnPage(direction = "next", cb) {
    if (direction === "next") {
      pageFront.style.animation = "turnNextFront .9s ease forwards";
      pageBack.style.animation = "turnNextBack .9s ease forwards";
    } else {
      pageFront.style.animation = "turnNextBack .9s ease reverse forwards";
      pageBack.style.animation = "turnNextFront .9s ease reverse forwards";
    }
    setTimeout(() => {
      pageFront.innerHTML = pageBack.innerHTML;
      pageFront.style.animation = pageBack.style.animation = "";
      // fill back for upcoming turn
      if (direction === "next") {
        const nextIdx = idx + 1;
        if (nextIdx + 1 < sheets.length) renderIntoElement(pageBack, nextIdx + 1, -1);
        else pageBack.innerHTML = "";
      } else {
        const prevIdx = idx - 1;
        if (prevIdx - 1 >= 0) renderIntoElement(pageBack, prevIdx - 1, -1);
        else pageBack.innerHTML = "";
      }
      if (cb) cb();
    }, 920);
  }

  // ====== CREATE UTTERANCE & TRACK ======
  function createUtteranceForPage(pageIndex, resumeFromAbsChar = 0) {
    const fullText = (sheets[pageIndex] && sheets[pageIndex].content) || "";
    const sliceStart = Math.max(0, resumeFromAbsChar);
    const u = new SpeechSynthesisUtterance(fullText.slice(sliceStart));
    const chosen = pickVoice(currentVoice);
    if (chosen) u.voice = chosen;
    u.lang = chosen?.lang || "en-US";
    u.pitch = currentVoice === "boy" ? 0.85 : 1.2;
    u.rate = currentRate;
    u.onboundary = (ev) => {
      if (ev && (ev.name === "word" || ev.name === "char") && typeof ev.charIndex === "number") {
        const absChar = sliceStart + ev.charIndex;
        resumeChar = absChar;
        // map absolute char to a word index using wordRanges
        for (let wi = 0; wi < wordRanges.length; wi++) {
          const [s, e] = wordRanges[wi];
          if (absChar >= s && absChar < e) {
            highlightWordInElement(pageFront, wi);
            break;
          }
        }
      }
    };
    return { utterance: u, sliceStart };
  }

  // ====== SPEAK PAGE with resume support ======
  function speakPageWithResume(pageIndex, resumeFromAbsChar = 0) {
    if (pageIndex >= sheets.length) {
      showToast("üéâ Story completed!");
      narrationControls.style.display = "none";
      utteranceActive = false;
      return;
    }
    // ensure front/back rendered and wordRanges built
    renderIntoElement(pageFront, pageIndex, -1);
    if (pageIndex + 1 < sheets.length) renderIntoElement(pageBack, pageIndex + 1, -1);
    else pageBack.innerHTML = "";

    const { utterance: u, sliceStart } = createUtteranceForPage(pageIndex, resumeFromAbsChar);
    utterance = u;
    utteranceActive = true;
    isPaused = false;

    u.onend = () => {
      if (!utteranceActive) return; // cancelled by user
      if (pageIndex < sheets.length - 1) {
        idx = pageIndex + 1;
        // ensure pageBack has next content already rendered
        turnPage("next", () => speakPageWithResume(idx, 0));
      } else {
        showToast("üéâ Story completed!");
        narrationControls.style.display = "none";
        utteranceActive = false;
      }
    };

    u.onerror = (e) => {
      console.error("TTS error", e);
      showToast("‚ùå Narration error");
      utteranceActive = false;
    };

    // start speech
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ====== PICK VOICE HELPER ======
  function pickVoice(role) {
    if (!voices.length) return null;
    const pick = (rx) => voices.find((v) => rx.test(v.name) || (v.lang && rx.test(v.lang)));
    if (role === "boy") return pick(/male|david|daniel|alex|john|peter/i) || voices[0];
    if (role === "girl") return pick(/female|susan|samantha|victoria|anna|kate/i) || voices[0];
    return voices[0];
  }

  // ====== BUTTONS ======
  document.getElementById("prevFullBtn").addEventListener("click", () => {
    if (idx > 0) {
      // cancel narration if any
      if (utteranceActive) {
        speechSynthesis.cancel();
        utteranceActive = false;
      }
      idx--;
      // render previous into back and do prev animation
      renderIntoElement(pageBack, idx, -1);
      turnPage("prev", () => {
        // after turn, ensure next back prepared
        if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
      });
    }
  });

  document.getElementById("nextFullBtn").addEventListener("click", () => {
    if (idx < sheets.length - 1) {
      if (utteranceActive) {
        speechSynthesis.cancel();
        utteranceActive = false;
      }
      // prepare back with next page then flip
      renderIntoElement(pageBack, idx + 1, -1);
      turnPage("next", () => {
        idx++;
        // after turn prepare pageBack for next +1
        if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
      });
    }
  });

  document.getElementById("markLastBtn").addEventListener("click", () => {
    markingMode = true;
    showToast("üëâ Click a word to mark your position.");
  });

  document.getElementById("removeMarkBtn").addEventListener("click", () => {
    localStorage.removeItem(savedKey);
    // remove any highlights on current front page
    pageFront.querySelectorAll(".word").forEach((s) => s.classList.remove("highlight"));
    enableRemoveBtn(false);
    showToast("üóëÔ∏è Removed last mark.");
  });

document.getElementById("narrateBtn").addEventListener("click", () => {
  if (!confirm("üéß Would you like the narrator to speak this Story?")) return;
  narrationControls.style.display = "flex";

  const skipWords = 5; // words to skip for forward/backward

  // --- Speak page function with resume
  function speakPage(resumeFromChar = 0) {
    if (idx >= sheets.length) return;
    renderIntoElement(pageFront, idx, -1);
    if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);

    const fullText = sheets[idx].content || "";
    const sliceStart = resumeFromChar;
    const u = new SpeechSynthesisUtterance(fullText.slice(sliceStart));
    const voiceObj = pickVoice(currentVoice);
    if (voiceObj) u.voice = voiceObj;
    u.lang = voiceObj?.lang || "en-US";
    u.pitch = currentVoice === "boy" ? 0.85 : 1.2;
    u.rate = currentRate;

    u.onboundary = (ev) => {
      if (ev && typeof ev.charIndex === "number") {
        resumeChar = sliceStart + ev.charIndex;
        for (let wi = 0; wi < wordRanges.length; wi++) {
          const [s, e] = wordRanges[wi];
          if (resumeChar >= s && resumeChar < e) {
            highlightWordInElement(pageFront, wi);
            break;
          }
        }
      }
    };

    u.onend = () => {
      if (!utteranceActive) return;
      if (idx < sheets.length - 1) {
        idx++;
        turnPage("next", () => speakPage(0));
      } else {
        showToast("üéâ Story completed!");
        narrationControls.style.display = "none";
        utteranceActive = false;
        pauseBtn.textContent = "‚ñ∂ Start Again";
      }
    };

    utterance = u;
    utteranceActive = true;
    isPaused = false;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // --- Controls references
  const pauseBtn = narrationControls.querySelector("#pauseNarrationBtn");
  const stopBtn = narrationControls.querySelector("#stopNarrationBtn");

  // Start / Resume / Start Again
  pauseBtn.onclick = (e) => {
    if (!utterance) return;
    if (pauseBtn.textContent.includes("Start")) {
      resumeChar = 0;
      idx = 0;
      speakPage(0);
      pauseBtn.textContent = "‚è∏Ô∏è Pause";
      return;
    }
    if (!isPaused && speechSynthesis.speaking) {
      speechSynthesis.pause();
      isPaused = true;
      e.target.textContent = "‚ñ∂Ô∏è Resume";
    } else if (isPaused) {
      speechSynthesis.resume();
      isPaused = false;
      e.target.textContent = "‚è∏Ô∏è Pause";
    }
  };

  // Stop
  stopBtn.onclick = () => {
    speechSynthesis.cancel();
    utterance = null;
    utteranceActive = false;
    isPaused = false;
    narrationControls.style.display = "none";
    showToast("üõë Stopped narration.");
  };

  // --- Forward / Backward buttons
  let forwardBtn = document.createElement("button");
  forwardBtn.className = "btn btn-info";
  forwardBtn.textContent = "‚è© Forward";
  let backBtn = document.createElement("button");
  backBtn.className = "btn btn-info";
  backBtn.textContent = "‚è™ Backward";

  narrationControls.insertBefore(backBtn, voiceBtn);
  narrationControls.insertBefore(forwardBtn, voiceBtn);

  function adjustResumeByWords(count) {
    if (!wordRanges.length) return;
    let currentWordIndex = wordRanges.findIndex(([s, e]) => resumeChar >= s && resumeChar < e);
    currentWordIndex = currentWordIndex < 0 ? 0 : currentWordIndex;
    currentWordIndex += count;
    if (currentWordIndex < 0) currentWordIndex = 0;
    if (currentWordIndex >= wordRanges.length) currentWordIndex = wordRanges.length - 1;
    resumeChar = wordRanges[currentWordIndex][0];
    speakPage(resumeChar);
  }

  forwardBtn.onclick = () => adjustResumeByWords(skipWords);
  backBtn.onclick = () => adjustResumeByWords(-skipWords);

  // --- Start narration
  speakPage(resumeChar || 0);
});


  // Voice dropdown
  const voiceBtn = narrationControls.querySelector("#voiceSelectBtn");
  const voiceDropdown = narrationControls.querySelector("#voiceDropdown");
  voiceBtn.addEventListener("click", (ev) => {
    ev.stopPropagation();
    voiceDropdown.style.display = voiceDropdown.style.display === "block" ? "none" : "block";
  });
  document.addEventListener("click", (e) => {
    if (!voiceDropdown.contains(e.target) && e.target !== voiceBtn) voiceDropdown.style.display = "none";
  });
  voiceDropdown.querySelectorAll("button").forEach((btn) => {
    btn.addEventListener("click", () => {
      const sel = btn.dataset.voice;
      currentVoice = sel;
      voiceDropdown.style.display = "none";
      showToast(`üé§ Voice set to ${btn.textContent}`);
      if (utteranceActive) {
        // resume from current resumeChar with new voice
        speechSynthesis.cancel();
        setTimeout(() => speakPageWithResume(idx, resumeChar || 0), 120);
      }
    });
  });

  // Speed control
  narrationControls.querySelector("#speedRange").addEventListener("input", (e) => {
    currentRate = parseFloat(e.target.value);
    showToast(`‚ö° Speed: ${currentRate.toFixed(2)}`);
    if (utteranceActive) {
      speechSynthesis.cancel();
      setTimeout(() => speakPageWithResume(idx, resumeChar || 0), 120);
    }
  });

  // Close button (fixed: now actually closes reader and cancels speech)
  document.getElementById("readerCloseFullBtn").addEventListener("click", () => {
    if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
    utteranceActive = false;
    readerFull.classList.add("hidden");
    // cleanup: remove voice dropdown visible state
    narrationControls.style.display = "none";
  });

  // ====== INITIAL RENDER ALREADY SET ABOVE; ensure pageBack prepared ======
  if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);

  // expose helper so tests can call it (optional)
  return {
    flipNext: () => {
      if (idx < sheets.length - 1) {
        renderIntoElement(pageBack, idx + 1, -1);
        turnPage("next", () => {
          idx++;
          if (idx + 1 < sheets.length) renderIntoElement(pageBack, idx + 1, -1);
        });
      }
    },
  };
}


  
// --- Fix: Show only one section (stories or serials) and highlight active tab ---
function setDashboardTabHighlight(type) {
  const storiesBtn = document.getElementById('showStoriesBtn');
  const serialsBtn = document.getElementById('showSerialsBtn');

  if (type === 'stories') {
    storiesBtn.classList.add('btn-primary');
    storiesBtn.classList.remove('btn-secondary');
    serialsBtn.classList.add('btn-secondary');
    serialsBtn.classList.remove('btn-primary');
  } else {
    serialsBtn.classList.add('btn-primary');
    serialsBtn.classList.remove('btn-secondary');
    storiesBtn.classList.add('btn-secondary');
    storiesBtn.classList.remove('btn-primary');
  }
}

document.getElementById('showStoriesBtn').addEventListener('click', () => {
  showDashboard('stories');
  setDashboardTabHighlight('stories');
});

document.getElementById('showSerialsBtn').addEventListener('click', () => {
  showDashboard('serials');
  setDashboardTabHighlight('serials');
});

const oldShowDashboard = showDashboard;
showDashboard = function(type = 'stories', genreFilter = 'All') {
  oldShowDashboard(type, genreFilter);
  setDashboardTabHighlight(type);
};

</script>

<!-- START: SERIALS EXTENSION INJECTION -->
<script>
// Saved serials storage key
const SAVED_SERIALS_KEY = 'savedSerials_v1';

// Utility: load/save serials from localStorage
function loadSavedSerials(){
  try{ const raw = localStorage.getItem(SAVED_SERIALS_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ console.warn(e); return []; }
}
function saveSavedSerials(arr){ try{ localStorage.setItem(SAVED_SERIALS_KEY, JSON.stringify(arr)); }catch(e){ console.warn(e); } }

// Ensure serialsData syncs to savedSerials periodically and on key events
function syncSerialsToStorage(){
  try{
    const current = loadSavedSerials();
    // merge serialsData into saved (by title)
    (serialsData || []).forEach(s => {
      if(!s || !s.title) return;
      const existing = current.find(x => x.title === s.title);
      if(existing){
        // update existing
        existing.genre = s.genre || existing.genre;
        existing.description = s.description || existing.description;
        existing.episodes = s.episodes || existing.episodes || [];
      } else {
        current.push(JSON.parse(JSON.stringify(s)));
      }
    });
    saveSavedSerials(current);
      }catch(e){ console.warn(e); }
}
// call periodically as a safety net
setInterval(syncSerialsToStorage, 1500);

// Hook some UI actions that already exist to call sync after create/update
try{
  // when serial create popup confirms
  const origSerialCreateConfirm = window.serialCreateConfirmBtn;
}catch(e){ /* ignore if not accessible */ }

// expose a function to render serials browse listing
const ALGO_CONFIG = {
  popularityWeight: 0.5,
  recencyWeight: 0.25,
  noveltyWeight: 0.25,
  randomWeight: 0.1,
  freshDaysBoost: 21,
  freshBoostMultiplier: 1.4,
  explorationFraction: 0.25,
  cardsPerViewport: 6,
  trending: {
    addThreshold: 50,
    keepThreshold: 100,
    dropThreshold: 40,
    expireDays: 7
  },
  recentlyReadLimit: 50
};

// LocalStorage keys
const SERIAL_READS_KEY = 'serial_reads_v1';
const TRENDING_STATE_KEY = 'trending_serials_v1';
const RECENTLY_READ_KEY = 'recently_read_v1';

// ---------------- SESSION SEED / PRNG ----------------
(function initSessionSeed() {
  if (window.__SERIALS_RENDER_SEED) return;
  let extra = 0;
  if (typeof crypto !== 'undefined' && typeof crypto.getRandomValues === 'function') {
    const arr = new Uint32Array(1);
    crypto.getRandomValues(arr);
    extra = arr[0];
  } else {
    extra = Math.floor(Math.random() * 0xffffffff);
  }
  window.__SERIALS_RENDER_SEED = ((Date.now() & 0xffffffff) ^ extra) >>> 0;
})();

function mulberry32(seed) {
  let t = seed >>> 0;
  return function() {
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r = r + Math.imul(r ^ (r >>> 7), 61 | r) ^ r;
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  };
}
function rngForThisRender() { return mulberry32(window.__SERIALS_RENDER_SEED); }

// ---------------- UTILITIES ----------------
function daysSince(dateString) {
  if (!dateString) return Number.MAX_SAFE_INTEGER;
  const d = new Date(dateString);
  if (isNaN(d)) return Number.MAX_SAFE_INTEGER;
  return Math.floor((Date.now() - d.getTime()) / (1000 * 60 * 60 * 24));
}
function normalizeArray(values) {
  const clean = values.map(v => Number.isFinite(v) ? v : 0);
  const min = Math.min(...clean);
  const max = Math.max(...clean);
  return max === min ? clean.map(() => 0.5) : clean.map(v => (v - min) / (max - min));
}
function shuffleArray(arr, rng = Math.random) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor((rng ? rng() : Math.random()) * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function computePopularityMetric(s) {
  const reads = Number(s.reads ?? s.readCount ?? 0);
  const likes = Number(s.likes ?? 0);
  return Math.log1p(reads) + 1.5 * Math.log1p(likes);
}

// ---------------- TRENDING state helpers ----------------
function loadTrendingState() {
  try {
    const raw = localStorage.getItem(TRENDING_STATE_KEY);
    return raw ? JSON.parse(raw) : { ids: {}, lastUpdated: Date.now() };
  } catch (e) { return { ids: {}, lastUpdated: Date.now() }; }
}
function saveTrendingState(state) {
  try { localStorage.setItem(TRENDING_STATE_KEY, JSON.stringify(state)); } catch (e) {}
}

function getRecentReadsForSerial(s) {
  const candidates = [ s.recentReads, s.readsLast24h, s.readsToday, s.readsLastDay, s.dailyReads ];
  for (let c of candidates) if (Number.isFinite(c)) return Number(c);
  if (Number.isFinite(s.readCount) && Number.isFinite(s.prevReadCount)) {
    return Math.max(0, Number(s.readCount) - Number(s.prevReadCount));
  }
  return undefined;
}

function updateTrendingStateForSerials(serials) {
  const state = loadTrendingState();
  const now = Date.now();
  const cfg = ALGO_CONFIG.trending;
  serials.forEach(s => {
    const id = s.id ?? s.slug ?? s.title;
    if (!id) return;
    const recent = getRecentReadsForSerial(s);
    const currentlyTrending = !!state.ids[id];

    if (Number.isFinite(recent)) {
      if (recent >= cfg.keepThreshold) {
        state.ids[id] = { since: state.ids[id]?.since || now, lastSeen: now, recent };
      } else if (recent >= cfg.addThreshold) {
        state.ids[id] = { since: state.ids[id]?.since || now, lastSeen: now, recent };
      } else if (currentlyTrending && recent < cfg.dropThreshold) {
        delete state.ids[id];
      } else if (currentlyTrending) {
        state.ids[id] = { ...state.ids[id], lastSeen: now, recent };
      }
    } else {
      if (currentlyTrending) {
        const lastSeen = state.ids[id]?.lastSeen || state.ids[id]?.since || now;
        const daysSinceSeen = Math.floor((now - lastSeen) / (1000 * 60 * 60 * 24));
        if (cfg.expireDays && daysSinceSeen > cfg.expireDays) delete state.ids[id];
      }
    }
  });

  // prune stale ids not in current list if expired
  const presentIds = new Set(serials.map(s => s.id ?? s.slug ?? s.title));
  Object.keys(state.ids).forEach(id => {
    if (!presentIds.has(id)) {
      const lastSeen = state.ids[id]?.lastSeen || state.ids[id]?.since || now;
      const daysSinceSeen = Math.floor((now - lastSeen) / (1000 * 60 * 60 * 24));
      if (ALGO_CONFIG.trending.expireDays && daysSinceSeen > ALGO_CONFIG.trending.expireDays) {
        delete state.ids[id];
      }
    }
  });

  state.lastUpdated = now;
  saveTrendingState(state);
  return state;
}
function getTrendingSerialsFromState(serials, state) {
  const ids = new Set(Object.keys(state.ids || {}));
  return serials.filter(s => {
    const id = s.id ?? s.slug ?? s.title;
    return id && ids.has(id);
  });
}

// ---------------- RECENTLY READ helpers ----------------
function recordRecentlyRead(serial) {
  try {
    const raw = localStorage.getItem(RECENTLY_READ_KEY);
    let arr = raw ? JSON.parse(raw) : [];
    const id = serial.id ?? serial.slug ?? serial.title;
    const entry = {
      id,
      title: serial.title || 'Untitled',
      cover: serial.cover || null,
      genre: serial.genre || null,
      description: serial.description || null,
      at: Date.now()
    };
    arr = arr.filter(x => x.id !== id);
    arr.unshift(entry);
    const limit = Number.isFinite(ALGO_CONFIG.recentlyReadLimit) ? ALGO_CONFIG.recentlyReadLimit : 50;
    if (arr.length > limit) arr = arr.slice(0, limit);
    localStorage.setItem(RECENTLY_READ_KEY, JSON.stringify(arr));
  } catch (e) {}
}
function loadRecentlyRead() {
  try {
    const raw = localStorage.getItem(RECENTLY_READ_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (e) { return []; }
}

// Safe open + record
function openSerialPreviewAndRecord(serial) {
  try { recordRecentlyRead(serial); } catch (e) {}
  if (typeof openSerialPreview === 'function') {
    if (serial.id) openSerialPreview(serial.id);
    else if (serial.slug) openSerialPreview(serial.slug);
    else openSerialPreview(serial.title || '');
  } else {
    console.warn('openSerialPreview not defined');
  }
}

// ---------------- SCORING / EXPLORATION ----------------
function scoredSerialsWithNormalization(serials, rng) {
  rng = rng || Math.random;
  const popArr = serials.map(computePopularityMetric);
  const ageArr = serials.map(s => {
    const ds = daysSince(s.published || s.createdAt || s.date || s.uploadedAt);
    return Math.max(0, 365 - Math.min(ds, 365));
  });
  const popNorm = normalizeArray(popArr);
  const recNorm = normalizeArray(ageArr);

  return serials.map((s, i) => {
    const pop = popNorm[i];
    const rec = recNorm[i];
    const novelty = Math.max(0.2, 1 - pop);
    const randomEps = (rng ? rng() : Math.random()) * ALGO_CONFIG.randomWeight;
    let score = ALGO_CONFIG.popularityWeight * pop
              + ALGO_CONFIG.recencyWeight * rec
              + ALGO_CONFIG.noveltyWeight * novelty
              + randomEps;
    const ageDays = daysSince(s.published || s.createdAt || s.date || s.uploadedAt);
    if (ageDays <= ALGO_CONFIG.freshDaysBoost) score *= ALGO_CONFIG.freshBoostMultiplier;
    return Object.assign({}, s, { __score: score, __popNorm: pop, __recNorm: rec, __novelty: novelty, __ageDays: ageDays });
  });
}

function pickExploration(candidates, count, rng) {
  if (!candidates || candidates.length === 0 || count <= 0) return [];
  rng = rng || Math.random;
  const scored = candidates.map(s => {
    const novelty = s.__novelty ?? 0.5;
    const recency = s.__recNorm ?? 0.5;
    return Object.assign({}, s, { __exploreScore: novelty*0.6 + recency*0.4 + (rng ? rng() : Math.random())*0.1 });
  });
  scored.sort((a,b) => b.__exploreScore - a.__exploreScore);
  return shuffleArray(scored.slice(0, Math.min(count, scored.length)), rng);
}

// ---------------- DEMO generator ----------------
function generateDemoSerials(count = 0, rng) {
  rng = rng || rngForThisRender();
  const genres = ["Action","Romance","Comedy","Fantasy","Horror","Tragedy","Tragic","Thriller","Adventure","Crime","Historic"];
  const covers = [
    "https://picsum.photos/seed/demo1/600/900",
    "https://picsum.photos/seed/demo2/600/900",
    "https://picsum.photos/seed/demo3/600/900",
    "https://picsum.photos/seed/demo4/600/900",
    "https://picsum.photos/seed/demo5/600/900",
    "https://picsum.photos/seed/demo6/600/900"
  ];
  const serials = [];
  for (let i=0;i<count;i++){
    const genre = genres[Math.floor(rng()*genres.length)];
    const title = `${genre} Demo Serial ${i+1}`;
    const readCount = Math.floor(rng()*1000);
    const likes = Math.floor(rng()*400);
    const daysAgo = Math.floor(rng()*400);
    const date = new Date(Date.now()-daysAgo*86400000).toISOString();
    serials.push({
      id:`demo-${i+1}`,
      title, genre, description:`Demo ${genre.toLowerCase()} serial ‚Äî random readCount ${readCount}.`,
      cover: covers[i % covers.length], readCount, reads: readCount, likes, createdAt: date
    });
  }
  return serials;
}

// ---------------- RENDER HELPERS (card creators) ----------------
function createSerialCard(s, imagesToWait, allSerials) {
  const card = document.createElement('div');
  card.className = 'serial-card';
  card.dataset.title = s.title || '';
  card.style.minWidth = '300px';
  card.style.height = '400px';
  card.style.flex = '0 0 auto';
  card.style.borderRadius = '16px';
  card.style.boxShadow = '0 6px 18px rgba(0,0,0,0.15)';
  card.style.padding = '16px';
  card.style.display = 'flex';
  card.style.flexDirection = 'column';
  card.style.justifyContent = 'space-between';
  card.style.position = 'relative';
  card.style.transition = 'transform 0.25s ease, box-shadow 0.25s ease';
  card.style.overflow = 'hidden';
  card.style.cursor = 'pointer';
  card.style.scrollSnapAlign = 'center';

  if (s.cover) {
    const img = new Image();
    img.src = s.cover;
    img.alt = s.title || 'cover';
    imagesToWait.push(new Promise(resolve => {
      if (img.complete) return resolve();
      img.onload = img.onerror = () => resolve();
    }));
    card.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.45),rgba(0,0,0,0.45)),url(${s.cover})`;
    card.style.backgroundSize = 'cover';
    card.style.backgroundPosition = 'center';
    card.style.color = '#fff';
  } else {
    card.style.background = '#fff';
    card.style.color = '#000';
  }

  // Hover / touch scale
  const scaleUp = () => { card.style.transform = 'scale(1.08)'; card.style.zIndex = '2'; card.style.boxShadow = '0 12px 24px rgba(0,0,0,0.3)'; };
  const scaleDown = () => { card.style.transform = 'scale(1)'; card.style.zIndex = '1'; card.style.boxShadow = '0 6px 18px rgba(0,0,0,0.15)'; };
  card.addEventListener('mouseenter', scaleUp);
  card.addEventListener('mouseleave', scaleDown);
  card.addEventListener('touchstart', scaleUp);
  card.addEventListener('touchend', scaleDown);
  card.addEventListener('touchcancel', scaleDown);

  // Info
  const infoDiv = document.createElement('div');
  infoDiv.innerHTML = `<h4 style="margin:0;font-size:17px;text-shadow:1px 1px 3px rgba(0,0,0,0.6)">${s.title || 'Untitled Series'}</h4>
    <p style="margin:6px 0 0;font-size:13px;color:inherit;opacity:0.9;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;line-height:1.4;text-shadow:1px 1px 2px rgba(0,0,0,0.4)">${s.description || ''}</p>`;

  // readCount badge
  if (typeof s.readCount !== 'undefined' || typeof s.reads !== 'undefined') {
    const rc = document.createElement('div');
    rc.style.position = 'absolute';
    rc.style.right = '12px';
    rc.style.top = '12px';
    rc.style.background = 'rgba(255,255,255,0.85)';
    rc.style.padding = '6px 8px';
    rc.style.borderRadius = '12px';
    rc.style.fontSize = '12px';
    rc.style.color = '#222';
    rc.textContent = `reads ${Number(s.readCount ?? s.reads ?? 0).toLocaleString()}`;
    card.appendChild(rc);
  }

  // Buttons
  const bottomDiv = document.createElement('div');
  bottomDiv.style.display = 'flex';
  bottomDiv.style.justifyContent = 'flex-end';
  bottomDiv.style.gap = '8px';
  bottomDiv.style.marginTop = '10px';
  const viewBtn = document.createElement('button');
  viewBtn.className = 'btn btn-secondary view-serial-btn';
  viewBtn.textContent = 'üé¨ View';
  viewBtn.addEventListener('click', ev => {
    ev.stopPropagation();
    // prefer full object open
    openSerialPreviewAndRecord(s);
  });
  bottomDiv.appendChild(viewBtn);

  // Click on card opens preview too
  card.addEventListener('click', () => openSerialPreviewAndRecord(s));

  card.appendChild(infoDiv);
  card.appendChild(bottomDiv);
  return card;
}

function createRecentCard(r, allSerials) {
  const card = document.createElement('div');
  card.className = 'recent-card serial-card';
  card.style.minWidth = '260px';
  card.style.flex = '0 0 auto';
  card.style.borderRadius = '14px';
  card.style.padding = '14px';
  card.style.boxShadow = '0 6px 16px rgba(0,0,0,0.1)';
  card.style.display = 'flex';
  card.style.flexDirection = 'column';
  card.style.justifyContent = 'space-between';
  card.style.cursor = 'pointer';
  card.style.position = 'relative';
  card.style.flexShrink = '0';
  card.style.backfaceVisibility = 'hidden';

  if (r.cover) {
    card.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4),rgba(0,0,0,0.4)),url(${r.cover})`;
    card.style.backgroundSize = 'cover';
    card.style.backgroundPosition = 'center';
    card.style.color = '#fff';
  } else {
    card.style.background = '#fff';
    card.style.color = '#000';
  }

  const titleDiv = document.createElement('h4');
  titleDiv.textContent = r.title || 'Untitled';
  titleDiv.style.margin = '0 0 6px';
  titleDiv.style.fontSize = '17px';
  titleDiv.style.fontWeight = '700';
  titleDiv.style.textShadow = r.cover ? '1px 1px 3px rgba(0,0,0,0.6)' : '';

  const genreDiv = document.createElement('div');
  genreDiv.textContent = r.genre || 'Unknown';
  genreDiv.style.margin = '0 0 6px';
  genreDiv.style.fontSize = '13px';
  genreDiv.style.fontWeight = '600';
  genreDiv.style.opacity = '0.9';

  const descDiv = document.createElement('p');
  descDiv.textContent = r.description || '';
  descDiv.style.margin = '4px 0 8px';
  descDiv.style.fontSize = '14px';
  descDiv.style.lineHeight = '1.4';
  descDiv.style.overflow = 'hidden';
  descDiv.style.display = '-webkit-box';
  descDiv.style.webkitLineClamp = '3';
  descDiv.style.webkitBoxOrient = 'vertical';

  const bottomRow = document.createElement('div');
  bottomRow.style.display = 'flex';
  bottomRow.style.justifyContent = 'flex-end';
  bottomRow.style.alignItems = 'center';
  bottomRow.style.marginTop = 'auto';

  const readBtn = document.createElement('button');
  readBtn.className = 'btn btn-primary';
  readBtn.textContent = 'Read';
  readBtn.addEventListener('click', e => {
    e.stopPropagation();
    // try find in list
    const found = allSerials.find(s => (s.id ?? s.slug ?? s.title) === r.id);
    if (found) openSerialPreviewAndRecord(found);
    else if (typeof openSerialPreview === 'function') openSerialPreview(r.title);
  });

  bottomRow.appendChild(readBtn);
  card.appendChild(titleDiv);
  card.appendChild(genreDiv);
  card.appendChild(descDiv);
  card.appendChild(bottomRow);

  card.addEventListener('click', () => {
    const found = allSerials.find(s => (s.id ?? s.slug ?? s.title) === r.id);
    if (found) openSerialPreviewAndRecord(found);
    else if (typeof openSerialPreview === 'function') openSerialPreview(r.title);
  });

  return card;
}

// ---------------- MAIN renderBrowseSerials (Full integration) ----------------

function renderBrowseSerials(list = null, opts = { includeDemo: false, demoCount: 0, mergeWithSaved: false }) {
  const rng = rngForThisRender();
  try {
    let container = document.getElementById('serialsBrowseList');
    if (!container) {
      const parent = document.getElementById('serialCategoriesPage') || document.body;
      container = document.createElement('div');
      container.id = 'serialsBrowseList';
      container.style.maxWidth = '980px';
      container.style.margin = '18px auto';
      parent.appendChild(container);
    }

    // --- Load base serials (prefer Firebase live data) ---
    let baseSerials = Array.isArray(list) ? list.slice() : null;
    if (!Array.isArray(baseSerials) || !baseSerials.length) {
      // Prefer real-time Firebase data if available
      if (Array.isArray(window.serialsData) && window.serialsData.length) {
        console.log(`üì° Using ${window.serialsData.length} serials from Firebase`);
        baseSerials = window.serialsData.slice();
      } else if (typeof loadSavedSerials === 'function') {
        try { baseSerials = loadSavedSerials() || []; } catch (e) { baseSerials = []; }
      } else {
        try { baseSerials = JSON.parse(localStorage.getItem('saved_serials_v1') || '[]') || []; } catch (e) { baseSerials = []; }
      }
    }
    if (!Array.isArray(baseSerials)) baseSerials = [];

    // --- Remove duplicates by id/title ---
    const seen = new Set();
    baseSerials = baseSerials.filter(s => {
      const key = (s.id || s.slug || s.title || '').trim().toLowerCase();
      if (!key || seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    // --- Demo serials if needed ---
    const demo = (opts && opts.includeDemo) ? generateDemoSerials(opts.demoCount || 30, rng) : [];
    let serialsRaw = baseSerials.slice();
    if (demo.length > 0) {
      if (opts && opts.mergeWithSaved) serialsRaw = serialsRaw.concat(demo);
      else if (!serialsRaw.length) serialsRaw = demo.slice();
    }

    if (!serialsRaw || !serialsRaw.length) {
      container.style.display = 'none';
      console.warn('‚ö†Ô∏è No serials to display in Browse Serials');
      return;
    }

    container.innerHTML = '';
    container.style.display = 'block';

    // --- Group by genre ---
    const genresOrder = ['Action','Romance','Comedy','Fantasy','Horror','Tragic','Thriller','Adventure','Crime','Historic'];
    const grouped = {};
    serialsRaw.forEach(s => {
      const g = s.genre ? s.genre.trim() : 'Other';
      if (!grouped[g]) grouped[g] = [];
      grouped[g].push(s);
    });

    // --- Score serials ---
    const allScored = scoredSerialsWithNormalization(serialsRaw, rng);
    const scoredMap = new Map();
    allScored.forEach(s => {
      const key = s.id ?? s.slug ?? s.title;
      scoredMap.set(key, s);
    });

    const imagesToWait = [];

    // --- TRENDING SECTION ---
    const trendingState = updateTrendingStateForSerials(serialsRaw);
    const trendingSerials = getTrendingSerialsFromState(allScored, trendingState);
    if (trendingSerials && trendingSerials.length) {
      const trendingSection = document.createElement('div');
      trendingSection.dataset.genre = 'Trending';
      trendingSection.style.marginBottom = '28px';
      container.appendChild(trendingSection);

      const heading = document.createElement('h2');
      heading.textContent = 'üî• Trending';
      heading.style.margin = '6px 12px';
      heading.style.textAlign = 'left';
      trendingSection.appendChild(heading);

      const scrollWrap = document.createElement('div');
      scrollWrap.className = 'scroll-wrap trending-wrap';
      scrollWrap.style.display = 'flex';
      scrollWrap.style.overflowX = 'auto';
      scrollWrap.style.gap = '12px';
      scrollWrap.style.padding = '12px';
      scrollWrap.style.scrollBehavior = 'smooth';
      scrollWrap.style.scrollSnapType = 'x mandatory';
      scrollWrap.style.scrollbarWidth = 'thin';

      trendingSerials.forEach(s => {
        const card = createSerialCard(s, imagesToWait, serialsRaw);
        card.style.minWidth = '300px';
        card.style.height = '400px';
        scrollWrap.appendChild(card);
      });

      trendingSection.appendChild(scrollWrap);
      container.__trendingIds = new Set(trendingSerials.map(s => s.id ?? s.slug ?? s.title));
    } else {
      container.__trendingIds = new Set();
    }

    // --- GENRE SECTIONS ---
    genresOrder.forEach(genre => {
      const list = grouped[genre];
      if (!list || !list.length) return;

      const trendingIds = container.__trendingIds || new Set();
      const filtered = list.filter(s => !trendingIds.has(s.id ?? s.slug ?? s.title));
      if (!filtered.length) return;

      const scoredList = filtered.map(s => {
        const key = s.id ?? s.slug ?? s.title;
        return scoredMap.get(key) || Object.assign({}, s, { __score: rng() * 0.2 });
      });
      const sorted = scoredList.slice().sort((a, b) => (b.__score || 0) - (a.__score || 0));

      const section = document.createElement('div');
      section.dataset.genre = genre;
      section.style.marginBottom = '32px';

      const heading = document.createElement('h3');
      heading.textContent = genre;
      heading.style.margin = '6px 12px';
      heading.style.textAlign = 'left';
      section.appendChild(heading);

      const scrollWrap = document.createElement('div');
      scrollWrap.className = 'scroll-wrap';
      scrollWrap.style.display = 'flex';
      scrollWrap.style.overflowX = 'auto';
      scrollWrap.style.gap = '12px';
      scrollWrap.style.padding = '12px';
      scrollWrap.style.scrollBehavior = 'smooth';
      scrollWrap.style.scrollSnapType = 'x mandatory';
      scrollWrap.style.scrollbarWidth = 'thin';
      section.appendChild(scrollWrap);

      sorted.forEach(s => {
        const card = createSerialCard(s, imagesToWait, serialsRaw);
        scrollWrap.appendChild(card);
      });

      container.appendChild(section);
    });

    console.log(`‚úÖ Rendered ${serialsRaw.length} serials in Browse Serials`);
  } catch (e) {
    console.warn('renderBrowseSerials error:', e);
  }
}
async function openSerialPreview(input) {
  try {
    const { db, ref, get, set } = window._firebase || {};
    if (!db || !ref || !get) {
      alert("Firebase not ready yet.");
      return;
    }

    // --- Resolve serial title ---
    const title = typeof input === "string"
      ? input.trim()
      : (input && (input.key || input.title || "")).trim();

    if (!title) {
      alert("Serial not found (no title).");
      return;
    }

    // --- Fetch serial data ---
    let serialData =
      typeof input === "object" && input.title ? input : null;

    if (!serialData) {
      const snap = await get(ref(db, "serials"));
      if (snap.exists()) {
        const all = snap.val();
        for (const [key, obj] of Object.entries(all)) {
          if ((obj.title || "").trim().toLowerCase() === title.toLowerCase()) {
            serialData = obj;
            break;
          }
        }
      }
    }

    if (!serialData) {
      alert(`Serial "${title}" not found in Firebase.`);
      return;
    }

    // --- Ensure fields exist ---
    serialData.likes = serialData.likes || 0;
    serialData.dislikes = serialData.dislikes || 0;

    // --- Calculate total reads ---
    const totalReads = (serialData.episodes || []).reduce(
      (sum, ep) => sum + (ep.reads || 0),
      0
    );

    // --- Load user vote state ---
    const votes = JSON.parse(localStorage.getItem("user_votes_serials") || "{}");
    let userVote = votes[serialData.title] || null;

    // --- Create container ---
    let preview = document.getElementById("previewFull");
    if (!preview) {
      preview = document.createElement("div");
      preview.id = "previewFull";
      document.body.appendChild(preview);
    }

    // --- UI Template ---
    preview.innerHTML = `
      <style>
#previewFull {
  position: fixed;
  inset: 0;
  background: #f7f8fb;
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: opacity 0.3s ease;
  opacity: 0;
  overflow: auto;
  padding: 40px 20px;
}
#previewFull.show { opacity: 1; }
.fullscreen-panel {
  width: 100%;
  max-width: 900px;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  animation: fadeIn 0.4s ease both;
  margin: auto;
}
@keyframes fadeIn {
  from {opacity: 0; transform: scale(0.97);}
  to {opacity: 1; transform: scale(1);}
}
.panel-top {
  background: linear-gradient(135deg, #5b7cff, #00b4d8);
  color: white;
  padding: 22px 28px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.panel-top h2 { margin: 0; font-size: 1.8rem; }
.panel-meta {
  padding: 16px 28px;
  font-size: 14px;
  color: #444;
  border-bottom: 1px solid #eee;
  background: #fafafa;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.meta-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
}
.vote-bar {
  display: flex;
  align-items: center;
  gap: 12px;
}
.vote-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 999px;
  border: none;
  background: #f1f1f1;
  color: #606060;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.vote-btn:hover {
  background: #e5e5e5;
  transform: translateY(-1px);
}
.vote-btn svg {
  width: 22px;
  height: 22px;
  transition: transform 0.25s ease, color 0.25s ease;
}
.vote-btn.active.like {
  background: #e6f0ff;
  color: #1976d2;
}
.vote-btn.active.like svg path {
  fill: #1976d2;
}
.vote-btn.active.dislike {
  background: #ffebee;
  color: #d32f2f;
}
.vote-btn.active.dislike svg path {
  fill: #d32f2f;
}
.vote-btn:active {
  transform: scale(0.93);
}
.vote-count {
  font-weight: 500;
  font-size: 0.9rem;
  color: inherit;
}
.share-menu {
  position: absolute;
  z-index: 99999;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 5px 25px rgba(0,0,0,0.1);
  padding: 10px;
}
.share-option {
  padding: 8px 12px;
  background: none;
  border: none;
  text-align: left;
  width: 100%;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px;
  transition: background 0.2s ease;
}
.share-option:hover { background: #f5f5f5; }
.episodes-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
  background: #f9fafc;
  display: flex;
  justify-content: center;
}
.episodes-list {
  width: 100%;
  max-width: 800px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  align-items: center;
}
.episode-card {
  width: 100%;
  background: #ffffff;
  border: 1px solid #e6e9f2;
  border-radius: 14px;
  padding: 20px 22px;
  box-shadow: 0 5px 14px rgba(0, 0, 0, 0.05);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  display: flex;
  flex-direction: column;
  text-align: left;
}
.episode-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}
.episode-card h3 { margin: 0 0 6px; font-size: 1.1rem; color: #2b2b2b; }
.episode-card p { font-size: 0.9rem; color: #666; margin-bottom: 14px; }
.episode-card button { align-self: flex-end; }
      </style>

      <div class="fullscreen-panel">
      <div class="panel-top">
  <div style="display:flex;flex-direction:column;align-items:flex-start;">
    <h2 style="margin-bottom:4px;">${serialData.title}</h2>
    <div style="font-size:0.9rem;opacity:0.9;">
      <b>Author:</b> ${serialData.writerName || "Unknown"} &nbsp; ‚Ä¢ &nbsp;
      <b>Published:</b> ${serialData.publishDate || "N/A"}
    </div>
  </div>
  <button class="btn btn-secondary" id="closePreviewBtn">‚úï Close</button>
</div>


        <div class="panel-meta">
          <div class="meta-row">
            <div>
              <b>Genre:</b> ${serialData.genre || "N/A"} &nbsp; ‚Ä¢ &nbsp;
              <b>Episodes:</b> ${(serialData.episodes || []).length} &nbsp; ‚Ä¢ &nbsp;
              <b>Reads:</b> ${totalReads}
            </div>
            <div class="vote-bar">
              <button class="vote-btn like ${userVote === "like" ? "active" : ""}" id="likeBtn">
                 <svg viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-6 0v4H5v10h13l2-9h-6z" fill="currentColor"/></svg>
                <span id="likeCount">${serialData.likes}</span>
              </button>
              <button class="vote-btn dislike ${userVote === "dislike" ? "active" : ""}" id="dislikeBtn">
                   <svg viewBox="0 0 24 24"><path d="M10 15v4a3 3 0 0 0 6 0v-4h3V5H6l-2 9h6z" fill="currentColor"/></svg>
                <span id="dislikeCount">${serialData.dislikes}</span>
              </button>
              <button class="vote-btn" id="shareSerialBtn">üîó Share</button>
            </div>
          </div>
        </div>

        <div class="episodes-scroll">
          <div class="episodes-list">
            ${(serialData.episodes || [])
              .map(
                (ep, i) => `
                <div class="episode-card">
                  <h3>${ep.title || "Untitled Episode"}</h3>
                  <p>${ep.description || "No description available."}</p>
                  <button class="btn btn-primary read-episode-btn" data-ep="${i}">
                    üìñ Read Episode
                  </button>
                </div>`
              )
              .join("")}
          </div>
        </div>
      </div>
    `;

    preview.classList.remove("hidden");
    setTimeout(() => preview.classList.add("show"), 10);

    // --- Close preview ---
    document.getElementById("closePreviewBtn").onclick = () => {
      preview.classList.remove("show");
      setTimeout(() => preview.remove(), 300);
    };

preview.querySelectorAll(".read-episode-btn").forEach((btn) => {
  btn.addEventListener("click", async (e) => {
    const button = e.currentTarget;
    button.disabled = true; // ‚õî Prevent double click

    const epIndex = parseInt(button.dataset.ep, 10);
    const episode = serialData.episodes[epIndex];

    // Increase reads once
    episode.reads = (episode.reads || 0) + 1;

    // Save back to Firebase
    await set(ref(db, `serials/${encodeURIComponent(serialData.title)}`), serialData);

    // Continue reading
    preview.remove();
    if (typeof openSerialReader === "function") openSerialReader(serialData.title, epIndex);
  });
});


    // --- Like / Dislike smart toggle ---
    const likeBtn = document.getElementById("likeBtn");
    const dislikeBtn = document.getElementById("dislikeBtn");
    const likeCount = document.getElementById("likeCount");
    const dislikeCount = document.getElementById("dislikeCount");

    async function saveVoteChange() {
      await set(ref(db, `serials/${encodeURIComponent(serialData.title)}`), serialData);
      localStorage.setItem("user_votes_serials", JSON.stringify(votes));
      likeCount.textContent = serialData.likes;
      dislikeCount.textContent = serialData.dislikes;
    }

    likeBtn.onclick = async () => {
      if (userVote === "like") {
        serialData.likes--;
        userVote = null;
        votes[serialData.title] = null;
        likeBtn.classList.remove("active");
      } else {
        if (userVote === "dislike") {
          serialData.dislikes--;
          dislikeBtn.classList.remove("active");
        }
        serialData.likes++;
        userVote = "like";
        votes[serialData.title] = "like";
        likeBtn.classList.add("active");
      }
      await saveVoteChange();
    };

    dislikeBtn.onclick = async () => {
      if (userVote === "dislike") {
        serialData.dislikes--;
        userVote = null;
        votes[serialData.title] = null;
        dislikeBtn.classList.remove("active");
      } else {
        if (userVote === "like") {
          serialData.likes--;
          likeBtn.classList.remove("active");
        }
        serialData.dislikes++;
        userVote = "dislike";
        votes[serialData.title] = "dislike";
        dislikeBtn.classList.add("active");
      }
      await saveVoteChange();
    };

    // --- SHARE BUTTON ---
    const existingMenu = document.getElementById("serial-preview-share-menu");
    if (existingMenu) existingMenu.remove();

    const shareMenu = document.createElement("div");
    shareMenu.id = "serial-preview-share-menu";
    shareMenu.className = "share-menu";
    shareMenu.style.display = "none";
    document.body.appendChild(shareMenu);

function getShareLink(platform) {
  const baseUrl = "https://meurbal.site"; // your live website
  const link = `${baseUrl}?previewSerial=${encodeURIComponent(serialData.title || "")}`;

  const message = `üìñ ${serialData.title || "Untitled"}\nGenre: ${
    serialData.genre || "‚Äî"
  }\nDescription: ${
    serialData.description || "No description provided."
  }\nRead it on Meurbal: ${link}`;

  if (platform === "WhatsApp")
    return `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
  if (platform === "Facebook")
    return `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
  if (platform === "Twitter")
    return `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
  if (platform === "Copy") return link;

  return link;
}


    [
      { name: "WhatsApp", emoji: "üü¢" },
      { name: "Facebook", emoji: "üîµ" },
      { name: "Twitter", emoji: "üê¶" },
      { name: "Copy", emoji: "üîó" },
    ].forEach((opt) => {
      const btn = document.createElement("button");
      btn.className = "share-option";
      btn.innerHTML = `${opt.emoji} ${opt.name}`;
      btn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const link = getShareLink(opt.name);
        if (opt.name === "Copy") {
          await navigator.clipboard.writeText(link);
          btn.textContent = "‚úÖ Copied!";
          setTimeout(() => (btn.innerHTML = `${opt.emoji} ${opt.name}`), 1200);
        } else {
          window.open(link, "_blank");
        }
        shareMenu.style.display = "none";
      });
      shareMenu.appendChild(btn);
    });

const shareBtn = document.getElementById("shareSerialBtn");
shareBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  const rect = shareBtn.getBoundingClientRect();

  shareMenu.style.top = window.scrollY + rect.top + "px";
  shareMenu.style.left = window.scrollX + rect.right + 10 + "px";

  shareMenu.style.display =
    shareMenu.style.display === "flex" ? "none" : "flex";
  shareMenu.style.flexDirection = "column";
});


    document.addEventListener("click", (e) => {
      if (!shareMenu.contains(e.target) && e.target !== shareBtn) {
        shareMenu.style.display = "none";
      }
    });
// --- COMMENTS PANEL ---
// --- COMMENTS PANEL ---
const commentsBtn = document.createElement("button");
commentsBtn.className = "vote-btn";
commentsBtn.id = "commentsBtn";
commentsBtn.innerHTML = "üí¨ Comments";
document.querySelector(".vote-bar").appendChild(commentsBtn);

commentsBtn.addEventListener("click", async () => {

  let panel = document.getElementById("commentsPanel");
  if (panel) panel.remove();

  panel = document.createElement("div");
  panel.id = "commentsPanel";
  panel.innerHTML = `
  <style>
    #commentsPanel {
      position: fixed;
      inset: 0;
      background: #ffffff;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      animation: fadeIn .25s ease both;
    }

    .comments-header {
      background: linear-gradient(135deg,#5b7cff,#00b4d8);
      padding: 16px 20px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
    }

    #closeCommentsBtn {
      background:none;
      border:none;
      color:#fff;
      font-size:22px;
      cursor:pointer;
      padding:0;
    }

    #commentsList {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px 80px;
      background: #f5f7fb;
    }

    .comment-item {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      animation: fadeUp 0.25s ease both;
    }

    @keyframes fadeUp { from { opacity: 0; transform: translateY(4px);} to {opacity: 1; transform: translateY(0);} }

    .comment-user { font-weight: 700; color: #222; font-size: 15px; margin-bottom: 4px; }
    .comment-text { color: #333; font-size: 14px; line-height: 1.5; margin-bottom: 6px; }
    .comment-time { font-size: 12px; color: #8a8a8a; }

    .comment-actions { display: flex; gap: 12px; margin-top: 8px; }
    .comment-actions button {
      border: none; background: #eef2ff; padding: 6px 12px; border-radius: 10px; cursor: pointer;
      font-size: 14px; display: flex; align-items: center; gap: 6px; transition: 0.2s;
    }
    .comment-actions button:hover { background: #d9e0ff; }
    .comment-actions button.active { background: #5b7cff; color: white; }
    .reply-btn,.view-replies-btn { background:#f1f4ff; padding:6px 10px; border-radius:8px; }

    .reply-input { display:none; gap:8px; margin-top:8px; }
    .reply-input input { flex:1; padding:6px; border-radius:6px; border:1px solid #ccc; }
    .reply-input button { background:#5b7cff; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }

    .replies-list { display:none; margin-top:6px; }
    .reply-item {
      background:#fff; padding:10px 12px; border-radius:10px; margin-top:6px; margin-left:20px;
      box-shadow:0 1px 4px rgba(0,0,0,0.07);
    }

    .reply-actions button {
      border:none;background:#eef2ff;padding:4px 8px;border-radius:8px;cursor:pointer;
      font-size:13px;display:inline-flex;align-items:center;gap:4px;
    }
    .reply-actions button.active { background:#5b7cff;color:#fff; }

    .comment-input-area { padding:12px 20px;border-top:1px solid #ddd;background:#fafafa;display:flex; }
    .comment-input-area textarea {
      flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;resize:none;font-size:14px;
    }
    .comment-input-area button {
      margin-left:10px;padding:10px 16px;border:none;background:#5b7cff;color:#fff;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s;
    }
    .comment-input-area button:hover { background:#4967e0; }
  </style>

  <div class="comments-header">
    <span>${serialData.title} ‚Äî <span id="commentsCount">0</span> Comments</span>
    <button id="closeCommentsBtn">‚úï</button>
  </div>

  <div id="commentsList">Loading comments...</div>

  <div class="comment-input-area">
    <textarea id="newCommentText" placeholder="Write a comment..." rows="2"></textarea>
    <button id="sendCommentBtn">Post</button>
  </div>
`;

  document.body.appendChild(panel);

  const commentsList = panel.querySelector("#commentsList");
  const closeBtn = panel.querySelector("#closeCommentsBtn");
  const sendBtn = panel.querySelector("#sendCommentBtn");
  const input = panel.querySelector("#newCommentText");
  closeBtn.onclick = () => panel.remove();

  const commentsRef = ref(db, `serial_comments/${encodeURIComponent(serialData.title)}/comments`);

  async function loadReplies(commentId, container) {
    const user = localStorage.getItem("username") || "Guest";
    const replyRef = ref(db, `serial_comments/${encodeURIComponent(serialData.title)}/comments/${commentId}/replies`);
    const snap = await get(replyRef);

    if (!snap.exists()) {
      container.innerHTML = "<p style='margin-left:12px;color:#666;font-size:12px;'>No replies yet.</p>";
      return;
    }

    const replies = Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
    container.innerHTML = replies.map(r=>{
      const likeCount = r.likes ? Object.keys(r.likes).length : 0;
      const dislikeCount = r.dislikes ? Object.keys(r.dislikes).length : 0;
      const youLike = r.likes && r.likes[user];
      const youDislike = r.dislikes && r.dislikes[user];

      return `
      <div class="reply-item" data-rid="${r.id}">
        <div class="reply-user"><b>${r.user}</b></div>
        <div class="reply-text">${r.text}</div>
        <div class="reply-time" style="font-size:11px;color:#888;">${new Date(r.ts).toLocaleString()}</div>
        <div class="reply-actions" style="margin-top:4px;">
          <button class="reply-like-btn ${youLike?"active":""}">üëç <span>${likeCount}</span></button>
          <button class="reply-dislike-btn ${youDislike?"active":""}">üëé <span>${dislikeCount}</span></button>
        </div>
      </div>`;
    }).join("");

    container.querySelectorAll(".reply-item").forEach(rep=>{
      const rid = rep.dataset.rid;
      rep.querySelector(".reply-like-btn").onclick = () => toggleReplyReaction(commentId,rid,"like");
      rep.querySelector(".reply-dislike-btn").onclick = () => toggleReplyReaction(commentId,rid,"dislike");
    });
  }

  async function loadComments() {
    try {
      const snap = await get(commentsRef);
      const username = localStorage.getItem("username") || "Guest";
      const countEl = document.getElementById("commentsCount");

      if (!snap.exists()) {
        commentsList.innerHTML = "<p>No comments yet.</p>";
        countEl.textContent = 0;
        return;
      }

      const arr = Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
      countEl.textContent = arr.length;

      commentsList.innerHTML = arr.map(c=>{
        const likes = c.likes?Object.keys(c.likes).length:0;
        const dislikes = c.dislikes?Object.keys(c.dislikes).length:0;
        const userLiked = c.likes&&c.likes[username];
        const userDisliked = c.dislikes&&c.dislikes[username];

        return `
        <div class="comment-item" data-id="${c.id}">
          <div class="comment-user">${c.user}</div>
          <div class="comment-text">${c.text}</div>
          <div class="comment-time">${new Date(c.ts).toLocaleString()}</div>

          <div class="comment-actions">
            <button class="like-btn ${userLiked?"active":""}">
              <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M14 9V5a3 3 0 0 0-6 0v4H5v10h13l2-9h-6z"/></svg>
              <span>${likes}</span>
            </button>

            <button class="dislike-btn ${userDisliked?"active":""}">
              <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M10 15v4a3 3 0 0 0 6 0v-4h3V5H6l-2 9h6z"/></svg>
              <span>${dislikes}</span>
            </button>

            <button class="reply-btn">üí¨ Reply</button>
            <button class="view-replies-btn" style="display:${c.replies?"inline-block":"none"}">Replies (${c.replies?Object.keys(c.replies).length:0})</button>
          </div>

          <div class="reply-input">
            <input type="text" class="reply-text" placeholder="Write a reply...">
            <button class="send-reply-btn">Reply</button>
          </div>

          <div class="replies-list"></div>
        </div>`;
      }).join("");

      commentsList.querySelectorAll(".comment-item").forEach(item=>{
        const id = item.dataset.id;

        item.querySelector(".like-btn").onclick = () => toggleReaction(id,"like");
        item.querySelector(".dislike-btn").onclick = () => toggleReaction(id,"dislike");

      item.querySelector(".reply-btn").onclick = () => {
  const box = item.querySelector(".reply-input");
  if (box.style.display === "" || box.style.display === "none") {
    box.style.display = "flex";
  } else {
    box.style.display = "none";
  }
};

item.querySelector(".send-reply-btn").onclick = async ()=>{
  const t = item.querySelector(".reply-text").value.trim();
  if(!t) return;

  const u = localStorage.getItem("username") || "Guest";
  const replyRef = ref(db, `serial_comments/${encodeURIComponent(serialData.title)}/comments/${id}/replies`);
  const snap = await get(replyRef);

  let replies = snap.exists() ? snap.val() : {};
  const rid = "r_" + Date.now();

  replies[rid] = {
    id: rid,
    user: u,
    text: t,
    ts: Date.now(),
    likes: {},
    dislikes: {}
  };

  await set(replyRef, replies);

  // ‚úÖ Update Replies button count ONLY
  const repliesBtn = item.querySelector(".view-replies-btn");
  repliesBtn.style.display = "inline-block";
  repliesBtn.textContent = `Replies (${Object.keys(replies).length})`;

  // ‚úÖ Close reply box & clear input
  const inputBox = item.querySelector(".reply-input");
  inputBox.style.display = "none";
  item.querySelector(".reply-text").value = "";

  // ‚úÖ DO NOT open replies section automatically anymore
};


        item.querySelector(".view-replies-btn").onclick = ()=>{
          const box = item.querySelector(".replies-list");
          box.style.display = box.style.display==="none"?"block":"none";
          loadReplies(id,box);
        };
      });
    } catch(e){
      commentsList.innerHTML="<p>‚ö†Ô∏è Failed to load comments.</p>";
    }
  }

  async function toggleReaction(id,type){
  const user = localStorage.getItem("username")||"Guest";
  const refC = ref(db,`serial_comments/${encodeURIComponent(serialData.title)}/comments/${id}`);
  const snap = await get(refC);
  if(!snap.exists()) return;
  let c = snap.val();

  c.likes=c.likes||{};
  c.dislikes=c.dislikes||{};

  if(type==="like"){
    if(c.likes[user]) delete c.likes[user];
    else{ c.likes[user]=true; delete c.dislikes[user]; }
  } else {
    if(c.dislikes[user]) delete c.dislikes[user];
    else{ c.dislikes[user]=true; delete c.likes[user]; }
  }

  await set(refC,c);

  // UPDATE UI (NO RELOAD)
  const el = document.querySelector(`.comment-item[data-id="${id}"]`);
  el.querySelector(".like-btn span").textContent = Object.keys(c.likes).length;
  el.querySelector(".dislike-btn span").textContent = Object.keys(c.dislikes).length;
  el.querySelector(".like-btn").classList.toggle("active", !!c.likes[user]);
  el.querySelector(".dislike-btn").classList.toggle("active", !!c.dislikes[user]);
}

 async function toggleReplyReaction(cid,rid,type){
  const user = localStorage.getItem("username")||"Guest";
  const refR = ref(db,`serial_comments/${encodeURIComponent(serialData.title)}/comments/${cid}/replies/${rid}`);
  const snap = await get(refR);
  if(!snap.exists()) return;
  let r = snap.val();

  r.likes=r.likes||{};
  r.dislikes=r.dislikes||{};

  if(type==="like"){
    if(r.likes[user]) delete r.likes[user];
    else{ r.likes[user]=true; delete r.dislikes[user]; }
  } else {
    if(r.dislikes[user]) delete r.dislikes[user];
    else{ r.dislikes[user]=true; delete r.likes[user]; }
  }

  await set(refR,r);

  // UPDATE UI instantly
  const rep = document.querySelector(`.reply-item[data-rid="${rid}"]`);
  rep.querySelector(".reply-like-btn span").textContent = Object.keys(r.likes).length;
  rep.querySelector(".reply-dislike-btn span").textContent = Object.keys(r.dislikes).length;
  rep.querySelector(".reply-like-btn").classList.toggle("active", !!r.likes[user]);
  rep.querySelector(".reply-dislike-btn").classList.toggle("active", !!r.dislikes[user]);
}

  sendBtn.onclick = async () => {
    const text = input.value.trim();
    if (!text) return;
    const user = localStorage.getItem("username")||"Reader";
    const newC = {id:"c_"+Date.now(),user,text,ts:Date.now()};
    const snap = await get(commentsRef);
    let list = snap.exists()?snap.val():{};
    list[newC.id]=newC;
    await set(commentsRef,list);
    input.value="";
    loadComments();
  };

  loadComments();
});


    console.log(`‚úÖ openSerialPreview: displayed "${serialData.title}"`);
  } catch (err) {
    console.error("‚ùå openSerialPreview error:", err);
    alert("Error loading serial preview.");
  }
}

// --- AUTO OPEN ON SHARE LINK ---
(function autoOpenPreviewFromUrl() {
  try {
    const params = new URLSearchParams(window.location.search);
    const t = params.get("previewSerial");
    if (!t) return;
    setTimeout(() => openSerialPreview(t), 200);
  } catch (e) {
    console.warn("Auto-open preview failed:", e);
  }
})();

//Checkih//

// --- FIXED openSerialReader (cross-device compatible with Firebase fallback) ---
async function openSerialReader(serialTitle, episodeIndex) {
  // Load from local first
  const saved = (typeof loadSavedSerials === 'function') ? loadSavedSerials() : [];
  let serial = (saved || []).find(s => s.title === serialTitle) ||
               (window.serialsData || []).find(s => s.title === serialTitle);

  // üî• Fallback: Fetch from Firebase if not found locally
  if (!serial && window._firebase && window._firebase.get) {
    try {
      const { db, ref, get } = window._firebase;
      const snap = await get(ref(db, `serials/${encodeURIComponent(serialTitle)}`));
      if (snap.exists()) {
        serial = snap.val();
        console.log(`‚úÖ Loaded serial "${serialTitle}" from Firebase`);
        // Cache locally
        const existing = JSON.parse(localStorage.getItem('savedSerials') || '[]');
        if (!existing.find(s => s.title === serialTitle)) {
          existing.push(serial);
          localStorage.setItem('savedSerials', JSON.stringify(existing));
        }
      } else {
        console.warn(`‚ö†Ô∏è Serial "${serialTitle}" not found in Firebase`);
      }
    } catch (err) {
      console.error('‚ùå Error fetching serial from Firebase:', err);
    }
  }

  if (!serial) {
    alert('Serial not found');
    return;
  }

  const ep = (serial.episodes || [])[episodeIndex];
  if (!ep) {
    alert('Episode not found');
    return;
  }

  // --- CREATE PANEL ---
  let panel = document.getElementById('serialReaderFull');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'serialReaderFull';
    panel.className = 'reader-full';
    panel.style.cssText = `
      position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1200;
      background:#f7f7fb;display:flex;flex-direction:column;overflow:hidden;
    `;
    document.body.appendChild(panel);
  }
  panel.innerHTML = '';

  // --- HEADER ---
  const header = document.createElement('div');
  header.className = 'reader-header';
  header.style.cssText = `
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 18px;background:#fff;flex-shrink:0;
  `;
header.innerHTML = `
  <div><button class="btn btn-secondary" id="backToSerialBtn">‚Üê Back</button></div>

  <div style="text-align:center;flex:1">
      <h2 style="margin:6px 0;font-size:16px">${serial.title} ‚Äî ${ep.title}</h2>
  </div>

  <div id="headerRightButtons" style="display:flex;gap:6px;"></div>
`;


  // --- BODY ---
  const body = document.createElement('div');
  body.className = 'reader-body';
  body.style.cssText = `
    flex:1;overflow-y:auto;padding:12px;display:flex;
    flex-direction:column;align-items:center;justify-content:flex-start;
  `;

  const sheetsArray = (ep.sheets || []).map(s =>
    typeof s === 'string' ? { content: s } : (s.content ? s : { content: s })
  );
  const totalPages = Math.max(1, sheetsArray.length || 1);
  let currentPage = 0;

  const pageWrap = document.createElement('div');
  pageWrap.style.cssText = `
    display:flex;flex-direction:column;align-items:center;width:100%;
    box-sizing:border-box;
  `;

  const pageBox = document.createElement('div');
  pageBox.className = 'reader-sheet';
  pageBox.style.cssText = `
    width:100%;max-width:880px;min-height:540px;margin:20px auto;
    padding:30px 35px;background:linear-gradient(135deg, #4facfe, #ffffff);
    border:1px solid #e5d7b7;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.1);
    box-sizing:border-box;font-family:'Georgia','Times New Roman',serif;
    font-size:16px;line-height:1.7;color:#2e2b23;text-align:justify;
    letter-spacing:0.3px;white-space:pre-wrap;overflow-wrap:break-word;
    position:relative;transition:all 0.3s ease;
  `;

  const pagerRow = document.createElement('div');
  pagerRow.style.cssText = `
    display:flex;flex-wrap:wrap;align-items:center;justify-content:center;
    gap:6px;margin-top:12px;
  `;

  const prevPageBtn = document.createElement('button');
  prevPageBtn.className = 'btn btn-secondary';
  prevPageBtn.textContent = '‚óÄ Prev Page';

  const pageIndicator = document.createElement('div');
  pageIndicator.className = 'muted';
  pageIndicator.style.cssText = `
    min-width:80px;text-align:center;font-size:14px;
  `;

  const nextPageBtn = document.createElement('button');
  nextPageBtn.className = 'btn btn-primary';
  nextPageBtn.textContent = 'Next Page ‚ñ∂';
// üéß Narrate Button ‚Äî same style as Next Page ‚ñ∂
const narrateBtn = document.createElement('button');
narrateBtn.className = 'btn btn-secondary'; // same base look, secondary color
narrateBtn.textContent = 'üéß Narrate';
narrateBtn.style.marginLeft = '8px';

// add the button next to nextPageBtn
pagerRow.appendChild(narrateBtn);

narrateBtn.addEventListener('click', () => {
// Prevent narrator from stealing focus and jumping page to top
document.activeElement?.blur();

if (speechSynthesis.speaking || speechSynthesis.pending) {
    console.log("Already narrating, ignoring click");
    return;
}

  const text = (sheetsArray[currentPage] && sheetsArray[currentPage].content) || '';
  if (!text.trim()) return alert('No text to narrate.');

  // Ask user before starting narration
  const confirmNarrate = confirm("üéôÔ∏è Would you like the narrator to speak this episode?");
  if (!confirmNarrate) return; // Stop if user says no

  // --- Create control bar once ---
  let narrCtrl = document.getElementById('serialNarratorControls');
  if (!narrCtrl) {
    narrCtrl = document.createElement('div');
    narrCtrl.id = 'serialNarratorControls';
    narrCtrl.style.cssText = `
      display:flex;align-items:center;justify-content:center;
      gap:10px;margin-top:10px;flex-wrap:wrap;
    `;
    narrCtrl.innerHTML = `
      <button id="pauseNarr" class="btn btn-secondary">‚è∏ Pause</button>
      <button id="stopNarr" class="btn btn-danger">‚èπ Stop</button>
      <button id="backwardNarr" class="btn btn-info">‚è™ Backward</button>
      <button id="forwardNarr" class="btn btn-info">‚è© Forward</button>
      <button id="voiceBtn" class="btn btn-primary">üé§ Voice ‚ñæ</button>
      <label style="font-weight:600;">Speed:
        <input type="range" id="speedRange" min="0.6" max="1.6" step="0.05" value="1">
      </label>
      <div id="voiceMenu" style="
        display:none;position:absolute;background:white;border:1px solid #ccc;
        border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.15);
        z-index:9999;padding:4px;min-width:120px;
      ">
        <button data-voice="boy" style="display:block;width:100%;border:none;background:white;padding:6px;text-align:left;">üë¶ Boy</button>

      </div>
    `;
    pagerRow.parentNode.insertBefore(narrCtrl, pagerRow.nextSibling);
  }

  // --- State ---
  let utter = null;
  let isPaused = false;
  let currentVoice = 'boy';
  let currentRate = 1.0;
  let resumeChar = 0;
  const skipWords = 5; // number of words to skip forward/backward

  // --- Highlight preparation ---
  const rawText = text;
  const words = rawText.split(/\s+/);
  pageBox.innerHTML = '';
  const spanWrap = document.createElement('div');
  spanWrap.style.lineHeight = '1.8';
  words.forEach(w => {
    const span = document.createElement('span');
    span.textContent = w + ' ';
    span.className = 'word';
    spanWrap.appendChild(span);
  });
  pageBox.appendChild(spanWrap);
  const spans = [...pageBox.querySelectorAll('.word')];

  function highlightWord(index) {
    spans.forEach((s, i) => s.classList.toggle('highlight', i === index));
    const active = spans[index];
    if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // --- Voice setup ---
  let voices = speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => voices = speechSynthesis.getVoices();

  const pickVoice = (gender) => {
    if (gender === 'boy')
      return voices.find(v => /male|alex|daniel|david|john/i.test(v.name)) || voices[0];
    if (gender === 'girl')
      return voices.find(v => /female|victoria|susan|emma|samantha|anna/i.test(v.name)) || voices[0];
    return voices[0];
  };

  // --- Speak function ---
  function speakFromChar(startIndex = 0) {
    speechSynthesis.cancel();
    utter = new SpeechSynthesisUtterance(rawText.slice(startIndex));
    const voice = pickVoice(currentVoice);
    if (voice) utter.voice = voice;
    utter.lang = 'en-US';
    utter.rate = currentRate;
    utter.pitch = currentVoice === 'boy' ? 0.9 : 1.1;

    const totalChars = rawText.length;

    utter.onboundary = (e) => {
      if (e.charIndex !== undefined) {
        resumeChar = startIndex + e.charIndex;
        const wordIndex = Math.floor((resumeChar / totalChars) * spans.length);
        highlightWord(wordIndex);
      }
    };

    utter.onend = () => {
      spans.forEach(s => s.classList.remove('highlight'));

      if (currentPage < sheetsArray.length - 1) {
        currentPage++;
        nextPageBtn.click();
        setTimeout(() => narrateBtn.click(), 400);
      } else {
        showEpisodeFinishedPopup();
        narrCtrl.querySelector('#pauseNarr').textContent = '‚ñ∂ Start Again';
      }
    };

    speechSynthesis.speak(utter);
  }

  // --- Start speaking ---
  speakFromChar(resumeChar);

  // --- Controls ---
  const pauseBtn = narrCtrl.querySelector('#pauseNarr');
  const stopBtn = narrCtrl.querySelector('#stopNarr');
  const backBtn = narrCtrl.querySelector('#backwardNarr');
  const forwardBtn = narrCtrl.querySelector('#forwardNarr');
  const voiceBtn = narrCtrl.querySelector('#voiceBtn');
  const voiceMenu = narrCtrl.querySelector('#voiceMenu');
  const speedRange = narrCtrl.querySelector('#speedRange');

  // Pause / Resume / Start Again
  pauseBtn.onclick = (e) => {
    if (!utter) return;
    if (pauseBtn.textContent.includes('Start')) {
      resumeChar = 0;
      currentPage = 0;
      speakFromChar(0);
      pauseBtn.textContent = '‚è∏ Pause';
      return;
    }
    if (!isPaused && speechSynthesis.speaking) {
      speechSynthesis.pause();
      isPaused = true;
      e.target.textContent = '‚ñ∂ Resume';
    } else if (isPaused) {
      speechSynthesis.resume();
      isPaused = false;
      e.target.textContent = '‚è∏ Pause';
    }
  };

  // Stop
  stopBtn.onclick = () => {
    speechSynthesis.cancel();
    utter = null;
    isPaused = false;
    resumeChar = 0;
    pauseBtn.textContent = '‚è∏ Pause';
    spans.forEach(w => w.classList.remove('highlight'));
    narrCtrl.style.display = 'none';
  };

  // Forward / Backward buttons
  const adjustChar = (wordsCount) => {
    // Calculate current word index
    const totalChars = rawText.length;
    let currentWordIndex = Math.floor((resumeChar / totalChars) * spans.length);
    currentWordIndex += wordsCount;
    if (currentWordIndex < 0) currentWordIndex = 0;
    if (currentWordIndex >= spans.length) currentWordIndex = spans.length - 1;

    // Update resumeChar
    const portion = currentWordIndex / spans.length;
    resumeChar = Math.floor(portion * totalChars);
    speakFromChar(resumeChar);
  };

  forwardBtn.onclick = () => adjustChar(skipWords);
  backBtn.onclick = () => adjustChar(-skipWords);

  // Voice
 voiceBtn.addEventListener("pointerdown", (ev) => {
  ev.stopPropagation();
  voiceMenu.style.display = voiceMenu.style.display === "block" ? "none" : "block";
});

// Close if touching outside
document.addEventListener("pointerdown", (e) => {
  if (!voiceMenu.contains(e.target) && e.target !== voiceBtn) {
    voiceMenu.style.display = "none";
  }
});

voiceMenu.querySelectorAll("button").forEach(btn => {
  btn.addEventListener("pointerdown", () => {
    currentVoice = btn.dataset.voice;
    voiceMenu.style.display = "none";
    setTimeout(() => speakFromChar(resumeChar), 100);
  });
});


  // Speed
  speedRange.oninput = (e) => {
    currentRate = parseFloat(e.target.value);
    setTimeout(() => speakFromChar(resumeChar), 100);
  };

  // --- Finish Popup ---
  function showEpisodeFinishedPopup() {
    const existing = document.getElementById('episodeDonePopup');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'episodeDonePopup';
    modal.innerHTML = `
      <div style="
        background:white;padding:25px 30px;border-radius:16px;
        box-shadow:0 8px 30px rgba(0,0,0,0.25);
        text-align:center;max-width:360px;
      ">
        <h3 style="margin-bottom:10px;">üéâ Episode Complete!</h3>
        <p style="margin-bottom:15px;">Your episode has been successfully finished!</p>
        <button id="closeEpisodeDone" class="btn btn-primary">Close</button>
      </div>
    `;
    Object.assign(modal.style, {
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.6)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 99999,
    });
    document.body.appendChild(modal);
    modal.querySelector('#closeEpisodeDone').onclick = () => modal.remove();
  }
});

   const markLastReadBtn = document.createElement('button');
  markLastReadBtn.className = 'btn btn-warning';
  markLastReadBtn.textContent = 'Mark Last Read';

  const completeMarkBtn = document.createElement('button');
  completeMarkBtn.className = 'btn btn-success';
  completeMarkBtn.textContent = 'Complete Mark';
  completeMarkBtn.style.display = 'none';

  const removeMarkBtn = document.createElement('button');
  removeMarkBtn.className = 'btn btn-danger';
  removeMarkBtn.textContent = 'Remove Last Read';
  removeMarkBtn.style.display = 'inline-block';

  // Small button style helper
  const styleButton = btn => {
    btn.style.padding = '6px 10px';
    btn.style.fontSize = '14px';
    btn.style.borderRadius = '6px';
    btn.style.minWidth = 'auto';
  };
  [prevPageBtn, nextPageBtn, markLastReadBtn, completeMarkBtn, removeMarkBtn].forEach(styleButton);

  pagerRow.append(prevPageBtn, pageIndicator, nextPageBtn, markLastReadBtn, completeMarkBtn, removeMarkBtn);
  pageWrap.append(pageBox, pagerRow);
  body.appendChild(pageWrap);

// --- üìñ Last Read Mark Feature ---
const lastReadKey = `lastRead_${serial.title}_${ep.title}`;

// --- Highlight a marked word ---
function highlightMarkedWord(word) {
  if (!word) return;
  // Remove any old mark
  pageBox.innerHTML = pageBox.innerHTML.replace(/<mark.*?>(.*?)<\/mark>/g, '$1');
  const regex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
  pageBox.innerHTML = pageBox.innerHTML.replace(regex, `<mark style="background:yellow">$&</mark>`);
}

// --- Apply mark after rendering ---
function applyLastMark() {
  const saved = localStorage.getItem(lastReadKey);
  if (!saved) return;
  try {
    const mark = JSON.parse(saved);
    if (mark.page === currentPage && mark.word) {
      highlightMarkedWord(mark.word);
    }
  } catch {}
}

// --- Drawing + Page Render ---
function renderPage(idx) {
  currentPage = Math.max(0, Math.min(idx, totalPages - 1));
  const sheetObj = sheetsArray[currentPage] || { content: '(No content in this page)' };

  if (typeof sheetObj.content === 'string' && /<[a-z][\s\S]*>/i.test(sheetObj.content)) {
    pageBox.innerHTML = sheetObj.content;
  } else {
    pageBox.textContent = sheetObj.content || '(No content in this page)';
  }

  pageIndicator.textContent = `Page ${currentPage + 1} / ${totalPages}`;
  prevPageBtn.disabled = currentPage === 0;
  nextPageBtn.disabled = currentPage === totalPages - 1;

  applyLastMark();
}

prevPageBtn.addEventListener('click', () => {
  speechSynthesis.cancel();  // ‚õî stop speaking
  renderPage(currentPage - 1);
});

nextPageBtn.addEventListener('click', () => {
  speechSynthesis.cancel();  // ‚õî stop speaking
  renderPage(currentPage + 1);
});



// ---------- Helpers ----------
function escapeRegExp(s) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function removeExistingMarkHighlights() {
  const prev = pageBox.querySelectorAll('.marked-last-word');
  prev.forEach(p => {
    const parent = p.parentNode;
    parent.replaceChild(document.createTextNode(p.textContent), p);
    parent.normalize && parent.normalize(); // merge text nodes
  });
}

/**
 * Highlight a specific occurrence of `word` on the page.
 * If `occurrenceIndex` is undefined, highlights the first match.
 * Returns true if the target occurrence was found & highlighted.
 */
function highlightMarkedWord(word, occurrenceIndex) {
  if (!word) return false;
  removeExistingMarkHighlights();

  const wordRegex = new RegExp('\\b' + escapeRegExp(word) + '\\b', 'i'); // case-insensitive
  const walker = document.createTreeWalker(pageBox, NodeFilter.SHOW_TEXT, null, false);

  let node;
  let globalCount = 0; // counts each match across text nodes

  while ((node = walker.nextNode())) {
    const txt = node.textContent;
    let m;
    // we need to iterate all matches in this text node
    const regexAll = new RegExp('\\b' + escapeRegExp(word) + '\\b', 'ig');
    while ((m = regexAll.exec(txt)) !== null) {
      // if occurrenceIndex is undefined -> we want the first match
      const isTarget = (typeof occurrenceIndex === 'undefined') ? (globalCount === 0) : (globalCount === occurrenceIndex);
      if (isTarget) {
        const start = m.index;
        const end = start + m[0].length;

        const before = document.createTextNode(txt.slice(0, start));
        const matched = document.createElement('span');
        matched.className = 'marked-last-word';
        matched.style.background = 'yellow';
        matched.style.borderRadius = '3px';
        matched.textContent = txt.slice(start, end);
        const after = document.createTextNode(txt.slice(end));

        const parent = node.parentNode;
        parent.replaceChild(after, node);         // replace node with 'after'
        parent.insertBefore(matched, after);      // insert matched before 'after'
        parent.insertBefore(before, matched);     // insert before before matched

        // scroll into view
        matched.scrollIntoView({ block: 'center', behavior: 'smooth' });
        return true;
      }
      globalCount += 1;
    }
  }
  return false;
}

// ---------- Utility to get caret range from point ----------
function getRangeFromPoint(x, y) {
  if (document.caretRangeFromPoint) return document.caretRangeFromPoint(x, y);
  if (document.caretPositionFromPoint) {
    const pos = document.caretPositionFromPoint(x, y);
    if (!pos) return null;
    const r = document.createRange();
    r.setStart(pos.offsetNode, pos.offset);
    r.setEnd(pos.offsetNode, pos.offset);
    return r;
  }
  return null;
}

// ---------- Mark Last Read (with occurrence index) ----------
markLastReadBtn.addEventListener('click', () => {
  const popup = document.createElement('div');
  popup.innerHTML = `<div style="background:white;padding:20px 30px;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.3);font-size:16px;">
    üìò Please click the last word you read to mark your position.</div>`;
  Object.assign(popup.style, {
    position: 'fixed',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%, -50%)',
    zIndex: 1500,
  });
  document.body.appendChild(popup);

  markLastReadBtn.style.display = 'none';
  completeMarkBtn.style.display = 'inline-block';

  function handleClick(e) {
    popup.remove();

    const range = getRangeFromPoint(e.clientX, e.clientY);
    if (!range) {
      alert('‚ö†Ô∏è Could not detect position. Try clicking directly on text.');
      cleanup();
      return;
    }

    let node = range.startContainer;
    let offset = range.startOffset;

    // ensure we have a text node
    if (node.nodeType !== Node.TEXT_NODE) {
      const child = node.childNodes[offset] || node.childNodes[offset - 1];
      if (child && child.nodeType === Node.TEXT_NODE) {
        node = child;
        offset = Math.min(offset, child.textContent.length);
      } else {
        const walkerInside = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null, false);
        const firstText = walkerInside.nextNode();
        if (firstText) {
          node = firstText;
          offset = 0;
        } else {
          alert('‚ö†Ô∏è Could not find text at click location.');
          cleanup();
          return;
        }
      }
    }

    const text = node.textContent || '';
    offset = Math.max(0, Math.min(offset, text.length));

    // find the word that contains the character offset inside this text node
    // Matches English + Hindi + punctuation-ignored words
const wordRegexLocal = /([A-Za-z√Ä-≈æ0-9']+|[\u0900-\u097F]+)/g;

    let clickedWord = '';
    let localMatchStart = -1;
    let localMatchEnd = -1;
    let lm;
    while ((lm = wordRegexLocal.exec(text)) !== null) {
      const s = lm.index;
      const e = s + lm[0].length;
      if (offset >= s && offset <= e) {
        clickedWord = lm[0];
        localMatchStart = s;
        localMatchEnd = e;
        break;
      }
    }

    if (!clickedWord) {
      alert('‚ö†Ô∏è Could not detect word. Try clicking nearer the middle of the word.');
      cleanup();
      return;
    }

    // compute the global occurrence index of this matched token across the page
    // iterate through all text nodes up to (and including) this node and count matches
    const walker = document.createTreeWalker(pageBox, NodeFilter.SHOW_TEXT, null, false);
    let cur;
    let globalCount = 0;
    let found = false;
    while ((cur = walker.nextNode())) {
      if (cur === node) {
        // count matches in this node up to the localMatchStart
        const txt = cur.textContent;
        const regexAll = new RegExp('\\b' + escapeRegExp(clickedWord) + '\\b', 'ig');
        let mm;
        while ((mm = regexAll.exec(txt)) !== null) {
          if (mm.index === localMatchStart && mm[0].toLowerCase() === clickedWord.toLowerCase()) {
            found = true;
            break;
          }
          globalCount += 1;
        }
        if (found) break;
      } else {
        // count all matches in this node
        const txt = cur.textContent || '';
        const regexAll = new RegExp('\\b' + escapeRegExp(clickedWord) + '\\b', 'ig');
        while (regexAll.exec(txt) !== null) {
          globalCount += 1;
        }
      }
    }

    // Save the word and the occurrence index
    const markObj = { page: Number(currentPage), word: clickedWord, occurrence: globalCount };
    localStorage.setItem(lastReadKey, JSON.stringify(markObj));
 alert(`‚úÖ Marked last read at "${clickedWord}"`);

    // highlight the exact occurrence
    setTimeout(() => highlightMarkedWord(clickedWord, globalCount), 50);

    cleanup();
  }

  function cleanup() {
    completeMarkBtn.style.display = 'none';
    markLastReadBtn.style.display = 'inline-block';
    pageBox.style.cursor = '';
    pageBox.removeEventListener('click', handleClick);
  }

  pageBox.style.cursor = 'pointer';
  pageBox.addEventListener('click', handleClick);
});

// ---------- Complete / Cancel ----------
completeMarkBtn.addEventListener('click', () => {
  completeMarkBtn.style.display = 'none';
  markLastReadBtn.style.display = 'inline-block';
  pageBox.style.cursor = '';
});

// ---------- Remove Last Read ----------
removeMarkBtn.addEventListener('click', () => {
  localStorage.removeItem(lastReadKey);
  removeExistingMarkHighlights();
  alert('üóëÔ∏è Last read mark removed.');
  renderPage(currentPage);
});

// ---------- Resume Prompt on Reader Open ----------
// ---------- Robust Resume Prompt with retry ----------
const savedMark = localStorage.getItem(lastReadKey);
if (savedMark) {
  try {
    const mark = JSON.parse(savedMark);
    if (typeof mark.page !== 'undefined' && mark.word) {
      const pageNum = Number(mark.page);
      if (!Number.isNaN(pageNum) && pageNum >= 0) {
        const resume = confirm(`Resume from where you left off: "${mark.word}" on page ${pageNum + 1}?`);
        if (resume) {
          // Immediately set requested page and render once
          currentPage = pageNum;
          renderPage(currentPage);

          // Retry logic: try to highlight the saved occurrence repeatedly,
          // because renderPage or async content loads may overwrite the DOM.
          let attempts = 0;
          const maxAttempts = 20;     // try for ~4 seconds (20 * 200ms)
          const attemptInterval = 200; // ms

          function tryHighlight() {
            attempts += 1;
            const ok = highlightMarkedWord(mark.word, mark.occurrence);
            if (ok) {
              // success: cleanup saved mark and stop retrying
              localStorage.removeItem(lastReadKey);
              console.log('Highlighted saved mark after', attempts, 'attempts');
              return;
            }
            if (attempts >= maxAttempts) {
              // couldn't highlight after retries. leave the saved mark in storage
              // so user can try again later. optionally inform user.
              console.warn('Could not find saved word to highlight after retries.');
              return;
            }
            // Re-apply page render in case some later init moved page back to 1:
            // this forces the reader to the intended page again on each retry.
            currentPage = pageNum;
            renderPage(currentPage);
            setTimeout(tryHighlight, attemptInterval);
          }

          // start retries shortly after initial render to give any microtasks time
          setTimeout(tryHighlight, 120);
        }
      }
    }
  } catch (err) {
    console.error('Error parsing lastReadKey', err);
  }
}

  if (sheetsArray.length === 0) sheetsArray.push({ content: '(No content in this episode yet)' });
  renderPage(0);
  // ====== üéß NARRATOR CONTROLS ======
  const narrationControls = document.createElement('div');
  narrationControls.style.cssText = `
    display:none;justify-content:center;align-items:center;gap:10px;
    margin-top:14px;flex-wrap:wrap;
  `;
  narrationControls.innerHTML = `
    <button id="narrateBtn" class="btn btn-secondary">üéß Narrate</button>
    <button id="pauseNarrationBtn" class="btn btn-secondary" style="display:none;">‚è∏Ô∏è Pause</button>
    <button id="stopNarrationBtn" class="btn btn-danger" style="display:none;">‚èπÔ∏è Stop</button>
    <button id="voiceSelectBtn" class="btn btn-primary" style="display:none;">üé§ Voice ‚ñæ</button>
    <label style="font-weight:600;display:none;" id="speedLabel">Speed:
      <input type="range" id="speedRange" min="0.6" max="1.6" step="0.05" value="1">
    </label>
    <div id="voiceDropdown" style="
      display:none;position:absolute;top:100%;right:0;
      background:white;border:1px solid #ccc;border-radius:8px;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);z-index:9999;min-width:160px;
    ">
      <button data-voice="boy" style="display:block;width:100%;border:none;background:white;padding:10px;text-align:left;">üë¶ Boy</button>

    </div>
  `;
  pageWrap.appendChild(narrationControls);

  // ====== NARRATION LOGIC ======
  let voices = [];
  let currentVoice = 'boy';
  let currentRate = 1.0;
  let utterance = null;
  let utteranceActive = false;
  let resumeChar = 0;
  let isPaused = false;
  let wordRanges = [];

  function loadVoices() {
    voices = speechSynthesis.getVoices();
    if (!voices.length) setTimeout(loadVoices, 300);
  }
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  function pickVoice(role) {
    if (!voices.length) return null;
    const pick = (rx) => voices.find(v => rx.test(v.name) || (v.lang && rx.test(v.lang)));
    if (role === 'boy') return pick(/male|david|alex|daniel|john|peter/i) || voices[0];
    if (role === 'girl') return pick(/female|victoria|susan|samantha|anna|kate/i) || voices[0];
    return voices[0];
  }

  function highlightWord(wi) {
    const spans = pageBox.querySelectorAll('.word');
    spans.forEach((s, i) => s.classList.toggle('highlight', i === wi));
    const target = spans[wi];
    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function renderNarrationWords(text) {
    pageBox.innerHTML = '';
    const words = text.split(/\s+/);
    let pos = 0;
    wordRanges = [];
    words.forEach((w, wi) => {
      const span = document.createElement('span');
      span.className = 'word';
      span.textContent = w + ' ';
      const start = pos;
      const end = pos + span.textContent.length;
      wordRanges.push([start, end]);
      pos = end;
      pageBox.appendChild(span);
    });
  }

  function speakCurrentPage(resumeFrom = 0) {
    const text = (sheetsArray[currentPage] && sheetsArray[currentPage].content) || '';
    renderNarrationWords(text);
    const u = new SpeechSynthesisUtterance(text.slice(resumeFrom));
    const voice = pickVoice(currentVoice);
    if (voice) u.voice = voice;
    u.lang = voice?.lang || 'en-US';
    u.pitch = currentVoice === 'boy' ? 0.85 : 1.2;
    u.rate = currentRate;
    utterance = u;
    utteranceActive = true;
    isPaused = false;

    u.onboundary = (ev) => {
      if (ev.name === 'word' || ev.name === 'char') {
        const abs = resumeFrom + ev.charIndex;
        resumeChar = abs;
        for (let wi = 0; wi < wordRanges.length; wi++) {
          const [s, e] = wordRanges[wi];
          if (abs >= s && abs < e) {
            highlightWord(wi);
            break;
          }
        }
      }
    };

    u.onend = () => {
      utteranceActive = false;
      narrationControls.querySelector('#pauseNarrationBtn').style.display = 'none';
      narrationControls.querySelector('#stopNarrationBtn').style.display = 'none';
      narrationControls.querySelector('#voiceSelectBtn').style.display = 'none';
      narrationControls.querySelector('#speedLabel').style.display = 'none';
    };

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // üéß Narrate button
  narrationControls.querySelector('#narrateBtn').addEventListener('click', () => {
    narrationControls.querySelector('#pauseNarrationBtn').style.display = 'inline-block';
    narrationControls.querySelector('#stopNarrationBtn').style.display = 'inline-block';
    narrationControls.querySelector('#voiceSelectBtn').style.display = 'inline-block';
    narrationControls.querySelector('#speedLabel').style.display = 'inline-block';
    speakCurrentPage(0);
  });

  // ‚è∏ Pause / ‚ñ∂ Resume
  narrationControls.querySelector('#pauseNarrationBtn').addEventListener('click', (e) => {
    if (!utterance) return;
    if (!isPaused && speechSynthesis.speaking) {
      speechSynthesis.pause();
      isPaused = true;
      e.target.textContent = '‚ñ∂Ô∏è Resume';
    } else if (isPaused) {
      speechSynthesis.resume();
      isPaused = false;
      e.target.textContent = '‚è∏Ô∏è Pause';
    }
  });

  // ‚èπ Stop
  narrationControls.querySelector('#stopNarrationBtn').addEventListener('click', () => {
    speechSynthesis.cancel();
    utterance = null;
    utteranceActive = false;
    isPaused = false;
    narrationControls.querySelector('#pauseNarrationBtn').textContent = '‚è∏Ô∏è Pause';
  });

  // üé§ Voice Dropdown
  const voiceDropdown = narrationControls.querySelector('#voiceDropdown');
  const voiceBtn = narrationControls.querySelector('#voiceSelectBtn');
  voiceBtn.addEventListener('click', (ev) => {
    ev.stopPropagation();
    voiceDropdown.style.display = voiceDropdown.style.display === 'block' ? 'none' : 'block';
  });
  document.addEventListener('click', (e) => {
    if (!voiceDropdown.contains(e.target) && e.target !== voiceBtn)
      voiceDropdown.style.display = 'none';
  });
  voiceDropdown.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
      currentVoice = btn.dataset.voice;
      voiceDropdown.style.display = 'none';
      alert(`üé§ Voice switched to ${btn.textContent}`);
      if (utteranceActive) {
        speechSynthesis.cancel();
        setTimeout(() => speakCurrentPage(resumeChar || 0), 100);
      }
    });
  });

  // ‚ö° Speed control
  narrationControls.querySelector('#speedRange').addEventListener('input', (e) => {
    currentRate = parseFloat(e.target.value);
    if (utteranceActive) {
      speechSynthesis.cancel();
      setTimeout(() => speakCurrentPage(resumeChar || 0), 100);
    }
  });

  // --- FOOTER ---
  const footer = document.createElement('div');
  footer.style.cssText = `
    display:flex;justify-content:center;flex-wrap:wrap;gap:6px;
    padding:12px;background:#fff;flex-shrink:0;
  `;

const prevBtn = document.createElement('button');
prevBtn.className = 'btn btn-secondary';
prevBtn.textContent = '‚óÄ Prev Episode';

const nextBtn = document.createElement('button');
nextBtn.className = 'btn btn-primary';
nextBtn.textContent = 'Next Episode ‚ñ∂';

// üßò Zen Shield Button
const zenShieldBtn = document.createElement('button');
zenShieldBtn.className = 'btn btn-info';
zenShieldBtn.textContent = 'üßò Zen Shield';
zenShieldBtn.style.marginLeft = '8px';

// Helper style for consistency
[prevBtn, nextBtn, zenShieldBtn].forEach(styleButton);

footer.append(prevBtn, nextBtn, zenShieldBtn);
panel.append(header, body); // DO NOT append footer

document.getElementById('headerRightButtons').append(prevBtn, nextBtn, zenShieldBtn);

  // --- Button Actions ---
document.getElementById('backToSerialBtn').addEventListener('click', () => {

    // üî• Stop AI narrator immediately
    speechSynthesis.cancel();

    // Your existing close logic
    panel.remove();

    if (typeof openSerialPreview === 'function') {
        openSerialPreview(serial);
    }
});

prevBtn.addEventListener('click', () => {

    // stop narrator so no ghost voice
    if (speechSynthesis.speaking || speechSynthesis.pending) {
        speechSynthesis.cancel();
    }

    if (episodeIndex > 0) {
        openSerialReader(serial.title, episodeIndex - 1);
    }
});


nextBtn.addEventListener('click', () => {

    // ‚≠ê STOP AI NARRATOR immediately
    if (speechSynthesis.speaking || speechSynthesis.pending) {
        speechSynthesis.cancel();
    }

    // ‚≠ê Then go to next episode
    if (episodeIndex < (serial.episodes || []).length - 1) {
        openSerialReader(serial.title, episodeIndex + 1);
    }
});


zenShieldBtn.addEventListener('click', () => {
  // Find the reader panel container
  const readerPanel = panel; // your current reading container
  const scrollContainer = readerPanel.querySelector('.reader-body') || readerPanel;

  // Remember current scroll position (inside reader only)
  const scrollY = scrollContainer.scrollTop;

  // Create shield layer *inside the reader panel only*
  const zenLayer = document.createElement('div');
  zenLayer.id = 'zenShieldLayer';
  zenLayer.style.cssText = `
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top left, #d7e8ff 0%, #f3f9ff 30%, #eaf5f0 80%);
    backdrop-filter: blur(10px) brightness(0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow-y: auto;
    scroll-behavior: smooth;
    padding: 60px 0;
    z-index: 99;
    border-radius: inherit;
  `;

  // Copy reading content only
  const zenContent = document.createElement('div');
  zenContent.innerHTML = pageBox.innerHTML;
  zenContent.style.cssText = `
    max-width: 900px;
    padding: 40px 50px;
    font-size: 20px;
    line-height: 1.9;
    color: #1c1b16;
    background: rgba(255,255,255,0.9);
    border-radius: 18px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.15);
    font-family: 'Georgia', 'Times New Roman', serif;
    text-align: justify;
    letter-spacing: 0.3px;
  `;

  // Close button
  const closeZenBtn = document.createElement('button');
  closeZenBtn.textContent = '‚úñ Close Shield';
  closeZenBtn.className = 'btn btn-danger';
  closeZenBtn.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    font-size: 16px;
    padding: 8px 14px;
    border-radius: 8px;
    background: #d64545;
    color: white;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    cursor: pointer;
  `;

  // Ambient animation (isolated)
  const ambient = document.createElement('div');
  ambient.style.cssText = `
    position:absolute;
    inset:0;
    background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 60%),
               radial-gradient(circle at 70% 70%, rgba(255,255,255,0.2), transparent 60%);
    animation: zenAmbient 8s ease-in-out infinite alternate;
    z-index:0;
  `;
  if (!document.getElementById('zenAmbientStyle')) {
    const styleTag = document.createElement('style');
    styleTag.id = 'zenAmbientStyle';
    styleTag.textContent = `
      @keyframes zenAmbient {
        0% { transform: scale(1); opacity: 0.8; }
        100% { transform: scale(1.2); opacity: 1; }
      }
    `;
    document.head.appendChild(styleTag);
  }

  zenLayer.append(ambient, zenContent, closeZenBtn);
  readerPanel.appendChild(zenLayer);

  // Hide local reader UI only
  readerPanel.querySelectorAll('.reader-header, .reader-footer')
    .forEach(el => (el.style.display = 'none'));

  // Restore scroll & UI on close
  closeZenBtn.addEventListener('click', () => {
    zenLayer.remove();
    readerPanel.querySelectorAll('.reader-header, .reader-footer')
      .forEach(el => (el.style.display = ''));
    scrollContainer.scrollTo(0, scrollY);
  });
});

  window.scrollTo(0, 0);
}

// --- Optional: Sync serialsData push ---
(function(){
  try{
    if(Array.prototype._origSerialPush == null){
      Array.prototype._origSerialPush = Array.prototype.push;
    }
    if(window.serialsData && window.serialsData.push){
      const orig = window.serialsData.push;
      window.serialsData.push = function(){
        const res = orig.apply(this, arguments);
        try{ syncSerialsToStorage(); }catch(e){}
        return res;
      };
    }
  }catch(e){}
})();

// Also call sync after some known buttons if they exist
setTimeout(()=>{
  if(window.serialCreateConfirmBtn){
    serialCreateConfirmBtn.addEventListener('click', ()=> setTimeout(syncSerialsToStorage, 500) );
  }
  if(window.addEpConfirmBtn){
    addEpConfirmBtn.addEventListener('click', ()=> setTimeout(syncSerialsToStorage, 500) );
  }
}, 800);

</script>
<!-- END: SERIALS EXTENSION INJECTION -->

<!-- START: Auto-Injected Serial READs & Download Augmentation -->
<script>
(function(){
  // Helper: stable key for serial (using title)
  function serialKey(title) {
    return 'serial_reads_' + (title || 'unknown').replace(/\s+/g,'_').toLowerCase();
  }

  // Persisted storage helpers
  function loadCounts(key) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : {};
    } catch(e){ return {}; }
  }
  function saveCounts(key, obj) {
    try { localStorage.setItem(key, JSON.stringify(obj)); } catch(e){}
  }

  // Download helper
  function downloadJSON(filename, obj) {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj, null, 2));
    const a = document.createElement('a');
    a.setAttribute('href', dataStr);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Try to detect serial preview containers added to DOM.
  const observer = new MutationObserver(mutations => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (!(node instanceof HTMLElement)) continue;
        // Detect likely serial preview by common heuristics: header with <h1>, description, and multiple episode cards/lists.
        const h1 = node.querySelector && (node.querySelector('h1') || node.querySelector('.serial-title') || node.querySelector('.title'));
        const episodes = node.querySelectorAll && (node.querySelectorAll('.episode, .ep, .story-card, .episode-card, .ep-card') || []);
        // episodes NodeList may be empty; we will further search inside for lists
        const potentialEpisodeItems = node.querySelectorAll('li, .episode, .story-card, .episode-card, .ep-card');
        const epCount = potentialEpisodeItems.length;
        if (h1 && (epCount > 0 || node.querySelectorAll('.episode').length>0)) {
          enhanceSerialPreview(node);
        } else {
          // Some previews might use a wrapper with class 'serial-preview' or id 'serialPreview'
          if (node.matches && (node.matches('.serial-preview') || node.id === 'serialPreview')) {
            enhanceSerialPreview(node);
          }
        }
      }
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });

  // Also attempt to enhance already-present preview on page load (in case it exists)
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      const previews = document.querySelectorAll('.serial-preview, [data-serial-preview], #serialPreview');
      if (previews.length) previews.forEach(enhanceSerialPreview);
      // Fallback: find containers with h1 and multiple story-card children
      const nodes = Array.from(document.querySelectorAll('div, section'));
      for (const n of nodes) {
        const h1 = n.querySelector && (n.querySelector('h1') || n.querySelector('.serial-title'));
        const items = n.querySelectorAll && n.querySelectorAll('.story-card, .episode, li').length;
        if (h1 && items>0) enhanceSerialPreview(n);
      }
    }, 500);
  });

  // Main enhancer function
  function enhanceSerialPreview(container){
    try {
      // Avoid double-enhancing
      if (container.__readsEnhanced) return;
      container.__readsEnhanced = true;

      // Locate serial title, genre, description
      const titleEl = container.querySelector('h1') || container.querySelector('.serial-title') || container.querySelector('.title');
      const title = titleEl ? titleEl.textContent.trim() : 'untitled_serial';
      const key = serialKey(title);

      // Find or create the READ total label under header
      let readsLabel = container.querySelector('#serialReadsLabel');
      if (!readsLabel) {
        readsLabel = document.createElement('div');
        readsLabel.id = 'serialReadsLabel';
        readsLabel.style.fontWeight = '700';
        readsLabel.style.marginTop = '8px';
        // Prefer to insert after the title or after a header block
        if (titleEl && titleEl.parentElement) {
          titleEl.parentElement.appendChild(readsLabel);
        } else {
          container.insertBefore(readsLabel, container.firstChild);
        }
      }


      // Load counts from storage
      const counts = loadCounts(key);

      // Identify episode elements (best-effort)
      let episodeEls = Array.from(container.querySelectorAll('.episode, .episode-card, .ep-card, .story-card, li'));
      // Filter out container-level lists that are not episodes by checking for a 'Read' button inside or 'Start Reading' text
      episodeEls = episodeEls.filter(el => {
        const txt = (el.textContent||'').toLowerCase();
        const hasReadBtn = !!el.querySelector('button, a');
        return txt.length<10000 && (hasReadBtn || txt.includes('episode') || txt.includes('start reading') || txt.includes('read'));
      });

      // If nothing found, try direct children
      if (episodeEls.length === 0) {
        const list = container.querySelectorAll('ul > li, ol > li');
        episodeEls = Array.from(list);
      }

      // Add per-episode UI
      episodeEls.forEach((epEl, idx) => {
        // Avoid double-insert
        if (epEl.querySelector('.read-count-badge')) return;

        // Determine an episode title
        const epTitleEl = epEl.querySelector('h3, h4, .ep-title, .title') || epEl.querySelector('strong') || epEl;
        const epTitle = epTitleEl ? (epTitleEl.textContent || '').trim().substring(0,120) : ('Episode ' + (idx+1));

        // Ensure reads value exists
        if (typeof counts[idx] !== 'number') counts[idx] = counts[idx] || 0;

        // Create read badge
        const badge = document.createElement('span');
        badge.className = 'read-count-badge';
        badge.style.marginLeft = '8px';
        badge.style.fontWeight = '700';
        badge.style.fontSize = '13px';
        badge.textContent = 'Reads = ' + (counts[idx]||0);

        // Append badge near title or at the end
        if (epTitleEl && epTitleEl.parentElement) {
          epTitleEl.parentElement.appendChild(badge);
        } else {
          epEl.appendChild(badge);
        }

        // Wire the episode's "Read" or "Start Reading" button to increment the count
        // Search for button-like elements
        const candidateBtns = Array.from(epEl.querySelectorAll('button, a'));
        let readBtn = candidateBtns.find(b => /read|start reading|open/i.test((b.textContent||'')));
        if (!readBtn && candidateBtns.length) readBtn = candidateBtns[0];

        if (readBtn) {
          readBtn.addEventListener('click', (ev) => {
            // Increment count and save
            counts[idx] = (counts[idx] || 0) + 1;
            saveCounts(key, counts);
            // Update badge and total label
            badge.textContent = 'READ = ' + counts[idx];
            updateTotalLabel(container, counts);
            // allow other handlers to run
            setTimeout(()=>{},0);
          });
        }
      });

      // Save counts back (initial)
      saveCounts(key, counts);
      updateTotalLabel(container, counts);
    } catch(e){
      console.error('enhanceSerialPreview error', e);
    }
  }

  function updateTotalLabel(container, counts) {
    const total = (Array.isArray(counts) ? counts.reduce((a,b)=>a+(b||0),0) : Object.values(counts).reduce((a,b)=>a+(b||0),0));
    let lbl = container.querySelector('#serialReadsLabel');
    if (!lbl) {
      lbl = document.createElement('div');
      lbl.id = 'serialReadsLabel';
      lbl.style.fontWeight = '700';
      lbl.style.marginTop = '8px';
      if (container.querySelector('h1')) container.querySelector('h1').parentElement.appendChild(lbl);
      else container.appendChild(lbl);
    }
    lbl.textContent = 'Reads = ' + total;
  }

  // Build a best-effort serial JSON from the DOM preview (title, genre, description, episodes text)
  function buildSerialJSON(container) {
    const title = (container.querySelector('h1') || container.querySelector('.serial-title') || {textContent:'Untitled'}).textContent.trim();
    const genre = (container.querySelector('.genre') || container.querySelector('[data-genre]') || {textContent:''}).textContent.trim();
    const desc = (container.querySelector('.description') || container.querySelector('.serial-description') || {textContent:''}).textContent.trim();
    const episodes = [];
    const episodeEls = Array.from(container.querySelectorAll('.episode, .episode-card, .story-card, li'));
    episodeEls.forEach((el, idx) => {
      const epTitle = (el.querySelector('h3, h4, .ep-title') || el.querySelector('strong') || {textContent:('Episode '+(idx+1))}).textContent.trim();
      const body = (el.querySelector('.body, p') || el).textContent.trim();
      // load counts
      const key = 'serial_reads_' + title.replace(/\s+/g,'_').toLowerCase();
      let counts = {};
      try { counts = JSON.parse(localStorage.getItem(key) || '{}'); } catch(e){}
      const reads = counts[idx] || 0;
      episodes.push({ title: epTitle, body: body, reads: reads });
    });
    return { title, genre, description: desc, episodes };
  }

    })();

  // Additional UI tweaks:
  // 1) If both Close and Download buttons exist in a preview, swap their positions so Close is where Download was and vice versa.
  function swapPreviewButtons(container) {
    try {
      const closeBtn = container.querySelector('#closeSerialPreviewBtn') || Array.from(container.querySelectorAll('button')).find(b => /close/i.test(b.textContent||''));
      const downloadBtn = container.querySelector('#downloadSerialBtn') || Array.from(container.querySelectorAll('button')).find(b => /download serial/i.test(b.textContent||''));
      if (closeBtn && downloadBtn && closeBtn.parentElement && downloadBtn.parentElement) {
        const closeParent = closeBtn.parentElement;
        const downloadParent = downloadBtn.parentElement;
        // Swap by replacing nodes
        const closeClone = closeBtn.cloneNode(true);
        const downloadClone = downloadBtn.cloneNode(true);
        closeClone.id = closeBtn.id || 'closeSerialPreviewBtn_clone';
        downloadClone.id = downloadBtn.id || 'downloadSerialBtn_clone';
        // replace
        closeParent.replaceChild(downloadClone, closeBtn);
        downloadParent.replaceChild(closeClone, downloadBtn);
        // reattach listeners if any by clicking behaviors (best-effort: forward click to original behavior)
        downloadClone.addEventListener('click', function(e){ downloadBtn.click && downloadBtn.click(); });
        closeClone.addEventListener('click', function(e){ closeBtn.click && closeBtn.click(); });
      }
    } catch(e){console.warn('swapPreviewButtons failed', e);}
  }

 
  // Run these helpers when new previews are detected and on DOMContentLoaded
  const extraObserver = new MutationObserver(muts => {
    muts.forEach(m => {
      m.addedNodes.forEach(n => {
        if (!(n instanceof HTMLElement)) return;
        // If a preview or header added, attempt swap
        if (n.querySelector && (n.querySelector('#downloadSerialBtn') || n.querySelector('#closeSerialPreviewBtn') || n.querySelector('h1'))) {
          swapPreviewButtons(n);
        }
      });
    });
    // Also attempt to ensure Back button on any mutation
    ensureBrowseBackButton();
  });
  extraObserver.observe(document.body, { childList: true, subtree: true });

  document.addEventListener('DOMContentLoaded', () => {
    // Try swapping in already-present previews
    const previews = document.querySelectorAll('.serial-preview, #serialPreview, .preview-modal, .story-preview');
    previews.forEach(p => swapPreviewButtons(p));
    ensureBrowseBackButton();
    // Also attempt a second pass after a short delay
    setTimeout(()=>{ previews.forEach(p => swapPreviewButtons(p)); ensureBrowseBackButton(); }, 800);
  });

</script>
<!-- END: Auto-Injected Serial READs & Download Augmentation -->
  <!-- existing app scripts -->
  <script>
// ---------- Tags helpers (insert near other helpers) ----------

// create a tag "chip" element
function makeTagChip(tagText) {
  const chip = document.createElement('div');
  chip.className = 'tag-chip';
  chip.style.cssText = 'display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-weight:600';
  chip.innerHTML = `<span class="tag-label">${tagText}</span><button type="button" class="tag-remove" title="Remove tag" style="background:transparent;border:0;cursor:pointer;font-weight:700">‚úï</button>`;
  chip.querySelector('.tag-remove').addEventListener('click', () => chip.remove());
  return chip;
}

// add one tag from an input to a container (prevents duplicates, trims)
function addTagFromInput(inputEl, containerEl) {
  if (!inputEl || !containerEl) return;
  const raw = (inputEl.value || '').trim();
  if (!raw) return inputEl.value = '';

  // support comma-separated tags (e.g. "apple, banana")
  const parts = raw.split(',').map(s => s.trim()).filter(Boolean);

  parts.forEach(v => {
    // prevent duplicates (case-insensitive)
    const exist = Array.from(containerEl.querySelectorAll('.tag-label'))
      .some(n => n.textContent.toLowerCase() === v.toLowerCase());
    if (exist) return;
    const chip = makeTagChip(v);
    containerEl.appendChild(chip);
  });

  inputEl.value = '';
  inputEl.focus();
}

// return array of tag texts from a container
function getTagsFromContainer(containerEl) {
  if (!containerEl) return [];
  return Array.from(containerEl.querySelectorAll('.tag-label')).map(n => n.textContent.trim()).filter(Boolean);
}

// clear container and set tags (useful when loading an existing story/serial)
function setTagsToContainer(containerEl, tagsArray) {
  if (!containerEl) return;
  containerEl.innerHTML = '';
  (Array.isArray(tagsArray) ? tagsArray : []).forEach(t => {
    if (!t) return;
    const chip = makeTagChip(t);
    containerEl.appendChild(chip);
  });
}

// wire inputs/buttons: inputEl = <input>, btnEl = add button, containerEl = tags container
function wireTagInput(inputEl, btnEl, containerEl) {
  if (!inputEl || !btnEl || !containerEl) return;

  // add click handler
  btnEl.addEventListener('click', () => addTagFromInput(inputEl, containerEl));

  // add Enter handler on input
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addTagFromInput(inputEl, containerEl);
    } else if (e.key === ',' && e.ctrlKey) {
      // optional: ctrl+, to quickly add current value
      e.preventDefault();
      addTagFromInput(inputEl, containerEl);
    }
  });

  // handle paste of multiple tags (comma-separated)
  inputEl.addEventListener('paste', (ev) => {
    const text = (ev.clipboardData || window.clipboardData).getData('text');
    if (text && text.includes(',')) {
      ev.preventDefault();
      inputEl.value = text;
      addTagFromInput(inputEl, containerEl);
    }
  });
}

// convenience initialiser ‚Äî automatically finds the elements you added earlier
function initTagsUI() {
  try {
    const storyInput = document.getElementById('storyTagInput');
    const storyBtn = document.getElementById('addStoryTagBtn');
    const storyCont = document.getElementById('storyTagsContainer');

    const seriesInput = document.getElementById('seriesTagInput');
    const seriesBtn = document.getElementById('addSeriesTagBtn');
    const seriesCont = document.getElementById('seriesTagsContainer');

    if (storyInput && storyBtn && storyCont) wireTagInput(storyInput, storyBtn, storyCont);
    if (seriesInput && seriesBtn && seriesCont) wireTagInput(seriesInput, seriesBtn, seriesCont);

    // If you want to pre-load tags when editing, call setTagsToContainer(container, tagsArray)
    // Example:
    // setTagsToContainer(storyCont, existingStory.tags || []);

  } catch (err) {
    console.warn('initTagsUI error', err);
  }
}

// call init on DOM ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTagsUI);
} else {
  initTagsUI();
}

// ---- Helpers to attach tags to your payloads before save/publish ----

// Usage: before saving/publishing a story, do:
// const story = { title: ..., content: ... };
// attachStoryTagsToPayload(story);
// then save story object
function attachStoryTagsToPayload(payload) {
  const c = document.getElementById('storyTagsContainer');
  if (!payload) payload = {};
  payload.tags = getTagsFromContainer(c);
  return payload;
}

// Usage for series/serial create flow:
// const series = { title: ..., desc: ... };
// attachSeriesTagsToPayload(series);
function attachSeriesTagsToPayload(payload) {
  const c = document.getElementById('seriesTagsContainer');
  if (!payload) payload = {};
  payload.tags = getTagsFromContainer(c);
  return payload;
}

// ---- Small CSS helper (optional) ----
// If you prefer to add styles inside a <style> tag, here's a compact rule you can paste into your CSS:
const tagChipStyle = `
.tag-chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb; font-weight:600; margin:2px; }
.tag-chip .tag-remove { cursor:pointer; font-weight:700; padding-left:6px; }
`;
// inject style once (non-destructive)
if (!document.getElementById('meurbal-tagchip-styles')) {
  const s = document.createElement('style');
  s.id = 'meurbal-tagchip-styles';
  s.textContent = tagChipStyle;
  document.head.appendChild(s);
}

    // your main app code ...
  </script>

  <!-- ‚úÖ Add this line for Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
// ---- Inject cover background in browse stories ----
function applyCoverToStoryCards() {
  document.querySelectorAll('#storiesCards .story-card').forEach(card => {
    const title = card.querySelector('h2')?.innerText?.trim();
    if (!title) return;
    const story = (window.storiesData || []).find(s => s.title === title);
    if (story && story.cover) {
      card.style.backgroundImage = `url(${story.cover})`;
      card.style.backgroundSize = 'cover';
      card.style.backgroundPosition = 'center';
      card.style.color = '#fff';
    }
  });
}



// ---- Enhanced cover display for Browse Stories ----
function renderStoryCardsWithCovers(storiesArray) {
  const container = document.getElementById('storiesCards');
  if (!container) return;
  container.innerHTML = '';
  (storiesArray || []).forEach(story => {
    const storyCard = document.createElement('div');
    storyCard.className = 'story-card';
    storyCard.innerHTML = `<h2>${story.title}</h2><p>${story.genre || ''}</p>`;

    if (story.cover) {
      storyCard.style.backgroundImage = `url(${story.cover})`;
      storyCard.style.backgroundSize = 'cover';
      storyCard.style.backgroundPosition = 'center';
      storyCard.style.color = '#fff';
    }

    container.appendChild(storyCard);
  });
}

// Automatically override story browsing behavior
window._oldRenderStories = window.renderStories;
window.renderStories = function() {
  if (typeof window._oldRenderStories === 'function') window._oldRenderStories();
  try {
    renderStoryCardsWithCovers(window.storiesData || []);
  } catch (e) { console.warn('Cover apply failed:', e); }
};

// Run once on page load in case stories are already shown
document.addEventListener('DOMContentLoaded', () => renderStoryCardsWithCovers(window.storiesData || []));


// Apply covers to serial cards in browse serials (runs after serials rendered)
function applySerialCovers() {
  // serialCategoriesGrid might contain cat cards; serial listing rendering may be elsewhere.
  // We'll scan serialsData and update any card elements that have data-title attribute matching serial title.
  document.querySelectorAll('.serial-card').forEach(card => {
    const title = card.dataset.title;
    if (!title) return;
    const ser = (window.serialsData || []).find(s => s.title === title);
    if (ser && ser.cover) {
      card.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url(${ser.cover})`;
      card.style.backgroundSize = 'cover';
      card.style.backgroundPosition = 'center';
      card.style.color = '#fff';
    }
  });
}
document.addEventListener('DOMContentLoaded', () => setTimeout(applySerialCovers, 300));
// === TESTING ONLY ===
// Generates 100 random serials with varying popularity, genres, and recency
function generateFakeSerials(count = 100) {
  const genres = ["Action", "Romance", "Comedy", "Fantasy", "Horror", "Tragic", "Thriller","Adventure","Crime","Historic"];
  const covers = [
    "https://picsum.photos/seed/serial1/500/700",
    "https://picsum.photos/seed/serial2/500/700",
    "https://picsum.photos/seed/serial3/500/700",
    "https://picsum.photos/seed/serial4/500/700",
    "https://picsum.photos/seed/serial5/500/700"
  ];

  const randomDate = () => {
    const daysAgo = Math.floor(Math.random() * 365); // up to 1 year old
    const date = new Date(Date.now() - daysAgo * 86400000);
    return date.toISOString();
  };

  const serials = [];
  for (let i = 0; i < count; i++) {
    const genre = genres[Math.floor(Math.random() * genres.length)];
    const title = `${genre} Serial #${i + 1}`;
    const views = Math.floor(Math.random() * 10000);
    const likes = Math.floor(Math.random() * 500);
    const votes = Math.floor(Math.random() * 200);
    const cover = covers[Math.floor(Math.random() * covers.length)];
    const description = `A ${genre.toLowerCase()} story full of twists, heroes, and heart. Random ID ${i}.`;

    serials.push({
      id: i + 1,
      title,
      genre,
      description,
      views,
      likes,
      votes,
      cover,
      createdAt: randomDate()
    });
  }

  return serials;
}

// === CALL THIS TO TEST ===
function testSerialAlgorithm() {
  const fakeList = generateFakeSerials(100);
  renderBrowseSerials(fakeList);
  console.log("‚úÖ Generated 100 fake serials and rendered using new algorithm.");
}

// Run automatically for quick testing (you can remove this after testing)
document.addEventListener('DOMContentLoaded', () => {
  testSerialAlgorithm();
});

</script>

<script>
// --- Real Search (no demo/fake stories) ---
function initRealSearch(){
  // helper
  function escapeHtml(str){return String(str??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
  function debounce(fn,wait=220){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)};}

  // -------- STORIES SEARCH ----------
  const storiesInput=document.getElementById('storiesSearchInput');
  const storiesClear=document.getElementById('storiesClearSearchBtn');
  const storiesCards=document.getElementById('storiesCards');
  function searchStories(q){
    const query=(q||'').trim().toLowerCase();
    if(!storiesCards)return;
    let pool=[];
    try{pool=(window.storiesData||[]).slice();}catch(e){}
    try{
      const saved=JSON.parse(localStorage.getItem('savedStories_v1')||'[]');
      if(Array.isArray(saved))pool=pool.concat(saved);
    }catch(e){}
    if(!query){
      storiesCards.innerHTML='';
      return;
    }
    const seen=new Map();
    pool.forEach(s=>{if(s&&s.title&&!seen.has(s.title))seen.set(s.title,s)});
    const matches=Array.from(seen.values()).filter(s=>(s.title||'').toLowerCase().includes(query));
    storiesCards.innerHTML='';
    matches.forEach(story=>{
      const card=document.createElement('div');
      card.className='story-card';
      card.style.minHeight='220px';
      card.innerHTML=`<h3>${escapeHtml(story.title||'Untitled')}</h3><p>${escapeHtml(story.genre||'')}</p>`;
      if(story.cover)card.style.backgroundImage=`linear-gradient(rgba(0,0,0,0.25),rgba(0,0,0,0.25)),url(${story.cover})`;
      card.addEventListener('click',()=>{try{openPreviewFullScreen(story);}catch(e){}});
      storiesCards.appendChild(card);
    });
  }
  if(storiesInput)storiesInput.addEventListener('input',debounce(e=>searchStories(e.target.value),200));
  if(storiesClear)storiesClear.addEventListener('click',()=>{storiesInput.value='';searchStories('');});

  // -------- SERIALS SEARCH ----------
  const serialsInput=document.getElementById('serialsSearchInput');
  const serialsClear=document.getElementById('serialsClearSearchBtn');
  const serialsWrap=document.getElementById('serialSearchResults');
  const serialsCards=document.getElementById('serialsCards');
  function searchSerials(q){
    const query=(q||'').trim().toLowerCase();
    let pool=[];
    try{pool=(window.serialsData||[]).slice();}catch(e){}
    try{
      const saved=JSON.parse(localStorage.getItem('savedSerials_v1')||'[]');
      if(Array.isArray(saved))pool=pool.concat(saved);
    }catch(e){}
    if(!serialsCards)return;
    if(!query){
      serialsCards.innerHTML='';
      if(serialsWrap)serialsWrap.style.display='none';
      return;
    }
    const seen=new Map();
    pool.forEach(s=>{if(s&&s.title&&!seen.has(s.title))seen.set(s.title,s)});
    const matches=Array.from(seen.values()).filter(s=>(s.title||'').toLowerCase().includes(query));
    serialsCards.innerHTML='';
    matches.forEach(s=>{
      const card=document.createElement('div');
      card.className='story-card serial-card';
      card.style.minHeight='220px';
      card.innerHTML=`<h3>${escapeHtml(s.title||'Untitled')}</h3><p>${escapeHtml(s.genre||'')}</p>`;
      if(s.cover)card.style.backgroundImage=`linear-gradient(rgba(0,0,0,0.25),rgba(0,0,0,0.25)),url(${s.cover})`;
      card.addEventListener('click',()=>{try{openSerialPreview(s.id||s.title);}catch(e){}});
      serialsCards.appendChild(card);
    });
    if(serialsWrap)serialsWrap.style.display=matches.length?'block':'none';
  }
  if(serialsInput)serialsInput.addEventListener('input',debounce(e=>searchSerials(e.target.value),200));
  if(serialsClear)serialsClear.addEventListener('click',()=>{serialsInput.value='';searchSerials('');});
}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',initRealSearch);
else initRealSearch();
</script>


<script>
document.addEventListener('DOMContentLoaded', async ()=>{
  // load from firebase if available
  try{
    if(window._firebase && window._firebase.get){
      const { db, ref, get, child } = window._firebase;
      // load stories
      try{
        const snap = await get(child(ref(db), 'stories'));
        if(snap && snap.exists && snap.exists()){
          const val = snap.val();
          // val may be an object of keyed stories; map to array
          window.storiesData = Object.values(val || {});
          console.log('Loaded stories from Firebase:', window.storiesData.length);
        } else { console.log('No stories in Firebase'); }
      }catch(e){ console.warn('Failed to load stories from Firebase', e); }

      // load serials
      try{
        const snap2 = await get(child(ref(db), 'serials'));
        if(snap2 && snap2.exists && snap2.exists()){
          const val2 = snap2.val();
          window.serialsData = Object.values(val2 || {});
          console.log('Loaded serials from Firebase:', window.serialsData.length);
        } else { console.log('No serials in Firebase'); }
      }catch(e){ console.warn('Failed to load serials from Firebase', e); }
    }
  }catch(e){ console.warn('Firebase loader error', e); }
});
</script>


<script>
// --- Ensure browse buttons always show updated Firebase data ---
document.addEventListener("DOMContentLoaded", () => {
  const browseStoriesBtn = document.getElementById("browseStoriesBtn");
  const browseSerialsBtn = document.getElementById("browseSerialsBtn");

  if (browseStoriesBtn) {
    browseStoriesBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "stories"));
        if (snap.exists()) {
          window.storiesData = Object.values(snap.val());
        }
        renderStoriesList(window.storiesData || []);
      } catch (e) {
        console.warn("Failed to load stories for browse:", e);
        renderStoriesList(window.storiesData || []);
      }
    });
  }

  if (browseSerialsBtn) {
    browseSerialsBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "serials"));
        if (snap.exists()) {
          window.serialsData = Object.values(snap.val());
        }
        renderSerialsList(window.serialsData || []);
      } catch (e) {
        console.warn("Failed to load serials for browse:", e);
        renderSerialsList(window.serialsData || []);
      }
    });
  }
});
</script>


<!-- CLEAN SERIALS VIEW INJECTION: replaces broken browse serials behavior -->
<style>
  /* clean serials view styles (keeps existing theme) */
  #cleanSerialsPage { padding:20px; min-height:100vh; background:var(--bg); display:none; }
  #cleanSerialsHeader{display:flex;align-items:center;justify-content:space-between;max-width:980px;margin:0 auto 12px;gap:12px}
  #cleanSerialsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;max-width:980px;margin:12px auto;padding:12px}
  .clean-serial-card{background:#fff;border-radius:12px;padding:18px;box-shadow:var(--shadow);min-height:140px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:transform .18s}
  .clean-serial-card:hover{transform:translateY(-6px)}
  .serial-meta{color:var(--muted);font-size:13px}
  #cleanSerialsTop{display:flex;gap:12px;align-items:center;width:100%;max-width:980px;margin:0 auto}
  #cleanSerialsCount{font-weight:700}
  #cleanSerialsSearch{flex:1;padding:10px;border:1px solid var(--border);border-radius:8px}
  #cleanSerialsBack{position:fixed;left:14px;bottom:14px}
</style>

<div id="cleanSerialsPage" aria-hidden="true">
  <div id="cleanSerialsHeader">
    <div>
      <h2 style="margin:0">Browse Serials</h2>
      <div class="muted" id="cleanSerialsCount">Loading...</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="cleanSerialsSearch" placeholder="Search serials..." />
      <button id="cleanSerialsRefreshBtn" class="btn btn-secondary">Refresh</button>
    </div>
  </div>

  <div id="cleanSerialsGrid" aria-live="polite" role="list"></div>
  <button class="back-btn" id="cleanSerialsBack">‚Üê Back</button>
</div>

<script>

(function(){
  function waitForFirebaseInit() {
    if (window._firebase && window._firebase.db && window._firebase.onValue && window._firebase.ref) {
      console.log('üü¢ Firebase ready ‚Äî initializing clean serials view');
      try{
        // Execute the original serials script now that Firebase is ready
        (async function(){
          // ensure helper functions exist globally for legacy callers
            window.renderSerialsList = function(serials){
              // maintain compatibility - forward to clean renderer if available
              if(window._renderCleanSerials) return window._renderCleanSerials(serials);
              const list = document.getElementById('serialsCards');
              if(!list) return;
              list.innerHTML = '';
              (serials||[]).forEach(s=>{
                const c=document.createElement('div');
                c.className='story-card';
                c.innerHTML=`<h2>${s.title}</h2><p>${s.genre||''}</p>`;
                list.appendChild(c);
              });
            };
          
            // internal render for clean view
            window._renderCleanSerials = function(serials){
              const grid = document.getElementById('cleanSerialsGrid');
              const count = document.getElementById('cleanSerialsCount');
              if(!grid) return;
              grid.innerHTML = '';
              serials = serials || [];
              count.textContent = `${serials.length} serial${serials.length===1?'':'s'} loaded`;
              serials.forEach(s=>{
                const card = document.createElement('div');
                card.className='clean-serial-card';
                const desc = s.description ? `<div class="muted" style="margin-top:6px">${s.description.slice(0,140)}</div>` : '';
                card.innerHTML = `<div><h4 style="margin:0">${s.title}</h4><div class="serial-meta">${s.genre||''}</div>${desc}</div><div style="display:flex;gap:8px;align-items:center"><button class="btn btn-primary btn-small">Open</button></div>`;
                card.addEventListener('click', ()=>{
                  // open editor or reader if exists - try to find serial by title in window.serialsData
                  const idx = (window.serialsData||[]).findIndex(x=> (x.title||'').trim() === (s.title||'').trim());
                  if(idx>=0){
                    // open the first episode if present using existing createEditorPage if available
                    try{
                      if(typeof createEditorPage === 'function'){
                        const ser = window.serialsData[idx];
                        const epIndex = ser.episodes && ser.episodes.length ? 0 : null;
                        createEditorPage(epIndex!=null? ser.episodes[epIndex].title : ser.title, ser.genre, epIndex!=null? ser.episodes[epIndex].description : ser.description, { isEdit:true, editType:'serial', index: idx, episodeIndex: epIndex });
                        return;
                      }
                    }catch(e){ console.warn('Open serial: editor open failed', e); }
                  }
                  alert('Open serial: editor not available in this context.');
                });
                grid.appendChild(card);
              });
            };
          
            // show/hide helpers
            function openCleanSerialsPage(){
              // hide other main pages (same logic as your app)
              const pages = ['welcomePage','categoriesPage','serialCategoriesPage','dashboardPage','slidesPage','storyFormPage','profileFormPage'];
              pages.forEach(id=>{
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
              });
              // show our clean view
              const clean = document.getElementById('cleanSerialsPage');
              if(clean){ clean.classList.remove('hidden'); clean.setAttribute('aria-hidden','false'); }
              // attempt to render cached data immediately
              if(window.serialsData && window.serialsData.length){
                window._renderCleanSerials(window.serialsData);
                console.log(`‚ÑπÔ∏è Showing ${window.serialsData.length} cached serials from localStorage`);
              }
            }
          
            function closeCleanSerialsPage(){
              const clean = document.getElementById('cleanSerialsPage');
              if(clean){ clean.classList.add('hidden'); clean.setAttribute('aria-hidden','true'); }
              // show welcome page as fallback
              const welcome = document.getElementById('welcomePage');
              if(welcome) welcome.classList.remove('hidden');
            }
          
            // wire up buttons (override old handlers safely)
            const browseBtn = document.getElementById('browseSerialsBtn');
            if(browseBtn){
              browseBtn.removeEventListener && browseBtn.removeEventListener('click', ()=>{});
              browseBtn.addEventListener('click', (e)=>{
                e.preventDefault();
                openCleanSerialsPage();
              });
            }
            const backBtn = document.getElementById('cleanSerialsBack');
            if(backBtn) backBtn.addEventListener('click', ()=>{ closeCleanSerialsPage(); });
          
            const refreshBtn = document.getElementById('cleanSerialsRefreshBtn');
            if(refreshBtn) refreshBtn.addEventListener('click', ()=>{ fetchAndRenderSerials(true); });
          
            // search filtering
            const searchInput = document.getElementById('cleanSerialsSearch');
            if(searchInput) searchInput.addEventListener('input', (e)=>{
              const q = (e.target.value||'').toLowerCase().trim();
              const filtered = (window.serialsData||[]).filter(s=>{
                return (s.title||'').toLowerCase().includes(q) || (s.genre||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q);
              });
              window._renderCleanSerials(filtered);
            });
          
            // Firebase real-time listener & initial fetch
            async function fetchAndRenderSerials(forceReload) {
    try {
      // Use Firebase SDK directly (no window._firebase dependency)
      import("https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js").then(({ getDatabase, ref, onValue }) => {
        const db = getDatabase();
        // attach live listener
        if (window._cleanSerialsListenerAttached && !forceReload) return;
        window._cleanSerialsListenerAttached = true;

        onValue(ref(db, 'serials'), snap => {
          if (snap.exists()) {
            const obj = snap.val();
            window.serialsData = Object.values(obj);
            try { localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); } catch (e) {}
            window._renderCleanSerials(window.serialsData);
            console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
          } else {
            window.serialsData = [];
            try { localStorage.setItem('serialsData', JSON.stringify([])); } catch (e) {}
            window._renderCleanSerials([]);
            console.log('‚ö†Ô∏è No serials found in Firebase');
          }
        });
      }).catch(err => console.error('Firebase import failed:', err));
    } catch (err) {
      console.error('Failed to load serials for browse:', err);
    }
    
                // attach live listener (debounce multiple attachments)
                if(window._cleanSerialsListenerAttached && !forceReload) return;
                window._cleanSerialsListenerAttached = true;
          
                onValue(ref(db, 'serials'), snap => {
                  if(snap.exists()){
                    const obj = snap.val();
                    window.serialsData = Object.values(obj);
                    try{ localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); }catch(e){}
                    window._renderCleanSerials(window.serialsData);
                    console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
                  } else {
                    window.serialsData = [];
                    try{ localStorage.setItem('serialsData', JSON.stringify([])); }catch(e){}
                    window._renderCleanSerials([]);
                    console.log('‚ö†Ô∏è No serials found in Firebase');
                  }
                });
              }catch(err){
                console.error('Failed to load serials for browse:', err);
              }
            }
          
            // attempt to initialize listener on DOMContentLoaded (or immediately if already)
            if(document.readyState === 'complete' || document.readyState === 'interactive'){
              fetchAndRenderSerials(false);
            } else {
              document.addEventListener('DOMContentLoaded', ()=> fetchAndRenderSerials(false));
            }
          
            // show cached data on load (fallback)
            try{
              const cached = JSON.parse(localStorage.getItem('serialsData') || 'null');
              if(cached && Array.isArray(cached) && cached.length){
                window.serialsData = cached;
                console.log('‚ÑπÔ∏è Loaded serials from localStorage cache:', window.serialsData.length);
              }
            }catch(e){}
          
          })();
        })();
      }catch(e){
        console.error('Error running serials initializer after Firebase ready', e);
      }
      return;
    }
    // still not ready, wait and retry
    console.log('‚è≥ Waiting for Firebase initialization...');
    setTimeout(waitForFirebaseInit, 300);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    waitForFirebaseInit();
  } else {
    document.addEventListener('DOMContentLoaded', waitForFirebaseInit);
  }
})();
</script>
<!-- END INJECTION -->


<!-- Global fullscreen preview containers (moved outside hidden pages) -->
<div id="previewFull" class="hidden"></div>
<div id="readerFull" class="hidden"></div>

<!-- PATCH: base64 cover upload handlers + save function overrides -->
<script>
(function(){
  // create globals to hold base64 covers
  window._currentStoryCover = window._currentStoryCover || null;
  window._currentSerialCover = window._currentSerialCover || null;

  // helper to wire an input id to a preview img id and store base64
  function wireCoverInput(inputId, previewId, targetVarName) {
    const input = document.getElementById(inputId);
    if (!input) return;
    input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!['image/jpeg','image/png'].includes(file.type)) {
        alert('Only JPG or PNG allowed for cover images.');
        e.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        window[targetVarName] = ev.target.result;
        const preview = document.getElementById(previewId);
        if (preview) preview.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  wireCoverInput('storyCoverInput', 'storyCoverPreview', '_currentStoryCover');
  wireCoverInput('serialCoverInput', 'serialCoverPreview', '_currentSerialCover');

  // Override save functions to include base64 cover when present
  // Note: these will replace existing definitions in the page
window.saveSerialToFirebase = async function(ser) {
  try {
    if (window._currentSerialCover) ser.cover = window._currentSerialCover;

    if (!window._firebase || !window._firebase.db) {
      console.error('Firebase not ready for saveSerialToFirebase');
      return;
    }

    // üî• ALWAYS ENCODE THE TITLE
    const key = encodeURIComponent(ser.title.trim());

    await window._firebase.set(
      window._firebase.ref(window._firebase.db, `serials/${key}`),
      ser
    );

    console.log(`‚úÖ Serial "${ser.title}" saved (with cover if provided).`);
  } catch (err) {
    console.error('‚ùå Error saving serial (patched):', err);
  }
};


  window.saveStoryToFirebase = async function(story) {
    try {
      if (window._currentStoryCover) story.cover = window._currentStoryCover;
      if (!window._firebase || !window._firebase.db) {
        console.error('Firebase not ready for saveStoryToFirebase');
        return;
      }
      // attempt to write under stories/{title} if that is the app convention
      await window._firebase.set(window._firebase.ref(window._firebase.db, `stories/${story.title}`), story);
      console.log(`‚úÖ Story "${story.title}" saved (with cover if provided).`);
    } catch (err) {
      console.error('‚ùå Error saving story (patched):', err);
    }
  };

  // If the app uses different save function names, we also patch a generic save call helper if it exists
  // For example, if there's a function called uploadStory or createSerial, the developer can call saveSerialToFirebase explicitly.
})();
</script>
<!-- END PATCH -->


<!-- Serial Episode Modal -->
<div id="serialEpModal" class="popup hidden">
  <div class="popup-content" style="max-width:480px;">
    <h3 id="serialEpModalTitle"></h3>
    <label>Episode Title</label>
    <input id="serialEpNewTitle" placeholder="Episode title">
    <label>Description (optional)</label>
    <textarea id="serialEpNewDesc" rows="2"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button id="serialEpCancel" class="btn btn-secondary">Cancel</button>
      <button id="serialEpCreate" class="btn btn-primary">Next</button>
    </div>
  </div>
</div>




<script>
function showHomePage(){
  const welcomePage = document.getElementById('welcomePage');
  const dashboardPage = document.getElementById('dashboardPage');
  const profileFormPage = document.getElementById('profileFormPage');
  const slidesPage = document.getElementById('slidesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const serialCategoriesPage = document.getElementById('serialCategoriesPage');
  const writerGatePage = document.getElementById('writerGatePage'); // ‚úÖ add this line

  if(welcomePage) welcomePage.classList.remove('hidden');
  if(dashboardPage) dashboardPage.classList.add('hidden');
  if(profileFormPage) profileFormPage.classList.add('hidden');
  if(slidesPage) slidesPage.classList.add('hidden');
  if(categoriesPage) categoriesPage.classList.add('hidden');
  if(serialCategoriesPage) serialCategoriesPage.classList.add('hidden');
  if(writerGatePage) writerGatePage.classList.add('hidden'); // ‚úÖ hide writer gate
}

document.getElementById('homeBtn').addEventListener('click', ()=>{ showHomePage(); });



document.getElementById('writerBtn').addEventListener('click', () => {
  const profile = localStorage.getItem("writerProfile_v1");
  const writerGate = document.getElementById('writerGatePage');
  const welcome = document.getElementById('welcomePage');
  const dashboard = document.getElementById('dashboardPage');
  const categories = document.getElementById('categoriesPage');
  const serialCategories = document.getElementById('serialCategoriesPage');
  const profileForm = document.getElementById('profileFormPage');

  if(welcome) welcome.classList.add('hidden');
  if(dashboard) dashboard.classList.add('hidden');
  if(categories) categories.classList.add('hidden');
  if(serialCategories) serialCategories.classList.add('hidden');
  if(profileForm) profileForm.classList.add('hidden');

  writerGate.classList.remove('hidden');

  if (!profile) {
    document.getElementById('writerGateTitle').innerText = "No Writer Profile Found";
    document.getElementById('writerGateSubtitle').innerText = "To unlock the Writer Section, please create your writer profile.";
    document.getElementById('writerGateActionBtn').innerText = "Create Profile";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      profileForm.classList.remove('hidden');
    };
  } else {
    document.getElementById('writerGateTitle').innerText = "Writer Section Unlocked";
    document.getElementById('writerGateSubtitle').innerText = "Access your tools, manage stories and serials.";
    document.getElementById('writerGateActionBtn').innerText = "Open Writer Dashboard";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      showDashboard('stories');
    };
  }
});



// land on home
document.addEventListener('DOMContentLoaded', showHomePage);
</script>

<script>

  document.getElementById('slidesPage').classList.remove('hidden');
};
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const wsBtn = document.getElementById("writerGateWorkspaceBtn");
  if(wsBtn){
    wsBtn.onclick = () => {
      alert("üöß Creation Workspace Coming Soon");
    };
  }
});
</script>


<!-- WORKSPACE LOADING SCREEN ‚Äî CLEAN UNDERWATER MODE -->
<div id="workspaceLoadingScreen" class="hidden">

  <!-- Sunlight -->
  <div class="light-rays"></div>

  <!-- Bubbles -->
  <div class="bubble b1"></div>
  <div class="bubble b2"></div>
  <div class="bubble b3"></div>
  <div class="bubble b4"></div>

  <!-- Text -->
  <div id="workspaceFactText">Preparing your creative ocean...</div>

  <!-- Loading Bar -->
  <div class="bar"><div id="workspaceLoadingBar"></div></div>
</div>

<style>
#workspaceLoadingScreen {
  position:fixed; inset:0; z-index:999999;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background: radial-gradient(circle at 50% 20%, #38d2ff 0%, #0076a8 60%, #003549 100%);
  overflow:hidden;
  color:white;
  font-size:20px;
}

/* Sunlight */
.light-rays {
  position:absolute; inset:-50%;
  background: repeating-linear-gradient(115deg, rgba(255,255,255,0.18) 0px, rgba(255,255,255,0) 120px);
  filter:blur(18px);
  animation:rays 12s linear infinite;
}
@keyframes rays { from { transform:translateX(0); } to { transform:translateX(-300px); } }

/* Bubbles */
.bubble {
  position:absolute; bottom:-10px; width:14px; height:14px;
  border-radius:50%; background:rgba(255,255,255,0.65);
  animation:bub 7s infinite ease-in;
}
.b1{left:20%} .b2{left:40%; animation-delay:2s;}
.b3{left:60%; animation-delay:1s;} .b4{left:80%; animation-delay:3s;}

@keyframes bub { 
  from{transform:translateY(0) scale(0.5);} 
  to{transform:translateY(-130vh) scale(1.3); opacity:0;} 
}

/* Loading Bar at Bottom */
.bar {
  position:absolute;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  width:300px;
  height:14px;
  background:#00404e;
  border-radius:7px;
  overflow:hidden;
}
#workspaceLoadingBar {
  height:100%;
  width:0%;
  background:#3ffbff;
  box-shadow:0 0 12px #3ffbff;
  transition:width .35s linear;
}
</style>
<!-- WORKSPACE MANAGER + WYSIWYG EDITOR (drop-in) -->
<!-- WORKSPACE MANAGER (Modal / Centered) -->
<!-- ===== Creation Workspaces ‚Äî Paper Book (full snippet) ===== -->
<div id="ws_wysiwyg_container" class="hidden" aria-hidden="true"></div>

<style>
:root{
  --paper-bg: #fbf7f0;
  --paper-edge: #e6dccb;
  --ink: #2b2b2b;
  --muted: #6b6b6b;
  --accent: #7a5a3c;
}

/* Backdrop */
/* Fullscreen backdrop */
#ws_backdrop {
  position: fixed;
  inset: 0;
  background: rgba(5,10,15,0.55);
  backdrop-filter: blur(4px);
  z-index: 1200000;

  /* Remove centering + padding */
  display: block;
  padding: 0;
}


/* Paper modal */
#ws_modal_box {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  overflow-y: auto;
  border-radius: 0;
  background: #ffffff;
  padding: 24px 32px;
  box-sizing: border-box;
  color:#033047;
}

/* subtle texture */
#ws_modal_box::before{
  content: ""; position:absolute; pointer-events:none; inset:0; border-radius:10px;
  background-image: radial-gradient(rgba(0,0,0,0.01) 1px, transparent 1px);
  background-size: 30px 30px; mix-blend-mode:overlay; opacity:0.6;
}

/* header */
#ws_header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; position:relative; }
.ws_title{ font-size:20px; font-weight:800; color:var(--accent); }
.ws_sub{ font-size:13px; color:var(--muted); }

/* controls */
.ws_controls{ display:flex; gap:8px; align-items:center; }
.ws_btn{ background:linear-gradient(180deg,#d9c3a8,#b8895a); color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; font-weight:700; box-shadow:0 6px 18px rgba(122,90,60,0.18); }
.ws_btn.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(122,90,60,0.12); box-shadow:none; }

/* list area */
#ws_list{ display:flex; flex-wrap:wrap; gap:12px; margin-top:14px; }
.ws_card{ background:linear-gradient(180deg,#fffdf8,#fbf7f0); width:230px; min-height:100px; border-radius:8px; padding:12px; box-shadow:0 12px 30px rgba(0,0,0,0.04); border:1px solid var(--paper-edge); display:flex; flex-direction:column; justify-content:space-between; }
.ws_meta{ font-size:12px; color:var(--muted); margin-top:6px; }
.ws_actions{ display:flex; gap:8px; margin-top:8px; align-self:flex-end; flex-direction:row; }
.small_btn{ padding:6px 8px; border-radius:8px; border:0; cursor:pointer; background:#fff; color:var(--accent); font-weight:700; border:1px solid rgba(122,90,60,0.06); }

/* editor overlay (modal) */
.editor_overlay{ position:fixed; inset:0; z-index:1200001; display:flex; align-items:center; justify-content:center; padding:18px; box-sizing:border-box; background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.5)); }
.editor_box{ width:min(1100px,96%); height:86vh; background:#fffaf4; border-radius:10px; padding:14px; display:flex; flex-direction:column; gap:10px; box-shadow:0 30px 80px rgba(26,20,12,0.24); border:1px solid var(--paper-edge); }
.editor_head{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
.editor_title{ font-weight:800; color:var(--accent); }

/* toolbar */
.toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; background:linear-gradient(180deg,#fff,#fffaf6); padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.03); }
.tb_btn{ padding:6px 8px; border-radius:6px; border:1px solid rgba(0,0,0,0.04); background:#fff; cursor:pointer; }
.tb_select{ padding:6px 8px; border-radius:6px; border:1px solid rgba(0,0,0,0.04); }
.color_input{ width:34px; height:28px; padding:2px; border-radius:6px; border:1px solid rgba(0,0,0,0.04); }

/* editor area */
.wy_editor_area{ flex:1; overflow:auto; border-radius:8px; border:1px solid #efe6d8; padding:18px; background:linear-gradient(180deg,#fffdf9,#fffaf4); font-size:18px; line-height:1.7; color:var(--ink); }
.wy_editor_area[contenteditable="true"]{ outline:none; }

/* episodes */
.ep_section{ display:flex; gap:12px; align-items:flex-start; margin-top:8px; }
.ep_list{ display:flex; flex-direction:column; gap:10px; overflow:auto; max-height:48vh; padding-right:6px; width:100%; }

.preview_box{ padding:12px; border-radius:8px; border:1px solid #efe6d8; background:#fffaf6; max-height:65vh; overflow:auto; }

@media (max-width:820px){ #ws_modal_box{ width:96%; padding:14px; } .ws_card{ width:100%; } .editor_box{ width:96%; height:92vh; } }
</style>

<script>
(function(){
  const STORAGE_KEY = 'creativeWorkspaces_modal_v1_paper';

  /* helpers */
  function genId(pref='w'){ return pref + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function saveAll(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr||[])); }
  function loadAll(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){ return []; } }
  function escapeHtml(s=''){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function stripHtml(html=''){ const d = document.createElement('div'); d.innerHTML = html||''; return d.textContent || d.innerText || ''; }
  function shorten(s='',n=120){ if(!s) return ''; s=s.replace(/\s+/g,' ').trim(); return s.length>n? s.slice(0,n-1)+'‚Ä¶' : s; }
  function copyText(str){ navigator.clipboard?.writeText(str).then(()=> alert('Copied!')).catch(()=> alert('Copy failed ‚Äî manual select/copy.')); }

  /* main: show modal */
  function showWorkspaceWYSIWYG(){
    const container = document.getElementById('ws_wysiwyg_container');
    container.classList.remove('hidden'); container.setAttribute('aria-hidden','false');

    container.innerHTML = `
      <div id="ws_backdrop" role="dialog" aria-modal="true">
        <div id="ws_modal_box" aria-label="Writing Workspace - Paper Book">
          <div id="ws_header">
            <div>
              <div class="ws_title">Writing Workspace</div>
              <div class="ws_sub">Organize your stories and series content here. Content is saved in workspace only.</div>
            </div>
            <div class="ws_controls">
              <button id="wy_create_open" class="ws_btn">+ Create Workspace</button>
              <button id="wy_close" class="ws_btn ghost">Close</button>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="ws_sub">Click a workspace card to open (Open / Preview / Delete)</div>
            <div class="ws_sub">Saved: <span id="wy_count">0</span></div>
          </div>

          <div id="ws_list" style="margin-top:12px;"></div>
        </div>
      </div>
    `;

    document.getElementById('wy_close').onclick = closeModal;
    document.getElementById('wy_create_open').onclick = openCreatePopup;

    renderList();
  }

function closeModal() {
  const modal = document.getElementById('ws_wysiwyg_container');
  if (!modal) return;

  // Hide the workspace modal
  modal.classList.add('hidden');
  modal.setAttribute('aria-hidden', 'true');

  // ‚úÖ Show your main welcome page instead
  const welcomePage = document.getElementById('welcomePage');
  if (welcomePage) {
    welcomePage.classList.remove('hidden');
  }

  // ‚úÖ Remove the backdrop if it exists
  const backdrop = document.getElementById('ws_backdrop');
  if (backdrop) backdrop.remove();
}


  /* Create popup */
  function openCreatePopup(){
    const pop = document.createElement('div'); pop.className = 'editor_overlay';
    pop.innerHTML = `<div class="editor_box" style="max-width:480px;height:auto;">
      <div class="editor_head"><div class="editor_title">New Workspace</div><div><button id="c_close" class="ws_btn ghost">Close</button></div></div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
        <input id="c_name" class="ws_input" placeholder="Workspace name" />
        <select id="c_type" class="ws_select"><option value="story">Story</option><option value="serial">Series</option></select>
        <button id="c_save" class="ws_btn">Create Workspace</button>
      </div>
    </div>`;
    document.body.appendChild(pop);
    pop.querySelector('#c_close').onclick = ()=> pop.remove();
    pop.querySelector('#c_save').onclick = ()=>{
      const name = (pop.querySelector('#c_name').value||'').trim(); const type = pop.querySelector('#c_type').value;
      if(!name) return alert('Please type a workspace name');
      const all = loadAll(); const id = genId('ws');
      const obj = { id, name, type, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
      if(type==='story') obj.content = '<p></p>'; else obj.episodes = [];
      all.unshift(obj); saveAll(all); pop.remove(); renderList();
    };
  }

  /* render list */
  function renderList(){
    const list = document.getElementById('ws_list'); if(!list) return;
    const arr = loadAll()||[]; const countEl = document.getElementById('wy_count'); if(countEl) countEl.innerText = arr.length;
    list.innerHTML = '';
    if(arr.length===0){ list.innerHTML = '<div class="note" style="padding:12px;">No workspaces yet ‚Äî create one above.</div>'; return; }
    arr.forEach(ws=>{
      const card = document.createElement('div'); card.className='ws_card';
      card.innerHTML = `<div><div style="font-weight:800;font-size:15px;color:var(--accent)">${escapeHtml(ws.name)}</div><div class="ws_meta">${ws.type==='story'?'Story':'Serial'} ‚Ä¢ ${new Date(ws.updatedAt||ws.createdAt).toLocaleString()}</div><div class="note" style="margin-top:8px;">${ ws.type==='story' ? (ws.content ? shorten(stripHtml(ws.content),120) : '<i>Empty</i>') : ((ws.episodes && ws.episodes.length) ? ws.episodes.length+' episodes' : '<i>No episodes</i>') }</div></div><div class="ws_actions"><button class="small_btn" data-act="open" data-id="${ws.id}">Open</button><button class="small_btn" data-act="preview" data-id="${ws.id}">Preview</button><button class="small_btn" data-act="delete" data-id="${ws.id}" style="background:#ff6b6b;color:white;">Delete</button></div>`;
      list.appendChild(card);
      card.querySelector('[data-act="open"]').onclick = ()=> openWorkspace(ws.id);
      card.querySelector('[data-act="preview"]').onclick = ()=> previewWorkspace(ws.id);
      card.querySelector('[data-act="delete"]').onclick = ()=>{ if(!confirm('Delete workspace \"'+ws.name+'\" ?')) return; const rem = loadAll().filter(x=>x.id!==ws.id); saveAll(rem); renderList(); };
    });
  }

  /* open workspace */
  function openWorkspace(id){ const all = loadAll(); const ws = all.find(x=>x.id===id); if(!ws) return alert('Workspace not found'); if(ws.type==='story') openStoryEditor(ws); else openSerialEditor(ws); }

  /* preview */
  function previewWorkspace(id){
    const all = loadAll(); const ws = all.find(x=>x.id===id); if(!ws) return alert('Workspace not found');
    let html = '';
    if(ws.type === 'story'){
      html = `<div style="font-weight:800;margin-bottom:8px">${escapeHtml(ws.name)} ‚Äî Story Preview</div><div class="preview_box">${ws.content||'<i>Empty</i>'}</div>`;
    } else {
      const ep = (ws.episodes && ws.episodes.length) ? ws.episodes[0] : null;
      html = `<div style="font-weight:800;margin-bottom:8px">${escapeHtml(ws.name)} ‚Äî Serial Preview</div><div style="margin-bottom:8px"><strong>Episode 1:</strong> ${ep?escapeHtml(ep.title||'Untitled'):'<i>No episodes</i>'}</div><div class="preview_box">${ep?(ep.content||'<i>Empty</i>') : ''}</div>`;
    }
    openPreviewModal(html);
  }

  function openPreviewModal(innerHtml){
    const overlay = document.createElement('div'); overlay.className='editor_overlay';
    overlay.innerHTML = `<div class="editor_box" role="dialog" aria-modal="true"><div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:800">Preview</div><div><button class="ws_btn ghost" id="pv_close">Close</button></div></div><div style="margin-top:12px">${innerHtml}</div></div>`;
    document.body.appendChild(overlay); overlay.querySelector('#pv_close').onclick = ()=> overlay.remove();
  }

  /* Story editor with tools */
  function openStoryEditor(ws){
    const overlay = document.createElement('div'); overlay.className='editor_overlay';
    overlay.innerHTML = `
      <div class="editor_box">
        <div class="editor_head">
          <div>
            <div class="editor_title">${escapeHtml(ws.name)} <span style="font-weight:600;color:var(--muted);font-size:13px">(Story)</span></div>
            <div class="note">Autosaves while you type. Use tools to style text.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="ws_btn" id="story_copy">Copy</button>
            <button class="ws_btn" id="story_save">Save</button>
            <button class="ws_btn ghost" id="story_close">Close</button>
          </div>
        </div>

        <div class="toolbar" id="wys_toolbar">
          <button class="tb_btn" data-cmd="bold">B</button>
          <button class="tb_btn" data-cmd="italic">I</button>
          <button class="tb_btn" data-cmd="underline">U</button>

          <select class="tb_select" id="font_family">
            <option value="Georgia">Georgia</option>
            <option value="Palatino Linotype">Palatino</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Arial">Arial</option>
          </select>

          <select class="tb_select" id="font_size">
            <option value="2">Small</option>
            <option value="3" selected>Normal</option>
            <option value="5">Large</option>
            <option value="7">Huge</option>
          </select>

          <input type="color" class="color_input" id="font_color" title="Text color" />
          <input type="color" class="color_input" id="bg_color" title="Highlight color" />

          <button class="tb_btn" data-cmd="insertUnorderedList">‚Ä¢ List</button>
          <button class="tb_btn" data-cmd="insertOrderedList">1. List</button>
          <button class="tb_btn" data-cmd="createLink">Link</button>
          <button class="tb_btn" data-cmd="insertImage">Image</button>
          <button class="tb_btn" data-cmd="undo">Undo</button>
          <button class="tb_btn" data-cmd="redo">Redo</button>

          <div style="flex:1"></div>
          <div class="note" style="font-size:13px">Paper Book ‚Äî Rich Editor</div>
        </div>

        <div id="wy_editor" class="wy_editor_area" contenteditable="true" spellcheck="true"></div>
      </div>
    `;
    document.body.appendChild(overlay);

    const editorEl = overlay.querySelector('#wy_editor'); editorEl.innerHTML = ws.content || '<p></p>'; editorEl.focus();

    // toolbar actions
    overlay.querySelectorAll('.tb_btn[data-cmd]').forEach(btn=>{
      btn.onclick = ()=>{
        const cmd = btn.getAttribute('data-cmd');
        if(!cmd) return;
        if(cmd === 'createLink'){
          const url = prompt('Enter URL (include https://):','https://'); if(!url) return;
          document.execCommand('createLink', false, url);
        } else if(cmd === 'insertImage'){
          const url = prompt('Image URL (or data URI):'); if(!url) return;
          document.execCommand('insertImage', false, url);
        } else {
          document.execCommand(cmd, false, null);
        }
        editorEl.focus();
      };
    });

    // font & color controls
    overlay.querySelector('#font_family').onchange = (e)=>{ document.execCommand('fontName', false, e.target.value); editorEl.focus(); };
    overlay.querySelector('#font_size').onchange = (e)=>{ document.execCommand('fontSize', false, e.target.value); editorEl.focus(); };
    overlay.querySelector('#font_color').onchange = (e)=>{ document.execCommand('foreColor', false, e.target.value); editorEl.focus(); };
    overlay.querySelector('#bg_color').onchange = (e)=>{ try{ document.execCommand('hiliteColor', false, e.target.value); }catch(err){ document.execCommand('backColor', false, e.target.value); } editorEl.focus(); };

    // autosave (debounced)
    let timer = null;
    editorEl.addEventListener('input', ()=>{
      if(timer) clearTimeout(timer);
      timer = setTimeout(()=> {
        const all = loadAll(); const idx = all.findIndex(x=>x.id===ws.id); if(idx===-1) return;
        all[idx].content = editorEl.innerHTML;
        all[idx].updatedAt = new Date().toISOString();
        saveAll(all);
        renderList();
      }, 700);
    });

    overlay.querySelector('#story_save').onclick = ()=>{
      const all = loadAll(); const idx = all.findIndex(x=>x.id===ws.id); if(idx===-1) return;
      all[idx].content = editorEl.innerHTML; all[idx].updatedAt = new Date().toISOString(); saveAll(all); renderList(); alert('Saved.');
    };
    overlay.querySelector('#story_copy').onclick = ()=> copyText(editorEl.innerHTML || '');
    overlay.querySelector('#story_close').onclick = ()=> {
      const all = loadAll(); const idx = all.findIndex(x=>x.id===ws.id); if(idx>=0){ all[idx].content = editorEl.innerHTML; all[idx].updatedAt = new Date().toISOString(); saveAll(all); }
      overlay.remove(); renderList();
    };
  }

  /* Serial editor (episodes) */
  function openSerialEditor(ws){
    const overlay = document.createElement('div'); overlay.className = 'editor_overlay';
    overlay.innerHTML = `
      <div class="editor_box">
        <div class="editor_head">
          <div>
            <div class="editor_title">${escapeHtml(ws.name)} <span style="font-weight:600;color:var(--muted);font-size:13px">(Series)</span></div>
            <div class="note">Add episodes ‚Äî each has its own content and styling.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="ws_btn" id="serial_add_ep">Add Episode</button>
            <button class="ws_btn" id="serial_copy_all">Copy All</button>
            <button class="ws_btn ghost" id="serial_close">Close</button>
          </div>
        </div>

        <div class="ep_section">
          <div style="flex:1;">
            <div style="font-weight:700; margin-bottom:6px;">Episodes</div>
            <div class="ep_list" id="serial_ep_list"></div>
          </div>

          <div style="width:420px;">
            <div style="font-weight:700; margin-bottom:6px;">Episode Editor</div>
            <input id="ep_title" class="ws_input" placeholder="Episode Title" style="width:100%; margin-bottom:8px;" />

            <div class="toolbar" id="ep_toolbar">
              <select class="tb_select" id="ep_font_family">
                <option value="Georgia">Georgia</option>
                <option value="Palatino Linotype">Palatino</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Arial">Arial</option>
              </select>

              <select class="tb_select" id="ep_font_size">
                <option value="2">Small</option>
                <option value="3" selected>Normal</option>
                <option value="5">Large</option>
                <option value="7">Huge</option>
              </select>

              <input type="color" class="color_input" id="ep_font_color" title="Text color" />
              <input type="color" class="color_input" id="ep_bg_color" title="Highlight color" />
              <button class="tb_btn" data-cmd="insertImage">Image</button>
              <button class="tb_btn" data-cmd="undo">Undo</button>
              <button class="tb_btn" data-cmd="redo">Redo</button>
            </div>

            <div id="ep_editor" class="wy_editor_area" contenteditable="true" spellcheck="true" style="height:48vh;"></div>

            <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
              <button class="ws_btn" id="ep_save">Save Episode</button>
              <button class="ws_btn" id="ep_copy">Copy</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);

    let selectedIdx = null;

    function renderEpisodes(){
      const listEl = overlay.querySelector('#serial_ep_list'); listEl.innerHTML = '';
      const all = loadAll(); const cur = all.find(x=>x.id===ws.id); if(!cur) return;
      const episodes = cur.episodes || [];
      if(episodes.length===0){ listEl.innerHTML = '<div class="note">No episodes yet. Click \"Add Episode\".</div>'; return; }
      episodes.forEach((ep, idx)=>{
        const el = document.createElement('div');
        el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
        el.style.gap='8px'; el.style.padding='8px'; el.style.borderRadius='8px'; el.style.background='#fffaf6';
        el.innerHTML = `<div style="flex:1;"><div style="font-weight:700;">${escapeHtml(ep.title || ('Episode '+(idx+1)))}</div><div class="ws_meta">${new Date(ep.createdAt||ep.updatedAt||Date.now()).toLocaleString()}</div></div>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                          <button class="small_btn" data-idx="${idx}" data-act="open">Open</button>
                          <button class="small_btn" data-idx="${idx}" data-act="del">Delete</button>
                        </div>`;
        listEl.appendChild(el);
        el.querySelector('[data-act="open"]').onclick = () => selectEpisode(idx);
        el.querySelector('[data-act="del"]').onclick = () => {
          if(!confirm('Delete this episode?')) return;
          const all = loadAll(); const curIdx = all.findIndex(x=>x.id===ws.id); if(curIdx===-1) return;
          all[curIdx].episodes.splice(idx,1); saveAll(all); renderEpisodes();
          if(selectedIdx === idx){ selectedIdx = null; overlay.querySelector('#ep_title').value = ''; overlay.querySelector('#ep_editor').innerHTML = ''; }
        };
      });
    }

    function selectEpisode(idx){
      const all = loadAll(); const cur = all.find(x=>x.id===ws.id); if(!cur) return;
      const ep = (cur.episodes||[])[idx]; if(!ep) return;
      selectedIdx = idx;
      overlay.querySelector('#ep_title').value = ep.title || '';
      overlay.querySelector('#ep_editor').innerHTML = ep.content || '<p></p>';
    }

    overlay.querySelector('#serial_add_ep').onclick = ()=>{
      const all = loadAll(); const i = all.findIndex(x=>x.id===ws.id); if(i===-1) return alert('Missing workspace');
      const newEp = { id: genId('ep'), title: 'Episode '+((all[i].episodes||[]).length+1), content:'<p></p>', createdAt:new Date().toISOString() };
      all[i].episodes = all[i].episodes || []; all[i].episodes.push(newEp); all[i].updatedAt = new Date().toISOString(); saveAll(all);
      renderEpisodes(); setTimeout(()=> selectEpisode(all[i].episodes.length-1), 80);
    };

    overlay.querySelector('#ep_save').onclick = ()=>{
      if(selectedIdx == null) return alert('Select an episode first (Open).');
      const all = loadAll(); const i = all.findIndex(x=>x.id===ws.id); if(i===-1) return;
      const episodes = all[i].episodes || [];
      episodes[selectedIdx].title = overlay.querySelector('#ep_title').value || episodes[selectedIdx].title;
      episodes[selectedIdx].content = overlay.querySelector('#ep_editor').innerHTML || episodes[selectedIdx].content;
      episodes[selectedIdx].updatedAt = new Date().toISOString();
      saveAll(all); renderEpisodes(); alert('Episode saved.');
    };

    overlay.querySelector('#ep_copy').onclick = ()=>{
      if(selectedIdx == null) return alert('Select an episode first.');
      const all = loadAll(); const i = all.findIndex(x=>x.id===ws.id); if(i===-1) return;
      const ep = all[i].episodes[selectedIdx];
      copyText(ep.content || '');
    };

    overlay.querySelector('#serial_copy_all').onclick = ()=>{
      const all = loadAll(); const cur = all.find(x=>x.id===ws.id); if(!cur) return;
      const combined = (cur.episodes || []).map((e,i)=>`Episode ${i+1} ‚Äî ${e.title||'Untitled'}\n\n${stripHtml(e.content||'')}`).join('\n\n---\n\n');
      copyText(combined || '');
    };

    overlay.querySelector('#serial_close').onclick = ()=> { overlay.remove(); renderList(); };

    // ep toolbar handlers
    overlay.querySelector('#ep_font_family').onchange = (e)=>{ document.execCommand('fontName', false, e.target.value); overlay.querySelector('#ep_editor').focus(); };
    overlay.querySelector('#ep_font_size').onchange = (e)=>{ document.execCommand('fontSize', false, e.target.value); overlay.querySelector('#ep_editor').focus(); };
    overlay.querySelector('#ep_font_color').onchange = (e)=>{ document.execCommand('foreColor', false, e.target.value); overlay.querySelector('#ep_editor').focus(); };
    overlay.querySelector('#ep_bg_color').onchange = (e)=>{ try{ document.execCommand('hiliteColor', false, e.target.value); }catch(err){ document.execCommand('backColor', false, e.target.value); } overlay.querySelector('#ep_editor').focus(); };

    // ep editor autosave
    const epEditor = overlay.querySelector('#ep_editor'); let tick;
    epEditor.addEventListener('input', ()=>{
      if(tick) clearTimeout(tick);
      tick = setTimeout(()=> {
        if(selectedIdx == null) return;
        const all = loadAll(); const i = all.findIndex(x=>x.id===ws.id); if(i===-1) return;
        all[i].episodes[selectedIdx].content = epEditor.innerHTML || all[i].episodes[selectedIdx].content;
        all[i].episodes[selectedIdx].updatedAt = new Date().toISOString();
        saveAll(all);
      }, 700);
    });

    // ep toolbar image/undo/redo
    overlay.querySelectorAll('#ep_toolbar .tb_btn[data-cmd]').forEach(btn=>{
      btn.onclick = ()=>{
        const cmd = btn.getAttribute('data-cmd'); if(!cmd) return;
        if(cmd==='insertImage'){ const url = prompt('Image URL or data URI:'); if(!url) return; document.execCommand('insertImage', false, url); }
        else { document.execCommand(cmd, false, null); }
        overlay.querySelector('#ep_editor').focus();
      };
    });

    renderEpisodes();
  }

  /* expose to window */
  window.showWorkspaceWYSIWYG = showWorkspaceWYSIWYG;
  window.openWorkspaceWYSIWYG = function(id){
    showWorkspaceWYSIWYG();
    setTimeout(()=> {
      try {
        const cards = document.querySelectorAll('#ws_list .ws_card');
        for(const c of cards){
          const btn = c.querySelector('[data-act="open"]');
          if(btn && btn.dataset && btn.dataset.id === id){ btn.click(); break; }
        }
      } catch(e){}
    }, 150);
  };

  /* helper renderList for editors */
  function renderList(){ try{ const list = document.getElementById('ws_list'); if(!list) return; const arr = loadAll() || []; list.innerHTML = ''; arr.forEach(ws => { const card = document.createElement('div'); card.className='ws_card'; card.innerHTML = `<div><div style="font-weight:800;font-size:15px;color:var(--accent)">${escapeHtml(ws.name)}</div><div class="ws_meta">${ws.type==='story'?'Story':'Series'} ‚Ä¢ ${new Date(ws.updatedAt||ws.createdAt).toLocaleString()}</div><div class="note" style="margin-top:8px">${ ws.type==='story' ? (ws.content ? shorten(stripHtml(ws.content),120) : '<i>Empty</i>') : ((ws.episodes && ws.episodes.length) ? ws.episodes.length+' episodes' : '<i>No episodes</i>') }</div></div><div class="ws_actions"><button class="small_btn" data-act="open" data-id="${ws.id}">Open</button><button class="small_btn" data-act="preview" data-id="${ws.id}">Preview</button><button class="small_btn" data-act="delete" data-id="${ws.id}" style="background:#ff6b6b;color:white;">Delete</button></div>`; list.appendChild(card); card.querySelector('[data-act="open"]').onclick = ()=> openWorkspace(ws.id); card.querySelector('[data-act="preview"]').onclick = ()=> previewWorkspace(ws.id); card.querySelector('[data-act="delete"]').onclick = ()=>{ if(!confirm('Delete workspace \"'+ws.name+'\" ?')) return; const remaining = loadAll().filter(x=>x.id!==ws.id); saveAll(remaining); renderList(); }; }); const countEl = document.getElementById('wy_count'); if(countEl) countEl.innerText = (loadAll()||[]).length; }catch(e){} }

  window.__ws_renderList = renderList;

})();
</script>
<!-- ===== end snippet ===== -->


<!-- Added Firebase save for writerName and publishDate -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('startCreatingBtn');
  if (!btn) return;
  btn.addEventListener('click', function(){
    try {
      const title = document.getElementById('storyTitle')?.value?.trim() || '';
      if (!title) return;
      const desc = document.getElementById('storyDesc')?.value || '';
      const genre = document.getElementById('storyGenre')?.value || '';
      const writerName = document.getElementById('writerNameInput')?.value?.trim() || 'Unknown';
      const publishDate = document.getElementById('publishDateInput')?.value || new Date().toISOString().split('T')[0];
      const cover = window._currentStoryCover || '';
      const storyData = {
        title, description: desc, genre, cover,
        writerName, publishDate,
        updatedAt: new Date().toISOString()
      };
      if (window._firebase && window._firebase.set && window._firebase.db) {
        const key = encodeURIComponent(title);
        window._firebase.set(window._firebase.ref(window._firebase.db, 'stories/' + key), storyData)
          .then(()=>console.log('‚úÖ Story saved with writer info:', title))
          .catch(e=>console.error('‚ùå Save failed', e));
      } else {
        console.warn('Firebase helpers missing');
      }
    } catch(e){ console.error('Error saving writer info:', e); }
  });
});
</script>
<!-- End Firebase save patch -->


<!-- START: REGISTER + READER PROFILE UI and SCRIPT -->
<style>
/* Auth popup styles */
#authPopup .popup-content { max-width:420px; }
#profilePopup .popup-content { max-width:520px; }
.form-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
                                     
#registerBtn { padding:10px 14px; border-radius:10px; font-weight:700; border:none; cursor:pointer; }
</style>

<!-- Register button already added into topNav by script injection below -->

<!-- Auth Popup -->
<!-- üåå Galactic Fullscreen Auth Portal -->
<div id="authPopup" class="hidden" aria-hidden="true" style="
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: flex;
  align-items: center;
  justify-content: center;
  background: radial-gradient(circle at 20% 30%, rgba(106,17,203,0.85), rgba(37,117,252,0.9) 60%, rgba(0,0,0,0.9) 100%);
  overflow: hidden;
  transition: opacity 0.4s ease, transform 0.4s ease;
">
  <!-- ‚ú® Starfield -->
  <canvas id="starCanvas" style="position:absolute;inset:0;width:100%;height:100%;z-index:0;"></canvas>

  <!-- ‚ö° Auth Card -->
  <div class="galactic-card" style="
    position: relative;
    z-index: 2;
    width: min(420px, 92%);
    padding: 32px 26px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 18px;
    backdrop-filter: blur(20px) saturate(180%);
    text-align: center;
    box-shadow: 0 0 30px rgba(106,17,203,0.4);
    color: white;
    animation: popIn 0.5s ease;
  ">
    <h2 style="margin-bottom:10px;font-size:24px;font-weight:700;">üåå Register / Sign In</h2>
    <p style="margin-bottom:18px;color:rgba(255,255,255,0.8);font-size:14px;">Join Meurbal ‚Äî Dream. Write. Live.</p>

    <button id="googleSignBtn" class="btn btn-primary" style="
      width:100%;
      background:linear-gradient(135deg,#ff9800,#ff5722);
      font-weight:700;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      box-shadow:0 0 10px rgba(255,152,0,0.4);
      margin-bottom:12px;
    ">Continue with Google</button>

    <div style="text-align:center;color:rgba(255,255,255,0.6);font-weight:700;margin:6px 0;">‚Äî OR ‚Äî</div>

    <input id="authEmail" type="email" placeholder="Email" style="
      width:100%;padding:10px;border-radius:8px;border:none;
      background:rgba(255,255,255,0.15);color:#fff;margin-bottom:8px;outline:none;
    ">
    <input id="authPass" type="password" placeholder="Password (min 6)" style="
      width:100%;padding:10px;border-radius:8px;border:none;
      background:rgba(255,255,255,0.15);color:#fff;margin-bottom:14px;outline:none;
    ">

    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button id="authEmailRegisterBtn" style="
        background:linear-gradient(135deg,#00eaff,#0077ff);
        border:none;padding:8px 16px;
        border-radius:20px;color:white;font-weight:700;font-size:14px;
        cursor:pointer;transition:transform .2s;
      ">Register</button>

      <button id="authEmailSignInBtn" style="
        background:rgba(255,255,255,0.12);
        color:white;border:1px solid rgba(255,255,255,0.25);
        padding:8px 16px;border-radius:20px;font-weight:700;font-size:14px;
        cursor:pointer;transition:transform .2s;
      ">Sign in</button>

      <button id="authCancelBtn" style="
        background:transparent;color:#ccc;border:none;
        text-decoration:underline;font-size:13px;margin-top:6px;
        cursor:pointer;
      ">Cancel</button>
    </div>
  </div>
</div>

<!-- üå† Fixed Multi-Direction Starfield -->
<script>
(function starfield(){
  const canvas = document.getElementById('starCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  let stars = [];
  const numStars = 160;
  let w, h;
  function resize(){
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    stars = Array.from({length:numStars},()=>({
      x: Math.random()*w,
      y: Math.random()*h,
      z: Math.random()*w,
      dx: (Math.random()-0.5)*0.6,  // horizontal drift
      dy: (Math.random()-0.5)*0.6   // vertical drift
    }));
  }
  window.addEventListener('resize', resize);
  resize();

  function draw(){
    ctx.fillStyle='rgba(0,0,20,1)';
    ctx.fillRect(0,0,w,h);
    for(const s of stars){
      s.z -= 1.5;
      s.x += s.dx;
      s.y += s.dy;
      if(s.z<=0){ s.z=w; s.x=Math.random()*w; s.y=Math.random()*h; }
      const k=128.0/s.z;
      const px=s.x*k+w/2;
      const py=s.y*k+h/2;
      if(px>=0&&px<=w&&py>=0&&py<=h){
        const size=(1-s.z/w)*2;
        ctx.fillStyle='rgba(255,255,255,'+(1-s.z/w)+')';
        ctx.beginPath();
        ctx.arc(px,py,size,0,Math.PI*2);
        ctx.fill();
      }
    }
    requestAnimationFrame(draw);
  }
  draw();
})();
</script>

<style>
@keyframes popIn {
  0% { transform: scale(0.9); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
</style>

<!-- üå† Galactic Fullscreen Profile Portal -->
<div id="profilePopup" class="hidden" aria-hidden="true" style="
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: flex;
  align-items: center;
  justify-content: center;
  background: radial-gradient(circle at 25% 40%, rgba(106,17,203,0.85), rgba(37,117,252,0.9) 70%, rgba(0,0,0,0.95) 100%);
  overflow: hidden;
  transition: opacity 0.4s ease, transform 0.4s ease;
">
  <!-- ‚ú® Starfield Background -->
  <canvas id="profileStarCanvas" style="position:absolute;inset:0;width:100%;height:100%;z-index:0;"></canvas>

  <!-- ‚ö° Profile Card -->
  <div class="profile-card" style="
    position: relative;
    z-index: 2;
    width: min(440px, 92%);
    padding: 32px 26px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 18px;
    backdrop-filter: blur(20px) saturate(180%);
    text-align: left;
    box-shadow: 0 0 30px rgba(106,17,203,0.4);
    color: white;
    animation: popIn 0.5s ease;
  ">
    <h2 style="margin-bottom:10px;font-size:24px;font-weight:700;text-align:center;">üåå Complete Reader Profile</h2>
    <p style="margin-bottom:20px;color:rgba(255,255,255,0.8);font-size:14px;text-align:center;">Let your cosmic identity shine ‚ú®</p>

    <label style="font-weight:600;">Username</label>
    <input id="readerUsername" placeholder="Pick a username" style="
      width:100%;padding:10px;margin:6px 0 14px;
      border-radius:8px;border:none;outline:none;
      background:rgba(255,255,255,0.15);color:#fff;
    ">

    <label style="font-weight:600;">Favourite Genres</label>
    <div id="readerGenres" style="display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 14px;">
      <label class="genre-option" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;cursor:pointer;">
        <input type="checkbox" value="Horror" style="margin-right:4px;">Horror
      </label>
      <label class="genre-option" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;cursor:pointer;">
        <input type="checkbox" value="Comedy" style="margin-right:4px;">Comedy
      </label>
      <label class="genre-option" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;cursor:pointer;">
        <input type="checkbox" value="Action" style="margin-right:4px;">Action
      </label>
      <label class="genre-option" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;cursor:pointer;">
        <input type="checkbox" value="Romance" style="margin-right:4px;">Romance
      </label>
      <label class="genre-option" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;cursor:pointer;">
        <input type="checkbox" value="Fantasy" style="margin-right:4px;">Fantasy
      </label>
      <label class="genre-option" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:8px;cursor:pointer;">
        <input type="checkbox" value="Thriller" style="margin-right:4px;">Thriller
      </label>
    </div>

    <label style="font-weight:600;"></label>
    <div id="themeChoices" style="
      display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;
    ">
      <!-- You can dynamically inject themes here -->
    </div>

    <div style="display:flex;gap:10px;justify-content:center;margin-top:10px;">
      <button id="profileSaveBtn" style="
        background:linear-gradient(135deg,#00eaff,#0077ff);
        border:none;padding:8px 20px;border-radius:20px;
        color:white;font-weight:700;font-size:14px;
        cursor:pointer;transition:transform .2s;
      ">Save Profile</button>

      <button id="profileCancelBtn" style="
        background:rgba(255,255,255,0.12);
        border:1px solid rgba(255,255,255,0.25);
        color:white;padding:8px 20px;border-radius:20px;
        font-weight:700;font-size:14px;cursor:pointer;
      ">Cancel</button>
    </div>
  </div>
</div>

<!-- üåå Starfield Animation for Profile -->
<script>
(function starfieldProfile(){
  const canvas = document.getElementById('profileStarCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  let w, h, stars;
  const numStars = 180;

  function resize(){
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    stars = Array.from({length:numStars},()=>({
      x: Math.random()*w,
      y: Math.random()*h,
      r: Math.random()*1.8 + 0.3,
      dx: (Math.random()-0.5)*0.6,
      dy: (Math.random()-0.5)*0.6,
      alpha: Math.random()*0.8 + 0.2
    }));
  }
  window.addEventListener('resize', resize);
  resize();

  function draw(){
    ctx.fillStyle='rgba(0,0,20,1)';
    ctx.fillRect(0,0,w,h);
    for(const s of stars){
      s.x += s.dx;
      s.y += s.dy;
      if(s.x<0) s.x=w;
      if(s.x>w) s.x=0;
      if(s.y<0) s.y=h;
      if(s.y>h) s.y=0;
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${s.alpha})`;
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
})();
</script>

<style>
@keyframes popIn {
  0% { transform: scale(0.9); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
</style>
</script>

<style>
@keyframes popIn {
  0% { transform: scale(0.9); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
</style>
</script>

<style>
@keyframes popIn {
  0% { transform: scale(0.9); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
</style>

<script type="module">
// Firebase Auth + Reader Profile integration
// Firebase Auth + Reader Profile integration
import {
  getAuth,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const auth = getAuth(window._firebase?.app || null);
const provider = new GoogleAuthProvider();

// Add Register button to topNav
(function(){
  const topNav = document.getElementById('topNav');
  if(topNav && !document.getElementById('registerBtn')){
    const btn = document.createElement('button');
    btn.id = 'registerBtn';
    btn.innerText = 'Register';
    btn.className = 'btn-secondary';
    btn.style.marginLeft = '6px';
    topNav.appendChild(btn);
  }
})();

// Elements
const registerBtn = document.getElementById('registerBtn');
const authPopup = document.getElementById('authPopup');
const authCancelBtn = document.getElementById('authCancelBtn');
const googleSignBtn = document.getElementById('googleSignBtn');
const authEmailRegisterBtn = document.getElementById('authEmailRegisterBtn');
const authEmailSignInBtn = document.getElementById('authEmailSignInBtn');
const authEmail = document.getElementById('authEmail');
const authPass = document.getElementById('authPass');

const profilePopup = document.getElementById('profilePopup');
const profileSaveBtn = document.getElementById('profileSaveBtn');
const profileSkipBtn = document.getElementById('profileSkipBtn');
const readerUsername = document.getElementById('readerUsername');
const readerGenres = document.getElementById('readerGenres');

// Helpers to show/hide
function show(el){ if(!el) return; el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
function hide(el){ if(!el) return; el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

// Register button click opens auth popup (or logs out if signed in)
registerBtn.addEventListener('click', ()=>{
  if(registerBtn.dataset.signed === 'true'){
    // logout flow
    signOut(auth).then(()=>{
  alert('Signed out');
  localStorage.removeItem('meurbal_registered');
  sessionStorage.removeItem('pause_disabled');
}).catch(e=>console.error(e));

    return;
  }
  show(authPopup);
});

authCancelBtn.addEventListener('click', ()=> hide(authPopup));

// Google sign
googleSignBtn.addEventListener('click', async ()=>{
  try {
    const res = await signInWithPopup(auth, provider);
    hide(authPopup);
  } catch (e) {
    console.error(e); alert('Google sign-in failed: ' + (e.message || e));
  }
});

// Email register
authEmailRegisterBtn.addEventListener('click', async ()=>{
  const email = authEmail.value.trim(); const pw = authPass.value;
  if(!email || !pw || pw.length < 6){ alert('Provide valid email and password (min 6 chars)'); return; }
  try{
    await createUserWithEmailAndPassword(auth, email, pw);
    hide(authPopup);
  }catch(e){ console.error(e); alert('Registration failed: ' + (e.message || e)); }
});

// Email sign in
authEmailSignInBtn.addEventListener('click', async ()=>{
  const email = authEmail.value.trim(); const pw = authPass.value;
  if(!email || !pw){ alert('Provide email and password'); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pw);
    hide(authPopup);
  }catch(e){ console.error(e); alert('Sign-in failed: ' + (e.message || e)); }
});

// On auth state change - check if profile exists in Firebase DB
onAuthStateChanged(auth, async (user)=>{
  if(user){
// Disable pause gate forever while logged in
localStorage.setItem('meurbal_registered', 'true');
sessionStorage.setItem('pause_disabled', 'true');

    registerBtn.innerText = 'Log Out';
    registerBtn.dataset.signed = 'true';

    const initials = (user.displayName || user.email || '').slice(0,2).toUpperCase();
    const profileBtn = document.getElementById('profileBtn');
    if(profileBtn) profileBtn.innerHTML = '<span class="profile-initials">'+initials+'</span>';

    // check database for /readers/{uid}
    try {
      const db = window._firebase.db;
      const dbRef = window._firebase.ref;
      const dbGet = window._firebase.get;
      const snap = await dbGet(dbRef(db, 'readers/' + user.uid));
      if(!snap.exists()){
        show(profilePopup);
      }
    } catch(err){
      console.warn('Failed to check reader profile:', err);
    }
  } else {
    registerBtn.innerText = 'Register';
    registerBtn.dataset.signed = 'false';
    const profileBtn = document.getElementById('profileBtn');
    if(profileBtn) profileBtn.innerHTML = '<span class="profile-initials">??</span>';
  }
});

// Profile save
profileSaveBtn.addEventListener('click', async ()=>{
  const username = readerUsername.value.trim();
  const genres = Array.from(readerGenres.querySelectorAll('input:checked')).map(i=>i.value);

  if(!username){ alert('Pick a username'); return; }
  try{
    const user = auth.currentUser;
    if(!user){ alert('No signed-in user'); hide(profilePopup); return; }

    const db = window._firebase.db;
    const dbRef = window._firebase.ref;

    await window._firebase.set(dbRef(db, 'readers/' + user.uid), {
      username,
      genres,
      email: user.email || null,
      createdAt: Date.now()
    });

    hide(profilePopup);
    alert('Profile saved!');
  } catch(e){ console.error(e); alert('Failed saving profile: ' + (e.message || e)); }
});

profileSkipBtn.addEventListener('click', ()=>{ hide(profilePopup); });

</script>
<!-- END: REGISTER + READER PROFILE UI and SCRIPT -->


<!-- START: IMPROVED REGISTER + THEMES WITH ANIMATIONS -->
<style>
/* --- REGISTER BUTTON ON HOME PAGE --- */
#homeRegisterBtn {
  position: absolute;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #00eaff, #0077ff);
  border: none;
  padding: 16px 36px;
  border-radius: 40px;
  font-size: 18px;
  font-weight: 700;
  color: white;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
  cursor: pointer;
  transition: 0.25s;
  z-index: 50;
}
#homeRegisterBtn:hover { transform: translateX(-50%) scale(1.05); }
#themeCanvas {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 1;
}
</style>

<canvas id="themeCanvas"></canvas>

<script type="module">
// --- Instant profile popup fix + animated themes ---
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";



const profilePopup = document.getElementById('profilePopup');
function show(el){ el?.classList.remove('hidden'); }
function hide(el){ el?.classList.add('hidden'); }




<!-- START: THEME SYNC FIX (particles + navbar harmony + re-register) -->
<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const auth = getAuth(window._firebase.app);


</script>
<!-- END: THEME SYNC FIX -->


<!-- üìä Combined Analytics Feature -->
<script type="module">
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDZpUl6FzT7pRtb5QwlEZrjkE4gpjZxIY4",
  authDomain: "meurbal-d3c72.firebaseapp.com",
  databaseURL: "https://meurbal-d3c72-default-rtdb.firebaseio.com",
  projectId: "meurbal-d3c72",
  storageBucket: "meurbal-d3c72.firebasestorage.app",
  messagingSenderId: "707190126856",
  appId: "1:707190126856:web:128c972aef19934c81d4bd",
  measurementId: "G-4SBPDJHJDS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ Increment read count when a story is opened
export async function incrementReadCount(storyTitle) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  data.reads++;
  await set(analyticsRef, data);
  console.log(`üìà Read count updated for ${storyTitle}`);
}

// ‚úÖ Increment like or comment counts
export async function incrementLikeOrComment(storyTitle, type) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  if (type === "like") data.likes++;
  if (type === "comment") data.comments++;
  await set(analyticsRef, data);
  console.log(`üíæ ${type} count updated for ${storyTitle}`);
}

// ‚úÖ Show analytics popup with chart
window.openAnalyticsModal = async function (storyTitle) {
  const modal = document.createElement('div');
  modal.className = 'story-analytics-modal';
  modal.innerHTML = `
    <div class="story-analytics-card">
      <div class="analytics-header">
        <div class="analytics-title">üìä Analytics ‚Äî ${storyTitle}</div>
        <button class="close-analytics">‚úñ</button>
      </div>
      <div class="analytics-body" id="analyticsBody">Loading...</div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector('.close-analytics').onclick = () => modal.remove();

  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snapshot = await get(analyticsRef);
  let data = snapshot.exists() ? snapshot.val() : { reads: 0, likes: 0, comments: 0 };

  modal.querySelector('#analyticsBody').innerHTML = `
    <div class="analytics-summary">
      <div class="summary-pill">üëÅÔ∏è Reads: ${data.reads}</div>
      <div class="summary-pill">üëç Likes: ${data.likes}</div>
      <div class="summary-pill">üí¨ Comments: ${data.comments}</div>
    </div>
    <canvas id="analyticsChart" height="120"></canvas>
  `;

  new Chart(document.getElementById('analyticsChart'), {
    type: 'bar',
    data: {
      labels: ['Reads', 'Likes', 'Comments'],
      datasets: [{
        label: 'Story Engagement',
        data: [data.reads, data.likes, data.comments],
        backgroundColor: ['#3b82f6','#22c55e','#f59e0b']
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// ‚úÖ Add Analytics button on story cards
function attachAnalyticsButtons() {
  document.querySelectorAll('.story-card').forEach(card => {
    const title = card.querySelector('h2')?.textContent?.trim();
    if (!title) return;
    if (card.querySelector('.analytics-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'btn btn-secondary analytics-btn';
    btn.textContent = 'üìä Analytics';
    btn.onclick = () => openAnalyticsModal(title);
    card.appendChild(btn);
  });
}
document.addEventListener('DOMContentLoaded', attachAnalyticsButtons);
</script>

</body>


<script>
function openSerialOptions(serial, serialIndex) {
  // Remove any existing popup
  document.querySelectorAll('.popup').forEach(p => p.remove());

  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.style.position = 'fixed';
  popup.style.top = '0';
  popup.style.left = '0';
  popup.style.width = '100%';
  popup.style.height = '100%';
  popup.style.background = 'rgba(0,0,0,0.5)';
  popup.style.display = 'flex';
  popup.style.alignItems = 'center';
  popup.style.justifyContent = 'center';
  popup.style.zIndex = '9999';

  popup.innerHTML = `
    <div class="popup-content" 
         style="background:white;padding:20px 24px;border-radius:12px;max-width:420px;width:90%;box-shadow:0 6px 20px rgba(0,0,0,0.2);text-align:center;">
      <h3 style="margin-bottom:12px;font-size:20px;">${serial.title} ‚Äî Series Options</h3>

      <button id="addEpNowBtn" class="btn btn-primary" style="margin-top:8px;width:100%;padding:10px;border:none;border-radius:8px;background:#3b82f6;color:white;font-weight:600;">
        ‚ûï Add New Episode
      </button>
  <button id="deleteSerialBtn" class="btn btn-danger"
  style="margin-top:10px;width:100%;padding:10px;border:none;border-radius:8px;
         background:#dc2626;color:white;font-weight:600;">
  üóëÔ∏è Delete Series
</button>
      <button id="deleteEpisodeBtn" class="btn btn-warning" style="margin-top:10px;width:100%;padding:10px;border:none;border-radius:8px;background:#f59e0b;color:white;font-weight:600;">
        ‚ö° Delete Episode
      </button>

      <button id="closeSerialOpts" class="btn btn-secondary" style="margin-top:12px;width:100%;padding:10px;border:none;border-radius:8px;background:#6b7280;color:white;font-weight:600;">
        ‚úñ Close
      </button>
    </div>
  `;
  document.body.appendChild(popup);

  // ---- Close ----
  document.getElementById('closeSerialOpts').onclick = () => popup.remove();

  // ---- Add Episode ----
document.getElementById('addEpNowBtn').onclick = () => {
  showAddEpisodeModal(serial, serialIndex);
};


      const newIndex = serial.episodes.length - 1;

      // ‚úÖ Save to Firebase + local
      saveSerialToFirebase(serial);
      serialsData[serialIndex] = serial;
      localStorage.setItem("serialsData", JSON.stringify(serialsData));

      alert(`‚úÖ Added new episode "${title}"`);
      popup.remove();

      // ‚úÖ Open editor for the new episode
      createEditorPage(
        title,
        serial.genre,
        desc,
        {
          isEdit: true,
          editType: "serial",
          index: serialIndex,
          episodeIndex: newIndex
        }
      );
    };
  };
document.getElementById('deleteSerialBtn').onclick = async () => {
  if (!confirm(`Delete series "${serial.title}" permanently?`)) return;

  try {
    const db = window._firebase?.db;
    const refFunc = window._firebase?.ref;
    const setFunc = window._firebase?.set;

    if (!db || !refFunc || !setFunc) {
      alert('‚ùå Firebase not initialized. Please reload the app.');
      return;
    }

    // ‚úÖ Remove from Firebase
    await setFunc(refFunc(db, `serials/${encodeURIComponent(serial.title)}`), null);

    // ‚úÖ Remove from local memory + storage
    window.serialsData.splice(serialIndex, 1);
    localStorage.setItem("serialsData", JSON.stringify(window.serialsData));

    // ‚úÖ Remove from dashboardCards cache
    const saved = JSON.parse(localStorage.getItem('dashboardCards') || '[]');
    const updated = saved.filter(card => card.title !== serial.title);
    localStorage.setItem('dashboardCards', JSON.stringify(updated));

    // ‚úÖ Remove serial card from dashboard visually
    const dashboardList = document.getElementById('dashboardList');
    if (dashboardList) {
      const cards = dashboardList.querySelectorAll('.dashboard-card h3');
      cards.forEach(h3 => {
        if (h3.textContent.trim().toLowerCase() === serial.title.trim().toLowerCase()) {
          h3.closest('.dashboard-card').remove();
        }
      });
    }

    // ‚úÖ Close popup and refresh UI
    popup.remove();
    alert(`‚úÖ Series "${serial.title}" deleted successfully.`);

    // Optional: refresh dashboard for clean state
    showDashboard('serials');
  } catch (err) {
    console.error('‚ùå Failed to delete serial:', err);
    alert('Series Sucessfully Deleted‚úÖ.');
  }
};
  // ---- Delete Episode ----
  document.getElementById('deleteEpisodeBtn').onclick = () => {
    if (!serial.episodes || serial.episodes.length === 0) {
      alert('No episodes to delete.');
      return;
    }

    // Build a mini UI list
    const listBox = document.createElement('div');
    listBox.className = 'episode-list-box';
    listBox.style.marginTop = '16px';
    listBox.style.textAlign = 'left';
    listBox.innerHTML = `
      <p style="font-weight:600;margin-bottom:8px;">Select an episode to delete:</p>
      <div style="max-height:180px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:6px;">
        ${serial.episodes.map((ep, i) => `
          <div class="ep-item" data-index="${i}"
               style="padding:8px;border-bottom:1px solid #eee;cursor:pointer;border-radius:6px;">
            <strong>${i + 1}. ${ep.title}</strong>
            ${ep.description ? `<div style="font-size:13px;color:#555;">${ep.description}</div>` : ''}
          </div>
        `).join('')}
      </div>
      <div style="text-align:center;margin-top:12px;">
        <button id="cancelDelEp" style="padding:8px 14px;background:#999;color:white;border:none;border-radius:6px;">Cancel</button>
      </div>
    `;
    const content = popup.querySelector('.popup-content');
    content.appendChild(listBox);

    listBox.querySelectorAll('.ep-item').forEach(item => {
      item.addEventListener('click', async () => {
        const index = parseInt(item.dataset.index);
        const ep = serial.episodes[index];
        if (!confirm(`Delete episode "${ep.title}"?`)) return;

        try {
          serial.episodes.splice(index, 1);

          const db = window._firebase?.db;
          const refFunc = window._firebase?.ref;
          const setFunc = window._firebase?.set;

          await setFunc(refFunc(db, `serials/${encodeURIComponent(serial.title)}`), serial);

          serialsData[serialIndex] = serial;
          localStorage.setItem('serialsData', JSON.stringify(serialsData));

          alert(`‚úÖ Episode "${ep.title}" deleted successfully.`);
          popup.remove();
        } catch (err) {
          console.error('‚ùå Failed to delete episode:', err);
          alert('Error deleting episode. Please check console.');
        }
      });
    });

    document.getElementById('cancelDelEp').onclick = () => listBox.remove();
  };
}

function showAddEpisodeModal(serial, serialIndex) {
  const box = document.getElementById("serialEpModal");
  document.getElementById("serialEpModalTitle").textContent = `Add Episode to: ${serial.title}`;
  const titleInput = document.getElementById("serialEpNewTitle");
  const descInput = document.getElementById("serialEpNewDesc");
  titleInput.value = ""; descInput.value = "";
  box.classList.remove("hidden");
  document.getElementById("serialEpCancel").onclick = () => box.classList.add("hidden");
  document.getElementById("serialEpCreate").onclick = () => {
    const t = titleInput.value.trim(); const d = descInput.value.trim();
    if (!t) return alert("Episode title is required.");
    serial.episodes = serial.episodes || [];
    serial.episodes.push({ title: t, description: d, sheets: [], status: "Draft" });
    const newIndex = serial.episodes.length - 1;
    if (typeof saveSerialToFirebase === "function") saveSerialToFirebase(serial);
    serialsData[serialIndex] = serial;
    localStorage.setItem("serialsData", JSON.stringify(serialsData));
    box.classList.add("hidden");
    createEditorPage(t, serial.genre, d, { isEdit: true, editType: "serial", index: serialIndex, episodeIndex: newIndex });
  };
}

function showEpisodeList(serial, serialIndex) {
  const modal = document.createElement("div");
  modal.className = "popup";
  modal.innerHTML = `
    <div class="popup-content" style="max-width:420px;">
      <h3>${serial.title} ‚Äî Episodes</h3>
      <div id="episodeListBox" style="margin-top:10px; text-align:left;"></div>
      <button id="closeEpList" class="btn btn-secondary" style="margin-top:12px;">Close</button>
    </div>`;
  document.body.appendChild(modal);
  const list = modal.querySelector("#episodeListBox");
  list.innerHTML = serial.episodes.map((e,i)=>`
    <div class="dashboard-card" style="margin-bottom:8px; cursor:pointer;">
      <b>${i+1}. ${e.title}</b>
      <p>Status: ${e.status || 'Draft'}</p>
    </div>`).join("");
  list.querySelectorAll(".dashboard-card").forEach((card,i)=>{
    card.onclick = () => {
      modal.remove();
      createEditorPage(serial.episodes[i].title, serial.genre, serial.episodes[i].description, { isEdit: true, editType: "serial", index: serialIndex, episodeIndex: i });
    };
  });
  document.getElementById("closeEpList").onclick = () => modal.remove();
}
</script>

</html>


<script>
// --- Real Search (no demo/fake stories) ---
function initRealSearch(){
  // helper
  function escapeHtml(str){return String(str??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
  function debounce(fn,wait=220){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)};}

  // -------- STORIES SEARCH ----------
  const storiesInput=document.getElementById('storiesSearchInput');
  const storiesClear=document.getElementById('storiesClearSearchBtn');
  const storiesCards=document.getElementById('storiesCards');
  function searchStories(q){
    const query=(q||'').trim().toLowerCase();
    if(!storiesCards)return;
    let pool=[];
    try{pool=(window.storiesData||[]).slice();}catch(e){}
    try{
      const saved=JSON.parse(localStorage.getItem('savedStories_v1')||'[]');
      if(Array.isArray(saved))pool=pool.concat(saved);
    }catch(e){}
    if(!query){
      storiesCards.innerHTML='';
      return;
    }
    const seen=new Map();
    pool.forEach(s=>{if(s&&s.title&&!seen.has(s.title))seen.set(s.title,s)});
    const matches=Array.from(seen.values()).filter(s=>(s.title||'').toLowerCase().includes(query));
    storiesCards.innerHTML='';
    matches.forEach(story=>{
      const card=document.createElement('div');
      card.className='story-card';
      card.style.minHeight='220px';
      card.innerHTML=`<h3>${escapeHtml(story.title||'Untitled')}</h3><p>${escapeHtml(story.genre||'')}</p>`;
      if(story.cover)card.style.backgroundImage=`linear-gradient(rgba(0,0,0,0.25),rgba(0,0,0,0.25)),url(${story.cover})`;
      card.addEventListener('click',()=>{try{openPreviewFullScreen(story);}catch(e){}});
      storiesCards.appendChild(card);
    });
  }
  if(storiesInput)storiesInput.addEventListener('input',debounce(e=>searchStories(e.target.value),200));
  if(storiesClear)storiesClear.addEventListener('click',()=>{storiesInput.value='';searchStories('');});

  // -------- SERIALS SEARCH ----------
  const serialsInput=document.getElementById('serialsSearchInput');
  const serialsClear=document.getElementById('serialsClearSearchBtn');
  const serialsWrap=document.getElementById('serialSearchResults');
  const serialsCards=document.getElementById('serialsCards');
  function searchSerials(q){
    const query=(q||'').trim().toLowerCase();
    let pool=[];
    try{pool=(window.serialsData||[]).slice();}catch(e){}
    try{
      const saved=JSON.parse(localStorage.getItem('savedSerials_v1')||'[]');
      if(Array.isArray(saved))pool=pool.concat(saved);
    }catch(e){}
    if(!serialsCards)return;
    if(!query){
      serialsCards.innerHTML='';
      if(serialsWrap)serialsWrap.style.display='none';
      return;
    }
    const seen=new Map();
    pool.forEach(s=>{if(s&&s.title&&!seen.has(s.title))seen.set(s.title,s)});
    const matches=Array.from(seen.values()).filter(s=>(s.title||'').toLowerCase().includes(query));
    serialsCards.innerHTML='';
    matches.forEach(s=>{
      const card=document.createElement('div');
      card.className='story-card serial-card';
      card.style.minHeight='220px';
      card.innerHTML=`<h3>${escapeHtml(s.title||'Untitled')}</h3><p>${escapeHtml(s.genre||'')}</p>`;
      if(s.cover)card.style.backgroundImage=`linear-gradient(rgba(0,0,0,0.25),rgba(0,0,0,0.25)),url(${s.cover})`;
      card.addEventListener('click',()=>{try{openSerialPreview(s.id||s.title);}catch(e){}});
      serialsCards.appendChild(card);
    });
    if(serialsWrap)serialsWrap.style.display=matches.length?'block':'none';
  }
  if(serialsInput)serialsInput.addEventListener('input',debounce(e=>searchSerials(e.target.value),200));
  if(serialsClear)serialsClear.addEventListener('click',()=>{serialsInput.value='';searchSerials('');});
}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',initRealSearch);
else initRealSearch();
</script>
<!-- ===== START: Firebase sync + bottom status box (paste before 
<script>
// --- Ensure browse buttons always show updated Firebase data ---
document.addEventListener("DOMContentLoaded", () => {
  const browseStoriesBtn = document.getElementById("browseStoriesBtn");
  const browseSerialsBtn = document.getElementById("browseSerialsBtn");

  if (browseStoriesBtn) {
    browseStoriesBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "stories"));
        if (snap.exists()) {
          window.storiesData = Object.values(snap.val());
        }
        renderStoriesList(window.storiesData || []);
      } catch (e) {
        console.warn("Failed to load stories for browse:", e);
        renderStoriesList(window.storiesData || []);
      }
    });
  }

  if (browseSerialsBtn) {
    browseSerialsBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "serials"));
        if (snap.exists()) {
          window.serialsData = Object.values(snap.val());
        }
        renderSerialsList(window.serialsData || []);
      } catch (e) {
        console.warn("Failed to load serials for browse:", e);
        renderSerialsList(window.serialsData || []);
      }
    });
  }
});
</script>


<!-- CLEAN SERIALS VIEW INJECTION: replaces broken browse serials behavior -->
<style>
  /* clean serials view styles (keeps existing theme) */
  #cleanSerialsPage { padding:20px; min-height:100vh; background:var(--bg); display:none; }
  #cleanSerialsHeader{display:flex;align-items:center;justify-content:space-between;max-width:980px;margin:0 auto 12px;gap:12px}
  #cleanSerialsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;max-width:980px;margin:12px auto;padding:12px}
  .clean-serial-card{background:#fff;border-radius:12px;padding:18px;box-shadow:var(--shadow);min-height:140px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:transform .18s}
  .clean-serial-card:hover{transform:translateY(-6px)}
  .serial-meta{color:var(--muted);font-size:13px}
  #cleanSerialsTop{display:flex;gap:12px;align-items:center;width:100%;max-width:980px;margin:0 auto}
  #cleanSerialsCount{font-weight:700}
  #cleanSerialsSearch{flex:1;padding:10px;border:1px solid var(--border);border-radius:8px}
  #cleanSerialsBack{position:fixed;left:14px;bottom:14px}
</style>

<div id="cleanSerialsPage" aria-hidden="true">
  <div id="cleanSerialsHeader">
    <div>
      <h2 style="margin:0">Browse Serials</h2>
      <div class="muted" id="cleanSerialsCount">Loading...</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="cleanSerialsSearch" placeholder="Search serials..." />
      <button id="cleanSerialsRefreshBtn" class="btn btn-secondary">Refresh</button>
    </div>
  </div>

  <div id="cleanSerialsGrid" aria-live="polite" role="list"></div>
  <button class="back-btn" id="cleanSerialsBack">‚Üê Back</button>
</div>

<script>
(function(){
  // ensure helper functions exist globally for legacy callers
  window.renderSerialsList = function(serials){
    // maintain compatibility - forward to clean renderer if available
    if(window._renderCleanSerials) return window._renderCleanSerials(serials);
    const list = document.getElementById('serialsCards');
    if(!list) return;
    list.innerHTML = '';
    (serials||[]).forEach(s=>{
      const c=document.createElement('div');
      c.className='story-card';
      c.innerHTML=`<h2>${s.title}</h2><p>${s.genre||''}</p>`;
      list.appendChild(c);
    });
  };

  // internal render for clean view
  window._renderCleanSerials = function(serials){
    const grid = document.getElementById('cleanSerialsGrid');
    const count = document.getElementById('cleanSerialsCount');
    if(!grid) return;
    grid.innerHTML = '';
    serials = serials || [];
    count.textContent = `${serials.length} serial${serials.length===1?'':'s'} loaded`;
    serials.forEach(s=>{
      const card = document.createElement('div');
      card.className='clean-serial-card';
      const desc = s.description ? `<div class="muted" style="margin-top:6px">${s.description.slice(0,140)}</div>` : '';
      card.innerHTML = `<div><h4 style="margin:0">${s.title}</h4><div class="serial-meta">${s.genre||''}</div>${desc}</div><div style="display:flex;gap:8px;align-items:center"><button class="btn btn-primary btn-small">Open</button></div>`;
      card.addEventListener('click', ()=>{
        // open editor or reader if exists - try to find serial by title in window.serialsData
        const idx = (window.serialsData||[]).findIndex(x=> (x.title||'').trim() === (s.title||'').trim());
        if(idx>=0){
          // open the first episode if present using existing createEditorPage if available
          try{
            if(typeof createEditorPage === 'function'){
              const ser = window.serialsData[idx];
              const epIndex = ser.episodes && ser.episodes.length ? 0 : null;
              createEditorPage(epIndex!=null? ser.episodes[epIndex].title : ser.title, ser.genre, epIndex!=null? ser.episodes[epIndex].description : ser.description, { isEdit:true, editType:'serial', index: idx, episodeIndex: epIndex });
              return;
            }
          }catch(e){ console.warn('Open serial: editor open failed', e); }
        }
        alert('Open serial: editor not available in this context.');
      });
      grid.appendChild(card);
    });
  };

  // show/hide helpers
  function openCleanSerialsPage(){
    // hide other main pages (same logic as your app)
    const pages = ['welcomePage','categoriesPage','serialCategoriesPage','dashboardPage','slidesPage','storyFormPage','profileFormPage'];
    pages.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.classList.add('hidden');
    });
    // show our clean view
    const clean = document.getElementById('cleanSerialsPage');
    if(clean){ clean.classList.remove('hidden'); clean.setAttribute('aria-hidden','false'); }
    // attempt to render cached data immediately
    if(window.serialsData && window.serialsData.length){
      window._renderCleanSerials(window.serialsData);
      console.log(`‚ÑπÔ∏è Showing ${window.serialsData.length} cached serials from localStorage`);
    }
  }

  function closeCleanSerialsPage(){
    const clean = document.getElementById('cleanSerialsPage');
    if(clean){ clean.classList.add('hidden'); clean.setAttribute('aria-hidden','true'); }
    // show welcome page as fallback
    const welcome = document.getElementById('welcomePage');
    if(welcome) welcome.classList.remove('hidden');
  }

  // wire up buttons (override old handlers safely)
  const browseBtn = document.getElementById('browseSerialsBtn');
  if(browseBtn){
    browseBtn.removeEventListener && browseBtn.removeEventListener('click', ()=>{});
    browseBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      openCleanSerialsPage();
    });
  }
  const backBtn = document.getElementById('cleanSerialsBack');
  if(backBtn) backBtn.addEventListener('click', ()=>{ closeCleanSerialsPage(); });

  const refreshBtn = document.getElementById('cleanSerialsRefreshBtn');
  if(refreshBtn) refreshBtn.addEventListener('click', ()=>{ fetchAndRenderSerials(true); });

  // search filtering
  const searchInput = document.getElementById('cleanSerialsSearch');
  if(searchInput) searchInput.addEventListener('input', (e)=>{
    const q = (e.target.value||'').toLowerCase().trim();
    const filtered = (window.serialsData||[]).filter(s=>{
      return (s.title||'').toLowerCase().includes(q) || (s.genre||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q);
    });
    window._renderCleanSerials(filtered);
  });

  // Firebase real-time listener & initial fetch
  async function fetchAndRenderSerials(forceReload) {
    try {
      // Use Firebase SDK directly (no window._firebase dependency)
      import("https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js").then(({ getDatabase, ref, onValue }) => {
        const db = getDatabase();
        // attach live listener
        if (window._cleanSerialsListenerAttached && !forceReload) return;
        window._cleanSerialsListenerAttached = true;

        onValue(ref(db, 'serials'), snap => {
          if (snap.exists()) {
            const obj = snap.val();
            window.serialsData = Object.values(obj);
            try { localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); } catch (e) {}
            window._renderCleanSerials(window.serialsData);
            console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
          } else {
            window.serialsData = [];
            try { localStorage.setItem('serialsData', JSON.stringify([])); } catch (e) {}
            window._renderCleanSerials([]);
            console.log('‚ö†Ô∏è No serials found in Firebase');
          }
        });
      }).catch(err => console.error('Firebase import failed:', err));
    } catch (err) {
      console.error('Failed to load serials for browse:', err);
    }
    
      // attach live listener (debounce multiple attachments)
      if(window._cleanSerialsListenerAttached && !forceReload) return;
      window._cleanSerialsListenerAttached = true;

      onValue(ref(db, 'serials'), snap => {
        if(snap.exists()){
          const obj = snap.val();
          window.serialsData = Object.values(obj);
          try{ localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); }catch(e){}
          window._renderCleanSerials(window.serialsData);
          console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
        } else {
          window.serialsData = [];
          try{ localStorage.setItem('serialsData', JSON.stringify([])); }catch(e){}
          window._renderCleanSerials([]);
          console.log('‚ö†Ô∏è No serials found in Firebase');
        }
      });
    }catch(err){
      console.error('Failed to load serials for browse:', err);
    }
  }

  // attempt to initialize listener on DOMContentLoaded (or immediately if already)
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    fetchAndRenderSerials(false);
  } else {
    document.addEventListener('DOMContentLoaded', ()=> fetchAndRenderSerials(false));
  }

  // show cached data on load (fallback)
  try{
    const cached = JSON.parse(localStorage.getItem('serialsData') || 'null');
    if(cached && Array.isArray(cached) && cached.length){
      window.serialsData = cached;
      console.log('‚ÑπÔ∏è Loaded serials from localStorage cache:', window.serialsData.length);
    }
  }catch(e){}

})();
</script>
<!-- END INJECTION -->


<!-- Global fullscreen preview containers (moved outside hidden pages) -->
<div id="previewFull" class="hidden"></div>
<div id="readerFull" class="hidden"></div>

<!-- PATCH: base64 cover upload handlers + save function overrides -->
<script>
(function(){
  // create globals to hold base64 covers
  window._currentStoryCover = window._currentStoryCover || null;
  window._currentSerialCover = window._currentSerialCover || null;

  // helper to wire an input id to a preview img id and store base64
  function wireCoverInput(inputId, previewId, targetVarName) {
    const input = document.getElementById(inputId);
    if (!input) return;
    input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!['image/jpeg','image/png'].includes(file.type)) {
        alert('Only JPG or PNG allowed for cover images.');
        e.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        window[targetVarName] = ev.target.result;
        const preview = document.getElementById(previewId);
        if (preview) preview.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  wireCoverInput('storyCoverInput', 'storyCoverPreview', '_currentStoryCover');
  wireCoverInput('serialCoverInput', 'serialCoverPreview', '_currentSerialCover');

  // Override save functions to include base64 cover when present
window.saveSerialToFirebase = async function(ser) {
  try {
    if (window._currentSerialCover) ser.cover = window._currentSerialCover;

    if (!window._firebase || !window._firebase.db) {
      console.error('Firebase not ready for saveSerialToFirebase');
      return;
    }

    const key = encodeURIComponent(ser.title.trim());

    await window._firebase.set(
      window._firebase.ref(window._firebase.db, `serials/${key}`),
      ser
    );

    console.log(`‚úÖ Serial "${ser.title}" saved (with cover if provided).`);
  } catch (err) {
    console.error('‚ùå Error saving serial (patched):', err);
  }
};


  window.saveStoryToFirebase = async function(story) {
    try {
      if (window._currentStoryCover) story.cover = window._currentStoryCover;
      if (!window._firebase || !window._firebase.db) {
        console.error('Firebase not ready for saveStoryToFirebase');
        return;
      }
      // attempt to write under stories/{title} if that is the app convention
      await window._firebase.set(window._firebase.ref(window._firebase.db, `stories/${story.title}`), story);
      console.log(`‚úÖ Story "${story.title}" saved (with cover if provided).`);
    } catch (err) {
      console.error('‚ùå Error saving story (patched):', err);
    }
  };

  // If the app uses different save function names, we also patch a generic save call helper if it exists
  // For example, if there's a function called uploadStory or createSerial, the developer can call saveSerialToFirebase explicitly.
})();
</script>
<!-- END PATCH -->


<!-- Serial Episode Modal -->
<div id="serialEpModal" class="popup hidden">
  <div class="popup-content" style="max-width:480px;">
    <h3 id="serialEpModalTitle"></h3>
    <label>Episode Title</label>
    <input id="serialEpNewTitle" placeholder="Episode title">
    <label>Description (optional)</label>
    <textarea id="serialEpNewDesc" rows="2"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button id="serialEpCancel" class="btn btn-secondary">Cancel</button>
      <button id="serialEpCreate" class="btn btn-primary">Next</button>
    </div>
  </div>
</div>




<script>
function showHomePage(){
  const welcomePage = document.getElementById('welcomePage');
  const dashboardPage = document.getElementById('dashboardPage');
  const profileFormPage = document.getElementById('profileFormPage');
  const slidesPage = document.getElementById('slidesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const serialCategoriesPage = document.getElementById('serialCategoriesPage');
  const writerGatePage = document.getElementById('writerGatePage'); // ‚úÖ add this line

  if(welcomePage) welcomePage.classList.remove('hidden');
  if(dashboardPage) dashboardPage.classList.add('hidden');
  if(profileFormPage) profileFormPage.classList.add('hidden');
  if(slidesPage) slidesPage.classList.add('hidden');
  if(categoriesPage) categoriesPage.classList.add('hidden');
  if(serialCategoriesPage) serialCategoriesPage.classList.add('hidden');
  if(writerGatePage) writerGatePage.classList.add('hidden'); // ‚úÖ hide writer gate
}


document.getElementById('homeBtn').addEventListener('click', ()=>{ showHomePage(); });



document.getElementById('writerBtn').addEventListener('click', () => {
  const profile = localStorage.getItem("writerProfile_v1");
  const writerGate = document.getElementById('writerGatePage');
  const welcome = document.getElementById('welcomePage');
  const dashboard = document.getElementById('dashboardPage');
  const categories = document.getElementById('categoriesPage');
  const serialCategories = document.getElementById('serialCategoriesPage');
  const profileForm = document.getElementById('profileFormPage');

  if(welcome) welcome.classList.add('hidden');
  if(dashboard) dashboard.classList.add('hidden');
  if(categories) categories.classList.add('hidden');
  if(serialCategories) serialCategories.classList.add('hidden');
  if(profileForm) profileForm.classList.add('hidden');

  writerGate.classList.remove('hidden');

  if (!profile) {
    document.getElementById('writerGateTitle').innerText = "No Writer Profile Found";
    document.getElementById('writerGateSubtitle').innerText = "To unlock the Writer Section, please create your writer profile.";
    document.getElementById('writerGateActionBtn').innerText = "Create Profile";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      profileForm.classList.remove('hidden');
    };
  } else {
    document.getElementById('writerGateTitle').innerText = "Writer Section Unlocked";
    document.getElementById('writerGateSubtitle').innerText = "Access your tools, manage stories and serials.";
    document.getElementById('writerGateActionBtn').innerText = "Open Writer Dashboard";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      showDashboard('stories');
    };
  }
});



// land on home
document.addEventListener('DOMContentLoaded', showHomePage);
</script>

<script>

  document.getElementById('slidesPage').classList.remove('hidden');
};
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const wsBtn = document.getElementById("writerGateWorkspaceBtn");
  if(wsBtn){
    wsBtn.onclick = () => {
      alert("üöß Creation Workspace Coming Soon");
    };
  }
});
</script>


<!-- WORKSPACE LOADING SCREEN ‚Äî OCEAN MODE -->
<div id="workspaceLoadingScreen" class="hidden" style="
  position:fixed; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center; text-align:center;
  color:white; z-index:999999; background:#001e28; overflow:hidden;">

  <!-- Ocean Background Gradient -->
  <div id="oceanBg"></div>

  <!-- Underwater Pearl Planet -->
  <div id="planetWrap" style="position:relative; margin-top:-10px;">
    <div id="planet"></div>
  </div>

  <!-- Fact Text -->
  <div id="workspaceFactText" style="margin-top:35px; font-size:22px; opacity:0.9;">
    Loading Ocean...
  </div>

  <!-- Loading Bar -->
  <div style="margin-top:45px; width:300px; height:14px; background:#00404e; border-radius:7px; overflow:hidden;">
    <div id="workspaceLoadingBar" style="height:100%; width:0%; background:#3ffbff; box-shadow:0 0 15px #3ffbff; transition:width 0.35s linear;"></div>
  </div>
</div>

<style>
/* OCEAN BACKGROUND WAVES */
#oceanBg {
  position:absolute;
  inset:0;
  background: linear-gradient(#003340, #00141e);
  overflow:hidden;
}

#oceanBg::before,
#oceanBg::after {
  content:"";
  position:absolute;
  width:200%;
  height:200%;
  top:0; left:0;
  background: radial-gradient(circle at 50% 90%, rgba(0,150,200,0.3), transparent 70%);
  animation: waterDrift 14s infinite linear;
  opacity:0.45;
}

#oceanBg::after {
  animation-duration: 22s;
  opacity:0.25;
}

@keyframes waterDrift {
  from { transform:translate(-20%, -10%); }
  to   { transform:translate(20%, 10%); }
}

/* PEARL-LIKE GLOW PLANET */
#planet {
  width: 260px;
  height: 260px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffffff 0%, #b8faff 30%, #009bb0 60%, #003d46 100%);
  position: relative;
  animation: slowRotate 18s linear infinite;
  filter: drop-shadow(0 0 40px #4ffbff);
}

/* Soft shimmer waves across surface */
#planet::before {
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  background: repeating-linear-gradient(
    120deg,
    rgba(255,255,255,0.12) 0px,
    rgba(255,255,255,0.12) 4px,
    transparent 4px,
    transparent 22px
  );
  mix-blend-mode: screen;
  animation: shimmer 9s linear infinite;
  opacity:0.25;
}

@keyframes slowRotate {
  from { transform:rotate(0deg); }
  to { transform:rotate(360deg); }
}

@keyframes shimmer {
  from { transform:translateX(0); }
  to { transform:translateX(-260px); }
}
</style>


<!-- Added Firebase save for writerName and publishDate -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('startCreatingBtn');
  if (!btn) return;
  btn.addEventListener('click', function(){
    try {
      const title = document.getElementById('storyTitle')?.value?.trim() || '';
      if (!title) return;
      const desc = document.getElementById('storyDesc')?.value || '';
      const genre = document.getElementById('storyGenre')?.value || '';
      const writerName = document.getElementById('writerNameInput')?.value?.trim() || 'Unknown';
      const publishDate = document.getElementById('publishDateInput')?.value || new Date().toISOString().split('T')[0];
      const cover = window._currentStoryCover || '';
      const storyData = {
        title, description: desc, genre, cover,
        writerName, publishDate,
        updatedAt: new Date().toISOString()
      };
      if (window._firebase && window._firebase.set && window._firebase.db) {
        const key = encodeURIComponent(title);
        window._firebase.set(window._firebase.ref(window._firebase.db, 'stories/' + key), storyData)
          .then(()=>console.log('‚úÖ Story saved with writer info:', title))
          .catch(e=>console.error('‚ùå Save failed', e));
      } else {
        console.warn('Firebase helpers missing');
      }
    } catch(e){ console.error('Error saving writer info:', e); }
  });
});
</script>
<!-- End Firebase save patch -->

<script>
    // üïí Wait until meurbalSplash is hidden/removed
    const checkSplashDone = setInterval(() => {
      const splash = document.getElementById('meurbalSplash');
      const hiddenNow =
        !splash ||
        splash.classList.contains('hidden') ||
        splash.style.display === 'none' ||
        splash.style.visibility === 'hidden' ||
        parseFloat(window.getComputedStyle(splash).opacity) < 0.05;

      if (hiddenNow && !aiBadgeVisible) {
        aiBadgeVisible = true;
        // Delay a bit after removal for smooth reveal
        setTimeout(() => {
          img.style.opacity = '1';
          img.style.pointerEvents = 'auto';
        }, 800); // ~ matches splash.remove timing
        clearInterval(checkSplashDone);
      }
    }, 300);
  }

  ensureBadge();
  // Recreate if DOM wipes it later
  setInterval(ensureBadge, 1500);
})();
</script>

<!-- üìä Combined Analytics Feature -->
<script type="module">
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDZpUl6FzT7pRtb5QwlEZrjkE4gpjZxIY4",
  authDomain: "meurbal-d3c72.firebaseapp.com",
  databaseURL: "https://meurbal-d3c72-default-rtdb.firebaseio.com",
  projectId: "meurbal-d3c72",
  storageBucket: "meurbal-d3c72.firebasestorage.app",
  messagingSenderId: "707190126856",
  appId: "1:707190126856:web:128c972aef19934c81d4bd",
  measurementId: "G-4SBPDJHJDS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
(function setupMeurbalSplash() {
  const SPLASH_KEY = 'meurbal_splash_shown_v2';
  const MIN_MS = 3000; // Minimum 3 seconds
  const splash = document.getElementById('meurbalSplash');
  const barFill = document.getElementById('meurbalSplashBarFill');
  if (!splash || !barFill) return;

  // Skip if already shown in this session
  if (sessionStorage.getItem(SPLASH_KEY)) {
    splash.classList.add('hidden');
    setTimeout(() => splash.remove?.(), 420);
    return;
  }

  splash.classList.add('showing');

  // Simulate bar fill while waiting for Firebase
  let progress = 0;
  const timer = setInterval(() => {
    progress += Math.random() * 10; // random incremental fill
    if (progress > 95) progress = 95; // cap before completion
    barFill.style.width = progress + '%';
  }, 200);

  // Firebase wait (adjust ref path if needed)
  const firebaseReadyPromise = (async () => {
    try {
      if (typeof db !== 'undefined' && typeof ref === 'function' && typeof get === 'function') {
        await get(ref(db, '/'));
      }
    } catch (e) {
      console.warn('Firebase load skipped:', e);
    }
  })();

  // Wait until both minimum time and Firebase ready
  Promise.all([
    new Promise(res => setTimeout(res, MIN_MS)),
    firebaseReadyPromise
  ]).finally(() => {
    clearInterval(timer);
    barFill.style.width = '100%'; // fill to complete

    // Save session
    sessionStorage.setItem(SPLASH_KEY, '1');

    // Fade out splash
    setTimeout(() => splash.classList.add('hidden'), 400);
    setTimeout(() => splash.remove?.(), 1000);

    // Optional: greeting text or transition message
    console.log("Dive into the world of imaginations üåä‚ú®");
  });

  // Fallback if Firebase hangs
  setTimeout(() => {
    clearInterval(timer);
    if (!sessionStorage.getItem(SPLASH_KEY)) {
      barFill.style.width = '100%';
      splash.classList.add('hidden');
      setTimeout(()=> splash.remove?.(), 800);
      sessionStorage.setItem(SPLASH_KEY, '1');
    }
  }, 10000);
})();

// ‚úÖ Increment read count when a story is opened
export async function incrementReadCount(storyTitle) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  data.reads++;
  await set(analyticsRef, data);
  console.log(`üìà Read count updated for ${storyTitle}`);
}

// ‚úÖ Increment like or comment counts
export async function incrementLikeOrComment(storyTitle, type) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  if (type === "like") data.likes++;
  if (type === "comment") data.comments++;
  await set(analyticsRef, data);
  console.log(`üíæ ${type} count updated for ${storyTitle}`);
}

// ‚úÖ Show analytics popup with chart
window.openAnalyticsModal = async function (storyTitle) {
  const modal = document.createElement('div');
  modal.className = 'story-analytics-modal';
  modal.innerHTML = `
    <div class="story-analytics-card">
      <div class="analytics-header">
        <div class="analytics-title">üìä Analytics ‚Äî ${storyTitle}</div>
        <button class="close-analytics">‚úñ</button>
      </div>
      <div class="analytics-body" id="analyticsBody">Loading...</div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector('.close-analytics').onclick = () => modal.remove();

  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snapshot = await get(analyticsRef);
  let data = snapshot.exists() ? snapshot.val() : { reads: 0, likes: 0, comments: 0 };

  modal.querySelector('#analyticsBody').innerHTML = `
    <div class="analytics-summary">
      <div class="summary-pill">üëÅÔ∏è Reads: ${data.reads}</div>
      <div class="summary-pill">üëç Likes: ${data.likes}</div>
      <div class="summary-pill">üí¨ Comments: ${data.comments}</div>
    </div>
    <canvas id="analyticsChart" height="120"></canvas>
  `;

  new Chart(document.getElementById('analyticsChart'), {
    type: 'bar',
    data: {
      labels: ['Reads', 'Likes', 'Comments'],
      datasets: [{
        label: 'Story Engagement',
        data: [data.reads, data.likes, data.comments],
        backgroundColor: ['#3b82f6','#22c55e','#f59e0b']
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// ‚úÖ Add Analytics button on story cards
function attachAnalyticsButtons() {
  document.querySelectorAll('.story-card').forEach(card => {
    const title = card.querySelector('h2')?.textContent?.trim();
    if (!title) return;
    if (card.querySelector('.analytics-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'btn btn-secondary analytics-btn';
    btn.textContent = 'üìä Analytics';
    btn.onclick = () => openAnalyticsModal(title);
    card.appendChild(btn);
  });
}
document.addEventListener('DOMContentLoaded', attachAnalyticsButtons);
</script>

</body>

<script>
/* FIREBASE SYNC INTEGRATION
   - Paste this just before 
<script>
// --- Ensure browse buttons always show updated Firebase data ---
document.addEventListener("DOMContentLoaded", () => {
  const browseStoriesBtn = document.getElementById("browseStoriesBtn");
  const browseSerialsBtn = document.getElementById("browseSerialsBtn");

  if (browseStoriesBtn) {
    browseStoriesBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "stories"));
        if (snap.exists()) {
          window.storiesData = Object.values(snap.val());
        }
        renderStoriesList(window.storiesData || []);
      } catch (e) {
        console.warn("Failed to load stories for browse:", e);
        renderStoriesList(window.storiesData || []);
      }
    });
  }

  if (browseSerialsBtn) {
    browseSerialsBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "serials"));
        if (snap.exists()) {
          window.serialsData = Object.values(snap.val());
        }
        renderSerialsList(window.serialsData || []);
      } catch (e) {
        console.warn("Failed to load serials for browse:", e);
        renderSerialsList(window.serialsData || []);
      }
    });
  }
});
</script>


<!-- CLEAN SERIALS VIEW INJECTION: replaces broken browse serials behavior -->
<style>
  /* clean serials view styles (keeps existing theme) */
  #cleanSerialsPage { padding:20px; min-height:100vh; background:var(--bg); display:none; }
  #cleanSerialsHeader{display:flex;align-items:center;justify-content:space-between;max-width:980px;margin:0 auto 12px;gap:12px}
  #cleanSerialsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;max-width:980px;margin:12px auto;padding:12px}
  .clean-serial-card{background:#fff;border-radius:12px;padding:18px;box-shadow:var(--shadow);min-height:140px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:transform .18s}
  .clean-serial-card:hover{transform:translateY(-6px)}
  .serial-meta{color:var(--muted);font-size:13px}
  #cleanSerialsTop{display:flex;gap:12px;align-items:center;width:100%;max-width:980px;margin:0 auto}
  #cleanSerialsCount{font-weight:700}
  #cleanSerialsSearch{flex:1;padding:10px;border:1px solid var(--border);border-radius:8px}
  #cleanSerialsBack{position:fixed;left:14px;bottom:14px}
</style>

<div id="cleanSerialsPage" aria-hidden="true">
  <div id="cleanSerialsHeader">
    <div>
      <h2 style="margin:0">Browse Serials</h2>
      <div class="muted" id="cleanSerialsCount">Loading...</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="cleanSerialsSearch" placeholder="Search serials..." />
      <button id="cleanSerialsRefreshBtn" class="btn btn-secondary">Refresh</button>
    </div>
  </div>

  <div id="cleanSerialsGrid" aria-live="polite" role="list"></div>
  <button class="back-btn" id="cleanSerialsBack">‚Üê Back</button>
</div>

<script>
(function(){
  // ensure helper functions exist globally for legacy callers
  window.renderSerialsList = function(serials){
    // maintain compatibility - forward to clean renderer if available
    if(window._renderCleanSerials) return window._renderCleanSerials(serials);
    const list = document.getElementById('serialsCards');
    if(!list) return;
    list.innerHTML = '';
    (serials||[]).forEach(s=>{
      const c=document.createElement('div');
      c.className='story-card';
      c.innerHTML=`<h2>${s.title}</h2><p>${s.genre||''}</p>`;
      list.appendChild(c);
    });
  };

  // internal render for clean view
  window._renderCleanSerials = function(serials){
    const grid = document.getElementById('cleanSerialsGrid');
    const count = document.getElementById('cleanSerialsCount');
    if(!grid) return;
    grid.innerHTML = '';
    serials = serials || [];
    count.textContent = `${serials.length} serial${serials.length===1?'':'s'} loaded`;
    serials.forEach(s=>{
      const card = document.createElement('div');
      card.className='clean-serial-card';
      const desc = s.description ? `<div class="muted" style="margin-top:6px">${s.description.slice(0,140)}</div>` : '';
      card.innerHTML = `<div><h4 style="margin:0">${s.title}</h4><div class="serial-meta">${s.genre||''}</div>${desc}</div><div style="display:flex;gap:8px;align-items:center"><button class="btn btn-primary btn-small">Open</button></div>`;
      card.addEventListener('click', ()=>{
        // open editor or reader if exists - try to find serial by title in window.serialsData
        const idx = (window.serialsData||[]).findIndex(x=> (x.title||'').trim() === (s.title||'').trim());
        if(idx>=0){
          // open the first episode if present using existing createEditorPage if available
          try{
            if(typeof createEditorPage === 'function'){
              const ser = window.serialsData[idx];
              const epIndex = ser.episodes && ser.episodes.length ? 0 : null;
              createEditorPage(epIndex!=null? ser.episodes[epIndex].title : ser.title, ser.genre, epIndex!=null? ser.episodes[epIndex].description : ser.description, { isEdit:true, editType:'serial', index: idx, episodeIndex: epIndex });
              return;
            }
          }catch(e){ console.warn('Open serial: editor open failed', e); }
        }
        alert('Open serial: editor not available in this context.');
      });
      grid.appendChild(card);
    });
  };

  // show/hide helpers
  function openCleanSerialsPage(){
    // hide other main pages (same logic as your app)
    const pages = ['welcomePage','categoriesPage','serialCategoriesPage','dashboardPage','slidesPage','storyFormPage','profileFormPage'];
    pages.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.classList.add('hidden');
    });
    // show our clean view
    const clean = document.getElementById('cleanSerialsPage');
    if(clean){ clean.classList.remove('hidden'); clean.setAttribute('aria-hidden','false'); }
    // attempt to render cached data immediately
    if(window.serialsData && window.serialsData.length){
      window._renderCleanSerials(window.serialsData);
      console.log(`‚ÑπÔ∏è Showing ${window.serialsData.length} cached serials from localStorage`);
    }
  }

  function closeCleanSerialsPage(){
    const clean = document.getElementById('cleanSerialsPage');
    if(clean){ clean.classList.add('hidden'); clean.setAttribute('aria-hidden','true'); }
    // show welcome page as fallback
    const welcome = document.getElementById('welcomePage');
    if(welcome) welcome.classList.remove('hidden');
  }

  // wire up buttons (override old handlers safely)
  const browseBtn = document.getElementById('browseSerialsBtn');
  if(browseBtn){
    browseBtn.removeEventListener && browseBtn.removeEventListener('click', ()=>{});
    browseBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      openCleanSerialsPage();
    });
  }
  const backBtn = document.getElementById('cleanSerialsBack');
  if(backBtn) backBtn.addEventListener('click', ()=>{ closeCleanSerialsPage(); });

  const refreshBtn = document.getElementById('cleanSerialsRefreshBtn');
  if(refreshBtn) refreshBtn.addEventListener('click', ()=>{ fetchAndRenderSerials(true); });

  // search filtering
  const searchInput = document.getElementById('cleanSerialsSearch');
  if(searchInput) searchInput.addEventListener('input', (e)=>{
    const q = (e.target.value||'').toLowerCase().trim();
    const filtered = (window.serialsData||[]).filter(s=>{
      return (s.title||'').toLowerCase().includes(q) || (s.genre||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q);
    });
    window._renderCleanSerials(filtered);
  });

  // Firebase real-time listener & initial fetch
  async function fetchAndRenderSerials(forceReload) {
    try {
      // Use Firebase SDK directly (no window._firebase dependency)
      import("https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js").then(({ getDatabase, ref, onValue }) => {
        const db = getDatabase();
        // attach live listener
        if (window._cleanSerialsListenerAttached && !forceReload) return;
        window._cleanSerialsListenerAttached = true;

        onValue(ref(db, 'serials'), snap => {
          if (snap.exists()) {
            const obj = snap.val();
            window.serialsData = Object.values(obj);
            try { localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); } catch (e) {}
            window._renderCleanSerials(window.serialsData);
            console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
          } else {
            window.serialsData = [];
            try { localStorage.setItem('serialsData', JSON.stringify([])); } catch (e) {}
            window._renderCleanSerials([]);
            console.log('‚ö†Ô∏è No serials found in Firebase');
          }
        });
      }).catch(err => console.error('Firebase import failed:', err));
    } catch (err) {
      console.error('Failed to load serials for browse:', err);
    }
    
      // attach live listener (debounce multiple attachments)
      if(window._cleanSerialsListenerAttached && !forceReload) return;
      window._cleanSerialsListenerAttached = true;

      onValue(ref(db, 'serials'), snap => {
        if(snap.exists()){
          const obj = snap.val();
          window.serialsData = Object.values(obj);
          try{ localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); }catch(e){}
          window._renderCleanSerials(window.serialsData);
          console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
        } else {
          window.serialsData = [];
          try{ localStorage.setItem('serialsData', JSON.stringify([])); }catch(e){}
          window._renderCleanSerials([]);
          console.log('‚ö†Ô∏è No serials found in Firebase');
        }
      });
    }catch(err){
      console.error('Failed to load serials for browse:', err);
    }
  }

  // attempt to initialize listener on DOMContentLoaded (or immediately if already)
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    fetchAndRenderSerials(false);
  } else {
    document.addEventListener('DOMContentLoaded', ()=> fetchAndRenderSerials(false));
  }

  // show cached data on load (fallback)
  try{
    const cached = JSON.parse(localStorage.getItem('serialsData') || 'null');
    if(cached && Array.isArray(cached) && cached.length){
      window.serialsData = cached;
      console.log('‚ÑπÔ∏è Loaded serials from localStorage cache:', window.serialsData.length);
    }
  }catch(e){}

})();
</script>
<!-- END INJECTION -->


<!-- Global fullscreen preview containers (moved outside hidden pages) -->
<div id="previewFull" class="hidden"></div>
<div id="readerFull" class="hidden"></div>

<!-- PATCH: base64 cover upload handlers + save function overrides -->
<script>
(function(){
  // create globals to hold base64 covers
  window._currentStoryCover = window._currentStoryCover || null;
  window._currentSerialCover = window._currentSerialCover || null;

  // helper to wire an input id to a preview img id and store base64
  function wireCoverInput(inputId, previewId, targetVarName) {
    const input = document.getElementById(inputId);
    if (!input) return;
    input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!['image/jpeg','image/png'].includes(file.type)) {
        alert('Only JPG or PNG allowed for cover images.');
        e.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        window[targetVarName] = ev.target.result;
        const preview = document.getElementById(previewId);
        if (preview) preview.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  wireCoverInput('storyCoverInput', 'storyCoverPreview', '_currentStoryCover');
  wireCoverInput('serialCoverInput', 'serialCoverPreview', '_currentSerialCover');

  // Override save functions to include base64 cover when present
window.saveSerialToFirebase = async function(ser) {
  try {
    if (window._currentSerialCover) ser.cover = window._currentSerialCover;

    if (!window._firebase || !window._firebase.db) {
      console.error('Firebase not ready for saveSerialToFirebase');
      return;
    }

    const key = encodeURIComponent(ser.title.trim());

    await window._firebase.set(
      window._firebase.ref(window._firebase.db, `serials/${key}`),
      ser
    );

    console.log(`‚úÖ Serial "${ser.title}" saved (with cover if provided).`);
  } catch (err) {
    console.error('‚ùå Error saving serial (patched):', err);
  }
};


  window.saveStoryToFirebase = async function(story) {
    try {
      if (window._currentStoryCover) story.cover = window._currentStoryCover;
      if (!window._firebase || !window._firebase.db) {
        console.error('Firebase not ready for saveStoryToFirebase');
        return;
      }
      // attempt to write under stories/{title} if that is the app convention
      await window._firebase.set(window._firebase.ref(window._firebase.db, `stories/${story.title}`), story);
      console.log(`‚úÖ Story "${story.title}" saved (with cover if provided).`);
    } catch (err) {
      console.error('‚ùå Error saving story (patched):', err);
    }
  };

  // If the app uses different save function names, we also patch a generic save call helper if it exists
  // For example, if there's a function called uploadStory or createSerial, the developer can call saveSerialToFirebase explicitly.
})();
</script>
<!-- END PATCH -->


<!-- Serial Episode Modal -->
<div id="serialEpModal" class="popup hidden">
  <div class="popup-content" style="max-width:480px;">
    <h3 id="serialEpModalTitle"></h3>
    <label>Episode Title</label>
    <input id="serialEpNewTitle" placeholder="Episode title">
    <label>Description (optional)</label>
    <textarea id="serialEpNewDesc" rows="2"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button id="serialEpCancel" class="btn btn-secondary">Cancel</button>
      <button id="serialEpCreate" class="btn btn-primary">Next</button>
    </div>
  </div>
</div>




<script>
function showHomePage(){
  const welcomePage = document.getElementById('welcomePage');
  const dashboardPage = document.getElementById('dashboardPage');
  const profileFormPage = document.getElementById('profileFormPage');
  const slidesPage = document.getElementById('slidesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const serialCategoriesPage = document.getElementById('serialCategoriesPage');
  const writerGatePage = document.getElementById('writerGatePage'); // ‚úÖ add this line

  if(welcomePage) welcomePage.classList.remove('hidden');
  if(dashboardPage) dashboardPage.classList.add('hidden');
  if(profileFormPage) profileFormPage.classList.add('hidden');
  if(slidesPage) slidesPage.classList.add('hidden');
  if(categoriesPage) categoriesPage.classList.add('hidden');
  if(serialCategoriesPage) serialCategoriesPage.classList.add('hidden');
  if(writerGatePage) writerGatePage.classList.add('hidden'); // ‚úÖ hide writer gate
}


document.getElementById('homeBtn').addEventListener('click', ()=>{ showHomePage(); });



document.getElementById('writerBtn').addEventListener('click', () => {
  const profile = localStorage.getItem("writerProfile_v1");
  const writerGate = document.getElementById('writerGatePage');
  const welcome = document.getElementById('welcomePage');
  const dashboard = document.getElementById('dashboardPage');
  const categories = document.getElementById('categoriesPage');
  const serialCategories = document.getElementById('serialCategoriesPage');
  const profileForm = document.getElementById('profileFormPage');

  if(welcome) welcome.classList.add('hidden');
  if(dashboard) dashboard.classList.add('hidden');
  if(categories) categories.classList.add('hidden');
  if(serialCategories) serialCategories.classList.add('hidden');
  if(profileForm) profileForm.classList.add('hidden');

  writerGate.classList.remove('hidden');

  if (!profile) {
    document.getElementById('writerGateTitle').innerText = "No Writer Profile Found";
    document.getElementById('writerGateSubtitle').innerText = "To unlock the Writer Section, please create your writer profile.";
    document.getElementById('writerGateActionBtn').innerText = "Create Profile";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      profileForm.classList.remove('hidden');
    };
  } else {
    document.getElementById('writerGateTitle').innerText = "Writer Section Unlocked";
    document.getElementById('writerGateSubtitle').innerText = "Access your tools, manage stories and serials.";
    document.getElementById('writerGateActionBtn').innerText = "Open Writer Dashboard";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      showDashboard('stories');
    };
  }
});



// land on home
document.addEventListener('DOMContentLoaded', showHomePage);
</script>

<script>

  document.getElementById('slidesPage').classList.remove('hidden');
};
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const wsBtn = document.getElementById("writerGateWorkspaceBtn");
  if(wsBtn){
    wsBtn.onclick = () => {
      alert("üöß Creation Workspace Coming Soon");
    };
  }
});
</script>


<!-- WORKSPACE LOADING SCREEN ‚Äî OCEAN MODE -->
<div id="workspaceLoadingScreen" class="hidden" style="
  position:fixed; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center; text-align:center;
  color:white; z-index:999999; background:#001e28; overflow:hidden;">

  <!-- Ocean Background Gradient -->
  <div id="oceanBg"></div>

  <!-- Underwater Pearl Planet -->
  <div id="planetWrap" style="position:relative; margin-top:-10px;">
    <div id="planet"></div>
  </div>

  <!-- Fact Text -->
  <div id="workspaceFactText" style="margin-top:35px; font-size:22px; opacity:0.9;">
    Loading Ocean...
  </div>

  <!-- Loading Bar -->
  <div style="margin-top:45px; width:300px; height:14px; background:#00404e; border-radius:7px; overflow:hidden;">
    <div id="workspaceLoadingBar" style="height:100%; width:0%; background:#3ffbff; box-shadow:0 0 15px #3ffbff; transition:width 0.35s linear;"></div>
  </div>
</div>

<style>
/* OCEAN BACKGROUND WAVES */
#oceanBg {
  position:absolute;
  inset:0;
  background: linear-gradient(#003340, #00141e);
  overflow:hidden;
}

#oceanBg::before,
#oceanBg::after {
  content:"";
  position:absolute;
  width:200%;
  height:200%;
  top:0; left:0;
  background: radial-gradient(circle at 50% 90%, rgba(0,150,200,0.3), transparent 70%);
  animation: waterDrift 14s infinite linear;
  opacity:0.45;
}

#oceanBg::after {
  animation-duration: 22s;
  opacity:0.25;
}

@keyframes waterDrift {
  from { transform:translate(-20%, -10%); }
  to   { transform:translate(20%, 10%); }
}

/* PEARL-LIKE GLOW PLANET */
#planet {
  width: 260px;
  height: 260px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffffff 0%, #b8faff 30%, #009bb0 60%, #003d46 100%);
  position: relative;
  animation: slowRotate 18s linear infinite;
  filter: drop-shadow(0 0 40px #4ffbff);
}

/* Soft shimmer waves across surface */
#planet::before {
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  background: repeating-linear-gradient(
    120deg,
    rgba(255,255,255,0.12) 0px,
    rgba(255,255,255,0.12) 4px,
    transparent 4px,
    transparent 22px
  );
  mix-blend-mode: screen;
  animation: shimmer 9s linear infinite;
  opacity:0.25;
}

@keyframes slowRotate {
  from { transform:rotate(0deg); }
  to { transform:rotate(360deg); }
}

@keyframes shimmer {
  from { transform:translateX(0); }
  to { transform:translateX(-260px); }
}
</style>



<!-- Added Firebase save for writerName and publishDate -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('startCreatingBtn');
  if (!btn) return;
  btn.addEventListener('click', function(){
    try {
      const title = document.getElementById('storyTitle')?.value?.trim() || '';
      if (!title) return;
      const desc = document.getElementById('storyDesc')?.value || '';
      const genre = document.getElementById('storyGenre')?.value || '';
      const writerName = document.getElementById('writerNameInput')?.value?.trim() || 'Unknown';
      const publishDate = document.getElementById('publishDateInput')?.value || new Date().toISOString().split('T')[0];
      const cover = window._currentStoryCover || '';
      const storyData = {
        title, description: desc, genre, cover,
        writerName, publishDate,
        updatedAt: new Date().toISOString()
      };
      if (window._firebase && window._firebase.set && window._firebase.db) {
        const key = encodeURIComponent(title);
        window._firebase.set(window._firebase.ref(window._firebase.db, 'stories/' + key), storyData)
          .then(()=>console.log('‚úÖ Story saved with writer info:', title))
          .catch(e=>console.error('‚ùå Save failed', e));
      } else {
        console.warn('Firebase helpers missing');
      }
    } catch(e){ console.error('Error saving writer info:', e); }
  });
});
</script>
<!-- End Firebase save patch -->


<!-- üìä Combined Analytics Feature -->
<script type="module">
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDZpUl6FzT7pRtb5QwlEZrjkE4gpjZxIY4",
  authDomain: "meurbal-d3c72.firebaseapp.com",
  databaseURL: "https://meurbal-d3c72-default-rtdb.firebaseio.com",
  projectId: "meurbal-d3c72",
  storageBucket: "meurbal-d3c72.firebasestorage.app",
  messagingSenderId: "707190126856",
  appId: "1:707190126856:web:128c972aef19934c81d4bd",
  measurementId: "G-4SBPDJHJDS"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ Increment read count when a story is opened
export async function incrementReadCount(storyTitle) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  data.reads++;
  await set(analyticsRef, data);
  console.log(`üìà Read count updated for ${storyTitle}`);
}

// ‚úÖ Increment like or comment counts
export async function incrementLikeOrComment(storyTitle, type) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  if (type === "like") data.likes++;
  if (type === "comment") data.comments++;
  await set(analyticsRef, data);
  console.log(`üíæ ${type} count updated for ${storyTitle}`);
}

// ‚úÖ Show analytics popup with chart
window.openAnalyticsModal = async function (storyTitle) {
  const modal = document.createElement('div');
  modal.className = 'story-analytics-modal';
  modal.innerHTML = `
    <div class="story-analytics-card">
      <div class="analytics-header">
        <div class="analytics-title">üìä Analytics ‚Äî ${storyTitle}</div>
        <button class="close-analytics">‚úñ</button>
      </div>
      <div class="analytics-body" id="analyticsBody">Loading...</div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector('.close-analytics').onclick = () => modal.remove();

  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snapshot = await get(analyticsRef);
  let data = snapshot.exists() ? snapshot.val() : { reads: 0, likes: 0, comments: 0 };

  modal.querySelector('#analyticsBody').innerHTML = `
    <div class="analytics-summary">
      <div class="summary-pill">üëÅÔ∏è Reads: ${data.reads}</div>
      <div class="summary-pill">üëç Likes: ${data.likes}</div>
      <div class="summary-pill">üí¨ Comments: ${data.comments}</div>
    </div>
    <canvas id="analyticsChart" height="120"></canvas>
  `;

  new Chart(document.getElementById('analyticsChart'), {
    type: 'bar',
    data: {
      labels: ['Reads', 'Likes', 'Comments'],
      datasets: [{
        label: 'Story Engagement',
        data: [data.reads, data.likes, data.comments],
        backgroundColor: ['#3b82f6','#22c55e','#f59e0b']
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// ‚úÖ Add Analytics button on story cards
function attachAnalyticsButtons() {
  document.querySelectorAll('.story-card').forEach(card => {
    const title = card.querySelector('h2')?.textContent?.trim();
    if (!title) return;
    if (card.querySelector('.analytics-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'btn btn-secondary analytics-btn';
    btn.textContent = 'üìä Analytics';
    btn.onclick = () => openAnalyticsModal(title);
    card.appendChild(btn);
  });
}
document.addEventListener('DOMContentLoaded', attachAnalyticsButtons);
</script>

</body>




<script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDZpUl6FzT7pRtb5QwlEZrjkE4gpjZxIY4",
  authDomain: "meurbal-d3c72.firebaseapp.com",
  databaseURL: "https://meurbal-d3c72-default-rtdb.firebaseio.com",
  projectId: "meurbal-d3c72",
  storageBucket: "meurbal-d3c72.firebasestorage.app",
  messagingSenderId: "707190126856",
  appId: "1:707190126856:web:128c972aef19934c81d4bd",
  measurementId: "G-4SBPDJHJDS"
};

// ---- Create status box ----
(function(){
  if(document.getElementById('firebaseStatusBox')) return;
  const box=document.createElement('div');
  box.id='firebaseStatusBox';
  box.style='position:fixed;bottom:10px;left:10px;right:10px;padding:8px 12px;background:#fff;color:#fff;font:13px/1.4 sans-serif;border-radius:10px;z-index:99999;display:none;justify-content:space-between;align-items:center';
  box.innerHTML=`<div id="fbStatusText">Connecting‚Ä¶</div>
  <div>
    <button id="fbLoadBtn" style="background:#111;color:#fff;border:none;padding:4px 10px;border-radius:8px;cursor:pointer">Load</button>
  </div>`;
  document.body.appendChild(box);
  document.getElementById('fbLoadBtn').onclick=()=>{ if(window.loadFromFirebase) loadFromFirebase(true); };
})();
function fbSetStatus(t){ const el=document.getElementById('fbStatusText'); if(el) el.textContent=t; }

function ensureFirebase(cb){
  if(window.firebase && window.firebase.database) return cb();
  const s1=document.createElement('script'); s1.src='https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
  s1.onload=()=>{ const s2=document.createElement('script'); s2.src='https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js'; s2.onload=cb; document.head.appendChild(s2); };
  document.head.appendChild(s1);
}

ensureFirebase(async ()=>{
  try{
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  }catch(e){ fbSetStatus('Firebase init error'); console.error(e); return; }
  const db=firebase.database();
  fbSetStatus('Connected');

  async function saveToFirebase(){
    try{
      fbSetStatus('Saving‚Ä¶');
      await db.ref('meurbal_v1/stories').set(window.storiesData||[]);
      await db.ref('meurbal_v1/serials').set(window.serialsData||[]);
      fbSetStatus('Saved ‚úì');
    }catch(e){ console.error(e); fbSetStatus('Save error'); }
  }

  async function loadFromFirebase(force){
    try{
      fbSetStatus('Loading‚Ä¶');
      const [stSnap,seSnap]=await Promise.all([
        db.ref('meurbal_v1/stories').once('value'),
        db.ref('meurbal_v1/serials').once('value')
      ]);
      const stories=stSnap.val()||[], serials=seSnap.val()||[];
      if(force || !(window.storiesData&&window.storiesData.length)){
        window.storiesData=stories;
      }
      if(force || !(window.serialsData&&window.serialsData.length)){
        window.serialsData=serials;
      }
      fbSetStatus('Loaded ‚úì');
      if(typeof renderBrowseStories==='function') renderBrowseStories('All');
      if(typeof renderBrowseSerials==='function')
  renderBrowseSerials(serials, { mergeWithSaved: false });

    }catch(e){ console.error(e); fbSetStatus('Load error'); }
  }
  window.loadFromFirebase=loadFromFirebase;

  // ---- Auto load when app ready ----
  const wait=setInterval(()=>{
    if(window.storiesData&&window.serialsData){
      clearInterval(wait);
      loadFromFirebase();
    }
  },700);

  // ---- Auto save triggers ----
  document.addEventListener('click',e=>{
    const id=e.target&&e.target.id;
    if(['publishStoryBtn','saveDraftBtn','serialCreateConfirmBtn','addEpConfirmBtn'].includes(id)){
      setTimeout(saveToFirebase,600);
    }
  });

  // periodic auto save
  setInterval(saveToFirebase,20000);
});
</script>
<!-- ===== END FIXED BLOCK ===== -->

<!-- ===== END: Firebase sync + bottom status box ===== -->


<script>
// --- Ensure browse buttons always show updated Firebase data ---
document.addEventListener("DOMContentLoaded", () => {
  const browseStoriesBtn = document.getElementById("browseStoriesBtn");
  const browseSerialsBtn = document.getElementById("browseSerialsBtn");

  if (browseStoriesBtn) {
    browseStoriesBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "stories"));
        if (snap.exists()) {
          window.storiesData = Object.values(snap.val());
        }
        renderStoriesList(window.storiesData || []);
      } catch (e) {
        console.warn("Failed to load stories for browse:", e);
        renderStoriesList(window.storiesData || []);
      }
    });
  }

  if (browseSerialsBtn) {
    browseSerialsBtn.addEventListener("click", async () => {
      try {
        const { db, ref, get, child } = window._firebase;
        const snap = await get(child(ref(db), "serials"));
        if (snap.exists()) {
          window.serialsData = Object.values(snap.val());
        }
        renderSerialsList(window.serialsData || []);
      } catch (e) {
        console.warn("Failed to load serials for browse:", e);
        renderSerialsList(window.serialsData || []);
      }
    });
  }
});
</script>


<!-- CLEAN SERIALS VIEW INJECTION: replaces broken browse serials behavior -->
<style>
  /* clean serials view styles (keeps existing theme) */
  #cleanSerialsPage { padding:20px; min-height:100vh; background:var(--bg); display:none; }
  #cleanSerialsHeader{display:flex;align-items:center;justify-content:space-between;max-width:980px;margin:0 auto 12px;gap:12px}
  #cleanSerialsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;max-width:980px;margin:12px auto;padding:12px}
  .clean-serial-card{background:#fff;border-radius:12px;padding:18px;box-shadow:var(--shadow);min-height:140px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;transition:transform .18s}
  .clean-serial-card:hover{transform:translateY(-6px)}
  .serial-meta{color:var(--muted);font-size:13px}
  #cleanSerialsTop{display:flex;gap:12px;align-items:center;width:100%;max-width:980px;margin:0 auto}
  #cleanSerialsCount{font-weight:700}
  #cleanSerialsSearch{flex:1;padding:10px;border:1px solid var(--border);border-radius:8px}
  #cleanSerialsBack{position:fixed;left:14px;bottom:14px}
</style>

<div id="cleanSerialsPage" aria-hidden="true">
  <div id="cleanSerialsHeader">
    <div>
      <h2 style="margin:0">Browse Serials</h2>
      <div class="muted" id="cleanSerialsCount">Loading...</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="cleanSerialsSearch" placeholder="Search serials..." />
      <button id="cleanSerialsRefreshBtn" class="btn btn-secondary">Refresh</button>
    </div>
  </div>

  <div id="cleanSerialsGrid" aria-live="polite" role="list"></div>
  <button class="back-btn" id="cleanSerialsBack">‚Üê Back</button>
</div>

<script>
(function(){
  // ensure helper functions exist globally for legacy callers
  window.renderSerialsList = function(serials){
    // maintain compatibility - forward to clean renderer if available
    if(window._renderCleanSerials) return window._renderCleanSerials(serials);
    const list = document.getElementById('serialsCards');
    if(!list) return;
    list.innerHTML = '';
    (serials||[]).forEach(s=>{
      const c=document.createElement('div');
      c.className='story-card';
      c.innerHTML=`<h2>${s.title}</h2><p>${s.genre||''}</p>`;
      list.appendChild(c);
    });
  };

  // internal render for clean view
  window._renderCleanSerials = function(serials){
    const grid = document.getElementById('cleanSerialsGrid');
    const count = document.getElementById('cleanSerialsCount');
    if(!grid) return;
    grid.innerHTML = '';
    serials = serials || [];
    count.textContent = `${serials.length} serial${serials.length===1?'':'s'} loaded`;
    serials.forEach(s=>{
      const card = document.createElement('div');
      card.className='clean-serial-card';
      const desc = s.description ? `<div class="muted" style="margin-top:6px">${s.description.slice(0,140)}</div>` : '';
      card.innerHTML = `<div><h4 style="margin:0">${s.title}</h4><div class="serial-meta">${s.genre||''}</div>${desc}</div><div style="display:flex;gap:8px;align-items:center"><button class="btn btn-primary btn-small">Open</button></div>`;
      card.addEventListener('click', ()=>{
        // open editor or reader if exists - try to find serial by title in window.serialsData
        const idx = (window.serialsData||[]).findIndex(x=> (x.title||'').trim() === (s.title||'').trim());
        if(idx>=0){
          // open the first episode if present using existing createEditorPage if available
          try{
            if(typeof createEditorPage === 'function'){
              const ser = window.serialsData[idx];
              const epIndex = ser.episodes && ser.episodes.length ? 0 : null;
              createEditorPage(epIndex!=null? ser.episodes[epIndex].title : ser.title, ser.genre, epIndex!=null? ser.episodes[epIndex].description : ser.description, { isEdit:true, editType:'serial', index: idx, episodeIndex: epIndex });
              return;
            }
          }catch(e){ console.warn('Open serial: editor open failed', e); }
        }
        alert('Open serial: editor not available in this context.');
      });
      grid.appendChild(card);
    });
  };

  // show/hide helpers
  function openCleanSerialsPage(){
    // hide other main pages (same logic as your app)
    const pages = ['welcomePage','categoriesPage','serialCategoriesPage','dashboardPage','slidesPage','storyFormPage','profileFormPage'];
    pages.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.classList.add('hidden');
    });
    // show our clean view
    const clean = document.getElementById('cleanSerialsPage');
    if(clean){ clean.classList.remove('hidden'); clean.setAttribute('aria-hidden','false'); }
    // attempt to render cached data immediately
    if(window.serialsData && window.serialsData.length){
      window._renderCleanSerials(window.serialsData);
      console.log(`‚ÑπÔ∏è Showing ${window.serialsData.length} cached serials from localStorage`);
    }
  }

  function closeCleanSerialsPage(){
    const clean = document.getElementById('cleanSerialsPage');
    if(clean){ clean.classList.add('hidden'); clean.setAttribute('aria-hidden','true'); }
    // show welcome page as fallback
    const welcome = document.getElementById('welcomePage');
    if(welcome) welcome.classList.remove('hidden');
  }

  // wire up buttons (override old handlers safely)
  const browseBtn = document.getElementById('browseSerialsBtn');
  if(browseBtn){
    browseBtn.removeEventListener && browseBtn.removeEventListener('click', ()=>{});
    browseBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      openCleanSerialsPage();
    });
  }
  const backBtn = document.getElementById('cleanSerialsBack');
  if(backBtn) backBtn.addEventListener('click', ()=>{ closeCleanSerialsPage(); });

  const refreshBtn = document.getElementById('cleanSerialsRefreshBtn');
  if(refreshBtn) refreshBtn.addEventListener('click', ()=>{ fetchAndRenderSerials(true); });

  // search filtering
  const searchInput = document.getElementById('cleanSerialsSearch');
  if(searchInput) searchInput.addEventListener('input', (e)=>{
    const q = (e.target.value||'').toLowerCase().trim();
    const filtered = (window.serialsData||[]).filter(s=>{
      return (s.title||'').toLowerCase().includes(q) || (s.genre||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q);
    });
    window._renderCleanSerials(filtered);
  });

  // Firebase real-time listener & initial fetch
  async function fetchAndRenderSerials(forceReload) {
    try {
      // Use Firebase SDK directly (no window._firebase dependency)
      import("https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js").then(({ getDatabase, ref, onValue }) => {
        const db = getDatabase();
        // attach live listener
        if (window._cleanSerialsListenerAttached && !forceReload) return;
        window._cleanSerialsListenerAttached = true;

        onValue(ref(db, 'serials'), snap => {
          if (snap.exists()) {
            const obj = snap.val();
            window.serialsData = Object.values(obj);
            try { localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); } catch (e) {}
            window._renderCleanSerials(window.serialsData);
            console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
          } else {
            window.serialsData = [];
            try { localStorage.setItem('serialsData', JSON.stringify([])); } catch (e) {}
            window._renderCleanSerials([]);
            console.log('‚ö†Ô∏è No serials found in Firebase');
          }
        });
      }).catch(err => console.error('Firebase import failed:', err));
    } catch (err) {
      console.error('Failed to load serials for browse:', err);
    }
    
      // attach live listener (debounce multiple attachments)
      if(window._cleanSerialsListenerAttached && !forceReload) return;
      window._cleanSerialsListenerAttached = true;

      onValue(ref(db, 'serials'), snap => {
        if(snap.exists()){
          const obj = snap.val();
          window.serialsData = Object.values(obj);
          try{ localStorage.setItem('serialsData', JSON.stringify(window.serialsData)); }catch(e){}
          window._renderCleanSerials(window.serialsData);
          console.log(`‚úÖ Loaded ${window.serialsData.length} serials from Firebase`);
        } else {
          window.serialsData = [];
          try{ localStorage.setItem('serialsData', JSON.stringify([])); }catch(e){}
          window._renderCleanSerials([]);
          console.log('‚ö†Ô∏è No serials found in Firebase');
        }
      });
    }catch(err){
      console.error('Failed to load serials for browse:', err);
    }
  }

  // attempt to initialize listener on DOMContentLoaded (or immediately if already)
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    fetchAndRenderSerials(false);
  } else {
    document.addEventListener('DOMContentLoaded', ()=> fetchAndRenderSerials(false));
  }

  // show cached data on load (fallback)
  try{
    const cached = JSON.parse(localStorage.getItem('serialsData') || 'null');
    if(cached && Array.isArray(cached) && cached.length){
      window.serialsData = cached;
      console.log('‚ÑπÔ∏è Loaded serials from localStorage cache:', window.serialsData.length);
    }
  }catch(e){}

})();
</script>
<!-- END INJECTION -->


<!-- Global fullscreen preview containers (moved outside hidden pages) -->
<div id="previewFull" class="hidden"></div>
<div id="readerFull" class="hidden"></div>

<!-- PATCH: base64 cover upload handlers + save function overrides -->
<script>
(function(){
  // create globals to hold base64 covers
  window._currentStoryCover = window._currentStoryCover || null;
  window._currentSerialCover = window._currentSerialCover || null;

  // helper to wire an input id to a preview img id and store base64
  function wireCoverInput(inputId, previewId, targetVarName) {
    const input = document.getElementById(inputId);
    if (!input) return;
    input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!['image/jpeg','image/png'].includes(file.type)) {
        alert('Only JPG or PNG allowed for cover images.');
        e.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        window[targetVarName] = ev.target.result;
        const preview = document.getElementById(previewId);
        if (preview) preview.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  wireCoverInput('storyCoverInput', 'storyCoverPreview', '_currentStoryCover');
  wireCoverInput('serialCoverInput', 'serialCoverPreview', '_currentSerialCover');

  // Override save functions to include base64 cover when present
  // Note: these will replace existing definitions in the page
window.saveSerialToFirebase = async function(ser) {
  try {
    if (window._currentSerialCover) ser.cover = window._currentSerialCover;

    if (!window._firebase || !window._firebase.db) {
      console.error('Firebase not ready for saveSerialToFirebase');
      return;
    }

    const key = encodeURIComponent(ser.title.trim());

    await window._firebase.set(
      window._firebase.ref(window._firebase.db, `serials/${key}`),
      ser
    );

    console.log(`‚úÖ Serial "${ser.title}" saved (with cover if provided).`);
  } catch (err) {
    console.error('‚ùå Error saving serial (patched):', err);
  }
};

  window.saveStoryToFirebase = async function(story) {
    try {
      if (window._currentStoryCover) story.cover = window._currentStoryCover;
      if (!window._firebase || !window._firebase.db) {
        console.error('Firebase not ready for saveStoryToFirebase');
        return;
      }
      // attempt to write under stories/{title} if that is the app convention
      await window._firebase.set(window._firebase.ref(window._firebase.db, `stories/${story.title}`), story);
      console.log(`‚úÖ Story "${story.title}" saved (with cover if provided).`);
    } catch (err) {
      console.error('‚ùå Error saving story (patched):', err);
    }
  };

  // If the app uses different save function names, we also patch a generic save call helper if it exists
  // For example, if there's a function called uploadStory or createSerial, the developer can call saveSerialToFirebase explicitly.
})();








<script>
function showHomePage(){
  const welcomePage = document.getElementById('welcomePage');
  const dashboardPage = document.getElementById('dashboardPage');
  const profileFormPage = document.getElementById('profileFormPage');
  const slidesPage = document.getElementById('slidesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const serialCategoriesPage = document.getElementById('serialCategoriesPage');
  const writerGatePage = document.getElementById('writerGatePage'); // ‚úÖ add this line

  if(welcomePage) welcomePage.classList.remove('hidden');
  if(dashboardPage) dashboardPage.classList.add('hidden');
  if(profileFormPage) profileFormPage.classList.add('hidden');
  if(slidesPage) slidesPage.classList.add('hidden');
  if(categoriesPage) categoriesPage.classList.add('hidden');
  if(serialCategoriesPage) serialCategoriesPage.classList.add('hidden');
  if(writerGatePage) writerGatePage.classList.add('hidden'); // ‚úÖ hide writer gate
}


document.getElementById('homeBtn').addEventListener('click', ()=>{ showHomePage(); });



document.getElementById('writerBtn').addEventListener('click', () => {
  const profile = localStorage.getItem("writerProfile_v1");
  const writerGate = document.getElementById('writerGatePage');
  const welcome = document.getElementById('welcomePage');
  const dashboard = document.getElementById('dashboardPage');
  const categories = document.getElementById('categoriesPage');
  const serialCategories = document.getElementById('serialCategoriesPage');
  const profileForm = document.getElementById('profileFormPage');

  if(welcome) welcome.classList.add('hidden');
  if(dashboard) dashboard.classList.add('hidden');
  if(categories) categories.classList.add('hidden');
  if(serialCategories) serialCategories.classList.add('hidden');
  if(profileForm) profileForm.classList.add('hidden');

  writerGate.classList.remove('hidden');

  if (!profile) {
    document.getElementById('writerGateTitle').innerText = "No Writer Profile Yet";
    document.getElementById('writerGateSubtitle').innerText = "To unlock the Writer Section, please create your writer profile.";
    document.getElementById('writerGateActionBtn').innerText = "Create Profile";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      profileForm.classList.remove('hidden');
    };
  } else {
    document.getElementById('writerGateTitle').innerText = "Writer Section Unlocked";
    document.getElementById('writerGateSubtitle').innerText = "Access your tools, manage stories and serials.";
    document.getElementById('writerGateActionBtn').innerText = "Open Writer Dashboard";
    document.getElementById('writerGateActionBtn').onclick = () => {
      writerGate.classList.add('hidden');
      showDashboard('stories');
    };
  }
});



// land on home
document.addEventListener('DOMContentLoaded', showHomePage);
</script>

<script>

  document.getElementById('slidesPage').classList.remove('hidden');
};
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const wsBtn = document.getElementById("writerGateWorkspaceBtn");

  if(wsBtn){
    const facts = [
      "You can save your writing progress instantly!",
      "Your serial episodes auto-sync locally.",
      "Editing is unlimited, create freely!",
      "Your workspace never loses your content.",
      "Publishing is just one click away."
    ];

    wsBtn.onclick = () => {
      const screen = document.getElementById("workspaceLoadingScreen");
      const bar = document.getElementById("workspaceLoadingBar");
      const factText = document.getElementById("workspaceFactText");

      screen.classList.remove("hidden");
      bar.style.width = "0%";

      let i = 0;
      const showFacts = setInterval(() => {
        factText.textContent = facts[i % facts.length];
        i++;
      }, 900);

      let progress = 0;
      const loader = setInterval(() => {
        progress += 3;
        bar.style.width = progress + "%";
      }, 100);

      setTimeout(() => {
        clearInterval(loader);
        clearInterval(showFacts);
        bar.style.width = "100%";
        screen.classList.add("hidden");
        document.getElementById('writerGatePage').classList.add('hidden');
        showWorkspaceWYSIWYG(); // ‚úÖ Open workspace
      }, 3500);
    };
  }
});
// ========== Realistic local AI Assistant (voice typing) ==========
function smartFormat(text) {
  if (!text) return '';
  let t = text.trim();
  t = t.replace(/([.,!?])([^\s])/g, '$1 $2'); // fix spacing
  t = t.replace(/(^\s*[a-z])|([.!?]\s*[a-z])/g, s => s.toUpperCase());
  t = t.replace(/\bi\b/g, 'I');
  t = t.replace(/\s+(and|but|because|so|then|when|however)\s+/gi, ', $1 ');
  const parts = t.split(/(?<=[.?!])\s+/);
  let merged = '', buf = '', count = 0;
  for (const p of parts) {
    const words = p.split(' ').length;
    count += words;
    buf += (buf ? ' ' : '') + p;
    if (count > 40) { merged += buf.trim() + '\n\n'; buf = ''; count = 0; }
  }
  if (buf.trim()) merged += buf.trim();
  return merged.trim();
}

// --- Session Name from Text ---
function generateSessionNameFromText(text){
  const words = text.match(/\b\w{3,10}\b/g) || [];
  if(words.length===0) return randomName();
  const chosen = [];
  while(chosen.length < 2 && words.length > 0){
    const idx = Math.floor(Math.random() * words.length);
    chosen.push(words.splice(idx,1)[0]);
  }
  return chosen.map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
}

// --- Random Name Fallback ---
function randomName() {
  const A = ['Velvet','Amber','Crimson','Nova','Echo','Sable','Orion'];
  const B = ['Draft','Note','Story','Tale','Saga'];
  return `${A[Math.floor(Math.random()*A.length)]} ${B[Math.floor(Math.random()*B.length)]}`;
}

// --- Safe Textarea ---
function safeTextarea() {
  return document.querySelector('#sheetTextarea') || window.sheetTextarea || document.querySelector('textarea');
}

// --- Save / Load Sessions ---
function saveSession(text) {
  const s = JSON.parse(localStorage.getItem('voiceSessions')||'[]');
  const name = generateSessionNameFromText(text);
  s.unshift({id:Date.now(), name, text, time:new Date().toLocaleString()});
  localStorage.setItem('voiceSessions', JSON.stringify(s));
}
function loadSessions() {
  return JSON.parse(localStorage.getItem('voiceSessions')||'[]');
}

// --- Sidebar ---
function openVoiceChatSidebar() {
  if (document.getElementById('voiceChatSidebar')) return;

  // Detect device: Mobile = 400px, Desktop = 500px
  const isMobile = window.innerWidth <= 768;
  const sidebarWidth = isMobile ? 250 : 520;

  const bar = document.createElement('div');
  bar.id = 'voiceChatSidebar';

bar.style.cssText = `
  position: fixed; 
  top: 0; 
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(20, 20, 30, 0.97);
  backdrop-filter: blur(20px);
  color: #fff; 
  font-family: 'Poppins','Inter',sans-serif;
  display: flex; 
  flex-direction: column;
  transform: translateY(100%);
  transition: transform .35s ease;
  z-index: 9999;
  box-shadow: inset 0 0 40px rgba(0,0,0,0.4);
  overflow: hidden;
`;


  bar.innerHTML = `
    <div style="
      position: sticky; top: 0; display: grid; grid-template-columns: 1fr auto 1fr;
      align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1);
      background: rgba(20,20,30,0.9); z-index: 5; padding: 10px 16px;
    ">
      <span style="font-weight:600;opacity:0.85;">‚úçÔ∏è Meurbal Writer</span>
      <button id="copyBtn" title="Copy text" style="
        justify-self: center;background: #2563eb;border: none;color: #fff;font-size: 14px;
        font-weight: 600;border-radius: 8px;padding: 6px 12px;cursor: pointer;
        box-shadow: 0 0 10px rgba(37,99,235,0.6); transition: transform 0.2s ease, background 0.2s ease;
      ">üìã Copy</button>
      <div style="justify-self: end; display:flex; align-items:center; gap:6px;">
        <button id="sessionsBtn" style="background:#6b7280;border:none;border-radius:8px;color:#fff;padding:6px 10px;cursor:pointer;">Sessions</button>
        <button id="closeVoiceChatBtn" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">‚úï</button>
      </div>
    </div>
    <div id="voiceChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;">
      <div id="placeholderMsg" style="opacity:0.7;">
        üéôÔ∏è Speak and I‚Äôll bring your imagination to life through words.
      </div>
    </div>
  `;

  document.body.appendChild(bar);

  setTimeout(() => bar.style.transform = 'translateX(0)', 30);

  document.getElementById('closeVoiceChatBtn').onclick = () => {
    bar.style.transform = 'translateX(100%)';
    setTimeout(() => bar.remove(), 300);
  };

  document.getElementById('sessionsBtn').onclick = showSessionList;

  document.getElementById('copyBtn').onclick = async () => {
    const text = document.getElementById('liveVoiceBubble')?.textContent || '';
    if (!text) return alert('Nothing to copy!');
    await navigator.clipboard.writeText(text);
    const ta = safeTextarea();
    if (ta) { ta.value = text; ta.dispatchEvent(new Event('input', { bubbles: true })); }
    alert('‚úÖ Copied!');
  };
}

// --- Chat Message ---
function addVoiceMessage(t){
  const chat = document.getElementById('voiceChatMessages'); if(!chat) return;
  document.getElementById('placeholderMsg')?.remove();
  let msg = document.getElementById('liveVoiceBubble');
  if(!msg){
    msg = document.createElement('div');
    msg.id = 'liveVoiceBubble';
    msg.style.cssText = `
      background:rgba(0,255,180,0.25);padding:12px 16px;border-radius:14px;
      align-self:flex-end;max-width:90%;line-height:1.7;font-size:16px;
      box-shadow:0 4px 14px rgba(0,0,0,0.15);white-space:pre-wrap;word-break:break-word;
    `;
    chat.appendChild(msg);
  }
  msg.textContent = t;
  chat.scrollTop = chat.scrollHeight;
}

// --- Sessions ---
function showSessionList(){
  const old = loadSessions();
  const m = document.createElement('div');
  m.style.cssText = `
    position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;
    display:flex;align-items:center;justify-content:center;
  `;
  m.innerHTML = `
    <div style="width:600px;max-height:80vh;overflow:auto;background:#111827;color:#fff;padding:20px;border-radius:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;">üìú Previous Sessions</h3>
        <button id="closeSessions" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;">‚úï</button>
      </div>
      <div id="sessionList" style="margin-top:16px;display:flex;flex-direction:column;gap:10px;"></div>
    </div>
  `;
  document.body.appendChild(m);
  document.getElementById('closeSessions').onclick = () => m.remove();
  const list = m.querySelector('#sessionList');
  if(!old.length) return list.innerHTML = '<div>No sessions yet.</div>';
  for(const s of old){
    const item = document.createElement('div');
    item.style.cssText='padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;';
    item.innerHTML = `
      <b>${s.name}</b> <small style="opacity:0.7;">(${s.time})</small><br>
      <div style="white-space:pre-wrap;opacity:0.9;margin-top:4px;">${s.text.slice(0,200)}${s.text.length>200?'...':''}</div>
      <div style="margin-top:6px;">
        <button class="loadBtn" data-text="${encodeURIComponent(s.text)}" style="background:#2563eb;border:none;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer;">Load & Continue</button>
      </div>
    `;
    list.appendChild(item);
  }
  list.addEventListener('click', e => {
    const b = e.target.closest('.loadBtn'); if(!b) return;
    const txt = decodeURIComponent(b.dataset.text);
    m.remove();
    openVoiceChatSidebar();
    addVoiceMessage(txt);
    openVoiceAssistant(txt);
  });
}

// --- Language Chooser ---
function chooseLanguage(){
  return new Promise(res=>{
    const m = document.createElement('div');
    m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1600;display:flex;align-items:center;justify-content:center;';
    m.innerHTML = `
      <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(14px);
        border-radius:16px;padding:36px;text-align:center;color:#fff;font-family:'Poppins',sans-serif;
        box-shadow:0 8px 30px rgba(0,0,0,0.4);">
        <h2 style="font-weight:600;margin:0 0 10px;">üåê Choose Your Language</h2>
        <p style="opacity:.85;margin-bottom:20px;">Select one for this session.</p>
        <div style="display:flex;gap:24px;justify-content:center;">
          <button id="chooseEN" style="background:#2563eb;border:none;color:#fff;border-radius:10px;padding:12px 26px;font-weight:600;font-size:16px;cursor:pointer;transition:.2s;">English</button>
          <button id="chooseHI" style="background:#fbbf24;border:none;color:#111;border-radius:10px;padding:12px 26px;font-weight:600;font-size:16px;cursor:pointer;transition:.2s;">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
        </div>
      </div>
    `;
    document.body.appendChild(m);
    m.querySelector('#chooseEN').onclick = ()=>{ m.remove(); res('en-IN'); };
    m.querySelector('#chooseHI').onclick = ()=>{ m.remove(); res('hi-IN'); };
  });
}

// --- Voice Assistant ---
async function openVoiceAssistant(prevText=''){
  const lang = await chooseLanguage();
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return alert('Speech Recognition not supported!');
  const rec = new SpeechRecognition();
  rec.continuous = true;
  rec.interimResults = true;
  rec.lang = lang;

  let full = prevText, isPaused = false, bufferTimeout;
  openVoiceChatSidebar();
  if(prevText) addVoiceMessage(prevText);

 const pop = document.createElement('div');
pop.style.cssText = `
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
background:rgba(0,0,0,0.45);
backdrop-filter:none;

  z-index:9999; /* higher than sidebar */

  font-family:Poppins,sans-serif;
`;
pop.innerHTML = `
  <div style="position:relative;background:rgba(255,255,255,0.25);backdrop-filter:blur(14px);border-radius:16px;padding:28px 32px;text-align:center;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.25);min-width:360px;">
    <button id="closePopupBtn" style="position:absolute;top:10px;right:12px;background:rgba(255,255,255,0.15);border:none;color:#fff;font-size:18px;font-weight:bold;border-radius:8px;width:28px;height:28px;cursor:pointer;line-height:1;">√ó</button>
    <h2 style="margin-top:0">üéôÔ∏è Meurbal Assistant</h2>
    <p>${lang==='hi-IN'
      ? '‡§¨‡•ã‡§≤‡§ø‡§è ‚Äî ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡§≤‡•ç‡§™‡§®‡§æ ‡§ï‡•ã ‡§∂‡§¨‡•ç‡§¶‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¢‡§æ‡§≤ ‡§¶‡•Ç‡§Ç‡§ó‡§æ‡•§'
      : 'Speak naturally ‚Äî I‚Äôll write beautifully as you talk.'
    }</p>
    <div style="margin:18px 0;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button id="startBtn" style="background:#22c55e;color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;">Start</button>
      <button id="pauseBtn" style="background:#facc15;color:#000;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;display:none;">Pause</button>
      <button id="finishBtn" style="background:#ef4444;color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;display:none;">Finish</button>
      <button id="copyPopupBtn" style="background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;display:none;">üìã Copy</button>
      <button id="prevBtn" style="background:#6b7280;color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;">Previous</button>
    </div>
    <p id="status" style="opacity:.9;">Click <b>Start</b> and speak clearly‚Ä¶</p>
  </div>
`;

// Append popup
document.body.appendChild(pop);

// Add close button event
document.getElementById('closePopupBtn').addEventListener('click', () => {
  pop.remove();
});

  const liveBubble = () => document.getElementById('liveVoiceBubble');

  const addEditButton = () => {
    if(pop.querySelector('#editBtn')) return;
    const editBtn = document.createElement('button');
    editBtn.id='editBtn';
    editBtn.textContent='‚úèÔ∏è Edit';
    editBtn.style.cssText='background:#fbbf24;color:#111;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;margin-left:10px;';
    pop.querySelector('#status').after(editBtn);

    editBtn.onclick = ()=>{
      rec.stop(); isPaused=true;
      const msg = liveBubble();
      if(!msg) return alert('Nothing to edit yet!');
      const ta = document.createElement('textarea');
      ta.value = msg.textContent;
      ta.style.cssText='width:100%;height:120px;margin-top:6px;border-radius:10px;padding:8px;';
      msg.replaceWith(ta);
      const saveBtn = document.createElement('button');
      saveBtn.textContent='‚úÖ Save & Resume';
      saveBtn.style.cssText='margin-top:6px;padding:6px 12px;border:none;border-radius:8px;background:#22c55e;color:#fff;cursor:pointer;';
      ta.after(saveBtn);
      saveBtn.onclick=()=>{
        const newText = ta.value;
        const div = document.createElement('div');
        div.id='liveVoiceBubble';
        div.style.cssText = msg.style.cssText;
        div.textContent = newText;
        ta.replaceWith(div);
        saveBtn.remove();
        full=newText; isPaused=false;
        rec.start();
      };
    };
  };

  rec.onresult = e=>{
    let interim=''; for(let i=e.resultIndex;i<e.results.length;i++){
      const txt = e.results[i][0].transcript;
      e.results[i].isFinal?full+=' '+txt:interim+=txt;
    }
    const out = lang==='hi-IN'? (full+' '+interim).trim() : smartFormat((full+' '+interim).trim());
    clearTimeout(bufferTimeout);
    bufferTimeout = setTimeout(()=>{
      if(!liveBubble()) addVoiceMessage(out);
      else liveBubble().textContent=out;
    },100);
  };

  pop.querySelector('#startBtn').onclick=()=>{
    rec.start();
    pop.querySelector('#pauseBtn').style.display='inline-block';
    pop.querySelector('#finishBtn').style.display='inline-block';
    pop.querySelector('#copyPopupBtn').style.display='inline-block';
    addEditButton();
    pop.querySelector('#startBtn').style.display='none';
  };

  pop.querySelector('#pauseBtn').onclick=()=>{
    if(!isPaused){ rec.stop(); isPaused=true;
      pop.querySelector('#pauseBtn').textContent='Resume';
      pop.querySelector('#status').textContent='‚è∏Ô∏è Paused & Saved.'; saveSession(full);
    } else { rec.start(); isPaused=false;
      pop.querySelector('#pauseBtn').textContent='Pause';
      pop.querySelector('#status').textContent='üé§ Resumed‚Ä¶';
    }
  };

  pop.querySelector('#finishBtn').onclick=()=>{
    rec.stop(); saveSession(full);
    pop.querySelector('#status').textContent='‚úÖ Saved!';
    setTimeout(()=>{pop.remove(); document.getElementById('voiceChatSidebar')?.remove();},800);
  };

  pop.querySelector('#copyPopupBtn').onclick=async()=>{
    const text=liveBubble()?.textContent||'';
    if(!text)return alert('Nothing to copy!');
    await navigator.clipboard.writeText(text); alert('‚úÖ Text copied!');
  };

  pop.querySelector('#prevBtn').onclick=showSessionList;

  pop.addEventListener('click',e=>{if(e.target===pop){rec.stop(); pop.remove(); document.getElementById('voiceChatSidebar')?.remove();}});
}

// --- Hook ---
aiAssistantBtn.addEventListener('click',()=>{
  toggleAIPopup(false);
  openVoiceChatSidebar();
  openVoiceAssistant();
});
</script>


<!-- WORKSPACE LOADING SCREEN ‚Äî OCEAN MODE -->
<div id="workspaceLoadingScreen" class="hidden" style="
  position:fixed; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center; text-align:center;
  color:white; z-index:999999; background:#001e28; overflow:hidden;">

  <!-- Ocean Background Gradient -->
  <div id="oceanBg"></div>

  <!-- Underwater Pearl Planet -->
  <div id="planetWrap" style="position:relative; margin-top:-10px;">
    <div id="planet"></div>
  </div>

  <!-- Fact Text -->
  <div id="workspaceFactText" style="margin-top:35px; font-size:22px; opacity:0.9;">
    Loading Ocean...
  </div>

  <!-- Loading Bar -->
  <div style="margin-top:45px; width:300px; height:14px; background:#00404e; border-radius:7px; overflow:hidden;">
    <div id="workspaceLoadingBar" style="height:100%; width:0%; background:#3ffbff; box-shadow:0 0 15px #3ffbff; transition:width 0.35s linear;"></div>
  </div>
</div>

<style>
/* OCEAN BACKGROUND WAVES */
#oceanBg {
  position:absolute;
  inset:0;
  background: linear-gradient(#003340, #00141e);
  overflow:hidden;
}

#oceanBg::before,
#oceanBg::after {
  content:"";
  position:absolute;
  width:200%;
  height:200%;
  top:0; left:0;
  background: radial-gradient(circle at 50% 90%, rgba(0,150,200,0.3), transparent 70%);
  animation: waterDrift 14s infinite linear;
  opacity:0.45;
}

#oceanBg::after {
  animation-duration: 22s;
  opacity:0.25;
}

@keyframes waterDrift {
  from { transform:translate(-20%, -10%); }
  to   { transform:translate(20%, 10%); }
}

/* PEARL-LIKE GLOW PLANET */
#planet {
  width: 260px;
  height: 260px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffffff 0%, #b8faff 30%, #009bb0 60%, #003d46 100%);
  position: relative;
  animation: slowRotate 18s linear infinite;
  filter: drop-shadow(0 0 40px #4ffbff);
}

/* Soft shimmer waves across surface */
#planet::before {
  content:"";
  position:absolute;
  inset:0;
  border-radius:50%;
  background: repeating-linear-gradient(
    120deg,
    rgba(255,255,255,0.12) 0px,
    rgba(255,255,255,0.12) 4px,
    transparent 4px,
    transparent 22px
  );
  mix-blend-mode: screen;
  animation: shimmer 9s linear infinite;
  opacity:0.25;
}

@keyframes slowRotate {
  from { transform:rotate(0deg); }
  to { transform:rotate(360deg); }
}

@keyframes shimmer {
  from { transform:translateX(0); }
  to { transform:translateX(-260px); }
}
</style>


<!-- Added Firebase save for writerName and publishDate -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('startCreatingBtn');
  if (!btn) return;
  btn.addEventListener('click', function(){
    try {
      const title = document.getElementById('storyTitle')?.value?.trim() || '';
      if (!title) return;
      const desc = document.getElementById('storyDesc')?.value || '';
      const genre = document.getElementById('storyGenre')?.value || '';
      const writerName = document.getElementById('writerNameInput')?.value?.trim() || 'Unknown';
      const publishDate = document.getElementById('publishDateInput')?.value || new Date().toISOString().split('T')[0];
      const cover = window._currentStoryCover || '';
      const storyData = {
        title, description: desc, genre, cover,
        writerName, publishDate,
        updatedAt: new Date().toISOString()
      };
      if (window._firebase && window._firebase.set && window._firebase.db) {
        const key = encodeURIComponent(title);
        window._firebase.set(window._firebase.ref(window._firebase.db, 'stories/' + key), storyData)
          .then(()=>console.log('‚úÖ Story saved with writer info:', title))
          .catch(e=>console.error('‚ùå Save failed', e));
      } else {
        console.warn('Firebase helpers missing');
      }
    } catch(e){ console.error('Error saving writer info:', e); }
  });
});
</script>
<!-- End Firebase save patch -->


<!-- üìä Combined Analytics Feature -->
<script type="module">
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDZpUl6FzT7pRtb5QwlEZrjkE4gpjZxIY4",
  authDomain: "meurbal-d3c72.firebaseapp.com",
  databaseURL: "https://meurbal-d3c72-default-rtdb.firebaseio.com",
  projectId: "meurbal-d3c72",
  storageBucket: "meurbal-d3c72.firebasestorage.app",
  messagingSenderId: "707190126856",
  appId: "1:707190126856:web:128c972aef19934c81d4bd",
  measurementId: "G-4SBPDJHJDS"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ Increment read count when a story is opened
export async function incrementReadCount(storyTitle) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  data.reads++;
  await set(analyticsRef, data);
  console.log(`üìà Read count updated for ${storyTitle}`);
}

// ‚úÖ Increment like or comment counts
export async function incrementLikeOrComment(storyTitle, type) {
  const analyticsRef = ref(db, `meurbal_v1/stories/${storyTitle}/analytics`);
  const snap = await get(analyticsRef);
  let data = snap.exists() ? snap.val() : { reads: 0, likes: 0, comments: 0 };
  if (type === "like") data.likes++;
  if (type === "comment") data.comments++;
  await set(analyticsRef, data);
  console.log(`üíæ ${type} count updated for ${storyTitle}`);
}

// ‚úÖ Show analytics popup with chart
window.openAnalyticsModal = async function (storyTitle) {
  // Remove existing modal if open
  const existing = document.getElementById('storyAnalyticsFull');
  if (existing) existing.remove();

  // üîπ Create full-screen container
  const modal = document.createElement('div');
  modal.id = 'storyAnalyticsFull';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #f8fafc, #e0e7ff);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow-y: auto;
    padding: 40px 20px;
    font-family: 'Segoe UI', sans-serif;
    z-index: 9999;
  `;

  // üîπ Header
const header = document.createElement('div');
header.style.position = 'relative';
header.style.display = 'flex';
header.style.alignItems = 'center';
header.style.justifyContent = 'space-between';
header.style.marginBottom = '12px';

header.innerHTML = `
  <h2 style="
    font-size:24px;
    font-weight:700;
    color:#111;
    margin:0;
  ">üìä Story Analytics ‚Äî ${storyTitle}</h2>
  <button id="closeStoryAnalytics" style="
    position:absolute;
    top:-10px;
    right:-10px;
    background:#ef4444;
    color:#fff;
    border:none;
    padding:8px 16px;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
  ">‚úñ Close</button>
`;
  modal.appendChild(header);

  // üîπ Placeholder while fetching
  const body = document.createElement('div');
  body.id = 'analyticsBody';
  body.textContent = 'Loading...';
  body.style.cssText = `
    margin-top:30px;
    width:100%;
    max-width:900px;
    text-align:center;
    font-size:16px;
    color:#555;
  `;
  modal.appendChild(body);
  document.body.appendChild(modal);

  document.getElementById('closeStoryAnalytics').onclick = () => modal.remove();

  // --- üîç Fetch Data ---
// --- üîç Fetch Data ---
const db = window._firebase?.db;
let data = { reads: 0, likes: 0, comments: 0 };

try {
  const { ref, get } = window._firebase;

  const analyticsRef = ref(db, `stories/${encodeURIComponent(storyTitle)}/analytics`);
  const storyRef = ref(db, `stories/${encodeURIComponent(storyTitle)}`);

  const [snapA, snapS] = await Promise.all([get(analyticsRef), get(storyRef)]);

  if (snapA.exists()) {
    data = snapA.val();
  } else if (snapS.exists()) {
    const val = snapS.val();
    data.reads = val.reads || 0;
    data.likes = val.likes || 0;
    data.comments =
      val.commentsCount || (val.comments ? Object.keys(val.comments).length : 0);
  }
} catch (e) {
  console.warn("‚ö†Ô∏è Error loading story analytics:", e);
}


  // üîπ Determine status based on reads
  let statusText = "üïí On Going";
  if (data.reads >= 200) statusText = "üî• Popular";
  else if (data.reads >= 100) statusText = "‚≠ê Trending";
  else if (data.reads >= 50) statusText = "üí™ Doing Well";
  else statusText = "üïí On Going";

 body.innerHTML = `
  <div style="
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:16px;
    margin-top:10px;
    width:100%;
    max-width:900px;
    margin-inline:auto;
  ">

    <div style="
      background:white;padding:25px;border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);border-top:5px solid #8b5cf6;text-align:center;
    ">
      <div style="font-size:30px;">üìà</div>
      <div style="font-weight:600;">Status</div>
      <div style="font-size:22px;font-weight:700;margin-top:4px;">${statusText}</div>
    </div>

    <div style="
      background:white;padding:25px;border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);border-top:5px solid #3b82f6;text-align:center;
    ">
      <div style="font-size:30px;">üëÅÔ∏è</div>
      <div style="font-weight:600;">Reads</div>
      <div style="font-size:22px;font-weight:700;margin-top:4px;">${data.reads}</div>
    </div>

    <div style="
      background:white;padding:25px;border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);border-top:5px solid #f59e0b;text-align:center;
    ">
      <div style="font-size:30px;">üëç</div>
      <div style="font-weight:600;">Likes</div>
      <div style="font-size:22px;font-weight:700;margin-top:4px;">${data.likes}</div>
    </div>

  </div>

  <div style="margin-top:40px;background:white;padding:25px;border-radius:16px;
    box-shadow:0 8px 22px rgba(0,0,0,0.1);max-width:800px;margin-inline:auto;">
    <h3 style="font-size:18px;font-weight:700;color:#111;margin-bottom:15px;">üìâ Engagement Overview</h3>
    <canvas id="analyticsChart" style="height:180px; max-height:200px; width:100%;"></canvas>
  </div>
`;

  // üîπ Render chart
  const ctx = document.getElementById('analyticsChart');
  if (window.Chart && ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Reads', 'Likes'],
        datasets: [{
          data: [data.reads, data.likes],
          backgroundColor: ['#3b82f6', '#f59e0b'],
          borderRadius: 8,
          barThickness: 60
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  }
};

// ‚úÖ Add Analytics button on story cards
function attachAnalyticsButtons() {
  document.querySelectorAll('.story-card').forEach(card => {
    const title = card.querySelector('h2')?.textContent?.trim();
    if (!title) return;
    if (card.querySelector('.analytics-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'btn btn-secondary analytics-btn';
    btn.textContent = 'üìä Analytics';
    btn.onclick = () => openAnalyticsModal(title);
    card.appendChild(btn);
  });
}
document.addEventListener('DOMContentLoaded', attachAnalyticsButtons);
</script>
<script>
/* 
   üî• UNIVERSAL SPA NAVIGATION SYSTEM FOR MEURBAL üî•
   - Auto-detects all pages, popups, modals
   - Enables browser Back / Forward
   - Saves last page & restores on refresh
   - ZERO need to manually list any IDs
   ====================================================== 
*/

// üîç Auto-detect all sections that count as a "page"
function detectPages() {
  const selectors = [
    '[id$="Page"]',
    '[id$="Popup"]',
    '[id$="Modal"]',
    '#editorPage',
    '#previewFull'
  ];

  const pages = new Set();
  selectors.forEach(sel => {
    document.querySelectorAll(sel).forEach(el => pages.add(el.id));
  });

  return Array.from(pages);
}

window.__ALL_PAGES = detectPages();

// ======================================================
// üöÄ Main Navigation Function
// ======================================================
window.showPage = function (pageId) {

  window.__ALL_PAGES.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });

  const page = document.getElementById(pageId);
  if (page) page.classList.remove("hidden");

  history.pushState({ page: pageId }, "", "#" + pageId);

  localStorage.setItem("meurbal_last_page", pageId);
};

// ======================================================
// ‚¨ÖÔ∏è‚û°Ô∏è Handle Browser Back/Forward Buttons
// ======================================================
window.addEventListener("popstate", (event) => {
  const page = event.state?.page || "welcomePage";
  window.showPage(page);
});

// ======================================================
// üîÑ Restore last page on refresh / reopen
// ======================================================
document.addEventListener("DOMContentLoaded", () => {
  window.__ALL_PAGES = detectPages();

  const last = localStorage.getItem("meurbal_last_page") || "welcomePage";
  window.showPage(last);
});

// ======================================================
// üß© data-nav Helper
// ======================================================
document.addEventListener("click", (e) => {
  const target = e.target.closest("[data-nav]");
  if (!target) return;

  const page = target.getAttribute("data-nav");
  if (page) window.showPage(page);
});


/* ======================================================
   SESSION PAGE MEMORY & WRAPPERS PATCH
   ====================================================== */
(function(){
  function saveCurrentPage(id){
    try { sessionStorage.setItem("currentPage", id); } catch(e){}
  }

  function hideAllPages() {
    [
      'welcomePage',
      'dashboardPage',
      'profileFormPage',
      'slidesPage',
      'categoriesPage',
      'serialCategoriesPage',
      'writerGatePage'
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    });
  }

  function restoreLastPage(){
    try {
      const last = sessionStorage.getItem("currentPage");
      if (!last) {
        if (typeof showHomePage === 'function') showHomePage();
        else document.getElementById('welcomePage')?.classList.remove('hidden');
        return;
      }
      hideAllPages();
      const page = document.getElementById(last);
      if (page) page.classList.remove('hidden');

      try { if (last === 'dashboardPage' && typeof showDashboard === 'function') showDashboard(); } catch(e){}
      try { if (last === 'categoriesPage' && typeof openCategoriesPage === 'function') openCategoriesPage(); } catch(e){}
      try { if (last === 'serialCategoriesPage' && typeof openSerialCategoriesPage === 'function') openSerialCategoriesPage(); } catch(e){}
      try { if (last === 'writerGatePage' && typeof showWriterGateway === 'function') showWriterGateway(); } catch(e){}

    } catch(e){}
  }

  function wrapFunction(name, saveId){
    const orig = window[name];
    if (typeof orig === 'function') {
      window[name] = function(...args){
        saveCurrentPage(saveId);
        return orig.apply(this, args);
      };
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    restoreLastPage();

    const map = {
      homeBtn: 'welcomePage',
      writerBtn: 'writerGatePage',
      browseStoriesBtn: 'categoriesPage',
      browseSerialsBtn: 'serialCategoriesPage',
      createContentBtn: 'writerGatePage',
      categoriesBackBtn: 'welcomePage',
      serialCategoriesBackBtn: 'welcomePage'
    };

    Object.entries(map).forEach(([id, pageId])=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', ()=> saveCurrentPage(pageId));
    });

    wrapFunction('showHomePage', 'welcomePage');
    wrapFunction('showDashboard', 'dashboardPage');
    wrapFunction('openCategoriesPage', 'categoriesPage');
    wrapFunction('openSerialCategoriesPage', 'serialCategoriesPage');
    wrapFunction('showWriterGateway', 'writerGatePage');

    const writerAction = document.getElementById('writerGateActionBtn');
    if (writerAction) {
      writerAction.addEventListener('click', ()=> saveCurrentPage('dashboardPage'));
    }

    window.addEventListener('popstate', () => {
      const last = sessionStorage.getItem("currentPage");
      hideAllPages();
      if (last) document.getElementById(last)?.classList.remove('hidden');
    });
  });

  window.saveCurrentPage = saveCurrentPage;
  window.hideAllPages = hideAllPages;
})();
</script>


<!-- BEGIN: Meurbal 5-minute pause gate (inserted by ChatGPT) -->
<div id="meurbalPauseGate" style="
  position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
  flex-direction: column; z-index: 2147483647; background: rgba(0,0,0,0.78); color: #fff;
  font-family: Inter, Poppins, system-ui, -apple-system, Arial, sans-serif; text-align: center; padding: 24px;
">
  <div style="max-width:740px; width:calc(100% - 48px); border-radius:16px; padding:28px; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.06); box-shadow:0 30px 80px rgba(0,0,0,0.6);">
    <h2 style="margin:0 0 12px; font-size:26px; font-weight:800;">‚è≥ Your experience has been paused</h2>
    <p style="margin:0 0 20px; color:rgba(255,255,255,0.92); font-size:16px;">
      To continue using Meurbal, please register or sign in. You can use your existing account or create a new one ‚Äî it's fast and free.
    </p>
    <div style="display:flex; gap:12px; justify-content:center; margin-top:8px; flex-wrap:wrap;">
      <button id="meurbalPauseRegisterBtn" style="padding:12px 20px; border-radius:12px; border:none; cursor:pointer; font-weight:700; font-size:16px; background: linear-gradient(135deg,#6a11cb,#2575fc); color:white;">Register</button>
      <button id="meurbalPauseSignInBtn" style="padding:10px 18px; border-radius:12px; border:1px solid rgba(255,255,255,0.18); background:transparent; color:white; font-weight:700; font-size:15px; cursor:pointer;">Sign In</button>
    </div>
    <p id="meurbalPauseNote" style="margin-top:14px; color: rgba(255,255,255,0.7); font-size:13px;">Tip: If you already registered in this browser, the pause will not appear.</p>
  </div>
</div>

<script>
// Meurbal 5-minute pause gate (injected by ChatGPT)
// Behavior: timer starts on first open of site (welcome page), shows gate after 5 minutes
// Gate will not show if localStorage.meurbal_registered == "true"
(function(){
  // don't re-inject if present
  if (window.__meurbalPauseInjected) return;
  window.__meurbalPauseInjected = true;

  // Mark first open
  try {
    if (!localStorage.getItem('meurbal_first_open')) {
      localStorage.setItem('meurbal_first_open', Date.now().toString());
    }
  } catch(e){ console.warn("meurbal pause: localStorage unavailable", e); }

  // If user already registered (flag set by app on real registration), skip timer
// If user already registered (flag set by app on real registration), skip timer AND hide gate instantly
try {
  if (localStorage.getItem('meurbal_registered') === 'true') {
    const gate = document.getElementById('meurbalPauseGate');
    if (gate) gate.style.display = 'none';
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    return; // stop gate code forever while logged in
  }
} catch(e){ /* ignore */ }


  // Show gate after 5 minutes (300000 ms) starting from page load
  var PAUSE_MS = 5 * 60 * 1000;

  // For safety, only start this when user is on top-level welcome or not deep inside editor.
  // The user explicitly chose "Timer starts as soon as user opens the website (from welcome page)".
  // We'll start the timer immediately on script load.
  var pauseTimer = setTimeout(showPauseGate, PAUSE_MS);

  function showPauseGate(){
    try {
      var gate = document.getElementById('meurbalPauseGate');
      if (!gate) return;
      gate.style.display = 'flex';
      // prevent scroll behind gate
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    } catch(e){ console.error(e); }
  }

  // Hook buttons to open existing register/sign-in UI (use current registerBtn behavior)
  function safeClickSelector(idOrEl){
    try{
      if (!idOrEl) return;
      if (typeof idOrEl === 'string') {
        var el = document.getElementById(idOrEl);
        if (el) el.click();
        return;
      }
      idOrEl.click();
    }catch(e){ console.warn(e); }
  }

  // Register button opens existing register UI by clicking bottom nav 'registerBtn'
  var regBtn = document.getElementById('meurbalPauseRegisterBtn');
  if (regBtn){
    regBtn.addEventListener('click', function(){
      // hide gate first (so click opens behind properly)
      var gate = document.getElementById('meurbalPauseGate');
      if (gate) gate.style.display = 'none';
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      // Click the existing register button (bottom nav)
      try {
        var bottomReg = document.getElementById('registerBtn');
        if (bottomReg) {
          bottomReg.click();
        } else {
          // fallback: attempt to open common register modal if exists
          var maybeRegister = document.querySelector('[data-action="open-register"], .open-register, .register-btn');
          if (maybeRegister) maybeRegister.click();
        }
      } catch(e){ console.warn("meurbal pause: failed to open register UI", e); }
    });
  }

  // Sign-in triggers same register button by your request ("mycurrentone"), which uses registerBtn click logic
  var signBtn = document.getElementById('meurbalPauseSignInBtn');
  if (signBtn){
    signBtn.addEventListener('click', function(){
      var gate = document.getElementById('meurbalPauseGate');
      if (gate) gate.style.display = 'none';
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      try {
        var bottomReg = document.getElementById('registerBtn');
        if (bottomReg) bottomReg.click();
        else {
          var maybeLogin = document.querySelector('[data-action="open-login"], .open-login, .login-btn');
          if (maybeLogin) maybeLogin.click();
        }
      } catch(e){ console.warn("meurbal pause: failed to open sign-in UI", e); }
    });
  }

  // If the app sets meurbal_registered we also remove gate if present
  window.addEventListener('storage', function(e){
    if (e.key === 'meurbal_registered' && e.newValue === 'true'){
      var gate = document.getElementById('meurbalPauseGate');
      if (gate) gate.style.display = 'none';
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      clearTimeout(pauseTimer);
    }
  });

  // Safety: if user navigates away and returns, ensure we don't show gate too early.
  // We recalc based on first_open timestamp.
  try {
    var first = parseInt(localStorage.getItem('meurbal_first_open') || Date.now());
    var elapsed = Date.now() - first;
    if (elapsed >= PAUSE_MS){
      // Immediately show gate if time has already passed
      clearTimeout(pauseTimer);
      showPauseGate();
    } else {
      // adjust timer for remaining time
      clearTimeout(pauseTimer);
      pauseTimer = setTimeout(showPauseGate, PAUSE_MS - elapsed);
    }
  } catch(e){ /* ignore */ }

})(); 
</script>
<script>
async function waitForFirebase() {
  let connected = false;
  for (let i = 0; i < 10; i++) { // retry 10 times
    try {
      await get(ref(db, '/'));
      connected = true;
      break;
    } catch (e) {
      await new Promise(r => setTimeout(r, 800)); // wait retry
    }
  }
  return connected;
}

waitForFirebase().then(ok => {
  if (ok) {
    setStatus('üü¢ Firebase: Connected', '#dcfce7');
    loadAllDataFromFirebase();
  } else {
    setStatus('üî¥ Firebase: Offline ‚Äî Showing saved data', '#fee2e2');
    renderStoriesList(window.storiesData);
    renderSerialsList(window.serialsData);
  }
});
async function loadAllDataFromFirebase() {
  try {
    const snap1 = await get(ref(db, 'stories'));
    if (snap1.exists()) {
      window.storiesData = Object.values(snap1.val());
      saveLocal('storiesData', window.storiesData);
      renderStoriesList(window.storiesData);
    }

    const snap2 = await get(ref(db, 'serials'));
    if (snap2.exists()) {
      window.serialsData = Object.values(snap2.val());
      saveLocal('serialsData', window.serialsData);
      renderSerialsList(window.serialsData);
    }
  } catch (e) {
    console.log("‚ö† Firebase read failed ‚Üí using offline data.");
    renderStoriesList(window.storiesData);
    renderSerialsList(window.serialsData);
  }
}
document.addEventListener("keydown", function (e) {
  // Prevent DevTools shortcuts
  if (
    (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C" || e.key === "R")) ||
    e.key === "F12"
  ) {
    e.preventDefault();
    e.stopPropagation();

    // Show your popup instead
    showExperiencePopup();
  }
});

// Disable right-click (optional)
document.addEventListener("contextmenu", e => {
  e.preventDefault();
  showExperiencePopup();
});
function showExperiencePopup() {
  const div = document.createElement("div");
  div.style.cssText = `
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 999999;
  `;
  div.innerHTML = `
    <div style="
      background: white; padding: 26px; border-radius: 14px;
      max-width: 360px; width: 90%; text-align: center;
      font-family: Inter, sans-serif; box-shadow:0 8px 25px rgba(0,0,0,0.25);
    ">
      <h2 style="margin:0 0 12px;">How is your experience going?</h2>
      <button id="exp_close" style="
        padding: 10px 18px; border-radius: 10px; border:none;
        cursor: pointer; background:#2575fc; color:white; font-weight:600;">
        Continue
      </button>
    </div>
  `;
  document.body.appendChild(div);
  document.getElementById("exp_close").onclick = () => div.remove();
}

</script>
</body>


<script>
function openSerialOptions(serial, serialIndex) {
  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.innerHTML = `
    <div class="popup-content">
      <h3>${serial.title} ‚Äî Series Options</h3>

      <button id="addEpNowBtn" class="btn btn-primary" style="margin-top:12px;">
        ‚ûï Add New Episode
      </button>

      <button id="deleteSerialBtn" class="btn btn-danger" style="margin-top:12px;background:#dc2626;color:white;">
        üóëÔ∏è Delete Series
      </button>

      <button id="deleteEpisodeBtn" class="btn btn-warning" style="margin-top:12px;background:#f59e0b;color:white;">
        ‚ö° Delete Episode
      </button>

      <button id="closeSerialOpts" class="btn btn-secondary" style="margin-top:10px;">
        Close
      </button>
    </div>
  `;
  document.body.appendChild(popup);

  // ---- Close ----
  document.getElementById('closeSerialOpts').onclick = () => popup.remove();

document.getElementById('addEpNowBtn').onclick = () => {
  showAddEpisodeModal(serial, serialIndex);
};

  // ---- Delete Serial ----
  document.getElementById('deleteSerialBtn').onclick = async () => {
    if (!confirm(`Delete series "${serial.title}" permanently?`)) return;

    try {
      const db = window._firebase?.db;
      const refFunc = window._firebase?.ref;
      const setFunc = window._firebase?.set;

      if (!db || !refFunc || !setFunc) {
        alert('‚ùå Firebase not initialized. Please reload the app.');
        return;
      }

      // ‚úÖ Remove from Firebase
      await setFunc(refFunc(db, `serials/${encodeURIComponent(serial.title)}`), null);

      // ‚úÖ Remove from localStorage + memory
      window.serialsData.splice(serialIndex, 1);
      localStorage.setItem("serialsData", JSON.stringify(window.serialsData));

      // ‚úÖ Remove from dashboardCards
      const saved = JSON.parse(localStorage.getItem('dashboardCards') || '[]');
      const updated = saved.filter(card => card.title !== serial.title);
      localStorage.setItem('dashboardCards', JSON.stringify(updated));

      popup.remove();
      alert(`‚úÖ Series "${serial.title}" deleted successfully.`);
      showDashboard('serials');
    } catch (err) {
      console.error('‚ùå Failed to delete serial:', err);
      alert('Series Successfully Deleted‚úÖ.');
    }
  };

  // ---- Delete Episode ----
  document.getElementById('deleteEpisodeBtn').onclick = async () => {
    if (!serial.episodes || serial.episodes.length === 0) {
      alert('No episodes to delete.');
      return;
    }

    const list = serial.episodes.map((ep, i) => `${i + 1}. ${ep.title}`).join('\n');
    const choice = prompt(`Enter episode number to delete:\n${list}`);
    const index = parseInt(choice) - 1;

    if (isNaN(index) || index < 0 || index >= serial.episodes.length) {
      alert('Invalid episode number.');
      return;
    }

    const epTitle = serial.episodes[index].title;
    if (!confirm(`Delete episode "${epTitle}"?`)) return;

    try {
      serial.episodes.splice(index, 1);

      // ‚úÖ Save updated serial to Firebase
      const db = window._firebase?.db;
      const refFunc = window._firebase?.ref;
      const setFunc = window._firebase?.set;

      await setFunc(refFunc(db, `serials/${encodeURIComponent(serial.title)}`), serial);

      // ‚úÖ Update localStorage
      serialsData[serialIndex] = serial;
      localStorage.setItem('serialsData', JSON.stringify(serialsData));

      alert(`‚úÖ Episode "${epTitle}" deleted successfully.`);
      popup.remove();
    } catch (err) {
      console.error('‚ùå Failed to delete episode:', err);
      alert('Error deleting episode. Please check console.');
    }
  };
}


function showAddEpisodeModal(serial, serialIndex) {
  const box = document.getElementById("serialEpModal");
  document.getElementById("serialEpModalTitle").textContent = `Add Episode to: ${serial.title}`;
  const titleInput = document.getElementById("serialEpNewTitle");
  const descInput = document.getElementById("serialEpNewDesc");
  titleInput.value = ""; descInput.value = "";
  box.classList.remove("hidden");
  document.getElementById("serialEpCancel").onclick = () => box.classList.add("hidden");
  document.getElementById("serialEpCreate").onclick = () => {
    const t = titleInput.value.trim(); const d = descInput.value.trim();
    if (!t) return alert("Episode title is required.");
    serial.episodes = serial.episodes || [];
    serial.episodes.push({ title: t, description: d, sheets: [], status: "Draft" });
    const newIndex = serial.episodes.length - 1;
    if (typeof saveSerialToFirebase === "function") saveSerialToFirebase(serial);
    serialsData[serialIndex] = serial;
    localStorage.setItem("serialsData", JSON.stringify(serialsData));
    box.classList.add("hidden");
    createEditorPage(t, serial.genre, d, { isEdit: true, editType: "serial", index: serialIndex, episodeIndex: newIndex });
  };
}

function showEpisodeList(serial, serialIndex) {
  const modal = document.createElement("div");
  modal.className = "popup";
  modal.innerHTML = `
    <div class="popup-content" style="max-width:420px;">
      <h3>${serial.title} ‚Äî Episodes</h3>
      <div id="episodeListBox" style="margin-top:10px; text-align:left;"></div>
      <button id="closeEpList" class="btn btn-secondary" style="margin-top:12px;">Close</button>
    </div>`;
  document.body.appendChild(modal);
  const list = modal.querySelector("#episodeListBox");
  list.innerHTML = serial.episodes.map((e,i)=>`
    <div class="dashboard-card" style="margin-bottom:8px; cursor:pointer;">
      <b>${i+1}. ${e.title}</b>
      <p>Status: ${e.status || 'Draft'}</p>
    </div>`).join("");
  list.querySelectorAll(".dashboard-card").forEach((card,i)=>{
    card.onclick = () => {
      modal.remove();
      createEditorPage(serial.episodes[i].title, serial.genre, serial.episodes[i].description, { isEdit: true, editType: "serial", index: serialIndex, episodeIndex: i });
    };
  });
  document.getElementById("closeEpList").onclick = () => modal.remove();
}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('‚úÖ Service worker registered:', reg))
      .catch(err => console.log('‚ùå Service worker failed:', err));
  });
}
>
  // üîó Wire bottom nav Register button to the auth popup logic
  document.addEventListener('DOMContentLoaded', () => {
    const bottomRegisterBtn = document.getElementById('registerBtn');
    const authPopup = document.getElementById('authPopup');
    const registerBtnTop = document.querySelector('#topNav #registerBtn');

    if (!bottomRegisterBtn || !authPopup) return;

    // When clicked in bottom nav
    bottomRegisterBtn.addEventListener('click', () => {
      // If user is logged in (top button says ‚ÄúLog Out‚Äù), then log out
      if (registerBtnTop && registerBtnTop.dataset.signed === 'true') {
        registerBtnTop.click(); // reuse existing logout logic
      } else {
        authPopup.classList.remove('hidden');
        authPopup.setAttribute('aria-hidden', 'false');
      }
    });
</script>

</html>
