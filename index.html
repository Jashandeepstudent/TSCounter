<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Themed Task App — Study Counter v2</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --card-w:820px;
  --radius:18px;
  --accent:#4a90e2;
  --btn-text:#ffffff;
  --bg1:#eef2ff;
  --bg2:#ffffff;
  --timer-color:#0b1220;
  --muted:#6b7280;
  --progress-gradient: linear-gradient(90deg,#4a90e2,#8b5cf6);
}
*{box-sizing:border-box; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; }
html,body{height:100%; margin:0; background:linear-gradient(135deg,var(--bg1),var(--bg2)); }
.container{ width:var(--card-w); max-width:96vw; margin:30px auto; background:rgba(255,255,255,0.95); border-radius:var(--radius); padding:22px; box-shadow:0 20px 60px rgba(2,6,23,0.12); overflow:auto; max-height:86vh; }
.header{ display:flex; align-items:center; gap:16px; }
.logo{ width:72px; height:72px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:28px; background:linear-gradient(180deg,#f0f0f0,#e6e6e6); color:#333; }
.title{ margin:0; font-size:20px; font-weight:700; }
.subtitle{ margin:2px 0 0; color:var(--muted); font-size:13px; }
.header-actions{ margin-left:auto; display:flex; gap:10px; align-items:center; }

/* study bar */
.study-wrapper{ display:flex; flex-direction:column; gap:6px; }
.study-meta{ font-size:13px; color:var(--muted); display:flex; gap:10px; align-items:center; }
.progress{ height:12px; background:#edf2f7; border-radius:8px; overflow:hidden; width:220px; margin-top:4px; }
.progress-inner{ height:100%; width:0%; background:var(--progress-gradient); transition:width .5s; }
.level-title{ font-size:12px; color:var(--muted); margin-top:4px; }

/* selected red */
.selected-red{ box-shadow: 0 8px 30px rgba(255,82,82,0.14) !important; border:2px solid #ff4d4d !important; }

/* form */
.row{ display:flex; gap:12px; align-items:center; }
.col{ flex:1; }
.input, input[type="text"], input[type="number"], select, input[type="date"], input[type="time"]{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e6eef8; font-size:15px; outline:none; background:white; box-shadow: inset 0 -4px 12px rgba(0,0,0,0.03); }
.btn{ padding:12px 16px; border-radius:12px; border:none; background:var(--accent); color:var(--btn-text); font-weight:700; cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.btn.secondary{ background:#6b7280; color:white; }
.btn.danger{ background:#e24a4a; color:white; }
.small{ padding:8px 10px; border-radius:10px; font-weight:700; }

/* grid */
.grid{ display:grid; gap:14px; margin-top:16px; }
.boxes{ display:grid; grid-template-columns:repeat(2,1fr); gap:14px; margin-top:12px; }
.box-card{ padding:16px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfbff); box-shadow:0 8px 30px rgba(0,0,0,0.06); }
.box-title{ font-weight:800; font-size:18px; }
.box-meta{ color:var(--muted); font-size:13px; }

/* table */
.table{ width:100%; border-collapse:collapse; margin-top:12px; }
.table th, .table td{ padding:10px; border-bottom:1px solid #edf2f7; text-align:left; }

/* modal */
.modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999; }
.modal-card{ width:420px; max-width:92vw; background:white; padding:16px; border-radius:12px; box-shadow:0 20px 60px rgba(2,6,23,0.2); }
.hidden{ display:none; }
.muted{ color:var(--muted); font-size:13px; }

/* stickers */
.bg{ position:fixed; inset:0; pointer-events:none; z-index:0; }
.sticker{ position:absolute; opacity:0.12; font-size:40px; transform:translate3d(0,0,0); animation:float 8s ease-in-out infinite; }
@keyframes float{ 0%{transform:translateY(0);} 50%{transform:translateY(-20px);} 100%{transform:translateY(0);} }

/* timer / mood */
#timerDisplay{ color:var(--timer-color); }
#moodDisplay{ display:flex; align-items:center; gap:12px; font-weight:800; }
#moodEmoji{ font-size:48px; line-height:1; }
#moodText{ font-size:18px; color:var(--muted); }

@media(max-width:900px){ .boxes{ grid-template-columns:1fr; } .logo{ width:56px; height:56px; font-size:20px; } }
</style>
</head>
<body>
<div class="bg" id="bg"></div>

<div class="container" role="main">
  <div class="header">
    <div class="logo" id="logo">✨</div>
    <div id="studyWrapperContainer">
      <!-- study-wrapper will be shown only when experience created -->
      <div class="study-wrapper" id="studyWrapper" style="display:none;">
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="title">Study Progress</div>
          <div class="study-meta">
            <div id="expText">EXP 0/20</div>
            <div id="levelText">Lv 0/100</div>
          </div>
        </div>
        <div class="progress" aria-hidden="true"><div class="progress-inner" id="progressInner"></div></div>
        <div class="level-title" id="levelTitle">Beginner</div>
      </div>
    </div>
    <div class="header-actions" id="headerActions"></div>
  </div>

  <div class="grid" id="mainGrid">
    <!-- Step 1 -->
    <div id="stepName">
      <h3>Hi — tell me who you are</h3>
      <div class="row">
        <input id="name" class="input" type="text" placeholder="Your name (e.g., Jahshan)">
        <input id="age" class="input" type="number" placeholder="Age" style="width:120px;">
      </div>
      <div style="margin-top:10px;">
        <button class="btn" id="btnContinue">Continue</button>
        <button class="btn secondary" id="btnReset">Reset</button>
      </div>
      <div id="nameError" class="muted" style="display:none; margin-top:8px;"></div>
    </div>

    <!-- Step 2 -->
    <div id="stepCustomize" class="hidden">
      <h3 id="greet">Hello!</h3>
      <div class="muted">Choose purpose & theme</div>

      <div style="margin-top:12px;">
        <div style="font-weight:800; margin-bottom:6px;">Purpose</div>
        <div class="row" style="margin-bottom:8px;">
          <div id="purposeStudy" class="box-card" style="cursor:pointer;">Study</div>
          <div id="purposeOther" class="box-card" style="cursor:pointer;">Other</div>
        </div>

        <div style="font-weight:800; margin-bottom:6px;">Theme</div>
        <div class="row">
          <div id="tCute" class="box-card" style="cursor:pointer;">Cute</div>
          <div id="tTech" class="box-card" style="cursor:pointer;">Tech</div>
          <div id="tCold" class="box-card" style="cursor:pointer;">Cold</div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" id="btnFinish">Finish</button>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3>Your Task Boxes</h3>
          <div class="muted">Create boxes (max 10 tasks each)</div>
        </div>
        <div>
          <!-- kept Create Task Box per request -->
          <button class="btn" id="btnCreateBox">+ Create Task Box</button>
        </div>
      </div>

      <div class="boxes" id="boxesList" aria-live="polite" style="margin-top:12px;"></div>

      <div id="allTasks" class="hidden" style="margin-top:12px;">
        <h3>All Tasks</h3>
        <table class="table" id="allTasksTable">
          <thead><tr><th>Box</th><th>Task</th><th>Deadline</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="allTasksBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Create Box Step 1 -->
    <div id="createBox1" class="hidden">
      <h3>Name the Task Box</h3>
      <input id="newBoxName" class="input" type="text" placeholder="e.g., Exam prep">
      <div style="margin-top:10px;">
        <button class="btn" id="toCreateBox2">Next: Duration</button>
        <button class="btn secondary" id="cancelCreateBox1">Cancel</button>
      </div>
      <div id="createBoxError" class="muted" style="display:none;"></div>
    </div>

    <!-- Create Box Step 2 -->
    <div id="createBox2" class="hidden">
      <h3>Duration</h3>
      <div class="row">
        <select id="recurrenceType" class="input">
          <option value="weekly">Week</option>
          <option value="monthly">Month</option>
          <option value="yearly">Year</option>
          <option value="days">Days</option>
        </select>
        <input id="recurrenceCount" class="input" type="number" placeholder="How many?" style="width:140px;">
      </div>
      <div style="margin-top:10px;">
        <button class="btn" id="createBoxBtn">Create Box</button>
        <button class="btn secondary" id="cancelCreateBox2">Cancel</button>
      </div>
    </div>

    <!-- Box Detail -->
    <div id="boxDetail" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3 id="boxTitle">Box</h3>
          <div id="boxMeta" class="muted"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="btnAddTask">Add Task</button>
          <button class="btn secondary" id="btnEditBox">Edit</button>
          <button class="btn danger" id="btnDeleteBox">Delete</button>
        </div>
      </div>
      <table class="table" id="tasksTable" style="margin-top:10px;">
        <thead><tr><th style="width:120px"></th><th>Task</th><th>Deadline</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="tasksBody"></tbody>
      </table>
      <div style="margin-top:12px;">
        <button class="btn secondary" id="backToDashboard">Back</button>
      </div>
    </div>


    <!-- Study Counter Menu -->
    
    <div id="studyCounterMenu" class="hidden" style="flex-direction:column;align-items:center;gap:8px;padding-top:8px;">
      <h2 style="margin:0;font-size:22px;">Choose Mode</h2>
      <div class="muted" style="font-size:13px;">Pick a mode — AFK, Battle, or something wild</div>
      <div style="margin-top:18px; display:grid; grid-template-columns:repeat(3,1fr); gap:14px; width:100%; max-width:900px; align-items:start;">
        <div class="box-card mode-card" style="display:flex;flex-direction:column;align-items:center;justify-content:center; padding:22px; cursor:pointer;" id="modeAfk">
          <div style="font-size:40px;">🛋️</div>
          <div style="font-weight:800; margin-top:8px;">AFK</div>
          <div class="muted" style="margin-top:6px; text-align:center;">Open the normal study timer (AFK mode)</div>
        </div>
        <div class="box-card mode-card" style="display:flex;flex-direction:column;align-items:center;justify-content:center; padding:22px; cursor:pointer;" id="modeChallenges">
          <div style="font-size:40px;">⚔️</div>
          <div style="font-weight:800; margin-top:8px;">Challenges</div>
          <div class="muted" style="margin-top:6px; text-align:center;">Battle challengers: Jashandeep, Khushi, AI</div>
        </div>
        <div class="box-card mode-card" style="display:flex;flex-direction:column;align-items:center;justify-content:center; padding:22px; cursor:pointer;" id="modePet">
          <div style="font-size:40px;">🐾</div>
          <div style="font-weight:800; margin-top:8px;">Study a Pet</div>
          <div class="muted" style="margin-top:6px; text-align:center;">Choose a pet and grow it by studying</div>
        </div>
      </div>
      <div style="margin-top:18px;"><button class="btn secondary" id="backFromMenuBtn">Back</button></div>
    </div>

    <!-- Challenges Page -->
    <div id="challengesPage" class="hidden">
      <h3>Challenges</h3>
      <div class="muted">Choose a challenger</div>
      <div style="margin-top:12px; display:grid; grid-template-columns:repeat(3,1fr); gap:12px;" id="challengersList">
        <!-- challenger cards appended here -->
      </div>
      <div style="margin-top:16px;"><button class="btn secondary" id="backFromChallenges">Back</button></div>
    </div>

    <!-- Jashandeep Battle (GK Quiz) -->
    <div id="jashBattlePage" class="hidden">
      <h3>Challenge: CEO Jashandeep</h3>
      <div class="muted">10 GK questions — Jashandeep answers instantly. Can you keep up?</div>
      <div style="display:flex; gap:14px; margin-top:12px; align-items:flex-start;">
        <div style="flex:1;" class="box-card">
          <div style="font-weight:800;">Jashandeep (CPU)</div>
          <div id="jashScore" class="muted" style="margin-top:6px;">Score: 0</div>
          <div id="jashAnswerArea" style="margin-top:12px;"></div>
        </div>
        <div style="flex:2;" class="box-card">
          <div id="jashQuestionNum" style="font-weight:800;"></div>
          <div id="jashQuestionText" style="margin-top:8px; font-size:18px;"></div>
          <div id="jashOptions" style="margin-top:12px; display:grid; gap:8px;"></div>
          <div style="margin-top:12px;"><button class="btn secondary" id="jashQuitBtn">Back</button></div>
        </div>
        <div style="flex:1;" class="box-card">
          <div style="font-weight:800;">You</div>
          <div id="userScore" class="muted" style="margin-top:6px;">Score: 0</div>
          <div id="userAnswerArea" style="margin-top:12px;"></div>
        </div>
      </div>
      <div style="margin-top:12px;" id="jashResultArea"></div>
    </div>

    
  <!-- Emoji Battle Page -->
  <div id="emojiBattlePage" class="hidden">
    <h3>Emoji Battle</h3>
    <div class="muted">Guess the combined meaning!</div>
    <div id="emojiChallengeArea" style="margin-top:16px; font-size:40px; text-align:center;"></div>
    <div id="emojiOptions" style="margin-top:16px; display:grid; gap:10px;"></div>
    <div id="emojiResult" style="margin-top:12px;"></div>
    <div style="margin-top:16px;"><button class="btn secondary" id="emojiQuitBtn">Back</button></div>
  </div>

  <!-- AI Calculator Challenge -->
    <div id="aiBattlePage" class="hidden">
      <h3>Challenge: AI Calculator</h3>
      <div class="muted">Speed math. AI answers instantly — try to be faster and correct.</div>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <div class="box-card" style="flex:1;">
          <div style="font-weight:800;">AI</div>
          <div id="aiScore" class="muted" style="margin-top:6px;">Score: 0</div>
        </div>
        <div class="box-card" style="flex:2;">
          <div id="aiQuestionNum" style="font-weight:800;"></div>
          <div id="aiQuestionText" style="margin-top:8px; font-size:18px;"></div>
          <input id="aiUserAnswer" class="input" type="text" placeholder="Type answer and press Enter" style="width:140px; margin-top:10px;">
<div style="margin-top:8px;"><button class="btn small" id="aiSubmitBtn">Submit</button></div>
          <div style="margin-top:8px;"><button class="btn secondary" id="aiQuitBtn">Back</button></div>
        </div>
        <div class="box-card" style="flex:1;">
          <div style="font-weight:800;">You</div>
          <div id="aiUserScore" class="muted" style="margin-top:6px;">Score: 0</div>
        </div>
      </div>
      <div id="aiResultArea" style="margin-top:12px;"></div>
    </div>
<!-- Study Counter Page -->
    
<!-- Pet Study Page -->
<div id="petStudyPage" class="hidden">
  <h3>Study a Pet</h3>
  <div class="muted">Pick a pet, answer GK questions and help it evolve. 100 questions total — evolves every 10 answered questions.</div>

  <div id="petSelectArea" style="margin-top:12px; display:flex; gap:12px; justify-content:center;">
    <button class="btn small" data-pet="cat">🐱 Cat</button>
    <button class="btn small" data-pet="dino">🦖 Dinosaur</button>
    <button class="btn small" data-pet="robot">🤖 Robot</button>
  </div>

  <div id="petGameArea" class="hidden" style="margin-top:20px; text-align:center;">
    
    <div id="petLabel" class="muted" style="margin-top:8px;">Your pet: —</div>
<div id="petCard" class="box-card" style="display:inline-block; padding:22px; border-radius:16px; min-width:320px;">
      <div id="petDisplay" class="pet-display" style="font-size:84px; line-height:1;">🐱</div>
    
      <div id="petSpeech" class="pet-speech" style="margin-top:8px; font-weight:800;">hlo 👋</div>
      <div id="petStats" style="margin-top:10px;" class="muted">Points: <span id="petPoints">0</span> — Answered: <span id="petAnswered">0</span>/100 — Evolution stage: <span id="petStage">0</span>/10</div>
    </div>

    <div id="petQuestionArea" style="margin-top:18px;">
      <div id="petQuestionNum" style="font-weight:700;"></div>
      <div id="petQuestionText" style="margin-top:8px; font-size:18px;"></div>
      <div id="petOptions" style="margin-top:12px; display:grid; gap:10px; max-width:520px; margin-left:auto; margin-right:auto;"></div>
      <div id="petFeedback" style="margin-top:10px; font-weight:700; min-height:22px;"></div>
      <div style="margin-top:12px;"><button class="btn danger" id="petQuitBtn" style="margin-left:8px;">Back</button></div>
    </div>
  </div>
</div>

<style>
/* Pet UI */
.pet-display{ transition: transform 300ms ease, filter 300ms ease; display:inline-block; }
.pet-wave{ animation: petWave 1.2s ease-in-out infinite; transform-origin:50% 50%; }
@keyframes petWave{ 0%{ transform: translateY(0) rotate(0deg);} 50%{ transform: translateY(-8px) rotate(-6deg);} 100%{ transform: translateY(0) rotate(0deg);} }

.pet-pulse{ animation: petPulse 420ms ease; }
@keyframes petPulse{ 0%{ transform: scale(1); } 50%{ transform: scale(1.18); } 100%{ transform: scale(1); } }

.pet-speech{ display:inline-block; background:rgba(0,0,0,0.06); padding:6px 10px; border-radius:999px; margin-top:6px; }
.pet-evolved{ box-shadow: 0 12px 40px rgba(0,0,0,0.12); transform: translateY(-6px); }
</style>


<div id="studyCounterPage" class="hidden">
      <h3>Study Counter</h3>
      <div class="muted">Start sessions and earn EXP every 15 minutes.</div>

      <div style="margin-top:12px;">
        <div id="sessionArea">
          <button class="btn" id="startSessionBtn">Start a Session</button>
        </div>

        <div id="timerArea" class="hidden" style="margin-top:12px;">
          <div id="timerDisplay" style="font-size:32px; font-weight:800;">00:00:00</div>
          <div style="margin-top:8px;">
            <button class="btn" id="pauseBtn">Pause</button>
            <button class="btn danger" id="stopBtn">Stop</button>
          </div>
          <div style="margin-top:12px;" id="moodDisplay">
            <div id="moodEmoji">🧠</div>
            <div id="moodText">Ready</div>
          </div>
          <div style="margin-top:8px;" id="sessionExpDisplay" class="muted">Session EXP: 0</div>
        </div>

        <div id="congratsArea" class="hidden" style="margin-top:12px;">
          <h4>Congratulations!</h4>
          <div id="congratsText" class="muted"></div>
          <div style="margin-top:8px;">
            <button class="btn" id="startAgainBtn">Start Another Session</button>
            <button class="btn secondary" id="backFromStudyBtn">Back to Dashboard</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- task modal -->
<div id="taskModal" class="modal hidden" aria-hidden="true">
  <div class="modal-card">
    <h3 id="taskModalTitle">Add Task</h3>
    <div class="muted">Provide task name, date & time. If past due you can't complete after deadline.</div>
    <div style="margin-top:10px;">
      <input id="modalTaskName" class="input" type="text" placeholder="Task name">
      <div class="row" style="margin-top:8px;">
        <input id="modalTaskDate" class="input" type="date">
        <input id="modalTaskTime" class="input" type="time">
      </div>
      <div id="modalError" class="muted" style="color:#a00; display:none; margin-top:8px;"></div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button class="btn secondary" id="modalCancel">Cancel</button>
        <button class="btn" id="modalAdd">Add Task</button>
      </div>
    </div>
  </div>
</div>

<!-- edit box modal -->
<div id="editBoxModal" class="modal hidden" aria-hidden="true">
  <div class="modal-card">
    <h3>Edit Box</h3>
    <input id="editBoxName" class="input" type="text" placeholder="Box name">
    <div class="row" style="margin-top:8px;">
      <select id="editRecurrenceType" class="input">
        <option value="weekly">Week</option>
        <option value="monthly">Month</option>
        <option value="yearly">Year</option>
        <option value="days">Days</option>
      </select>
      <input id="editRecurrenceCount" class="input" type="number" placeholder="How many?" style="width:140px;">
    </div>
    <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn secondary" id="editCancel">Cancel</button>
      <button class="btn" id="editSave">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- Config ---------- */
const STORAGE_KEY = 'taskAppState_v2';
const MAX_LEVEL = 100;
const LEVEL_THRESHOLD = 20; // exp per level (kept constant unless you want curve)
const BASE_MILESTONE_EXP = 5; // base exp awarded every 15 minutes
const MILESTONE_SECONDS = 15 * 60; // 900

/* ---------- App state ---------- */
let state = {
  user: { name:'', age:0, purpose:'', theme:'', experienceCreated:false, title:'' },
  boxes: [],
  exp: 0,
  level: 0,
  session: { active:false, startedAt: null, elapsedBefore:0, paused:false, sessionExp:0 },
  version: 2
};

/* ---------- Short helpers ---------- */
const $ = id => document.getElementById(id);
const show = id => { const el=$(id); if(el) el.classList.remove('hidden'); };
const hide = id => { const el=$(id); if(el) el.classList.add('hidden'); };
const val = id => { const el=$(id); return el? el.value : null; };
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.warn('save failed',e); } }
function loadState(){ try{ const s = localStorage.getItem(STORAGE_KEY); if(s){ const loaded = JSON.parse(s); // merge to keep schema
    state = Object.assign(state, loaded);
    // Ensure arrays exist
    state.boxes = state.boxes || [];
    state.user = Object.assign({name:'',age:0,purpose:'',theme:'',experienceCreated:false,title:''}, state.user || {});
    state.session = Object.assign({active:false,startedAt:null,elapsedBefore:0,paused:false,sessionExp:0}, state.session || {});
  } }catch(e){ console.warn('load failed', e); } }

/* ---------- Theme system (applies to tokens/btns/timer) ---------- */
const themeDefinitions = {
  cute: { accent:'#ff6aa2', btnText:'#fff', bg1:'#fff0f6', bg2:'#fff7fb', timer:'#6d174d', progress:'linear-gradient(90deg,#ff6aa2,#ff8fbf)' },
  tech: { accent:'#00aaff', btnText:'#fff', bg1:'#081126', bg2:'#12223b', timer:'#e6eef8', progress:'linear-gradient(90deg,#00aaff,#4ad6ff)' },
  cold: { accent:'#2bb7ff', btnText:'#fff', bg1:'#d9f1ff', bg2:'#f2fbff', timer:'#0b3a57', progress:'linear-gradient(90deg,#2bb7ff,#5cd6ff)' }
};

function applyTheme(t){
  const def = themeDefinitions[t] || themeDefinitions['cute'];
  document.documentElement.style.setProperty('--accent', def.accent);
  document.documentElement.style.setProperty('--btn-text', def.btnText);
  document.documentElement.style.setProperty('--bg1', def.bg1);
  document.documentElement.style.setProperty('--bg2', def.bg2);
  document.documentElement.style.setProperty('--timer-color', def.timer);
  document.documentElement.style.setProperty('--progress-gradient', def.progress);
  // update body class for sticker selection / other visuals
  document.body.className = t;
  renderStickers();
  saveState();
}

/* ---------- Titles and levels ---------- */
function computeTitleForLevel(lv){
  if(lv >= 100) return 'Transcendent';
  if(lv >= 90) return 'Immortal';
  if(lv >= 80) return 'Mythic';
  if(lv >= 70) return 'Grandmaster';
  if(lv >= 60) return 'Master';
  if(lv >= 50) return 'Veteran';
  if(lv >= 40) return 'Expert';
  if(lv >= 30) return 'Advanced';
  if(lv >= 20) return 'Skilled';
  if(lv >= 10) return 'Practitioner';
  if(lv >= 5) return 'Intermediate';
  return 'Beginner';
}

/* ---------- Experience logic ---------- */
function getExpPerMilestone(){ // increases by 5 for each level (per request)
  return BASE_MILESTONE_EXP + (state.level * 5);
}

function addExp(amount){
  state.exp += amount;
  // Level up loop
  while(state.exp >= LEVEL_THRESHOLD && state.level < MAX_LEVEL){
    state.exp -= LEVEL_THRESHOLD;
    state.level++;
    onLevelUp();
  }
  updateStudyBar();
  saveState();
}

function onLevelUp(){
  // update title unlocks
  const newTitle = computeTitleForLevel(state.level);
  if(newTitle !== state.user.title){
    state.user.title = newTitle;
  }
  // a level-up is requested to increase exp rate - handled by getExpPerMilestone()
  // notify (visual)
  setTimeout(()=> {
    showSmallToast('Level up! Now Lv ' + state.level + ' — ' + state.user.title);
  }, 800);
  saveState();
}

/* ---------- UI rendering ---------- */
function updateStudyBar(){
  const pct = Math.min(100, (state.exp/LEVEL_THRESHOLD)*100);
  const inner = $('progressInner');
  if(inner) inner.style.width = pct + '%';
  const expText = $('expText'); if(expText) expText.innerText = `EXP ${state.exp}/${LEVEL_THRESHOLD}`;
  const levelText = $('levelText'); if(levelText) levelText.innerText = `Lv ${state.level}/${MAX_LEVEL}`;
  const title = state.user.title || computeTitleForLevel(state.level);
  const levelTitleEl = $('levelTitle'); if(levelTitleEl) levelTitleEl.innerText = title;
}

/* show/hide study UI depending on experience creation */
function renderStudyUiVisibility(){
  const wrapper = $('studyWrapper');
  const ha = $('headerActions');
  if(state.user.experienceCreated){
    if(wrapper) wrapper.style.display = 'flex';
    setupHeaderActions();
  } else {
    if(wrapper) wrapper.style.display = 'none';
    if(ha) ha.innerHTML = '';
  }
}

/* ---------- Boxes & tasks ---------- */
function renderBoxes(){
  const list = $('boxesList'); if(!list) return;
  list.innerHTML='';
  if(state.boxes.length===0){ list.innerHTML = '<div class="muted">No boxes yet — create one</div>'; return; }
  state.boxes.forEach((b, idx)=>{
    const el = document.createElement('div'); el.className='box-card';
    el.innerHTML = `<div class="box-title">${escape(b.name)}</div>
      <div class="box-meta">Duration: ${b.recurrence.type} × ${b.recurrence.count}</div>
      <div class="box-meta">Tasks: ${b.items.length}/10</div>
      <div style="margin-top:8px;"><button class="btn small" data-idx="${idx}" aria-label="Open box">Open</button></div>`;
    el.querySelector('button').addEventListener('click', ()=>openBox(idx));
    list.appendChild(el);
  });
  saveState();
}

/* ---------- Task flow (similar to previous, but persisted) ---------- */
let currentBox = null;
let taskEditMode = false, taskEditBox = null, taskEditIndex = null;

function showTaskModal(edit=false, bidx=null, tidx=null){
  taskEditMode = !!edit;
  taskEditBox = bidx; taskEditIndex = tidx;
  if(edit){
    const t = state.boxes[bidx].items[tidx];
    $('taskModalTitle').innerText = 'Edit Task';
    $('modalTaskName').value = t.text;
    const iso = new Date(t.iso);
    $('modalTaskDate').value = iso.toISOString().slice(0,10);
    $('modalTaskTime').value = iso.toTimeString().slice(0,5);
    $('modalAdd').innerText = 'Save';
  } else {
    $('taskModalTitle').innerText = 'Add Task';
    $('modalTaskName').value=''; $('modalTaskDate').value=''; $('modalTaskTime').value=''; $('modalAdd').innerText = 'Add Task';
  }
  $('modalError').style.display='none';
  $('taskModal').classList.remove('hidden');
}

function hideTaskModal(){ $('taskModal').classList.add('hidden'); }

function confirmAddTask(){
  const name = val('modalTaskName')?.trim();
  const date = val('modalTaskDate');
  const time = val('modalTaskTime');
  const err = $('modalError');
  if(!name){ err.style.display='block'; err.innerText='Task name required.'; return; }
  if(!date){ err.style.display='block'; err.innerText='Date required.'; return; }
  if(!time){ err.style.display='block'; err.innerText='Time required.'; return; }
  const iso = parseISO(date, time);
  if(!iso){ err.style.display='block'; err.innerText='Invalid date/time'; return; }
  if(taskEditMode){
    state.boxes[taskEditBox].items[taskEditIndex] = { text:name, iso, done: state.boxes[taskEditBox].items[taskEditIndex].done };
  } else {
    if(currentBox===null){ alert('Open a box first'); return; }
    const b = state.boxes[currentBox];
    if(b.items.length >= 10){ err.style.display='block'; err.innerText='Max 10 tasks'; setTimeout(()=>err.style.display='none',1800); return; }
    b.items.push({ text:name, iso, done:false });
  }
  hideTaskModal(); renderTasks(); renderBoxes(); renderAllTasks(); saveState();
}

function renderTasks(){
  const tbody = $('tasksBody'); if(!tbody) return;
  tbody.innerHTML='';
  const b = state.boxes[currentBox];
  if(!b || b.items.length===0){ tbody.innerHTML = '<tr><td colspan="5" class="muted">No tasks yet. Click Add Task.</td></tr>'; return; }
  b.items.forEach((t,i)=>{
    const d = new Date(t.iso);
    const now = new Date();
    const overdue = (!t.done && d < now);
    const status = t.done ? 'Completed' : (overdue ? 'Overdue' : 'Pending');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><button class="btn small" data-idx="${i}" data-action="complete">Complete</button></td><td>${escape(t.text)}</td><td>${d.toLocaleString()}</td><td>${status}</td><td><button class="btn small secondary" data-action="edit" data-idx="${i}">Edit</button> <button class="btn small danger" data-action="delete" data-idx="${i}">Delete</button></td>`;
    tr.querySelectorAll('button').forEach(btn=>{
      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      if(action === 'complete') btn.addEventListener('click', ()=> handleComplete(currentBox, idx));
      if(action === 'edit') btn.addEventListener('click', ()=> showTaskModal(true, currentBox, idx));
      if(action === 'delete') btn.addEventListener('click', ()=> deleteTask(currentBox, idx));
    });
    tbody.appendChild(tr);
  });
}

function renderAllTasks(){
  const tbody = $('allTasksBody'); if(!tbody) return;
  tbody.innerHTML='';
  state.boxes.forEach((b, bi)=>{
    b.items.forEach((t, ti)=>{
      const tr = document.createElement('tr');
      const d = new Date(t.iso);
      const now = new Date();
      const overdue = (!t.done && d < now);
      const status = t.done ? 'Completed' : (overdue ? 'Overdue' : 'Pending');
      tr.innerHTML = `<td>${escape(b.name)}</td><td>${escape(t.text)}</td><td>${d.toLocaleString()}</td><td>${status}</td><td><button class="btn small" data-bi="${bi}" data-ti="${ti}" data-action="complete">Complete</button> <button class="btn small secondary" data-bi="${bi}" data-ti="${ti}" data-action="edit">Edit</button> <button class="btn small danger" data-bi="${bi}" data-ti="${ti}" data-action="delete">Delete</button></td>`;
      tr.querySelectorAll('button').forEach(btn=>{
        const action = btn.dataset.action;
        const bi = Number(btn.dataset.bi);
        const ti = Number(btn.dataset.ti);
        if(action === 'complete') btn.addEventListener('click', ()=> handleComplete(bi, ti));
        if(action === 'edit') btn.addEventListener('click', ()=> showTaskModal(true, bi, ti));
        if(action === 'delete') btn.addEventListener('click', ()=> deleteTask(bi, ti));
      });
      tbody.appendChild(tr);
    });
  });
}

/* task actions */
function deleteTask(bi, ti){
  if(!confirm('Delete this task?')) return;
  state.boxes[bi].items.splice(ti,1);
  renderTasks(); renderBoxes(); renderAllTasks(); saveState();
}

function handleComplete(bi, ti){
  const t = state.boxes[bi].items[ti];
  if(!t) return;
  const d = new Date(t.iso);
  if(new Date() > d){ alert('You are not able to complete them in time'); return; }
  if(t.done) return;
  t.done = true; renderTasks(); renderBoxes(); renderAllTasks();
  // reward small EXP for completing task (same as before)
  addExp(5);
  saveState();
  // after 5s ask to delete
  setTimeout(()=>{
    const taskNow = state.boxes[bi] && state.boxes[bi].items[ti];
    if(!taskNow) return;
    if(!confirm('Task complete — would you like me to delete it?')) return;
    state.boxes[bi].items.splice(ti,1);
    renderTasks(); renderBoxes(); renderAllTasks(); saveState();
  }, 5000);
}

/* box functions */
function gotoCreateBox2(){
  const name = val('newBoxName')?.trim();
  if(!name){ $('createBoxError').style.display='block'; $('createBoxError').innerText='Enter a name'; setTimeout(()=>$('createBoxError').style.display='none',1600); return; }
  $('createBox1').dataset.name = name;
  hide('createBox1'); show('createBox2');
}
function createBoxFinal(){
  const type = val('recurrenceType') || 'weekly';
  const count = Number(val('recurrenceCount')) || 1;
  const name = $('createBox1').dataset.name || val('newBoxName') || 'Box';
  const box = { id:Date.now(), name, recurrence:{type, count}, items:[] };
  state.boxes.push(box);
  $('newBoxName').value=''; $('recurrenceCount').value='';
  hide('createBox2'); show('dashboard'); renderBoxes(); saveState();
}

function openBox(idx){
  currentBox = idx;
  const b = state.boxes[idx];
  $('boxTitle').innerText = b.name;
  $('boxMeta').innerText = `Duration: ${b.recurrence.type} × ${b.recurrence.count}`;
  hide('dashboard'); show('boxDetail'); renderTasks();
}

function showEditBox(){
  if(currentBox===null) return;
  const b = state.boxes[currentBox];
  $('editBoxName').value = b.name;
  $('editRecurrenceType').value = b.recurrence.type;
  $('editRecurrenceCount').value = b.recurrence.count;
  show('editBoxModal');
}
function hideEditBox(){ hide('editBoxModal'); }
function saveEditBox(){
  const name = val('editBoxName')?.trim();
  const type = val('editRecurrenceType');
  const count = Number(val('editRecurrenceCount')) || 1;
  if(!name) return alert('Name required');
  state.boxes[currentBox].name = name;
  state.boxes[currentBox].recurrence = { type, count };
  hideEditBox(); renderBoxes(); $('boxTitle').innerText = name; $('boxMeta').innerText = `Duration: ${type} × ${count}`;
  saveState();
}
function deleteCurrentBox(){
  if(currentBox===null) return;
  if(!confirm('Delete this box and its tasks?')) return;
  state.boxes.splice(currentBox,1);
  currentBox = null;
  hide('boxDetail'); show('dashboard'); renderBoxes(); renderAllTasks(); saveState();
}

/* ---------- Timer / session persistence ---------- */
let sessionInterval = null;
let elapsedSeconds = 0;
let paused = false;

const moodSet = [
  {emoji:'🧠', text:'Calm focus — warm-up'},
  {emoji:'📚', text:'Deep concentration'},
  {emoji:'⚡', text:'Flow state — productive'},
  {emoji:'😮‍💨', text:'Slightly tired — stretch'},
  {emoji:'🔋', text:'Refreshed — keep going'},
  {emoji:'🏆', text:'Sharp focus — great work'}
];

function startSession(){
  // if session already active, reset or resume? start fresh per user's expectation
  state.session.active = true;
  state.session.startedAt = Date.now();
  state.session.elapsedBefore = 0;
  state.session.paused = false;
  state.session.sessionExp = 0;
  saveState();

  initSessionFromState();
  hide('sessionArea'); hide('congratsArea'); show('timerArea');
}

function initSessionFromState(){
  // initialize variables from state (handles resume after reload)
  clearInterval(sessionInterval);
  paused = !!state.session.paused;
  // compute elapsedSeconds based on startedAt & elapsedBefore
  elapsedSeconds = Number(state.session.elapsedBefore) || 0;
  if(state.session.active && !state.session.paused && state.session.startedAt){
    const since = Math.floor((Date.now() - state.session.startedAt) / 1000);
    elapsedSeconds = (Number(state.session.elapsedBefore) || 0) + since;
  }
  // compute sessionExp (and award missed milestones if app was closed)
  let computedSessionExp = Number(state.session.sessionExp) || 0;
  const prevElapsedBefore = Number(state.session.elapsedBefore) || 0;
  const prevMilestones = Math.floor(prevElapsedBefore / MILESTONE_SECONDS);
  const nowMilestones = Math.floor(elapsedSeconds / MILESTONE_SECONDS);
  const missedMilestones = Math.max(0, nowMilestones - prevMilestones);
  if(missedMilestones > 0){
    const expPer = getExpPerMilestone();
    const totalMissed = missedMilestones * expPer;
    computedSessionExp += totalMissed;
    addExp(totalMissed); // global award
    showExpToast(`+${totalMissed} EXP (while away)`);
  }
  state.session.sessionExp = computedSessionExp;
  saveState();

  // update UI
  $('timerDisplay').innerText = formatTime(elapsedSeconds);
  updateMood(elapsedSeconds);
  $('sessionExpDisplay').innerText = 'Session EXP: ' + state.session.sessionExp;

  if(state.session.active){
    sessionInterval = setInterval(()=>{
      if(!paused){
        elapsedSeconds++;
        $('timerDisplay').innerText = formatTime(elapsedSeconds);
        handleMilestones();
      }
      // persist small amount frequently
      if(elapsedSeconds % 5 === 0){
        state.session.elapsedBefore = elapsedSeconds;
        saveState();
      }
    }, 1000);
  }
  const pbtn = $('pauseBtn'); if(pbtn) pbtn.innerText = paused ? 'Resume' : 'Pause';
}

function handleMilestones(){
  // check if we've hit the next 15min boundary
  if(elapsedSeconds > 0 && elapsedSeconds % MILESTONE_SECONDS === 0){
    const expPer = getExpPerMilestone();
    state.session.sessionExp = (state.session.sessionExp || 0) + expPer;
    addExp(expPer);
    $('sessionExpDisplay').innerText = 'Session EXP: ' + state.session.sessionExp;
    updateMood(elapsedSeconds);
    showExpToast('+' + expPer + ' EXP');
    // persist
    state.session.elapsedBefore = elapsedSeconds;
    saveState();
  }
}

function togglePause(){
  paused = !paused;
  state.session.paused = paused;
  if(paused){
    // when pausing, store elapsedBefore as of now
    state.session.elapsedBefore = elapsedSeconds;
    saveState();
    showSmallToast('Paused');
    const pbtn = $('pauseBtn'); if(pbtn) pbtn.innerText = 'Resume';
  } else {
    // resuming: set startedAt as now - elapsedBefore
    state.session.startedAt = Date.now() - (elapsedSeconds * 1000);
    state.session.paused = false;
    saveState();
    showSmallToast('Resumed');
    const pbtn = $('pauseBtn'); if(pbtn) pbtn.innerText = 'Pause';
  }
}

function stopSession(){
  // stop interval
  if(sessionInterval) clearInterval(sessionInterval);
  sessionInterval = null;
  // mark session inactive and persist final values
  state.session.active = false;
  state.session.startedAt = null;
  state.session.elapsedBefore = elapsedSeconds;
  state.session.paused = false;
  // sessionExp already tracked
  saveState();

  hide('timerArea'); show('congratsArea');
  const totalTime = formatTime(elapsedSeconds);
  const totalExp = state.session.sessionExp || 0;
  $('congratsText').innerText = `You studied for ${totalTime} and earned ${totalExp} EXP this session.`;
  // reset local session record so next session starts fresh (but keep boxes/exp etc)
  state.session = { active:false, startedAt:null, elapsedBefore:0, paused:false, sessionExp:0 };
  saveState();
}

function resetSessionUI(){
  hide('congratsArea'); hide('timerArea'); show('sessionArea');
  $('timerDisplay').innerText = '00:00:00';
  $('moodEmoji').innerText = '🧠'; $('moodText').innerText = 'Ready';
  $('sessionExpDisplay').innerText = 'Session EXP: 0';
  elapsedSeconds = 0; paused = false;
  state.session = { active:false, startedAt:null, elapsedBefore:0, paused:false, sessionExp:0 };
  saveState();
}

function updateMood(elapsed){
  // pick mood based on milestone count (0..)
  const index = Math.min(moodSet.length-1, Math.floor(elapsed / MILESTONE_SECONDS));
  const mood = moodSet[index] || moodSet[moodSet.length-1];
  $('moodEmoji').innerText = mood.emoji;
  $('moodText').innerText = mood.text + (elapsed >= MILESTONE_SECONDS ? ` (after ${Math.floor(elapsed/60)} min)` : '');
}

/* ---------- small UI toasts ---------- */
function showSmallToast(msg){
  const t = document.createElement('div');
  t.style.position='fixed'; t.style.bottom='22px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.padding='10px 14px';
  t.style.borderRadius='12px'; t.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)'; t.style.background='rgba(0,0,0,0.7)'; t.style.color='white'; t.style.zIndex=99999;
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 900);
}
function showExpToast(msg){
  const t = document.createElement('div');
  t.style.position='fixed'; t.style.top='90px'; t.style.right='24px'; t.style.padding='8px 12px'; t.style.borderRadius='10px';
  t.style.background='linear-gradient(90deg,var(--accent),#8b5cf6)'; t.style.color='white'; t.style.fontWeight='700'; t.style.zIndex=99999;
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .4s'; t.style.opacity='0'; setTimeout(()=>t.remove(),400); }, 1400);
}

/* ---------- Utilities ---------- */
function formatTime(s){
  const hh = String(Math.floor(s/3600)).padStart(2,'0');
  const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}
function parseISO(dateStr, timeStr){
  if(!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return null;
  if(!/^\d{2}:\d{2}$/.test(timeStr)) return null;
  const iso = dateStr + 'T' + timeStr + ':00';
  const d = new Date(iso);
  if(isNaN(d.getTime())) return null;
  return d.toISOString();
}
function escape(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* stickers - draws theme-based icons */
function renderStickers(){
  const bg = $('bg'); if(!bg) return;
  bg.innerHTML='';
  const icons = state.user.theme==='cute' ? ['🐱','🎀'] : state.user.theme==='tech' ? ['🤖','💻'] : state.user.theme==='cold' ? ['❄️','🧊'] : ['✨','🌟'];
  for(let i=0;i<30;i++){
    const n = i%icons.length;
    const div = document.createElement('div'); div.className='sticker';
    div.style.left = Math.random()*92 + 'vw';
    div.style.top = Math.random()*92 + 'vh';
    div.style.fontSize = (18 + Math.random()*60) + 'px';
    div.innerText = icons[n];
    bg.appendChild(div);
  }
}

/* ---------- Header actions (Study Counter button appears only when experienceCreated) ---------- */
function setupHeaderActions(){
  const ha = $('headerActions'); if(!ha) return;
  ha.innerHTML='';
  if(!state.user.experienceCreated) return;
  const sc = document.createElement('button'); sc.className='btn secondary small'; sc.innerText='Study Counter';
  sc.addEventListener('click', ()=>{ hideAll(); show('studyCounterMenu'); });
  ha.appendChild(sc);
}

/* ---------- Life-cycle: load, init, save ---------- */
function init(){
  // load saved state
  loadState();

  // wire up controls
  $('btnContinue').addEventListener('click', onContinue);
  $('btnReset').addEventListener('click', onReset);
  $('purposeStudy').addEventListener('click', ()=>selectPurpose('Study'));
  $('purposeOther').addEventListener('click', ()=>selectPurpose('Other'));
  $('tCute').addEventListener('click', ()=>selectTheme('cute'));
  $('tTech').addEventListener('click', ()=>selectTheme('tech'));
  $('tCold').addEventListener('click', ()=>selectTheme('cold'));
  $('btnFinish').addEventListener('click', finishSetup);

  $('btnCreateBox').addEventListener('click', ()=>{ hide('dashboard'); show('createBox1'); });
  $('toCreateBox2').addEventListener('click', gotoCreateBox2);
  $('createBoxBtn').addEventListener('click', createBoxFinal);
  $('cancelCreateBox1').addEventListener('click', ()=>{ hide('createBox1'); show('dashboard'); });
  $('cancelCreateBox2').addEventListener('click', ()=>{ hide('createBox2'); show('dashboard'); });

  $('backToDashboard').addEventListener('click', ()=>{ currentBox=null; hide('boxDetail'); show('dashboard'); renderBoxes(); });

  $('btnAddTask').addEventListener('click', ()=>{ showTaskModal(); });
  $('modalCancel').addEventListener('click', hideTaskModal);
  $('modalAdd').addEventListener('click', confirmAddTask);

  $('btnEditBox').addEventListener('click', showEditBox);
  $('editCancel').addEventListener('click', hideEditBox);
  $('editSave').addEventListener('click', saveEditBox);
  $('btnDeleteBox').addEventListener('click', deleteCurrentBox);

  const startBtn = $('startSessionBtn'); if(startBtn) startBtn.addEventListener('click', startSession);
  const pauseBtn = $('pauseBtn'); if(pauseBtn) pauseBtn.addEventListener('click', togglePause);
  const stopBtn = $('stopBtn'); if(stopBtn) stopBtn.addEventListener('click', stopSession);
  const startAgainBtn = $('startAgainBtn'); if(startAgainBtn) startAgainBtn.addEventListener('click', resetSessionUI);
  const backFromStudyBtn = $('backFromStudyBtn');
  // Pet game quit -> go back to Study Counter Menu
  const petQuit = $('petQuitBtn');
  if (petQuit) petQuit.addEventListener('click', () => {
    if (confirm('Quit pet study?')) {
      hide('petStudyPage');
      show('studyCounterMenu');
    }
  }); if(backFromStudyBtn) backFromStudyBtn.addEventListener('click', ()=>{ hide('studyCounterPage'); show('dashboard'); renderBoxes(); setupHeaderActions(); });

  
  
  // --- Study Counter Menu buttons ---
  const afkBtn = $('modeAfk');
  if (afkBtn) afkBtn.addEventListener('click', () => {
    hideAll(); show('studyCounterPage');
    if (state.session.active) {
      hide('sessionArea'); show('timerArea'); initSessionFromState();
    } else {
      hide('timerArea'); hide('congratsArea'); show('sessionArea');
    }
  });

  const chalBtn = $('modeChallenges');
  if (chalBtn) chalBtn.addEventListener('click', () => {
    hideAll(); show('challengesPage'); renderChallengesList();
  });

  const petBtn = $('modePet');
  if (petBtn) petBtn.addEventListener('click', () => {
    hideAll(); show('petStudyPage');
  });

  const backMenuBtn = $('backFromMenuBtn');
  if (backMenuBtn) backMenuBtn.addEventListener('click', () => {
    hide('studyCounterMenu'); show('dashboard'); renderBoxes(); setupHeaderActions();
  });
// Render challengers list
  function renderChallengesList(){
    const list = $('challengersList');
    if(!list) return;
    list.innerHTML='';
    const challengers = [
      { id:'jash', name:'CEO Jashandeep', desc:'10 GK questions — unbeatable', icon:'🧠' },
      { id:'emoji', name:'Emoji Battle', desc:'Guess emojis and win EXP', icon:'😊' },
      { id:'ai', name:'AI Calculator', desc:'Speed math — AI is fast', icon:'🤖' }
    ];
    challengers.forEach(c=>{
      const div = document.createElement('div');
      div.className='box-card';
      div.style.cursor='pointer';
      div.innerHTML = `<div style="font-size:28px;">${c.icon}</div><div style="font-weight:800;margin-top:6px;">${c.name}</div><div class="muted" style="margin-top:6px;">${c.desc}</div><div style="margin-top:8px;"><button class="btn small" data-id="${c.id}">Challenge</button></div>`;
      div.querySelector('button').addEventListener('click', ()=>{
        if(c.id==='jash') startJashBattle();
        if(c.id==='emoji') startEmojiBattle();
        if(c.id==='ai') startAiBattle();
      });
      list.appendChild(div);
    });
  }

  // --------- Jashandeep GK Battle ---------
  const jashQuestions = [
    {q:'What is the capital of France?', opts:['Paris','Rome','Berlin','Madrid'], a:0},
    {q:'Which planet is known as the Red Planet?', opts:['Venus','Mars','Jupiter','Saturn'], a:1},
    {q:'Who wrote "Romeo and Juliet"?', opts:['Shakespeare','Hemingway','Tolkien','Chaucer'], a:0},
    {q:'What is the largest ocean on Earth?', opts:['Atlantic','Indian','Pacific','Arctic'], a:2},
    {q:'In which year did India gain independence?', opts:['1947','1937','1950','1960'], a:0},
    {q:'What is H2O commonly known as?', opts:['Salt','Water','Oxygen','Hydrogen'], a:1},
    {q:'Who painted the Mona Lisa?', opts:['Van Gogh','Picasso','Da Vinci','Rembrandt'], a:2},
    {q:'What is the smallest prime number?', opts:['0','1','2','3'], a:2},
    {q:'Which gas do plants absorb?', opts:['Nitrogen','Oxygen','Carbon Dioxide','Helium'], a:2},
    {q:'What is the currency of Japan?', opts:['Yen','Dollar','Euro','Won'], a:0}
  ];
  let jashState = { idx:0, jashScore:0, userScore:0, userAnswered:false };


// helper to shuffle arrays
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=a[i]; a[i]=a[j]; a[j]=t; } return a; }

  function startJashBattle(){
    jashState = { idx:0, jashScore:0, userScore:0, userAnswered:false };
    // use shuffled questions list
    if(Array.isArray(jashQuestions)){
      jashState.questions = shuffleArray(jashQuestions.slice());
    } else { jashState.questions = []; }
    hideAll(); show('jashBattlePage');
    renderJashQuestion();
  }

  
function renderJashQuestion(){
    var i = (jashState && typeof jashState.idx === 'number') ? jashState.idx : 0;
    var list = (jashState && Array.isArray(jashState.questions)) ? jashState.questions : (Array.isArray(jashQuestions) ? jashQuestions : []);
    if(i >= list.length){ finishJashBattle(); return; }
    var q = list[i];
    if($('jashQuestionNum')) $('jashQuestionNum').innerText = 'Question ' + (i+1) + ' / ' + list.length;
    if($('jashQuestionText')) $('jashQuestionText').innerText = q.q;
    var opts = $('jashOptions'); if(opts) opts.innerHTML='';
    // clear previous timers
    if(jashState._aiTimer){ clearTimeout(jashState._aiTimer); jashState._aiTimer = null; }
    if(jashState._timeoutId){ clearTimeout(jashState._timeoutId); jashState._timeoutId = null; }
    if(jashState._advanceTimer){ clearTimeout(jashState._advanceTimer); jashState._advanceTimer = null; }

    jashState._userAnswered = false;
    jashState._aiAnswered = false;
    jashState._moving = false;

    function advanceSoon(delay){
      if(typeof delay !== 'number') delay = 100;
      if(jashState._moving) return;
      jashState._moving = true;
      jashState._advanceTimer = setTimeout(function(){
        jashState.idx = (jashState.idx||0) + 1;
        renderJashQuestion();
      }, delay);
    }

    // render options
    if(Array.isArray(q.opts)){
      q.opts.forEach(function(o, oi){
        var btn = document.createElement('button');
        btn.className='btn small';
        btn.style.width='100%';
        btn.innerText = o;
        btn.dataset.idx = oi;
        btn.addEventListener('click', function(){
          if(jashState._userAnswered) return;
          jashState._userAnswered = true;
          if(Number(btn.dataset.idx) === q.a){
            jashState.userScore = (jashState.userScore||0) + 1;
            if($('userScore')) $('userScore').innerText = 'Score: ' + jashState.userScore;
            showSmallToast('+1');
          } else {
            showSmallToast('Wrong');
          }
          // advance immediately on user answer (no waiting)
          advanceSoon(80);
        });
        if(opts) opts.appendChild(btn);
      });
    }

    // AI answers quickly and we advance immediately when it reveals
    if($('jashAnswerArea')) $('jashAnswerArea').innerText = 'AI is answering...';
    jashState._aiTimer = setTimeout(function(){
      jashState._aiAnswered = true;
      if($('jashAnswerArea')) $('jashAnswerArea').innerHTML = '<div style="font-weight:800;">' + q.opts[q.a] + '</div>';
      jashState.jashScore = (jashState.jashScore||0) + 1;
      if($('jashScore')) $('jashScore').innerText = 'Score: ' + jashState.jashScore;
      // advance immediately upon AI reveal
      advanceSoon(80);
    }, 800);

    // safety fallback
    jashState._timeoutId = setTimeout(function(){
      advanceSoon(80);
    }, 5000);
  }
function finishJashBattle(){
    // ensure Jash is unbeatable: if user somehow got equal or greater score, reduce it so CPU wins
    if(jashState.userScore >= jashState.jashScore){
      jashState.userScore = Math.max(0, jashState.jashScore - 1);
      $('userScore').innerText = 'Score: ' + jashState.userScore;
    }
    const resultArea = $('jashResultArea');
    resultArea.innerHTML = `<div class="box-card"><div style="font-weight:800;">Battle finished</div><div class="muted" style="margin-top:6px;">Jashandeep: ${jashState.jashScore} — You: ${jashState.userScore}</div><div style="margin-top:8px;"><button class="btn" id="jashBackBtn">Back to Challenges</button></div></div>`;
    const backBtn = $('jashBackBtn'); if(backBtn) backBtn.addEventListener('click', ()=>{ hide('jashBattlePage'); show('challengesPage'); renderChallengesList(); });
  }

  // Jash quit
  const jashQuit = $('jashQuitBtn'); if(jashQuit) jashQuit.addEventListener('click', ()=>{ if(confirm('Quit challenge?')){ hide('jashBattlePage'); show('challengesPage'); renderChallengesList(); } });

  
  // --------- Emoji Battle ---------
  
  const emojiCombos = [
    {combo:['🦁','👑'], answer:'Lion King', options:['Lion King','Zoo','Crown']},
    {combo:['🚀','🌕'], answer:'Moon Mission', options:['Moon Mission','Airport','Star Wars']},
    {combo:['🍔','🍟','🥤'], answer:'Fast Food Meal', options:['Fast Food Meal','Picnic','Healthy Diet']},
    {combo:['🕷️','🕸️','🦸'], answer:'Spiderman', options:['Spiderman','Batman','Superman']},
    {combo:['🐍','⚡'], answer:'Harry Potter', options:['Harry Potter','Snake Power','Magic Show']},
    {combo:['🧊','👑'], answer:'Frozen', options:['Frozen','Winter King','Snow']},
    {combo:['🐭','🧀'], answer:'Tom and Jerry', options:['Tom and Jerry','Cheese Mouse','Rat King']},
    {combo:['🌊','🧜‍♀️'], answer:'Little Mermaid', options:['Little Mermaid','Aquaman','Sea Queen']},
    {combo:['🐉','🔥'], answer:'Dragon', options:['Dragon','Lizard','Phoenix']},
    {combo:['🦸','🛡️'], answer:'Captain America', options:['Captain America','Iron Man','Thor']},
    {combo:['⚡','⚔️'], answer:'Thor', options:['Thor','Zeus','Hercules']},
    {combo:['🦇','🌃'], answer:'Batman', options:['Batman','Vampire','Spooky']},
    {combo:['💍','🌋'], answer:'Lord of the Rings', options:['Lord of the Rings','Volcano Treasure','Magic Ring']},
    {combo:['🧙','🧝'], answer:'Hobbit', options:['Hobbit','Wizard School','Fairy Tale']},
    {combo:['👽','🚀'], answer:'Alien Invasion', options:['Alien Invasion','Space Trip','UFO Sight']},
    {combo:['🍎','🐍'], answer:'Adam and Eve', options:['Adam and Eve','Poison Apple','Snake Game']},
    {combo:['🐼','🎋'], answer:'Kung Fu Panda', options:['Kung Fu Panda','Panda Zoo','Bamboo Life']},
    {combo:['🦖','🏞️'], answer:'Jurassic Park', options:['Jurassic Park','Zoo','Fossils']},
    {combo:['👑','❄️'], answer:'Ice Queen', options:['Ice Queen','Frozen','Snow Queen']},
    {combo:['🦸','🤖'], answer:'Iron Man', options:['Iron Man','Robocop','Transformer']},
    {combo:['🧛','🩸'], answer:'Dracula', options:['Dracula','Vampire Diaries','Blood King']},
    {combo:['🎃','👻'], answer:'Halloween', options:['Halloween','Christmas','Easter']},
    {combo:['🎄','🎅'], answer:'Christmas', options:['Christmas','Eid','Halloween']},
    {combo:['🐯','🐻'], answer:'Jungle Book', options:['Jungle Book','Zoo Tales','Wild Life']},
    {combo:['🧞','🕌'], answer:'Aladdin', options:['Aladdin','Arabian Nights','Magic Genie']},
    {combo:['🏹','💘'], answer:'Cupid', options:['Cupid','Hunter','Archer']},
    {combo:['🦸','🦸‍♀️'], answer:'Avengers', options:['Avengers','Justice League','Superheroes']},
    {combo:['🌋','🌊'], answer:'Disaster', options:['Disaster','Tsunami','Volcano']},
    {combo:['🏰','🐉'], answer:'Dragon Castle', options:['Dragon Castle','Haunted House','Royal Palace']},
    {combo:['🧑‍🚀','🛰️'], answer:'Astronaut', options:['Astronaut','Pilot','Engineer']},
    {combo:['🐴','🏇'], answer:'Horse Racing', options:['Horse Racing','Cowboy','Farm']},
    {combo:['🍫','🥛'], answer:'Chocolate Milk', options:['Chocolate Milk','Milkshake','Hot Cocoa']},
    {combo:['👑','🦸'], answer:'Black Panther', options:['Black Panther','King Hero','Super King']},
    {combo:['🐧','❄️'], answer:'Happy Feet', options:['Happy Feet','Penguin Story','Ice Age']},
    {combo:['🦊','🌲'], answer:'Zootopia', options:['Zootopia','Jungle Life','Wild Forest']},
    {combo:['🐝','🍯'], answer:'Bee Movie', options:['Bee Movie','Honey Life','Winnie the Pooh']},
    {combo:['🧊','🧊'], answer:'Ice Age', options:['Ice Age','Frozen','Winter']},
    {combo:['🦈','🌊'], answer:'Jaws', options:['Jaws','Shark Attack','Sea Monster']},
    {combo:['👑','🧒'], answer:'Lion King Jr.', options:['Lion King Jr.','Prince','Young King']},
    {combo:['⚔️','👑'], answer:'Game of Thrones', options:['Game of Thrones','King Fight','Throne War']},
    {combo:['🧟','🌃'], answer:'Zombie Night', options:['Zombie Night','Walking Dead','Scary Movie']},
    {combo:['🧝','🏹'], answer:'Legolas', options:['Legolas','Elf Warrior','Forest Archer']},
    {combo:['🧙','⚡'], answer:'Wizard', options:['Wizard','Harry Potter','Magic']},
    {combo:['🐻','🍯'], answer:'Winnie the Pooh', options:['Winnie the Pooh','Bear Life','Sweet Bear']},
    {combo:['🦜','🏝️'], answer:'Pirates', options:['Pirates','Treasure Island','Jungle']},
    {combo:['🕵️','🔎'], answer:'Detective', options:['Detective','Spy','Investigator']},
    {combo:['👩‍🚀','🌌'], answer:'Space Explorer', options:['Space Explorer','Alien','Galaxy Hero']},
    {combo:['🦸‍♂️','🦸‍♀️','🛡️'], answer:'Justice League', options:['Justice League','Avengers','X-Men']},
  ];


  let emojiState = { idx:0 };

  function startEmojiBattle(){
    emojiState.idx = 0;
    hideAll(); show('emojiBattlePage');
    renderEmojiQuestion();
  }

  function renderEmojiQuestion(){
    if(emojiState.idx >= emojiCombos.length){
      $('emojiChallengeArea').innerHTML = '';
      $('emojiOptions').innerHTML = '';
      $('emojiResult').innerHTML = `<div class='box-card'><div style='font-weight:800;'>Finished!</div><div class='muted'>Correct: ${emojiState.correct || 0} | Incorrect: ${emojiState.incorrect || 0}</div><div style='margin-top:10px; display:flex; gap:10px;'><button class='btn' id='emojiRetryBtn'>Retry</button><button class='btn secondary' id='emojiBackBtn'>Back to Challenges</button></div></div>`;
      $('emojiRetryBtn').addEventListener('click', ()=> startEmojiBattle());
      $('emojiBackBtn').addEventListener('click', ()=>{ hide('emojiBattlePage'); show('challengesPage'); });
      return;
    }
    const q = emojiCombos[emojiState.idx];
    $('emojiChallengeArea').innerText = q.combo.join(' + ');
    const opts = $('emojiOptions'); opts.innerHTML='';
    shuffleArray(q.options.slice()).forEach(opt=>{
      const btn = document.createElement('button');
      btn.className='btn small';
      btn.innerText = opt;
      btn.addEventListener('click', ()=>{
        if(opt===q.answer){
          addExp(2);
          showSmallToast('+2 EXP');
        } else {
          showSmallToast('Wrong');
        }
        emojiState.idx++;
        renderEmojiQuestion();
      });
      opts.appendChild(btn);
    });
  }

  const emojiQuit = $('emojiQuitBtn'); if(emojiQuit) emojiQuit.addEventListener('click', ()=>{ hide('emojiBattlePage'); show('challengesPage'); });

  // --------- AI Calculator Battle ---------
  let aiState = { idx:0, aiScore:0, userScore:0, problems:[] };

  function generateProblems(n){
    const arr = [];
    for(let i=0;i<n;i++){
      const a = Math.floor(Math.random()*20)+1;
      const b = Math.floor(Math.random()*20)+1;
      const op = ['+','-','*'][Math.floor(Math.random()*3)];
      let ans = op==='+'? a+b : op==='-'? a-b : a*b;
      arr.push({q:`${a} ${op} ${b}`, ans});
    }
    return arr;
  }

  function startAiBattle(){
    aiState = { idx:0, aiScore:0, userScore:0, problems: generateProblems(7) };
    hideAll(); show('aiBattlePage');
    renderAiQuestion();
  }

  function renderAiQuestion(){
    const i = aiState.idx;
    if(i >= aiState.problems.length){ finishAiBattle(); return; }
    const p = aiState.problems[i];
    $('aiQuestionNum').innerText = `Problem ${i+1} / ${aiState.problems.length}`;
    $('aiQuestionText').innerText = p.q;
    // AI answers instantly
    setTimeout(()=>{
      aiState.aiScore++;
      $('aiScore').innerText = 'Score: ' + aiState.aiScore;
    }, 800);
    // wait for user input (Enter)
    const input = $('aiUserAnswer'); input.value='';
    input.focus();
    function onKey(e){
      if(e.key==='Enter'){
        const v = input.value.trim();
        if(v==='') return;
        if(Number(v) === p.ans){ aiState.userScore++; $('aiUserScore').innerText = 'Score: ' + aiState.userScore; showSmallToast('+1'); }
        else { showSmallToast('Wrong'); }
        input.removeEventListener('keydown', onKey);
        aiState.idx++;
        setTimeout(renderAiQuestion, 600);
      }
    }
    input.addEventListener('keydown', onKey);
    // if user doesn't answer in 4000ms, move on
    setTimeout(()=>{
      input.removeEventListener('keydown', onKey);
      if(aiState.idx === i) { aiState.idx++; renderAiQuestion(); }
    }, 4000);
  }

  function finishAiBattle(){
    // ensure AI wins (if tie or AI loses, nudge result)
    if(aiState.userScore >= aiState.aiScore){ aiState.userScore = Math.max(0, aiState.aiScore - 1); $('aiUserScore').innerText = 'Score: ' + aiState.userScore; }
    $('aiResultArea').innerHTML = `<div class="box-card"><div style="font-weight:800;">AI Battle finished</div><div class="muted" style="margin-top:6px;">AI: ${aiState.aiScore} — You: ${aiState.userScore}</div><div style="margin-top:8px;"><button class="btn" id="aiBackBtn">Back to Challenges</button></div></div>`;
    const backBtn = $('aiBackBtn'); if(backBtn) backBtn.addEventListener('click', ()=>{ hide('aiBattlePage'); show('challengesPage'); renderChallengesList(); });
  }

  const aiQuit = $('aiQuitBtn'); if(aiQuit) aiQuit.addEventListener('click', ()=>{ if(confirm('Quit challenge?')){ hide('aiBattlePage'); show('challengesPage'); renderChallengesList(); } });


  // Ensure mode-card clicks are bound (cards use modeAfk/modeChallenges/modeComingSoon)
  const modeAfkEl = $('modeAfk'); if(modeAfkEl) modeAfkEl.addEventListener('click', ()=>{
    hideAll(); show('studyCounterPage');
    if(state.session.active){ hide('sessionArea'); show('timerArea'); initSessionFromState(); }
    else { hide('timerArea'); hide('congratsArea'); show('sessionArea'); }
  });
  const modeChallengesEl = $('modeChallenges'); if(modeChallengesEl) modeChallengesEl.addEventListener('click', ()=>{
    hideAll(); show('challengesPage'); renderChallengesList();
  });
  const modeComingEl = $('modeComingSoon'); if(modeComingEl) modeComingEl.addEventListener('click', ()=>{
    hideAll(); show('studyCounterMenu'); alert('Coming soon — stay tuned!');
  });
  // Also keep backwards-compatible buttons (if present) functional
  const legacyAfk = $('btnAfkMode'); if(legacyAfk) legacyAfk.addEventListener('click', ()=>{ hideAll(); show('studyCounterPage'); if(state.session.active){ hide('sessionArea'); show('timerArea'); initSessionFromState(); } else { hide('timerArea'); hide('congratsArea'); show('sessionArea'); } });
  const legacyChal = $('btnChallengesMode'); if(legacyChal) legacyChal.addEventListener('click', ()=>{ hideAll(); show('challengesPage'); renderChallengesList(); });
  const legacySoon = $('btnComingSoonMode'); if(legacySoon) legacySoon.addEventListener('click', ()=>{ hideAll(); show('studyCounterMenu'); alert('Coming soon — stay tuned!'); });
// initial UI state
  hideAll();
  show('stepName');
  renderStickers();
  updateStudyBar();
  applyTheme(state.user.theme || 'cute');
  renderBoxes();

  if(state.user && state.user.name){
    $('name').value = state.user.name; $('age').value = state.user.age || '';
    hideAll(); show('dashboard'); updateLogo(true); renderBoxes();
  }

  // study UI visibility depends on experienceCreated
  renderStudyUiVisibility();

  // if there's a saved active session, restore in study page state
  if(state.session && state.session.active){
    // ensure Study Counter is available
    state.user.experienceCreated = true;
    renderStudyUiVisibility();
  }

  // show dashboard if user restored
  if(state.user.name && (state.user.experienceCreated || state.boxes.length>0)){
    hideAll(); show('dashboard');
  }
}

/* hide helper excludes pages we don't want */

function hideAll(){
  const ids = [
    'stepName','stepCustomize','dashboard','createBox1','createBox2','boxDetail',
    'studyCounterPage','studyCounterMenu','challengesPage','jashBattlePage',
    'emojiBattlePage','aiBattlePage','petStudyPage','petGameArea','petSelectArea',
    'taskModal','editBoxModal','congratsArea','timerArea','sessionArea','allTasks'
  ];
  ids.forEach(id=>{ const el=$(id); if(el) el.classList.add('hidden'); });
}
/* Continue & setup */
function onContinue(){
  const n = val('name')?.trim();
  const a = val('age');
  if(!n || !a){ $('nameError').style.display='block'; $('nameError').innerText='Please enter name and age.'; setTimeout(()=>$('nameError').style.display='none',2000); return; }
  state.user.name = n; state.user.age = Number(a);
  $('greet').innerText = `Hello ${state.user.name}, customize your experience`;
  hide('stepName'); show('stepCustomize'); updateLogo(false);
  saveState();
}

function onReset(){
  if(!confirm('Reset all app data?')) return;
  state = {
    user: { name:'', age:0, purpose:'', theme:'', experienceCreated:false, title:'' },
    boxes: [], exp:0, level:0,
    session: { active:false, startedAt:null, elapsedBefore:0, paused:false, sessionExp:0 }
  };
  document.body.className='';
  applyTheme('cute');
  updateLogo(false);
  hideAll(); show('stepName'); renderBoxes(); renderStickers(); updateStudyBar();
  saveState();
}

function selectPurpose(p){
  state.user.purpose = p;
  ['purposeStudy','purposeOther'].forEach(id=> { const el=$(id); if(el) el.classList.remove('selected-red'); });
  if(p==='Study') $('purposeStudy').classList.add('selected-red');
  else $('purposeOther').classList.add('selected-red');
  saveState();
}

function selectTheme(t){
  state.user.theme = t;
  ['tCute','tTech','tCold'].forEach(id=> { const el=$(id); if(el) el.classList.remove('selected-red'); });
  if(t==='cute') $('tCute').classList.add('selected-red');
  if(t==='tech') $('tTech').classList.add('selected-red');
  if(t==='cold') $('tCold').classList.add('selected-red');
  applyTheme(t);
  updateLogo(false);
  saveState();
}

function updateLogo(showInitials){
  const logo = $('logo');
  if(showInitials && state.user.name){
    const parts = state.user.name.trim().split(/\s+/);
    const initials = parts.length>1 ? (parts[0][0]+parts[1][0]) : parts[0].slice(0,2);
    logo.innerText = initials.toUpperCase();
    logo.style.background = '#111'; logo.style.color='#fff';
  } else {
    if(state.user.theme==='cute'){ logo.innerText='💖'; logo.style.background='linear-gradient(180deg,#ff8fbf,#ff6aa2)'; logo.style.color='white'; }
    else if(state.user.theme==='tech'){ logo.innerText='🤖'; logo.style.background='linear-gradient(180deg,#00aaff,#0066ff)'; logo.style.color='white'; }
    else if(state.user.theme==='cold'){ logo.innerText='❄️'; logo.style.background='linear-gradient(180deg,#5cd6ff,#2bb7ff)'; logo.style.color='white'; }
    else { logo.innerText='✨'; logo.style.background='linear-gradient(180deg,#f0f0f0,#e6e6e6)'; logo.style.color='#333'; }
  }
}

/* finish setup */
function finishSetup(){
  if(!state.user.name) return onContinue();
  if(!state.user.theme) selectTheme('cute');
  hide('stepCustomize'); show('dashboard'); updateLogo(true);
  // mark experience created now (makes study UI visible)
  state.user.experienceCreated = true;
  state.user.title = computeTitleForLevel(state.level);
  renderStudyUiVisibility();
  renderBoxes();
  saveState();
}


function showBattleResultPopup(winner){
  // create modal (re-uses .modal/.modal-card styles already in your CSS)
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'battleResultModal';
  modal.style.zIndex = 200000;

  const earned = (winner === 'You') ? 15 : 0; // victory = 15 EXP
  const title = (winner === 'You') ? 'Victory!' : 'Defeat';
  const msg = (winner === 'You') ? `You earned ${earned} EXP` : `You earned ${earned} EXP`;

  modal.innerHTML = `<div class="modal-card" style="max-width:420px;">
    <h3 style="margin:0;">${title}</h3>
    <div class="muted" style="margin-top:8px;">${msg}</div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn" id="brRetry">Retry</button>
      <button class="btn secondary" id="brBack">Back</button>
      <button class="btn small" id="brDownload">Download</button>
    </div>
  </div>`;

  document.body.appendChild(modal);

  // award EXP (only once)
  if(earned > 0){
    addExp(earned);
    showExpToast('+' + earned + ' EXP');
  }

  // Back -> go to challenges
  document.getElementById('brBack').addEventListener('click', ()=>{
    const m = document.getElementById('battleResultModal');
    if(m) m.remove();
    hide('roastBattlePage'); show('challengesPage'); renderChallengesList();
  });

  // Retry -> re-start roast
  document.getElementById('brRetry').addEventListener('click', ()=>{
    const m = document.getElementById('battleResultModal');
    if(m) m.remove();
    startRoastBattle();
  });

  // Download -> create a small text file with history & result
  document.getElementById('brDownload').addEventListener('click', ()=>{
    const lines = [];
    lines.push(`Roast Battle Result: ${title}`);
    lines.push(`Earned EXP: ${earned}`);
    lines.push('');
    lines.push('History:');
    roastState.history.forEach((h, idx)=>{
      lines.push(`R${idx+1} — Khushi: ${h.k} | You: ${h.u}`);
    });
    const blob = new Blob([lines.join('\n')], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'roast_battle_result.txt';
    a.click();
    URL.revokeObjectURL(url);
  });
}
/* ---------- init DOM ---------- */
document.addEventListener('DOMContentLoaded', init);

/* Expose manual save for debugging */
window._saveState = saveState;

// ---- Robust Pet State Init ----
var petState = { selected:null, order:[], qIndex:0, answered:0, points:0, evolution:0 };
try {
  const saved = localStorage.getItem('chosenPet');
  if(saved) petState.selected = saved;
} catch(e){}

// ---- startPetMode (robust) ----
function startPetMode(){
  try {
    if(typeof hideAll==='function') hideAll();
    if(typeof show==='function') show('petStudyPage');
    const sel = document.getElementById('petSelectArea');
    const game = document.getElementById('petGameArea');

    if(petState && petState.selected){
      if(sel) sel.style.display = 'none';
      if(game){ game.style.display = ''; game.classList.remove('hidden'); }
      beginGameWith(petState.selected);
    } else {
      if(sel){ sel.style.display = ''; sel.classList.remove('hidden'); }
      if(game){ game.style.display = 'none'; game.classList.add('hidden'); }
    }

    const speech = document.getElementById('petSpeech');
    if(speech) speech.innerText = 'hlo 👋';
    if(typeof renderPetUI==='function') renderPetUI();
  } catch(e){
    console.error('startPetMode error', e);
  }
}

// Expose globally
window.startPetMode = startPetMode;

// ---- Wire event listener after DOM ready ----
(function(){
  function wirePetCard(){
    var modeCard = document.getElementById('modePet');
    if(modeCard){
      modeCard.removeEventListener('click', startPetMode);
      modeCard.addEventListener('click', startPetMode);
    }
  }
  if(document.readyState==='complete' || document.readyState==='interactive'){
    wirePetCard();
  } else {
    document.addEventListener('DOMContentLoaded', wirePetCard);
  }
})();

</script>

<!-- RUNTIME OVERRIDES v4 -->

<script>
(function(){
  // Final robust Pet Mode module (v17)
  const STORAGE_CHOSEN_PET = 'chosenPet';
  const STORAGE_STATE = 'chosenPetState_v1';

  // Ensure PET_QUESTIONS exists (use existing if present, else generate 100 placeholders)
  if(typeof PET_QUESTIONS === 'undefined' || !Array.isArray(PET_QUESTIONS) || PET_QUESTIONS.length < 1){
    var PET_QUESTIONS = [];
    for(var i=1;i<=100;i++){
      PET_QUESTIONS.push({
        q: 'What is ' + i + ' + ' + i + '?',
        opts: [ (i+i).toString(), (i+i+1).toString(), (i+i-1).toString(), (i+i+2).toString() ],
        a: 0
      });
    }
  }

  // helper $ and show/hide fallbacks
  const $ = id => document.getElementById(id);
  const show = (typeof window.show === 'function') ? window.show : (id => { const el = $(id); if(el) el.classList.remove('hidden'); });
  const hide = (typeof window.hide === 'function') ? window.hide : (id => { const el = $(id); if(el) el.classList.add('hidden'); });

  function shuffleArray(arr){
    for(var i=arr.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=arr[i]; arr[i]=arr[j]; arr[j]=t; }
  }

  // Load all persisted pet states (map by petKey)
  function loadAllStates(){
    try{
      var raw = localStorage.getItem(STORAGE_STATE);
      if(!raw) return {};
      return JSON.parse(raw) || {};
    }catch(e){ return {}; }
  }
  function saveAllStates(obj){
    try{ localStorage.setItem(STORAGE_STATE, JSON.stringify(obj)); }catch(e){}
  }

  // petState is the currently-active pet's state (kept in-memory)
  var petState = { selected:null, order:[], qIndex:0, answered:0, points:0, evolution:0 };

  // restore chosen pet reference if any
  try{ var savedPet = localStorage.getItem(STORAGE_CHOSEN_PET); if(savedPet) petState.selected = savedPet; }catch(e){}

  function persistPetState(){
    try{
      if(!petState || !petState.selected) return;
      var all = loadAllStates();
      all[petState.selected] = {
        order: petState.order,
        qIndex: petState.qIndex,
        answered: petState.answered,
        points: petState.points,
        evolution: petState.evolution
      };
      saveAllStates(all);
      try{ localStorage.setItem(STORAGE_CHOSEN_PET, petState.selected); }catch(e){}
    }catch(e){ console && console.error && console.error('persistPetState err', e); }
  }

  function loadPersistedForPet(petKey){
    try{
      if(!petKey) return null;
      var all = loadAllStates();
      return all[petKey] || null;
    }catch(e){ return null; }
  }

  // UI rendering
  function renderPetUI(){
    try{
      var disp = $('petDisplay');
      var pointsEl = $('petPoints');
      var answeredEl = $('petAnswered');
      var stageEl = $('petStage');
      if(disp && petState.selected){
        var PET_ICONS = { cat:['🐱','😺','🐈','😸','😻'], dino:['🦖','🦕','🐲','🐉','🌋'], robot:['🤖','⚙️','🔧','🛠️','🚀'] };
        var icons = PET_ICONS[petState.selected] || PET_ICONS.cat;
        var stage = Math.min(Math.floor((petState.answered||0)/10), icons.length-1);
        disp.innerText = icons[stage] || icons[0];
        if(stage>0) disp.classList.add('pet-evolved'); else disp.classList.remove('pet-evolved');
      }
      if(pointsEl) pointsEl.innerText = petState.points||0;
      if(answeredEl) answeredEl.innerText = (petState.answered||0) + '/' + (PET_QUESTIONS.length||0);
      if(stageEl) stageEl.innerText = Math.min(Math.floor((petState.answered||0)/10), 10);

      var labelEl = $('petLabel');
      if(labelEl){
        var nameMap = {cat:'Cat', dino:'Dinosaur', robot:'Robot'};
        var emoji = (petState.selected && PET_ICONS && PET_ICONS[petState.selected] && PET_ICONS[petState.selected][0]) ? PET_ICONS[petState.selected][0] : '';
        labelEl.innerText = 'Your pet: ' + (emoji ? (emoji + ' ') : '') + (nameMap[petState.selected] || (petState.selected || '—'));
      }
    }catch(e){ console && console.error && console.error('renderPetUI err', e); }
  }

  // Load current question into UI
  function loadPetQuestion(){
    try{
      var fb = $('petFeedback'); if(fb) fb.innerText = '';
      var qNumEl = $('petQuestionNum');
      var qTextEl = $('petQuestionText');
      var optsEl = $('petOptions');
      if(!qNumEl || !qTextEl || !optsEl) return;
      if(!petState.order || petState.order.length === 0){
        petState.order = Array.from({length: PET_QUESTIONS.length}, (_,i)=>i);
        shuffleArray(petState.order);
      }
      if(typeof petState.qIndex === 'undefined') petState.qIndex = 0;
      if(petState.qIndex >= petState.order.length){
        qNumEl.innerText = 'Completed';
        qTextEl.innerText = 'You have finished the pet questions.';
        optsEl.innerHTML = '';
        persistPetState();
        return;
      }
      var qIndexLocal = petState.qIndex;
      var qId = petState.order[qIndexLocal];
      var q = PET_QUESTIONS[qId];
      qNumEl.innerText = 'Question ' + (qIndexLocal+1) + ' / ' + petState.order.length;
      qTextEl.innerText = (q.q || 'Question text missing').replace(/^Question\s+\d+:\s*/i,'');
      // options: we expect opts array of strings
      optsEl.innerHTML = '';
      if(Array.isArray(q.opts)){
        q.opts.forEach(function(opt, idx){
          var btn = document.createElement('button');
          btn.className = 'btn small';
          btn.style.margin = '6px';
          btn.innerText = opt;
          btn.onclick = function(){ submitPetAnswer(idx); };
          optsEl.appendChild(btn);
        });
      } else {
        optsEl.innerHTML = '<div class="muted">No options available</div>';
      }
    }catch(e){ console && console.error && console.error('loadPetQuestion err', e); }
  }

  // Submit an answer: only advance if correct; otherwise show "Try again"
  function submitPetAnswer(choiceIdx){
    try{
      var fb = $('petFeedback');
      var qIndexLocal = petState.qIndex || 0;
      var qId = petState.order && petState.order[qIndexLocal];
      if(typeof qId === 'undefined'){ if(fb) fb.innerText = 'No question loaded.'; return; }
      var q = PET_QUESTIONS[qId];
      var correct = (typeof q.a !== 'undefined') ? q.a : 0;
      if(choiceIdx === correct){
        // correct — advance
        petState.points = (petState.points||0) + 2;
        petState.answered = (petState.answered||0) + 1;
        petState.qIndex = qIndexLocal + 1;
        petState.evolution = Math.min(10, Math.floor((petState.answered||0)/10));
        persistPetState();
        renderPetUI();
        if(fb){ fb.innerText = 'Correct!'; fb.classList.remove('negative'); fb.classList.add('positive'); }
        setTimeout(function(){ if(fb) fb.innerText = ''; loadPetQuestion(); }, 300);
      } else {
        if(fb){ fb.innerText = 'Wrong — try again.'; fb.classList.remove('positive'); fb.classList.add('negative'); }
        // do not advance
      }
    }catch(e){ console && console.error && console.error('submitPetAnswer err', e); }
  }

  // Begin game with given petKey (load persisted state or fresh)
  function beginGameWith(petKey){
    try{
      if(!petKey) return;
      petState.selected = petKey;
      // load persisted for this pet if exists
      var saved = loadPersistedForPet(petKey);
      if(saved && Array.isArray(saved.order) && saved.order.length === PET_QUESTIONS.length){
        petState.order = saved.order.slice();
        petState.qIndex = saved.qIndex || 0;
        petState.answered = saved.answered || 0;
        petState.points = saved.points || 0;
        petState.evolution = saved.evolution || 0;
      } else {
        petState.order = Array.from({length: PET_QUESTIONS.length}, (_,i)=>i);
        shuffleArray(petState.order);
        petState.qIndex = 0; petState.answered = 0; petState.points = 0; petState.evolution = 0;
      }
      try{ localStorage.setItem(STORAGE_CHOSEN_PET, petKey); }catch(e){}
      // show/hide UI
      var sel = $('petSelectArea'); if(sel){ sel.classList.add('hidden'); sel.style.display = 'none'; }
      var game = $('petGameArea'); if(game){ game.classList.remove('hidden'); game.style.display = ''; }
      renderPetUI();
      loadPetQuestion();
      persistPetState();
    }catch(e){ console && console.error && console.error('beginGameWith err', e); }
  }
  // expose
  window.beginGameWith = beginGameWith;

  // Start pet mode (entry from menu)
  function startPetMode(){
    try{
      if(typeof window.hideAll === 'function') window.hideAll();
      show('petStudyPage');
      var sel = $('petSelectArea'); var game = $('petGameArea');
      var saved = null;
      try{ saved = localStorage.getItem(STORAGE_CHOSEN_PET); }catch(e){}
      if(saved){
        beginGameWith(saved);
      } else {
        if(sel){ sel.classList.remove('hidden'); sel.style.display = ''; }
        if(game){ game.classList.add('hidden'); game.style.display = 'none'; }
      }
      var speech = $('petSpeech'); if(speech) speech.innerText = 'hlo 👋';
      renderPetUI();
    }catch(e){ console && console.error && console.error('startPetMode err', e); }
  }
  window.startPetMode = startPetMode;

  // Wire up listeners (pet buttons and mode card)
  function wire(){
    try{
      document.querySelectorAll('[data-pet]').forEach(function(btn){
        btn.removeEventListener && btn.removeEventListener('click', function(){});
        btn.addEventListener('click', function(){ beginGameWith(this.getAttribute('data-pet')); });
      });
      var modeCard = document.getElementById('modePet');
      if(modeCard){
        modeCard.removeEventListener && modeCard.removeEventListener('click', startPetMode);
        modeCard.addEventListener('click', startPetMode);
      }
      var petQuit = document.getElementById('petQuitBtn');
      if(petQuit){
        petQuit.removeEventListener && petQuit.removeEventListener('click', function(){});
        petQuit.addEventListener('click', function(){ if(confirm('Quit pet study and return to modes?')){ if(typeof window.hide === 'function') window.hide('petStudyPage'); if(typeof window.show === 'function') window.show('studyCounterMenu'); } });
      }
      // hide select area if saved pet exists (non-navigation)
      var saved = null; try{ saved = localStorage.getItem(STORAGE_CHOSEN_PET); }catch(e){}
      if(saved){ var sel = document.getElementById('petSelectArea'); if(sel) sel.style.display = 'none'; }
      window._petState = petState;
    }catch(e){ console && console.error && console.error('wire err', e); }
  }

  if(document.readyState === 'complete' || document.readyState === 'interactive') wire(); else document.addEventListener('DOMContentLoaded', wire);



  // expose certain functions globally for robustness
  try{
    window.submitPetAnswer = submitPetAnswer;
    window.loadPetQuestion = loadPetQuestion;
    window.renderPetUI = renderPetUI;
    window.persistPetState = persistPetState;
    window.beginGameWith = beginGameWith;
    window.startPetMode = startPetMode;
  }catch(e){}
})(); 
</script>

</script>



<script>
(function(){
  // Persist current visible 'page' id so a reload can restore it.
  function setCurrentPage(pageId){
    try{ localStorage.setItem('currentPage', pageId); }catch(e){}
  }

  // Wrap existing global start functions so they set currentPage when invoked.
  function wrapStartFunction(funcName, pageId){
    try{
      if(typeof window[funcName] === 'function'){
        var orig = window[funcName];
        window[funcName] = function(){
          try{ setCurrentPage(pageId); }catch(e){}
          return orig.apply(this, arguments);
        };
      } else {
        // Poll until the function is available, then wrap it
        var attempts = 0;
        var intv = setInterval(function(){
          attempts++;
          if(typeof window[funcName] === 'function'){
            var orig = window[funcName];
            window[funcName] = function(){
              try{ setCurrentPage(pageId); }catch(e){}
              return orig.apply(this, arguments);
            };
            clearInterval(intv);
          } else if(attempts > 50){
            clearInterval(intv);
          }
        }, 100);
      }
    }catch(e){}
  }

  wrapStartFunction('startPetMode', 'petStudyPage');
  wrapStartFunction('startEmojiBattle', 'emojiBattlePage');
  wrapStartFunction('startJashBattle', 'jashBattlePage');
  wrapStartFunction('startAiBattle', 'aiBattlePage');

  // Also ensure beginGameWith persists chosen pet (if not already)
  if(typeof window.beginGameWith === 'function'){
    (function(){
      var orig = window.beginGameWith;
      window.beginGameWith = function(petKey){
        try{ setCurrentPage('petStudyPage'); }catch(e){}
        try{ localStorage.setItem('chosenPet', petKey); }catch(e){}
        return orig.apply(this, arguments);
      };
    })();
  } else {
    // poll to wrap later
    var cnt = 0;
    var t = setInterval(function(){
      cnt++;
      if(typeof window.beginGameWith === 'function'){
        var orig = window.beginGameWith;
        window.beginGameWith = function(petKey){
          try{ setCurrentPage('petStudyPage'); }catch(e){}
          try{ localStorage.setItem('chosenPet', petKey); }catch(e){}
          return orig.apply(this, arguments);
        };
        clearInterval(t);
      } else if(cnt>50) clearInterval(t);
    }, 100);
  }

  // Restore page on load
  function restorePage(){
    try{
      var p = localStorage.getItem('currentPage');
      if(!p) return;
      // call the appropriate start function if available
      if(p === 'petStudyPage' && typeof window.startPetMode === 'function'){ window.startPetMode(); return; }
      if(p === 'emojiBattlePage' && typeof window.startEmojiBattle === 'function'){ window.startEmojiBattle(); return; }
      if(p === 'jashBattlePage' && typeof window.startJashBattle === 'function'){ window.startJashBattle(); return; }
      if(p === 'aiBattlePage' && typeof window.startAiBattle === 'function'){ window.startAiBattle(); return; }
      // If it's a plain page id, try to show it (fallback)
      if(typeof window.show === 'function'){ try{ window.show(p); }catch(e){} }
    }catch(e){}
  }

  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(restorePage, 60);
  } else {
    document.addEventListener('DOMContentLoaded', restorePage);
  }
})();
</script>


<script>
(function(){
  function navToModes(){
    try{ localStorage.setItem('currentPage','studyCounterMenu'); }catch(e){}
    try{
      if(typeof hideAll === 'function') hideAll();
      if(typeof show === 'function') return show('studyCounterMenu');
      var el = document.getElementById('studyCounterMenu');
      if(el) el.classList.remove('hidden');
    }catch(e){}
  }

  function wireBackButtons(){
    var ids = ['petQuitBtn','emojiQuitBtn','jashQuitBtn','aiQuitBtn','backFromMenuBtn'];
    ids.forEach(function(id){
      var btn = document.getElementById(id);
      if(!btn) return;
      try{ btn.innerText = 'Back'; }catch(e){}
      try{ btn.removeEventListener && btn.removeEventListener('click', function(){}); }catch(e){}
      btn.addEventListener('click', function(ev){
        ev && ev.preventDefault && ev.preventDefault();
        navToModes();
      });
    });
  }

  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(wireBackButtons, 50);
  } else {
    document.addEventListener('DOMContentLoaded', wireBackButtons);
  }
})();
</script>


<script>
// Unified back-button handlers — robust fix
(function(){
  const mapping = {
    'backFromChallenges': function(){ try{ hide('challengesPage'); show('studyCounterMenu'); }catch(e){} },
    'backFromMenuBtn': function(){ try{ hide('studyCounterMenu'); show('dashboard'); renderBoxes(); setupHeaderActions(); }catch(e){} },
    'backFromStudyBtn': function(){ try{ hide('studyCounterPage'); show('dashboard'); renderBoxes(); setupHeaderActions(); }catch(e){} },
    'backToDashboard': function(){ try{ currentBox=null; hide('boxDetail'); show('dashboard'); renderBoxes(); }catch(e){} },
    'jashQuitBtn': function(){ try{ if(confirm('Quit challenge?')){ hide('jashBattlePage'); show('challengesPage'); renderChallengesList(); } }catch(e){} },
    'jashBackBtn': function(){ try{ hide('jashBattlePage'); show('challengesPage'); renderChallengesList(); }catch(e){} },
    'emojiQuitBtn': function(){ try{ hide('emojiBattlePage'); show('challengesPage'); renderChallengesList(); }catch(e){} },
    'emojiQuitBtn2': function(){ try{ hide('emojiBattlePage'); show('challengesPage'); renderChallengesList(); }catch(e){} },
    'aiQuitBtn': function(){ try{ hide('aiBattlePage'); show('challengesPage'); renderChallengesList(); }catch(e){} },
    'aiBackBtn': function(){ try{ hide('aiBattlePage'); show('challengesPage'); renderChallengesList(); }catch(e){} },
    'petQuitBtn': function(){ try{ if(confirm('Quit pet study?')){ hide('petStudyPage'); show('studyCounterMenu'); } }catch(e){} },
    'brBack': function(ev){ try{ const modal = ev.currentTarget && ev.currentTarget.closest && ev.currentTarget.closest('.modal'); if(modal){ modal.remove(); } }catch(e){} }
  };

  function attachOnce(id, handler){
    const el = document.getElementById(id);
    if(!el) return;
    // remove existing click listeners by cloning
    try{
      const newEl = el.cloneNode(true);
      el.parentNode.replaceChild(newEl, el);
      newEl.addEventListener('click', handler);
    }catch(e){
      // fallback
      try{ el.addEventListener('click', handler); }catch(e){}
    }
  }

  function safeAttach(){
    Object.keys(mapping).forEach(function(id){
      attachOnce(id, function(ev){
        ev && ev.preventDefault && ev.preventDefault();
        try{ mapping[id](ev); }catch(e){ console.warn('back handler failed', id, e); }
      });
    });
    // also attach to any element with data-back-to attribute for flexibility
    document.querySelectorAll('[data-back-to]').forEach(function(btn){
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        const target = btn.getAttribute('data-back-to');
        if(target) try{ hideAll(); show(target); }catch(e){};
      });
    });
  }

  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(safeAttach, 50);
  } else {
    document.addEventListener('DOMContentLoaded', safeAttach);
  }
})();
</script>
</body>
</html>
