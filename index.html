<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uniorax ‚Äî MySQL Connected</title>
  <style>
    :root{
      --accent:#4f46e5; --bg:#0b0b0b; --card:#151515; --muted:#aab4c4; --line:#222;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6eef8}
    header{position:sticky;top:0;background:#0e0e0e;border-bottom:1px solid var(--line);z-index:10}
    .bar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .dots{font-size:22px;cursor:pointer}
    .title{font-weight:700;letter-spacing:.3px}
    .grow{flex:1}
    .search{display:flex;align-items:center;background:#111;border:1px solid var(--line);border-radius:10px;padding:6px 10px;gap:8px}
    .search input{background:transparent;border:none;outline:none;color:#e6eef8;width:220px}
    .bell{position:relative;cursor:pointer;padding:8px;border-radius:10px;background:#111;border:1px solid var(--line)}
    .pill{position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:11px}
    .menu{position:absolute;left:12px;top:56px;background:#0f0f0f;border:1px solid var(--line);border-radius:14px;padding:10px;display:none;min-width:220px}
    .menu a{display:block;color:#e6eef8;text-decoration:none;padding:8px;border-radius:8px}
    .menu a:hover{background:#171717}
    main{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr 320px;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .profiles{display:flex;flex-direction:column;gap:12px}
    .p-row{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;background:#121212;border:1px solid var(--line);border-radius:14px;padding:10px}
    .avatar{width:64px;height:64px;border-radius:12px;background:#0c0c0c;object-fit:cover}
    .p-meta b{display:block;font-size:16px}
    .muted{color:var(--muted);font-size:12px}
    .btn{border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#181818;color:#e6eef8;border:1px solid var(--line)}
    .right .card{position:sticky; top:84px}
    .toolbar{display:flex;gap:8px;margin-bottom:10px}
    .select{width:100%;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0f0f0f;color:#e6eef8}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    dialog{border:none;border-radius:16px;padding:0;max-width:520px;width:96%}
    .modal{background:#0f0f0f;border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .modal header{position:static;background:#121212;border-bottom:1px solid var(--line)}
    .modal .body{padding:16px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field input,.field select,.field textarea{background:#121212;border:1px solid var(--line);border-radius:10px;padding:10px;color:#e6eef8}
    .chat-wrap{max-height:360px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#101010;border:1px solid var(--line);border-radius:12px;padding:10px}
    .msg{max-width:72%;padding:10px;border-radius:12px}
    .me{background:var(--accent);color:white;margin-left:auto}
    .them{background:#1f1f1f;color:white;margin-right:auto}
    .pilltab{display:flex;gap:8px;margin:8px 0}
    .pilltab button{border:1px solid var(--line);background:#121212;color:#e6eef8;border-radius:999px;padding:6px 10px;cursor:pointer}
    .pilltab button.active{background:var(--accent);color:#fff;border-color:transparent}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="dots" id="dots">‚ãÆ</div>
    <div class="title">Uniorax</div>
    <div class="grow"></div>
    <div class="search">
      üîé <input id="q" placeholder="Search by name or ID">
    </div>
    <div class="bell" id="bell">
      üîî <span class="pill" id="notifCount" style="display:none">0</span>
    </div>
  </div>
  <div class="menu" id="menu">
    <a href="#" id="createProfile">‚ûï Create Profile</a>
    <a href="#" id="viewProfiles">üë• View Profiles</a>
  </div>
</header>

<main>
  <section class="left">
    <div class="card">
      <div class="toolbar">
        <button class="btn primary" id="btnNew">+ New Profile</button>
        <select class="select" id="category">
          <option value="">All categories</option>
          <option>Plumber</option>
          <option>Electrician</option>
          <option>Carpenter</option>
          <option>Painter</option>
        </select>
      </div>
      <div class="profiles" id="profiles"></div>
      <div class="note" id="emptyState" style="display:none">No profiles yet. Click ‚Äú+ New Profile‚Äù.</div>
    </div>
  </section>

  <aside class="right">
    <div class="card">
      <h3>Notifications</h3>
      <div class="pilltab">
        <button id="tabUnread" class="active">Unread</button>
        <button id="tabRead">Read</button>
      </div>
      <div id="notifUnread"></div>
      <div id="notifRead" style="display:none"></div>
    </div>
  </aside>
</main>

<!-- Profile Modal -->
<dialog id="profileDlg">
  <div class="modal">
    <header class="bar"><div class="title">Create / Edit Profile</div></header>
    <div class="body">
      <div class="grid2">
        <div class="field"><label>Name</label><input id="f_name"></div>
        <div class="field"><label>Age</label><input id="f_age" type="number" min="10"></div>
      </div>
      <div class="grid2">
        <div class="field"><label>Skill</label>
          <select id="f_skill" class="select">
            <option>Plumber</option><option>Electrician</option><option>Carpenter</option><option>Painter</option>
          </select>
        </div>
        <div class="field"><label>Contact</label><input id="f_contact" placeholder="Phone or email"></div>
      </div>
      <div class="field"><label>Address</label><input id="f_address"></div>
      <div class="field"><label>Avatar URL (optional)</label><input id="f_avatar" placeholder="https://..."></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn ghost" id="cancelProfile">Cancel</button>
        <button class="btn primary" id="saveProfile">Save</button>
      </div>
    </div>
  </div>
</dialog>

<!-- Chat Modal -->
<dialog id="chatDlg">
  <div class="modal">
    <header class="bar"><div class="title" id="chatTitle">Chat</div></header>
    <div class="body">
      <div class="chat-wrap" id="chatWrap"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="chatText" placeholder="Type a message‚Ä¶" style="flex:1" />
        <button class="btn primary" id="sendMsg">Send</button>
      </div>
    </div>
  </div>
</dialog>

<script>
const API = "http://localhost:3000/api";
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

// UI toggles
$("#dots").onclick = ()=> $("#menu").style.display = $("#menu").style.display === "block" ? "none" : "block";
$("#btnNew").onclick = ()=> openProfileForm();
$("#createProfile").onclick = (e)=>{e.preventDefault(); $("#menu").style.display="none"; openProfileForm();};
$("#viewProfiles").onclick = (e)=>{e.preventDefault(); $("#menu").style.display="none"; loadProfiles();};
$("#tabUnread").onclick = ()=>{ $("#tabUnread").classList.add("active"); $("#tabRead").classList.remove("active"); $("#notifUnread").style.display="block"; $("#notifRead").style.display="none";};
$("#tabRead").onclick = ()=>{ $("#tabRead").classList.add("active"); $("#tabUnread").classList.remove("active"); $("#notifUnread").style.display="none"; $("#notifRead").style.display="block";};

// Globals
let PROFILES = [];
const ME = { uid: "me", name: "You" }; // simple local identity

function genUID(){ return Math.floor(10000 + Math.random()*90000).toString(); }

// Fetch helpers
async function apiGet(path){
  const res = await fetch(API + path);
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}
async function apiPost(path, body){
  const res = await fetch(API + path, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error(await res.text());
  return res.json().catch(()=> ({})); // some endpoints return empty object
}

// Load & render profiles
async function loadProfiles(){
  const q = $("#q").value.trim().toLowerCase();
  const cat = $("#category").value;
  const rows = await apiGet("/profiles");
  PROFILES = rows;
  let list = rows;
  if (cat) list = list.filter(p => (p.skill||"").toLowerCase() === cat.toLowerCase());
  if (q) list = list.filter(p => (p.name||"").toLowerCase().includes(q) || (p.uid||"").toLowerCase().includes(q));
  renderProfiles(list);
}

function renderProfiles(list){
  const box = $("#profiles");
  box.innerHTML = "";
  if(!list.length){ $("#emptyState").style.display="block"; return; }
  $("#emptyState").style.display="none";
  list.forEach(p => {
    const row = document.createElement("div");
    row.className = "p-row";
    const avatar = p.avatar && p.avatar.startsWith("http") ? p.avatar : "https://via.placeholder.com/64";
    row.innerHTML = `
      <img class="avatar" src="${avatar}" alt="avatar">
      <div class="p-meta">
        <b>${p.name || "Unnamed"}</b>
        <div class="muted">${p.skill || "‚Äî"} ‚Ä¢ Age ${p.age ?? "‚Äî"} ‚Ä¢ ID: ${p.uid}</div>
        <div class="muted">${p.address || ""}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" data-edit>Edit</button>
        <button class="btn primary" data-chat>Chat</button>
      </div>
    `;
    row.querySelector("[data-edit]").onclick = ()=> openProfileForm(p);
    row.querySelector("[data-chat]").onclick = ()=> openChat(p);
    box.appendChild(row);
  });
}

// Profile form
function openProfileForm(p=null){
  $("#f_name").value = p?.name || "";
  $("#f_age").value = p?.age || "";
  $("#f_skill").value = p?.skill || "Plumber";
  $("#f_contact").value = p?.contact || "";
  $("#f_address").value = p?.address || "";
  $("#f_avatar").value = p?.avatar || "";
  $("#saveProfile").onclick = async ()=>{
    const payload = {
      uid: p?.uid || genUID(),
      name: $("#f_name").value.trim(),
      age: Number($("#f_age").value)||null,
      skill: $("#f_skill").value.trim(),
      contact: $("#f_contact").value.trim(),
      address: $("#f_address").value.trim(),
      avatar: $("#f_avatar").value.trim()
    };
    // naive upsert: try insert; on duplicate, we could add an /update endpoint. For now: if exists, show note.
    try{
      await apiPost("/profiles", payload);
      addNotif(`Profile saved: ${payload.name}`, false);
    }catch(e){
      addNotif("Profile might already exist (UID in use). Implement /update if needed.", true);
    }
    $("#profileDlg").close();
    await loadProfiles();
  };
  $("#cancelProfile").onclick = ()=> $("#profileDlg").close();
  $("#profileDlg").showModal();
}

// Chat
let CHAT_PEER = null;
async function openChat(them){
  CHAT_PEER = them;
  $("#chatTitle").textContent = `Chat with ${them.name}`;
  $("#chatWrap").innerHTML = "";
  $("#chatDlg").showModal();
  const history = await apiGet(`/messages/${ME.uid}/${them.uid}`);
  history.forEach(renderMsg);
}
function renderMsg(m){
  const div = document.createElement("div");
  div.className = "msg " + (m.sender_uid === ME.uid ? "me" : "them");
  div.textContent = m.text;
  $("#chatWrap").appendChild(div);
  $("#chatWrap").scrollTop = $("#chatWrap").scrollHeight;
}
$("#sendMsg").onclick = async ()=>{
  const txt = $("#chatText").value.trim();
  if(!txt || !CHAT_PEER) return;
  await apiPost("/messages", { sender_uid: ME.uid, receiver_uid: CHAT_PEER.uid, text: txt });
  renderMsg({ sender_uid: ME.uid, text: txt });
  $("#chatText").value = "";
};

// Notifications (simple demo, client-side only)
function addNotif(text, unread=true){
  const el = document.createElement("div");
  el.className = "p-row";
  el.innerHTML = `<div class="muted" style="grid-column:1/-1">${text}</div>`;
  (unread ? $("#notifUnread") : $("#notifRead")).appendChild(el);
  updateNotifCount();
}
function updateNotifCount(){
  const count = $("#notifUnread").children.length;
  const pill = $("#notifCount");
  pill.textContent = String(count);
  pill.style.display = count ? "inline-block" : "none";
}

// Search & filters
$("#q").addEventListener("input", loadProfiles);
$("#category").addEventListener("change", loadProfiles);

// Initial boot
loadProfiles().catch(err=>console.error(err));
</script>
</body>
</html>
