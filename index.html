<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Themed Task App — Study Counter v2</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --card-w:820px;
  --radius:18px;
  --accent:#4a90e2;
  --btn-text:#ffffff;
  --bg1:#eef2ff;
  --bg2:#ffffff;
  --timer-color:#0b1220;
  --muted:#6b7280;
  --progress-gradient: linear-gradient(90deg,#4a90e2,#8b5cf6);
}
*{box-sizing:border-box; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; }
html,body{height:100%; margin:0; background:linear-gradient(135deg,var(--bg1),var(--bg2)); }
.container{ width:var(--card-w); max-width:96vw; margin:30px auto; background:rgba(255,255,255,0.95); border-radius:var(--radius); padding:22px; box-shadow:0 20px 60px rgba(2,6,23,0.12); overflow:auto; max-height:86vh; }
.header{ display:flex; align-items:center; gap:16px; }
.logo{ width:72px; height:72px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:28px; background:linear-gradient(180deg,#f0f0f0,#e6e6e6); color:#333; }
.title{ margin:0; font-size:20px; font-weight:700; }
.subtitle{ margin:2px 0 0; color:var(--muted); font-size:13px; }
.header-actions{ margin-left:auto; display:flex; gap:10px; align-items:center; }

/* study bar */
.study-wrapper{ display:flex; flex-direction:column; gap:6px; }
.study-meta{ font-size:13px; color:var(--muted); display:flex; gap:10px; align-items:center; }
.progress{ height:12px; background:#edf2f7; border-radius:8px; overflow:hidden; width:220px; margin-top:4px; }
.progress-inner{ height:100%; width:0%; background:var(--progress-gradient); transition:width .5s; }
.level-title{ font-size:12px; color:var(--muted); margin-top:4px; }

/* selected red */
.selected-red{ box-shadow: 0 8px 30px rgba(255,82,82,0.14) !important; border:2px solid #ff4d4d !important; }

/* form */
.row{ display:flex; gap:12px; align-items:center; }
.col{ flex:1; }
.input, input[type="text"], input[type="number"], select, input[type="date"], input[type="time"]{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e6eef8; font-size:15px; outline:none; background:white; box-shadow: inset 0 -4px 12px rgba(0,0,0,0.03); }
.btn{ padding:12px 16px; border-radius:12px; border:none; background:var(--accent); color:var(--btn-text); font-weight:700; cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.btn.secondary{ background:#6b7280; color:white; }
.btn.danger{ background:#e24a4a; color:white; }
.small{ padding:8px 10px; border-radius:10px; font-weight:700; }

/* grid */
.grid{ display:grid; gap:14px; margin-top:16px; }
.boxes{ display:grid; grid-template-columns:repeat(2,1fr); gap:14px; margin-top:12px; }
.box-card{ padding:16px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfbff); box-shadow:0 8px 30px rgba(0,0,0,0.06); }
.box-title{ font-weight:800; font-size:18px; }
.box-meta{ color:var(--muted); font-size:13px; }

/* table */
.table{ width:100%; border-collapse:collapse; margin-top:12px; }
.table th, .table td{ padding:10px; border-bottom:1px solid #edf2f7; text-align:left; }

/* modal */
.modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999; }
.modal-card{ width:420px; max-width:92vw; background:white; padding:16px; border-radius:12px; box-shadow:0 20px 60px rgba(2,6,23,0.2); }
.hidden{ display:none; }
.muted{ color:var(--muted); font-size:13px; }

/* stickers */
.bg{ position:fixed; inset:0; pointer-events:none; z-index:0; }
.sticker{ position:absolute; opacity:0.12; font-size:40px; transform:translate3d(0,0,0); animation:float 8s ease-in-out infinite; }
@keyframes float{ 0%{transform:translateY(0);} 50%{transform:translateY(-20px);} 100%{transform:translateY(0);} }

/* timer / mood */
#timerDisplay{ color:var(--timer-color); }
#moodDisplay{ display:flex; align-items:center; gap:12px; font-weight:800; }
#moodEmoji{ font-size:48px; line-height:1; }
#moodText{ font-size:18px; color:var(--muted); }

@media(max-width:900px){ .boxes{ grid-template-columns:1fr; } .logo{ width:56px; height:56px; font-size:20px; } }
</style>
</head>
<body>
<div class="bg" id="bg"></div>

<div class="container" role="main">
  <div class="header">
    <div class="logo" id="logo">✨</div>
    <div id="studyWrapperContainer">
      <!-- study-wrapper will be shown only when experience created -->
      <div class="study-wrapper" id="studyWrapper" style="display:none;">
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="title">Study Progress</div>
          <div class="study-meta">
            <div id="expText">EXP 0/20</div>
            <div id="levelText">Lv 0/100</div>
          </div>
        </div>
        <div class="progress" aria-hidden="true"><div class="progress-inner" id="progressInner"></div></div>
        <div class="level-title" id="levelTitle">Beginner</div>
      </div>
    </div>
    <div class="header-actions" id="headerActions"></div>
  </div>

  <div class="grid" id="mainGrid">
    <!-- Step 1 -->
    <div id="stepName">
      <h3>Hi — tell me who you are</h3>
      <div class="row">
        <input id="name" class="input" type="text" placeholder="Your name (e.g., Jahshan)">
        <input id="age" class="input" type="number" placeholder="Age" style="width:120px;">
      </div>
      <div style="margin-top:10px;">
        <button class="btn" id="btnContinue">Continue</button>
        <button class="btn secondary" id="btnReset">Reset</button>
      </div>
      <div id="nameError" class="muted" style="display:none; margin-top:8px;"></div>
    </div>

    <!-- Step 2 -->
    <div id="stepCustomize" class="hidden">
      <h3 id="greet">Hello!</h3>
      <div class="muted">Choose purpose & theme</div>

      <div style="margin-top:12px;">
        <div style="font-weight:800; margin-bottom:6px;">Purpose</div>
        <div class="row" style="margin-bottom:8px;">
          <div id="purposeStudy" class="box-card" style="cursor:pointer;">Study</div>
          <div id="purposeOther" class="box-card" style="cursor:pointer;">Other</div>
        </div>

        <div style="font-weight:800; margin-bottom:6px;">Theme</div>
        <div class="row">
          <div id="tCute" class="box-card" style="cursor:pointer;">Cute</div>
          <div id="tTech" class="box-card" style="cursor:pointer;">Tech</div>
          <div id="tCold" class="box-card" style="cursor:pointer;">Cold</div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" id="btnFinish">Finish</button>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3>Your Task Boxes</h3>
          <div class="muted">Create boxes (max 10 tasks each)</div>
        </div>
        <div>
          <!-- kept Create Task Box per request -->
          <button class="btn" id="btnCreateBox">+ Create Task Box</button>
        </div>
      </div>

      <div class="boxes" id="boxesList" aria-live="polite" style="margin-top:12px;"></div>

      <div id="allTasks" class="hidden" style="margin-top:12px;">
        <h3>All Tasks</h3>
        <table class="table" id="allTasksTable">
          <thead><tr><th>Box</th><th>Task</th><th>Deadline</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="allTasksBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Create Box Step 1 -->
    <div id="createBox1" class="hidden">
      <h3>Name the Task Box</h3>
      <input id="newBoxName" class="input" type="text" placeholder="e.g., Exam prep">
      <div style="margin-top:10px;">
        <button class="btn" id="toCreateBox2">Next: Duration</button>
        <button class="btn secondary" id="cancelCreateBox1">Cancel</button>
      </div>
      <div id="createBoxError" class="muted" style="display:none;"></div>
    </div>

    <!-- Create Box Step 2 -->
    <div id="createBox2" class="hidden">
      <h3>Duration</h3>
      <div class="row">
        <select id="recurrenceType" class="input">
          <option value="weekly">Week</option>
          <option value="monthly">Month</option>
          <option value="yearly">Year</option>
          <option value="days">Days</option>
        </select>
        <input id="recurrenceCount" class="input" type="number" placeholder="How many?" style="width:140px;">
      </div>
      <div style="margin-top:10px;">
        <button class="btn" id="createBoxBtn">Create Box</button>
        <button class="btn secondary" id="cancelCreateBox2">Cancel</button>
      </div>
    </div>

    <!-- Box Detail -->
    <div id="boxDetail" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3 id="boxTitle">Box</h3>
          <div id="boxMeta" class="muted"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="btnAddTask">Add Task</button>
          <button class="btn secondary" id="btnEditBox">Edit</button>
          <button class="btn danger" id="btnDeleteBox">Delete</button>
        </div>
      </div>
      <table class="table" id="tasksTable" style="margin-top:10px;">
        <thead><tr><th style="width:120px"></th><th>Task</th><th>Deadline</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="tasksBody"></tbody>
      </table>
      <div style="margin-top:12px;">
        <button class="btn secondary" id="backToDashboard">Back</button>
      </div>
    </div>

    <!-- Study Counter Page -->
    <div id="studyCounterPage" class="hidden">
      <h3>Study Counter</h3>
      <div class="muted">Start sessions and earn EXP every 15 minutes.</div>

      <div style="margin-top:12px;">
        <div id="sessionArea">
          <button class="btn" id="startSessionBtn">Start a Session</button>
        </div>

        <div id="timerArea" class="hidden" style="margin-top:12px;">
          <div id="timerDisplay" style="font-size:32px; font-weight:800;">00:00:00</div>
          <div style="margin-top:8px;">
            <button class="btn" id="pauseBtn">Pause</button>
            <button class="btn danger" id="stopBtn">Stop</button>
          </div>
          <div style="margin-top:12px;" id="moodDisplay">
            <div id="moodEmoji">🧠</div>
            <div id="moodText">Ready</div>
          </div>
          <div style="margin-top:8px;" id="sessionExpDisplay" class="muted">Session EXP: 0</div>
        </div>

        <div id="congratsArea" class="hidden" style="margin-top:12px;">
          <h4>Congratulations!</h4>
          <div id="congratsText" class="muted"></div>
          <div style="margin-top:8px;">
            <button class="btn" id="startAgainBtn">Start Another Session</button>
            <button class="btn secondary" id="backFromStudyBtn">Back to Dashboard</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- task modal -->
<div id="taskModal" class="modal hidden" aria-hidden="true">
  <div class="modal-card">
    <h3 id="taskModalTitle">Add Task</h3>
    <div class="muted">Provide task name, date & time. If past due you can't complete after deadline.</div>
    <div style="margin-top:10px;">
      <input id="modalTaskName" class="input" type="text" placeholder="Task name">
      <div class="row" style="margin-top:8px;">
        <input id="modalTaskDate" class="input" type="date">
        <input id="modalTaskTime" class="input" type="time">
      </div>
      <div id="modalError" class="muted" style="color:#a00; display:none; margin-top:8px;"></div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button class="btn secondary" id="modalCancel">Cancel</button>
        <button class="btn" id="modalAdd">Add Task</button>
      </div>
    </div>
  </div>
</div>

<!-- edit box modal -->
<div id="editBoxModal" class="modal hidden" aria-hidden="true">
  <div class="modal-card">
    <h3>Edit Box</h3>
    <input id="editBoxName" class="input" type="text" placeholder="Box name">
    <div class="row" style="margin-top:8px;">
      <select id="editRecurrenceType" class="input">
        <option value="weekly">Week</option>
        <option value="monthly">Month</option>
        <option value="yearly">Year</option>
        <option value="days">Days</option>
      </select>
      <input id="editRecurrenceCount" class="input" type="number" placeholder="How many?" style="width:140px;">
    </div>
    <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn secondary" id="editCancel">Cancel</button>
      <button class="btn" id="editSave">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- Config ---------- */
const STORAGE_KEY = 'taskAppState_v2';
const MAX_LEVEL = 100;
const LEVEL_THRESHOLD = 20; // exp per level (kept constant unless you want curve)
const BASE_MILESTONE_EXP = 5; // base exp awarded every 15 minutes
const MILESTONE_SECONDS = 15 * 60; // 900

/* ---------- App state ---------- */
let state = {
  user: { name:'', age:0, purpose:'', theme:'', experienceCreated:false, title:'' },
  boxes: [],
  exp: 0,
  level: 0,
  session: { active:false, startedAt: null, elapsedBefore:0, paused:false, sessionExp:0 },
  version: 2
};

/* ---------- Short helpers ---------- */
const $ = id => document.getElementById(id);
const show = id => { const el=$(id); if(el) el.classList.remove('hidden'); };
const hide = id => { const el=$(id); if(el) el.classList.add('hidden'); };
const val = id => { const el=$(id); return el? el.value : null; };
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.warn('save failed',e); } }
function loadState(){ try{ const s = localStorage.getItem(STORAGE_KEY); if(s){ const loaded = JSON.parse(s); // merge to keep schema
    state = Object.assign(state, loaded);
    // Ensure arrays exist
    state.boxes = state.boxes || [];
    state.user = Object.assign({name:'',age:0,purpose:'',theme:'',experienceCreated:false,title:''}, state.user || {});
    state.session = Object.assign({active:false,startedAt:null,elapsedBefore:0,paused:false,sessionExp:0}, state.session || {});
  } }catch(e){ console.warn('load failed', e); } }

/* ---------- Theme system (applies to tokens/btns/timer) ---------- */
const themeDefinitions = {
  cute: { accent:'#ff6aa2', btnText:'#fff', bg1:'#fff0f6', bg2:'#fff7fb', timer:'#6d174d', progress:'linear-gradient(90deg,#ff6aa2,#ff8fbf)' },
 tech: { 
  accent:'#00aaff', 
  btnText:'#fff', 
  bg1:'#081126', 
  bg2:'#12223b', 
  timer:'#00aaff',   // 🔵 now blue
  progress:'linear-gradient(90deg,#00aaff,#4ad6ff)' 
},

  cold: { accent:'#2bb7ff', btnText:'#fff', bg1:'#d9f1ff', bg2:'#f2fbff', timer:'#0b3a57', progress:'linear-gradient(90deg,#2bb7ff,#5cd6ff)' }
};

function applyTheme(t){
  const def = themeDefinitions[t] || themeDefinitions['cute'];
  document.documentElement.style.setProperty('--accent', def.accent);
  document.documentElement.style.setProperty('--btn-text', def.btnText);
  document.documentElement.style.setProperty('--bg1', def.bg1);
  document.documentElement.style.setProperty('--bg2', def.bg2);
  document.documentElement.style.setProperty('--timer-color', def.timer);
  document.documentElement.style.setProperty('--progress-gradient', def.progress);
  // update body class for sticker selection / other visuals
  document.body.className = t;
  renderStickers();
  saveState();
}

/* ---------- Titles and levels ---------- */
function computeTitleForLevel(lv){
  if(lv >= 100) return 'Transcendent';
  if(lv >= 90) return 'Immortal';
  if(lv >= 80) return 'Mythic';
  if(lv >= 70) return 'Grandmaster';
  if(lv >= 60) return 'Master';
  if(lv >= 50) return 'Veteran';
  if(lv >= 40) return 'Expert';
  if(lv >= 30) return 'Advanced';
  if(lv >= 20) return 'Skilled';
  if(lv >= 10) return 'Practitioner';
  if(lv >= 5) return 'Intermediate';
  return 'Beginner';
}

/* ---------- Experience logic ---------- */
function getExpPerMilestone(){ // increases by 5 for each level (per request)
  return BASE_MILESTONE_EXP + (state.level * 5);
}

function addExp(amount){
  state.exp += amount;
  // Level up loop
  while(state.exp >= LEVEL_THRESHOLD && state.level < MAX_LEVEL){
    state.exp -= LEVEL_THRESHOLD;
    state.level++;
    onLevelUp();
  }
  updateStudyBar();
  saveState();
}

function onLevelUp(){
  // update title unlocks
  const newTitle = computeTitleForLevel(state.level);
  if(newTitle !== state.user.title){
    state.user.title = newTitle;
  }
  // a level-up is requested to increase exp rate - handled by getExpPerMilestone()
  // notify (visual)
  setTimeout(()=> {
    showSmallToast('Level up! Now Lv ' + state.level + ' — ' + state.user.title);
  }, 200);
  saveState();
}

/* ---------- UI rendering ---------- */
function updateStudyBar(){
  const pct = Math.min(100, (state.exp/LEVEL_THRESHOLD)*100);
  const inner = $('progressInner');
  if(inner) inner.style.width = pct + '%';
  const expText = $('expText'); if(expText) expText.innerText = `EXP ${state.exp}/${LEVEL_THRESHOLD}`;
  const levelText = $('levelText'); if(levelText) levelText.innerText = `Lv ${state.level}/${MAX_LEVEL}`;
  const title = state.user.title || computeTitleForLevel(state.level);
  const levelTitleEl = $('levelTitle'); if(levelTitleEl) levelTitleEl.innerText = title;
}

/* show/hide study UI depending on experience creation */
function renderStudyUiVisibility(){
  const wrapper = $('studyWrapper');
  const ha = $('headerActions');
  if(state.user.experienceCreated){
    if(wrapper) wrapper.style.display = 'flex';
    setupHeaderActions();
  } else {
    if(wrapper) wrapper.style.display = 'none';
    if(ha) ha.innerHTML = '';
  }
}

/* ---------- Boxes & tasks ---------- */
function renderBoxes(){
  const list = $('boxesList'); if(!list) return;
  list.innerHTML='';
  if(state.boxes.length===0){ list.innerHTML = '<div class="muted">No boxes yet — create one</div>'; return; }
  state.boxes.forEach((b, idx)=>{
    const el = document.createElement('div'); el.className='box-card';
    el.innerHTML = `<div class="box-title">${escape(b.name)}</div>
      <div class="box-meta">Duration: ${b.recurrence.type} × ${b.recurrence.count}</div>
      <div class="box-meta">Tasks: ${b.items.length}/10</div>
      <div style="margin-top:8px;"><button class="btn small" data-idx="${idx}" aria-label="Open box">Open</button></div>`;
    el.querySelector('button').addEventListener('click', ()=>openBox(idx));
    list.appendChild(el);
  });
  saveState();
}

/* ---------- Task flow (similar to previous, but persisted) ---------- */
let currentBox = null;
let taskEditMode = false, taskEditBox = null, taskEditIndex = null;

function showTaskModal(edit=false, bidx=null, tidx=null){
  taskEditMode = !!edit;
  taskEditBox = bidx; taskEditIndex = tidx;
  if(edit){
    const t = state.boxes[bidx].items[tidx];
    $('taskModalTitle').innerText = 'Edit Task';
    $('modalTaskName').value = t.text;
    const iso = new Date(t.iso);
    $('modalTaskDate').value = iso.toISOString().slice(0,10);
    $('modalTaskTime').value = iso.toTimeString().slice(0,5);
    $('modalAdd').innerText = 'Save';
  } else {
    $('taskModalTitle').innerText = 'Add Task';
    $('modalTaskName').value=''; $('modalTaskDate').value=''; $('modalTaskTime').value=''; $('modalAdd').innerText = 'Add Task';
  }
  $('modalError').style.display='none';
  $('taskModal').classList.remove('hidden');
}

function hideTaskModal(){ $('taskModal').classList.add('hidden'); }

function confirmAddTask(){
  const name = val('modalTaskName')?.trim();
  const date = val('modalTaskDate');
  const time = val('modalTaskTime');
  const err = $('modalError');
  if(!name){ err.style.display='block'; err.innerText='Task name required.'; return; }
  if(!date){ err.style.display='block'; err.innerText='Date required.'; return; }
  if(!time){ err.style.display='block'; err.innerText='Time required.'; return; }
  const iso = parseISO(date, time);
  if(!iso){ err.style.display='block'; err.innerText='Invalid date/time'; return; }
  if(taskEditMode){
    state.boxes[taskEditBox].items[taskEditIndex] = { text:name, iso, done: state.boxes[taskEditBox].items[taskEditIndex].done };
  } else {
    if(currentBox===null){ alert('Open a box first'); return; }
    const b = state.boxes[currentBox];
    if(b.items.length >= 10){ err.style.display='block'; err.innerText='Max 10 tasks'; setTimeout(()=>err.style.display='none',1800); return; }
    b.items.push({ text:name, iso, done:false });
  }
  hideTaskModal(); renderTasks(); renderBoxes(); renderAllTasks(); saveState();
}

function renderTasks(){
  const tbody = $('tasksBody'); if(!tbody) return;
  tbody.innerHTML='';
  const b = state.boxes[currentBox];
  if(!b || b.items.length===0){ tbody.innerHTML = '<tr><td colspan="5" class="muted">No tasks yet. Click Add Task.</td></tr>'; return; }
  b.items.forEach((t,i)=>{
    const d = new Date(t.iso);
    const now = new Date();
    const overdue = (!t.done && d < now);
    const status = t.done ? 'Completed' : (overdue ? 'Overdue' : 'Pending');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><button class="btn small" data-idx="${i}" data-action="complete">Complete</button></td><td>${escape(t.text)}</td><td>${d.toLocaleString()}</td><td>${status}</td><td><button class="btn small secondary" data-action="edit" data-idx="${i}">Edit</button> <button class="btn small danger" data-action="delete" data-idx="${i}">Delete</button></td>`;
    tr.querySelectorAll('button').forEach(btn=>{
      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      if(action === 'complete') btn.addEventListener('click', ()=> handleComplete(currentBox, idx));
      if(action === 'edit') btn.addEventListener('click', ()=> showTaskModal(true, currentBox, idx));
      if(action === 'delete') btn.addEventListener('click', ()=> deleteTask(currentBox, idx));
    });
    tbody.appendChild(tr);
  });
}

function renderAllTasks(){
  const tbody = $('allTasksBody'); if(!tbody) return;
  tbody.innerHTML='';
  state.boxes.forEach((b, bi)=>{
    b.items.forEach((t, ti)=>{
      const tr = document.createElement('tr');
      const d = new Date(t.iso);
      const now = new Date();
      const overdue = (!t.done && d < now);
      const status = t.done ? 'Completed' : (overdue ? 'Overdue' : 'Pending');
      tr.innerHTML = `<td>${escape(b.name)}</td><td>${escape(t.text)}</td><td>${d.toLocaleString()}</td><td>${status}</td><td><button class="btn small" data-bi="${bi}" data-ti="${ti}" data-action="complete">Complete</button> <button class="btn small secondary" data-bi="${bi}" data-ti="${ti}" data-action="edit">Edit</button> <button class="btn small danger" data-bi="${bi}" data-ti="${ti}" data-action="delete">Delete</button></td>`;
      tr.querySelectorAll('button').forEach(btn=>{
        const action = btn.dataset.action;
        const bi = Number(btn.dataset.bi);
        const ti = Number(btn.dataset.ti);
        if(action === 'complete') btn.addEventListener('click', ()=> handleComplete(bi, ti));
        if(action === 'edit') btn.addEventListener('click', ()=> showTaskModal(true, bi, ti));
        if(action === 'delete') btn.addEventListener('click', ()=> deleteTask(bi, ti));
      });
      tbody.appendChild(tr);
    });
  });
}

/* task actions */
function deleteTask(bi, ti){
  if(!confirm('Delete this task?')) return;
  state.boxes[bi].items.splice(ti,1);
  renderTasks(); renderBoxes(); renderAllTasks(); saveState();
}

function handleComplete(bi, ti){
  const t = state.boxes[bi].items[ti];
  if(!t) return;
  const d = new Date(t.iso);
  if(new Date() > d){ alert('You are not able to complete them in time'); return; }
  if(t.done) return;
  t.done = true; renderTasks(); renderBoxes(); renderAllTasks();
  // reward small EXP for completing task (same as before)
  addExp(5);
  saveState();
  // after 5s ask to delete
  setTimeout(()=>{
    const taskNow = state.boxes[bi] && state.boxes[bi].items[ti];
    if(!taskNow) return;
    if(!confirm('Task complete — would you like me to delete it?')) return;
    state.boxes[bi].items.splice(ti,1);
    renderTasks(); renderBoxes(); renderAllTasks(); saveState();
  }, 5000);
}

/* box functions */
function gotoCreateBox2(){
  const name = val('newBoxName')?.trim();
  if(!name){ $('createBoxError').style.display='block'; $('createBoxError').innerText='Enter a name'; setTimeout(()=>$('createBoxError').style.display='none',1600); return; }
  $('createBox1').dataset.name = name;
  hide('createBox1'); show('createBox2');
}
function createBoxFinal(){
  const type = val('recurrenceType') || 'weekly';
  const count = Number(val('recurrenceCount')) || 1;
  const name = $('createBox1').dataset.name || val('newBoxName') || 'Box';
  const box = { id:Date.now(), name, recurrence:{type, count}, items:[] };
  state.boxes.push(box);
  $('newBoxName').value=''; $('recurrenceCount').value='';
  hide('createBox2'); show('dashboard'); renderBoxes(); saveState();
}

function openBox(idx){
  currentBox = idx;
  const b = state.boxes[idx];
  $('boxTitle').innerText = b.name;
  $('boxMeta').innerText = `Duration: ${b.recurrence.type} × ${b.recurrence.count}`;
  hide('dashboard'); show('boxDetail'); renderTasks();
}

function showEditBox(){
  if(currentBox===null) return;
  const b = state.boxes[currentBox];
  $('editBoxName').value = b.name;
  $('editRecurrenceType').value = b.recurrence.type;
  $('editRecurrenceCount').value = b.recurrence.count;
  show('editBoxModal');
}
function hideEditBox(){ hide('editBoxModal'); }
function saveEditBox(){
  const name = val('editBoxName')?.trim();
  const type = val('editRecurrenceType');
  const count = Number(val('editRecurrenceCount')) || 1;
  if(!name) return alert('Name required');
  state.boxes[currentBox].name = name;
  state.boxes[currentBox].recurrence = { type, count };
  hideEditBox(); renderBoxes(); $('boxTitle').innerText = name; $('boxMeta').innerText = `Duration: ${type} × ${count}`;
  saveState();
}
function deleteCurrentBox(){
  if(currentBox===null) return;
  if(!confirm('Delete this box and its tasks?')) return;
  state.boxes.splice(currentBox,1);
  currentBox = null;
  hide('boxDetail'); show('dashboard'); renderBoxes(); renderAllTasks(); saveState();
}

/* ---------- Timer / session persistence ---------- */
let sessionInterval = null;
let elapsedSeconds = 0;
let paused = false;

const moodSet = [
  {emoji:'🧠', text:'Calm focus — warm-up'},
  {emoji:'📚', text:'Deep concentration'},
  {emoji:'⚡', text:'Flow state — productive'},
  {emoji:'😮‍💨', text:'Slightly tired — stretch'},
  {emoji:'🔋', text:'Refreshed — keep going'},
  {emoji:'🏆', text:'Sharp focus — great work'}
];

function startSession(){
  // if session already active, reset or resume? start fresh per user's expectation
  state.session.active = true;
  state.session.startedAt = Date.now();
  state.session.elapsedBefore = 0;
  state.session.paused = false;
  state.session.sessionExp = 0;
  saveState();

  initSessionFromState();
  hide('sessionArea'); hide('congratsArea'); show('timerArea');
}

function initSessionFromState(){
  // initialize variables from state (handles resume after reload)
  clearInterval(sessionInterval);
  paused = !!state.session.paused;
  // compute elapsedSeconds based on startedAt & elapsedBefore
  elapsedSeconds = Number(state.session.elapsedBefore) || 0;
  if(state.session.active && !state.session.paused && state.session.startedAt){
    const since = Math.floor((Date.now() - state.session.startedAt) / 1000);
    elapsedSeconds = (Number(state.session.elapsedBefore) || 0) + since;
  }
  // compute sessionExp (and award missed milestones if app was closed)
  let computedSessionExp = Number(state.session.sessionExp) || 0;
  const prevElapsedBefore = Number(state.session.elapsedBefore) || 0;
  const prevMilestones = Math.floor(prevElapsedBefore / MILESTONE_SECONDS);
  const nowMilestones = Math.floor(elapsedSeconds / MILESTONE_SECONDS);
  const missedMilestones = Math.max(0, nowMilestones - prevMilestones);
  if(missedMilestones > 0){
    const expPer = getExpPerMilestone();
    const totalMissed = missedMilestones * expPer;
    computedSessionExp += totalMissed;
    addExp(totalMissed); // global award
    showExpToast(`+${totalMissed} EXP (while away)`);
  }
  state.session.sessionExp = computedSessionExp;
  saveState();

  // update UI
  $('timerDisplay').innerText = formatTime(elapsedSeconds);
  updateMood(elapsedSeconds);
  $('sessionExpDisplay').innerText = 'Session EXP: ' + state.session.sessionExp;

  if(state.session.active){
    sessionInterval = setInterval(()=>{
      if(!paused){
        elapsedSeconds++;
        $('timerDisplay').innerText = formatTime(elapsedSeconds);
        handleMilestones();
      }
      // persist small amount frequently
      if(elapsedSeconds % 5 === 0){
        state.session.elapsedBefore = elapsedSeconds;
        saveState();
      }
    }, 1000);
  }
  const pbtn = $('pauseBtn'); if(pbtn) pbtn.innerText = paused ? 'Resume' : 'Pause';
}

function handleMilestones(){
  // check if we've hit the next 15min boundary
  if(elapsedSeconds > 0 && elapsedSeconds % MILESTONE_SECONDS === 0){
    const expPer = getExpPerMilestone();
    state.session.sessionExp = (state.session.sessionExp || 0) + expPer;
    addExp(expPer);
    $('sessionExpDisplay').innerText = 'Session EXP: ' + state.session.sessionExp;
    updateMood(elapsedSeconds);
    showExpToast('+' + expPer + ' EXP');
    // persist
    state.session.elapsedBefore = elapsedSeconds;
    saveState();
  }
}

function togglePause(){
  paused = !paused;
  state.session.paused = paused;
  if(paused){
    // when pausing, store elapsedBefore as of now
    state.session.elapsedBefore = elapsedSeconds;
    saveState();
    showSmallToast('Paused');
    const pbtn = $('pauseBtn'); if(pbtn) pbtn.innerText = 'Resume';
  } else {
    // resuming: set startedAt as now - elapsedBefore
    state.session.startedAt = Date.now() - (elapsedSeconds * 1000);
    state.session.paused = false;
    saveState();
    showSmallToast('Resumed');
    const pbtn = $('pauseBtn'); if(pbtn) pbtn.innerText = 'Pause';
  }
}

function stopSession(){
  // stop interval
  if(sessionInterval) clearInterval(sessionInterval);
  sessionInterval = null;
  // mark session inactive and persist final values
  state.session.active = false;
  state.session.startedAt = null;
  state.session.elapsedBefore = elapsedSeconds;
  state.session.paused = false;
  // sessionExp already tracked
  saveState();

  hide('timerArea'); show('congratsArea');
  const totalTime = formatTime(elapsedSeconds);
  const totalExp = state.session.sessionExp || 0;
  $('congratsText').innerText = `You studied for ${totalTime} and earned ${totalExp} EXP this session.`;
  // reset local session record so next session starts fresh (but keep boxes/exp etc)
  state.session = { active:false, startedAt:null, elapsedBefore:0, paused:false, sessionExp:0 };
  saveState();
}

function resetSessionUI(){
  hide('congratsArea'); hide('timerArea'); show('sessionArea');
  $('timerDisplay').innerText = '00:00:00';
  $('moodEmoji').innerText = '🧠'; $('moodText').innerText = 'Ready';
  $('sessionExpDisplay').innerText = 'Session EXP: 0';
  elapsedSeconds = 0; paused = false;
  state.session = { active:false, startedAt:null, elapsedBefore:0, paused:false, sessionExp:0 };
  saveState();
}

function updateMood(elapsed){
  // pick mood based on milestone count (0..)
  const index = Math.min(moodSet.length-1, Math.floor(elapsed / MILESTONE_SECONDS));
  const mood = moodSet[index] || moodSet[moodSet.length-1];
  $('moodEmoji').innerText = mood.emoji;
  $('moodText').innerText = mood.text + (elapsed >= MILESTONE_SECONDS ? ` (after ${Math.floor(elapsed/60)} min)` : '');
}

/* ---------- small UI toasts ---------- */
function showSmallToast(msg){
  const t = document.createElement('div');
  t.style.position='fixed'; t.style.bottom='22px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.padding='10px 14px';
  t.style.borderRadius='12px'; t.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)'; t.style.background='rgba(0,0,0,0.7)'; t.style.color='white'; t.style.zIndex=99999;
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 900);
}
function showExpToast(msg){
  const t = document.createElement('div');
  t.style.position='fixed'; t.style.top='90px'; t.style.right='24px'; t.style.padding='8px 12px'; t.style.borderRadius='10px';
  t.style.background='linear-gradient(90deg,var(--accent),#8b5cf6)'; t.style.color='white'; t.style.fontWeight='700'; t.style.zIndex=99999;
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .4s'; t.style.opacity='0'; setTimeout(()=>t.remove(),400); }, 1400);
}

/* ---------- Utilities ---------- */
function formatTime(s){
  const hh = String(Math.floor(s/3600)).padStart(2,'0');
  const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}
function parseISO(dateStr, timeStr){
  if(!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return null;
  if(!/^\d{2}:\d{2}$/.test(timeStr)) return null;
  const iso = dateStr + 'T' + timeStr + ':00';
  const d = new Date(iso);
  if(isNaN(d.getTime())) return null;
  return d.toISOString();
}
function escape(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* stickers - draws theme-based icons */
function renderStickers(){
  const bg = $('bg'); if(!bg) return;
  bg.innerHTML='';
  const icons = state.user.theme==='cute' ? ['🐱','🎀'] : state.user.theme==='tech' ? ['🤖','💻'] : state.user.theme==='cold' ? ['❄️','🧊'] : ['✨','🌟'];
  for(let i=0;i<30;i++){
    const n = i%icons.length;
    const div = document.createElement('div'); div.className='sticker';
    div.style.left = Math.random()*92 + 'vw';
    div.style.top = Math.random()*92 + 'vh';
    div.style.fontSize = (18 + Math.random()*60) + 'px';
    div.innerText = icons[n];
    bg.appendChild(div);
  }
}

/* ---------- Header actions (Study Counter button appears only when experienceCreated) ---------- */
function setupHeaderActions(){
  const ha = $('headerActions'); if(!ha) return;
  ha.innerHTML='';
  if(!state.user.experienceCreated) return;
  const sc = document.createElement('button'); sc.className='btn secondary small'; sc.innerText='Study Counter';
  sc.addEventListener('click', ()=>{ hideAll(); show('studyCounterPage'); // ensure session UI reflects saved state
    if(state.session.active){ hide('sessionArea'); show('timerArea'); initSessionFromState(); } else { hide('timerArea'); hide('congratsArea'); show('sessionArea'); }
  });
  ha.appendChild(sc);
}

/* ---------- Life-cycle: load, init, save ---------- */
function init(){
  // load saved state
  loadState();

  // wire up controls
  $('btnContinue').addEventListener('click', onContinue);
  $('btnReset').addEventListener('click', onReset);
  $('purposeStudy').addEventListener('click', ()=>selectPurpose('Study'));
  $('purposeOther').addEventListener('click', ()=>selectPurpose('Other'));
  $('tCute').addEventListener('click', ()=>selectTheme('cute'));
  $('tTech').addEventListener('click', ()=>selectTheme('tech'));
  $('tCold').addEventListener('click', ()=>selectTheme('cold'));
  $('btnFinish').addEventListener('click', finishSetup);

  $('btnCreateBox').addEventListener('click', ()=>{ hide('dashboard'); show('createBox1'); });
  $('toCreateBox2').addEventListener('click', gotoCreateBox2);
  $('createBoxBtn').addEventListener('click', createBoxFinal);
  $('cancelCreateBox1').addEventListener('click', ()=>{ hide('createBox1'); show('dashboard'); });
  $('cancelCreateBox2').addEventListener('click', ()=>{ hide('createBox2'); show('dashboard'); });

  $('backToDashboard').addEventListener('click', ()=>{ currentBox=null; hide('boxDetail'); show('dashboard'); renderBoxes(); });

  $('btnAddTask').addEventListener('click', ()=>{ showTaskModal(); });
  $('modalCancel').addEventListener('click', hideTaskModal);
  $('modalAdd').addEventListener('click', confirmAddTask);

  $('btnEditBox').addEventListener('click', showEditBox);
  $('editCancel').addEventListener('click', hideEditBox);
  $('editSave').addEventListener('click', saveEditBox);
  $('btnDeleteBox').addEventListener('click', deleteCurrentBox);

  const startBtn = $('startSessionBtn'); if(startBtn) startBtn.addEventListener('click', startSession);
  const pauseBtn = $('pauseBtn'); if(pauseBtn) pauseBtn.addEventListener('click', togglePause);
  const stopBtn = $('stopBtn'); if(stopBtn) stopBtn.addEventListener('click', stopSession);
  const startAgainBtn = $('startAgainBtn'); if(startAgainBtn) startAgainBtn.addEventListener('click', resetSessionUI);
  const backFromStudyBtn = $('backFromStudyBtn'); if(backFromStudyBtn) backFromStudyBtn.addEventListener('click', ()=>{ hide('studyCounterPage'); show('dashboard'); renderBoxes(); setupHeaderActions(); });

  // initial UI state
  hideAll();
  show('stepName');
  renderStickers();
  updateStudyBar();
  applyTheme(state.user.theme || 'cute');
  renderBoxes();

  if(state.user && state.user.name){
    $('name').value = state.user.name; $('age').value = state.user.age || '';
    hideAll(); show('dashboard'); updateLogo(true); renderBoxes();
  }

  // study UI visibility depends on experienceCreated
  renderStudyUiVisibility();

  // if there's a saved active session, restore in study page state
  if(state.session && state.session.active){
    // ensure Study Counter is available
    state.user.experienceCreated = true;
    renderStudyUiVisibility();
  }

  // show dashboard if user restored
  if(state.user.name && (state.user.experienceCreated || state.boxes.length>0)){
    hideAll(); show('dashboard');
  }
}

/* hide helper excludes pages we don't want */
function hideAll(){
  const ids = ['stepName','stepCustomize','dashboard','createBox1','createBox2','boxDetail','taskModal','editBoxModal','studyCounterPage'];
  ids.forEach(id=>{ const el=$(id); if(el) el.classList.add('hidden'); });
}

/* Continue & setup */
function onContinue(){
  const n = val('name')?.trim();
  const a = val('age');
  if(!n || !a){ $('nameError').style.display='block'; $('nameError').innerText='Please enter name and age.'; setTimeout(()=>$('nameError').style.display='none',2000); return; }
  state.user.name = n; state.user.age = Number(a);
  $('greet').innerText = `Hello ${state.user.name}, customize your experience`;
  hide('stepName'); show('stepCustomize'); updateLogo(false);
  saveState();
}

function onReset(){
  if(!confirm('Reset all app data?')) return;
  state = {
    user: { name:'', age:0, purpose:'', theme:'', experienceCreated:false, title:'' },
    boxes: [], exp:0, level:0,
    session: { active:false, startedAt:null, elapsedBefore:0, paused:false, sessionExp:0 }
  };
  document.body.className='';
  applyTheme('cute');
  updateLogo(false);
  hideAll(); show('stepName'); renderBoxes(); renderStickers(); updateStudyBar();
  saveState();
}

function selectPurpose(p){
  state.user.purpose = p;
  ['purposeStudy','purposeOther'].forEach(id=> { const el=$(id); if(el) el.classList.remove('selected-red'); });
  if(p==='Study') $('purposeStudy').classList.add('selected-red');
  else $('purposeOther').classList.add('selected-red');
  saveState();
}

function selectTheme(t){
  state.user.theme = t;
  ['tCute','tTech','tCold'].forEach(id=> { const el=$(id); if(el) el.classList.remove('selected-red'); });
  if(t==='cute') $('tCute').classList.add('selected-red');
  if(t==='tech') $('tTech').classList.add('selected-red');
  if(t==='cold') $('tCold').classList.add('selected-red');
  applyTheme(t);
  updateLogo(false);
  saveState();
}

function updateLogo(showInitials){
  const logo = $('logo');
  if(showInitials && state.user.name){
    const parts = state.user.name.trim().split(/\s+/);
    const initials = parts.length>1 ? (parts[0][0]+parts[1][0]) : parts[0].slice(0,2);
    logo.innerText = initials.toUpperCase();
    logo.style.background = '#111'; logo.style.color='#fff';
  } else {
    if(state.user.theme==='cute'){ logo.innerText='💖'; logo.style.background='linear-gradient(180deg,#ff8fbf,#ff6aa2)'; logo.style.color='white'; }
    else if(state.user.theme==='tech'){ logo.innerText='🤖'; logo.style.background='linear-gradient(180deg,#00aaff,#0066ff)'; logo.style.color='white'; }
    else if(state.user.theme==='cold'){ logo.innerText='❄️'; logo.style.background='linear-gradient(180deg,#5cd6ff,#2bb7ff)'; logo.style.color='white'; }
    else { logo.innerText='✨'; logo.style.background='linear-gradient(180deg,#f0f0f0,#e6e6e6)'; logo.style.color='#333'; }
  }
}

/* finish setup */
function finishSetup(){
  if(!state.user.name) return onContinue();
  if(!state.user.theme) selectTheme('cute');
  hide('stepCustomize'); show('dashboard'); updateLogo(true);
  // mark experience created now (makes study UI visible)
  state.user.experienceCreated = true;
  state.user.title = computeTitleForLevel(state.level);
  renderStudyUiVisibility();
  renderBoxes();
  saveState();
}

/* ---------- init DOM ---------- */
document.addEventListener('DOMContentLoaded', init);

/* Expose manual save for debugging */
window._saveState = saveState;
</script>
</body>
</html>
